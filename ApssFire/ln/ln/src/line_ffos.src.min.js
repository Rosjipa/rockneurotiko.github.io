var BASE_DEFAULT="",LineConfig=function(){return null!=LineConfig.instance?LineConfig.instance:void 0};LineConfig.PHASE="REAL",LineConfig.DEVICE_NAME="",LineConfig.OS_NAME="Firefox_OS",LineConfig.APPLICATION_VERSION="1.0.2",LineConfig.OS_VERSION="1.1",LineConfig.APPLICATION_CODE={BETA:"FIREFOXOS_BETA",RC:"FIREFOXOS_RC",REAL:"FIREFOXOS"},LineConfig.CONNECTION_INFO_REGION="JP",LineConfig.AUTO_RESEND_SLEEPTIME=1500,LineConfig.AUTO_RESEND_INTERVAL=36e5,LineConfig.AUTO_RESEND_TIME=6e5,LineConfig.LONGPOLLING_TIMEOUT=6e4,LineConfig.LONGPOLLING_TIMEOUT_TABLE=[6e4,11e4,18e4,3e5],LineConfig.LONGPOLLING_MAX_LEVEL=LineConfig.LONGPOLLING_TIMEOUT_TABLE.length-1,LineConfig.FETCH_OPERATION_COUNT=30,LineConfig.END_OF_OPERATION_SLEEP_INTERVAL=300,LineConfig.NEW_FRIEND_CHECK_TIME=6e4,LineConfig.DIMMED_TIMEOUT=12e4,LineConfig.restrictZone=["73002","21405","21407","71606","74807","73404","732102","732123","33403","72406","72410","72411","72423","45005","00"],LineConfig.restrictCountry=["730","214","716","748","734","732","334","724"],LineConfig.LIST_THUMBNAIL_SIZE=56,LineConfig.PROFILE_THUMBNAIL_SIZE=90,LineConfig.UPLOAD_IMAGE_QUALITY=70,LineConfig.UPLOAD_TIMEOUT_INTERVAL=2e4,LineConfig.SETTING_DISPLAY_NAME_LENGTH=20,LineConfig.SETTING_STATUS_MESSAGE_LENGTH=100,LineConfig.LOCALE="pt-BR",LineConfig.DEFAULT_REGION="JP",LineConfig.REGISTER_PHONE_INPUT_LIMIT_SECONDS=10,LineConfig.REGISTER_PHONE_PINCODE_SESSION_LIMIT=30,LineConfig.REGISTER_PHONE_NUMBER_MIN_LENGTH=1,LineConfig.REGISTER_PIN_NUMBER_MIN_LENGTH=1,LineConfig.MAX_PHONE_NUMBER_LENGTH=15,LineConfig.MIN_PASSWORD_LENGTH=6,LineConfig.MAX_PASSWORD_LENGTH=20,LineConfig.MAX_PINCODE_LENGTH=6,LineConfig.SMS_RESEND_TIMEOUT=12e4,LineConfig.HEIGHT_OF_EMPTY_CHAT_LIST=228,LineConfig.MAX_GROUP_MEMBER_COUNT=99,LineConfig.RECOMMEND_FRIEND_MAX_BADGE_COUNT=99,LineConfig.NEW_FRIEND_MAX_BADGE_COUNT=99,LineConfig.MAX_DIMMED_TIME=3e4,LineConfig.MAX_WORKER_SEND_TIME=1e4,LineConfig.FILE_UPLOAD_LIMIT=3e6,LineConfig.prototype={getApplicationCode:function(){return LineConfig.APPLICATION_CODE[LineConfig.PHASE]},getApplicationCodeValue:function(){return ApplicationType[this.getApplicationCode()]},createUUID:function(){for(var s=[],hexDigits="0123456789abcdef",i=0;36>i;i++)s[i]=hexDigits.substr(Math.floor(16*Math.random()),1);s[14]="4",s[19]=hexDigits.substr(3&s[19]|8,1),s[8]=s[13]=s[18]=s[23]="-";var uuid=s.join("");return uuid}},LineConfig.getInstance=function(){return null==LineConfig.instance&&(LineConfig.instance=new LineConfig),LineConfig.instance},LineConfig.instance=null,$(document).ready(function(){LineMain.getInstance()});var LineMain=function(){return null!=LineMain.instance?LineMain.instance:(LineMain.showSplash(),_.extend(this,new ScreenManager),LineMain.runResourcePreLoader(),RegisterStepInfoKeeper.getInstance().setApplicationInitialized(!1),null===RegisterStepInfoKeeper.getInstance().getDeviceId()&&RegisterStepInfoKeeper.getInstance().setDeviceId(LineConfig.getInstance().createUUID()),DatabaseStoreFactory.getInstance().openDB(LineMain.upgradeneedDB,LineMain.loadDB),void AuthInfoKeeper.getInstance().setMCCMNC())};LineMain.upgradeneedDB=function(){},LineMain.loadDB=function(){for(var mcc=AuthInfoKeeper.getInstance().getMCC(),mccMnc=AuthInfoKeeper.getInstance().getMCCMNC(),restrictCountryFlag=!1,restrictFlag=!1,c=0;c<LineConfig.restrictCountry.length;c++)if(LineConfig.restrictCountry[c]==mcc){restrictCountryFlag=!0;for(var i=0;i<LineConfig.restrictZone.length;i++)mccMnc.indexOf(LineConfig.restrictZone[i])>-1&&(restrictFlag=!0);"00"==mccMnc&&(restrictFlag=!0)}0==restrictCountryFlag&&(restrictFlag=!0),0==restrictFlag?(alert($.i18n.prop("ONLY_USE_LIMITED_OPERATOR"))):(NetworkChecker.getInstance().run(),OperationPoller.getInstance(),LineMain.start())},LineMain.isMigrateGroupOk=!0,LineMain.isMigrateContactOk=!0,LineMain.isContactDataOk=!1,LineMain.isChatDataOk=!1,LineMain.start=function(){var countryInfo=ResourceLoader.getInstance().getMccInfoByMccNo(AuthInfoKeeper.getInstance().getMCC());if(countryInfo&&(LineConfig.DEFAULT_REGION=countryInfo.countryCode),LineMain.setOperationCommand(),Utility.initPressedEvent(),ChatProxy.getInstance(),RegisterStepInfoKeeper.getInstance().setApplicationInitialized(!0),ContactProxy.getInstance().prepareDataStart(LineMain.initUI),LineMain.SERVER_TIME_OFFSET=0,SettingProxy.getInstance().getServerTime(function(time){LineMain.SERVER_TIME_OFFSET=Number(time)-(new Date).getTime()}),navigator.getDeviceStorage){Utility.getSDCardStatus($.proxy(function(status){return"shared"===status?(LineMain.SDCardSecurityWarning(),!1):void 0},this));var sdcard=navigator.getDeviceStorage("sdcard");sdcard.addEventListener("change",function(event){{var reason=event.reason;event.path}return"shared"===reason?(LineMain.SDCardSecurityWarning(),!1):void 0}),Debugger=new DebugManager("Line/configuration.txt")}else Debugger={},Debugger.isDebugging=function(){return!1}},LineMain.initUI=function(){LineMain.isMigrateGroupOk&&LineMain.isMigrateContactOk&&LineMain.isContactDataOk&&LineMain.isChatDataOk&&(CommonUI.getInstance(),RegisterStepInfoKeeper.getInstance().isAccountInitialized()&&RegisterStepInfoKeeper.getInstance().isAuthorized()?LineMain.initAfterRegister():(LineMain.getInstance().removeNotRegisterStack(),LineMain.initBeforeRegister()),LineMain.hideSplash())},LineMain.initBeforeRegister=function(){var screenInfo={screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE};RegisterUI.getInstance(),SettingUI.getInstance(),SelectCountryUI.getInstance();var stack=LineMain.getInstance().getStack();stack.length>0&&(screenInfo=stack.pop(),LineMain.getInstance().setStack(stack)),LineMain.getInstance().changeScreen(screenInfo)},LineMain.initAfterRegister=function(){var lastOp=PersistentStore.getInstance().get("LastOP");null==lastOp&&SettingProxy.getInstance().getLastOpRevision(function(rev){PersistentStore.getInstance().set("LastOP",rev),OperationPollerPersistentStore.getInstance().setLastOperationId(rev)}),DimmedUI.getInstance().open("",{},{isCenter:!0}),ServerInfoChecker.getInstance().updateServerInfo(function(){ServerInfo.serverList=JSON.parse(PersistentStore.getInstance().get("CI_serverList")),SettingProxy.getInstance().updateConnectionServerInfo(),ProfileProxy.getInstance().updateConnectionServerInfo(),ContactProxy.getInstance().updateConnectionServerInfo(),GroupProxy.getInstance().updateConnectionServerInfo(),ChatProxy.getInstance().updateConnectionServerInfo(),OperationPoller.getInstance().updateConnectionServerInfo(),LinePushNotification.setEvent()}),ContactUI.getInstance(),ChatListUI.getInstance(),RecommendUI.getInstance(),RegisterUI.getInstance(),SettingUI.getInstance(),ChatUI.getInstance(),GroupUI.getInstance(),ChatEditListUI.getInstance(),FriendManagerUI.getInstance(),GroupManagerUI.getInstance(),SearchByIdUI.getInstance(),ProfileUI.getInstance(),SettingProxy.getInstance().updateToLocalSettings(),ProfileProxy.getInstance().updateToLocalProfile();var screenInfo;RegisterStepInfoKeeper.getInstance().isEmailAccountInitialized()||RegisterStepInfoKeeper.getInstance().isShownEmailRegister()?(DimmedUI.getInstance().close(),screenInfo={screen:LineMain.MAIN_SCREEN_TYPE.FRIENDS,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_LIST}):screenInfo={screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_EMAIL_REGISTER},LineMain.getInstance().changeScreen(screenInfo),DimmedUI.getInstance().close()},LineMain.showSplash=function(){$("#_wrap_splash").show()},LineMain.hideSplash=function(){$("#_wrap_splash").animate({opacity:0},200,"ease-out",function(){$(this).addClass("MdNonDisp")})},LineMain.setOperationCommand=function(){new ChatCommand,new ContactCommand,new GroupCommand,new SettingCommand,new ProfileCommand,new SystemCommand},LineMain.runResourcePreLoader=function(){Utility.initI18nProperties();for(var resource=[{type:"img",url:"/res/img/MdBTM.png"},{type:"img",url:"/res/img/img_error.png"},{type:"img",url:"/res/img/common.png"},{type:"img",url:"/res/img/MdMN/img_mdMN04Regist_01.png"},{type:"img",url:"/res/img/MdMN/img_mdMN04Empty_03.png"},{type:"img",url:"/res/img/MdMN/img_mdMN04Empty_01.png"},{type:"img",url:"/res/img/MdMN/ico_mdMN05Input.png"},{type:"img",url:"/res/img/noimg/profile_img90x90.png"},{type:"img",url:"/res/img/noimg/profile_img56x56.png"},{type:"img",url:"/res/img/noimg/noimg_group_90x90.png"}],i=0,nLen=resource.length;nLen>i;i++)Utility.resourcePreLoader(resource.type,resource.url)},LineMain.SDCardSecurityWarning=function(){return $("textarea:focus, input:focus").blur(),AlertUI.getInstance().open({message:$.i18n.prop("ENV_FAIL_SDCARD_MOUNTED"),button:{label:$.i18n.prop("CLOSE"),callback:function(){window.close()}}}),!1},LineMain.getInstance=function(){return null==LineMain.instance&&(LineMain.instance=new LineMain),LineMain.instance},LineMain.instance=null,LineMain.AVAILABLE_TOUCH=!!("ontouchstart"in window),LineMain.WINDOW_HEIGHT=$(window).height(),LineMain.HEADER_SIZE=36,LineMain.MENU_BAR_SIZE=47,LineMain.SEARCH_BAR_SIZE=36,LineMain.BUTTON_GROUP_SIZE=47,LineMain.CHAT_INPUT_SIZE=40,LineMain.CHAT_BLOCK_BTN_SIZE=46,LineMain.MAIN_SCREEN_TYPE={REGISTER:100,FRIENDS:200,CHAT:300,SETTING:400,ADD_CONTACT:500,FRIEND_MANAGER:600,GROUP:700,GROUP_MANAGER:800,ETC:900},LineMain.MAIN_SCREEN_TYPE_MAP=_.invert(LineMain.MAIN_SCREEN_TYPE),LineMain.SUB_SCREEN_TYPE={REGISTER_NEW_LINE:101,REGISTER_EMAIL_LOGIN:102,REGISTER_INPUT_PHONE:110,REGISTER_CONFIRM_TERM:111,REGISTER_SEND_PIN_CODE:112,REGISTER_INPUT_PIN_CODE:113,REGISTER_CONFIRM_SAME_DEVICE:114,REGISTER_CONFIRM_USE_CONTACTS:115,REGISTER_INPUT_PROFILE:117,REGISTER_EMAIL_REGISTER:118,REGISTER_EMAIL_REGISTER_INPUT_PINCODE:119,REGISTER_EMAIL_REGISTER_FINISH:120,FRIEND_LIST:201,CHAT_LIST:301,CHAT_ROOM:302,CHAT_LIST_EDIT:303,CHAT_SETTING:304,CHAT_MEMBER_LIST:305,SETTING_LIST:401,SETTING_PROFILE:402,SETTING_ACCOUNTS:403,SETTING_NOTIFICATIONS:404,SETTING_CHATS:405,SETTING_FRIENDS:406,SETTING_INVITE_FRIENDS:407,SETTING_HIDE_LIST:408,SETTING_BLOCK_LIST:409,SETTING_PRIVACY:410,SETTING_HELP:411,SETTING_ABOUT_LINE:412,SETTING_TERMS_OF_SERVICE:413,SETTING_PRIVACY_POLICY:414,SETTING_LEGAL_NOTICES:415,SETTING_PROFILE_INPUT_DISPLAY_NAME:416,SETTING_PROFILE_INPUT_STATUS_MESSAGE:417,SETTING_DELETE_ACCOUNT:419,SETTING_INTERCEPT_ACCOUNT:420,SETTING_EMAIL_ACCOUNTS:421,SETTING_EMAIL_CHANGE_EMAIL:422,SETTING_REGISTER_EMAIL:423,SETTING_REGISTER_EMAIL_INPUT_PINCODE:424,SETTING_EMAIL_CANCEL_REGISTRATION:425,SETTING_EMAIL_CHANGE_VERIFY:426,SETTING_EMAIL_CHANGE_PASSWORD:427,SETTING_EMAIL_CHANGE_SUCCESS:428,SETTING_OTHER_DEVICE:429,ADD_CONTACT_LIST:501,FRIEND_MANAGER_EDIT:601,FRIEND_MANAGER_CHOOSE:602,FRIEND_MANAGER_NEW:603,GROUP_DETAIL:701,GROUP_MANAGER_NEW:801,GROUP_MANAGER_EDIT:802,SEARCH_BY_USERID:901,ETC_SINGLE_INPUT_PAGE:902,SELECT_COUNTRY:903,ETC_IMAGE_VIEWER:904,ETC_PINCODE_INPUT:905},LineMain.SUB_SCREEN_TYPE_MAP=_.invert(LineMain.SUB_SCREEN_TYPE);var CommandManager=function(){return null!=CommandManager.instance?CommandManager.instance:void(this.commandList=[])};CommandManager.prototype={regist:function(opType,command){for(var flag=!0,i=0;i<this.commandList.length;i++)this.commandList[i].opType==opType&&(flag=!1);1==flag&&this.commandList.push({opType:opType,command:command})},execute:function(opType,operation,isForceFetchOps){for(var cmdList=this.commandList,execFlag=!1,i=0;i<cmdList.length;i++)for(var key in cmdList[i])if("opType"==key&&cmdList[i][key]==opType)return execFlag=!0,void cmdList[i].command.execute(operation,isForceFetchOps)},getOpTypeName:function(opType){for(var key in OpType)if(OpType[key]==opType)return key}},CommandManager.getInstance=function(){return null==CommandManager.instance&&(CommandManager.instance=new CommandManager),CommandManager.instance},CommandManager.instance=null,CommandManager.SEPERATOR="^1E";var ACCEPT_GROUP_INVITATION=function(){this.opType=OpType.ACCEPT_GROUP_INVITATION,this.execute=function(params){var groupId=params.getParam1();ChatProxy.getInstance().acceptGroupInvitation(groupId),ContactUI.getInstance().increaseContactBadgeCount()}},CREATE_ROOM=function(){this.opType=OpType.CREATE_ROOM,this.execute=function(params){params.getParam1()}},ChatCommand=function(){this.cmdManager=CommandManager.getInstance(),this.cmdManager.regist(OpType.RECEIVE_MESSAGE,new RECEIVE_MESSAGE),this.cmdManager.regist(OpType.SEND_MESSAGE,new SEND_MESSAGE),this.cmdManager.regist(OpType.SEND_CONTENT,new SEND_CONTENT),this.cmdManager.regist(OpType.RECEIVE_MESSAGE_RECEIPT,new RECEIVE_MESSAGE_RECEIPT),this.cmdManager.regist(OpType.CREATE_ROOM,new CREATE_ROOM),this.cmdManager.regist(OpType.LEAVE_ROOM,new LEAVE_ROOM),this.cmdManager.regist(OpType.NOTIFIED_LEAVE_ROOM,new NOTIFIED_LEAVE_ROOM),this.cmdManager.regist(OpType.INVITE_INTO_ROOM,new INVITE_INTO_ROOM),this.cmdManager.regist(OpType.NOTIFIED_INVITE_INTO_ROOM,new NOTIFIED_INVITE_INTO_ROOM),this.cmdManager.regist(OpType.INVITE_INTO_GROUP,new INVITE_INTO_GROUP),this.cmdManager.regist(OpType.NOTIFIED_ACCEPT_GROUP_INVITATION,new NOTIFIED_ACCEPT_GROUP_INVITATION),this.cmdManager.regist(OpType.NOTIFIED_INVITE_INTO_GROUP,new NOTIFIED_INVITE_INTO_GROUP),this.cmdManager.regist(OpType.NOTIFIED_LEAVE_GROUP,new NOTIFIED_LEAVE_GROUP),this.cmdManager.regist(OpType.ACCEPT_GROUP_INVITATION,new ACCEPT_GROUP_INVITATION),this.cmdManager.regist(OpType.LEAVE_GROUP,new LEAVE_GROUP),this.cmdManager.regist(OpType.KICKOUT_FROM_GROUP,new KICKOUT_FROM_GROUP),this.cmdManager.regist(OpType.NOTIFIED_KICKOUT_FROM_GROUP,new NOTIFIED_KICKOUT_FROM_GROUP),this.cmdManager.regist(OpType.REJECT_GROUP_INVITATION,new REJECT_GROUP_INVITATION),this.cmdManager.regist(OpType.UPDATE_GROUP,new UPDATE_GROUP),this.cmdManager.regist(OpType.NOTIFIED_UPDATE_GROUP,new NOTIFIED_UPDATE_GROUP)},INVITE_INTO_GROUP=function(){this.opType=OpType.INVITE_INTO_GROUP,this.execute=function(params){var groupId=params.getParam1(),inviteeMid=null;inviteeMid=params.getParam2().indexOf(CommandManager.SEPERATOR)>-1?Utility.seperateString(params.getParam2(),CommandManager.SEPERATOR):[params.getParam2()],ChatProxy.getInstance().inviteIntoGroup(groupId,inviteeMid)}},INVITE_INTO_ROOM=function(){this.opType=OpType.INVITE_INTO_ROOM,this.execute=function(op){var chatId=op.getParam1(),updatedMids=null,mineMid=op.getParam3();updatedMids=op.getParam2().indexOf(CommandManager.SEPERATOR)>-1?Utility.seperateString(op.getParam2(),CommandManager.SEPERATOR):op.getParam2(),null==mineMid?ChatProxy.getInstance().notifyInviteIntoRoom(chatId,updatedMids):AuthInfoKeeper.getInstance().getAuthMid()==mineMid&&ChatProxy.getInstance().notifyInviteIntoRoomForMe(chatId,updatedMids)}},KICKOUT_FROM_GROUP=function(){this.opType=OpType.KICKOUT_FROM_GROUP,this.execute=function(params){var groupId=params.getParam1(),deletedMid=null;deletedMid=params.getParam2().indexOf(CommandManager.SEPERATOR)>-1?Utility.seperateString(params.getParam2(),CommandManager.SEPERATOR):""==params.getParam2()?[]:[params.getParam2()],ChatProxy.getInstance().kickoutFromGroup(groupId,deletedMid)}},LEAVE_GROUP=function(){this.opType=OpType.LEAVE_GROUP,this.execute=function(params){var groupId=params.getParam1();ChatProxy.getInstance().leaveGroup(groupId,EventManager.EMPTY)}},LEAVE_ROOM=function(){this.opType=OpType.LEAVE_ROOM,this.execute=function(params){var roomId=params.getParam1();ChatProxy.getInstance().doDeleteChat(roomId,"desktop",EventManager.EMPTY)}},NOTIFIED_ACCEPT_GROUP_INVITATION=function(){this.opType=OpType.NOTIFIED_ACCEPT_GROUP_INVITATION,this.execute=function(params){var groupId=params.getParam1(),acceptedMid=params.getParam2();ContactProxy.getInstance().getContact(acceptedMid,$.proxy(function(){ChatProxy.getInstance().notifyAcceptGroupInvitation(groupId,acceptedMid)},this))}},NOTIFIED_INVITE_INTO_GROUP=function(){this.opType=OpType.NOTIFIED_INVITE_INTO_GROUP,this.execute=function(params,isForceFetchOps){var groupId=params.getParam1(),inviterMid=params.getParam2(),inviteeMid=null,myMid=AuthInfoKeeper.getInstance().getAuthMid(),isInviteMe=!1;if(inviteeMid=params.getParam3().indexOf(CommandManager.SEPERATOR)>-1?Utility.seperateString(params.getParam3(),CommandManager.SEPERATOR):[params.getParam3()],1==_.isArray(inviteeMid)?1==_.contains(inviteeMid,myMid)&&(isInviteMe=!0):inviteeMid==myMid&&(isInviteMe=!0),1==isInviteMe)ChatProxy.getInstance().notifyInviteIntoGroupForMe(groupId,inviterMid,isForceFetchOps);else if(1==_.isArray(inviteeMid)){var totalCount=inviteeMid.length,count=0;_.each(inviteeMid,function(mid){ContactProxy.getInstance().getContact(mid,function(){count===totalCount-1&&ChatProxy.getInstance().notifyInviteIntoGroup(groupId,inviterMid,inviteeMid),count++})})}else ContactProxy.getInstance().getContact(inviterMid,function(){ChatProxy.getInstance().notifyInviteIntoGroup(groupId,inviterMid,inviteeMid)})}},NOTIFIED_INVITE_INTO_ROOM=function(){this.opType=OpType.NOTIFIED_INVITE_INTO_ROOM,this.execute=function(params){var chatId=params.getParam1(),inviterMid=params.getParam2(),inviteeMid=null,myMid=AuthInfoKeeper.getInstance().getAuthMid(),flag=!1;if(inviteeMid=params.getParam3().indexOf(CommandManager.SEPERATOR)>-1?Utility.seperateString(params.getParam3(),CommandManager.SEPERATOR):params.getParam3(),1==_.isArray(inviteeMid)?flag=_.contains(inviteeMid,myMid):inviteeMid==myMid&&(flag=!0),1==flag)ChatProxy.getInstance().notifyInviteIntoRoomForMe(chatId,inviterMid,inviteeMid);else if(1==_.isArray(inviteeMid)){var totalCount=inviteeMid.length,count=0;_.each(inviteeMid,function(mid){ContactProxy.getInstance().getContact(mid,function(){count===totalCount-1&&ChatProxy.getInstance().notifyInviteIntoRoom(chatId,inviteeMid,inviterMid),count++})})}else ContactProxy.getInstance().getContact(inviteeMid,function(){ChatProxy.getInstance().notifyInviteIntoRoom(chatId,inviteeMid,inviterMid)})}},NOTIFIED_KICKOUT_FROM_GROUP=function(){this.opType=OpType.NOTIFIED_KICKOUT_FROM_GROUP,this.execute=function(params){var groupId=params.getParam1(),kickerMid=params.getParam2(),kickoutMid=params.getParam3();kickoutMid==AuthInfoKeeper.getInstance().getAuthMid()&&ChatProxy.getInstance().notifyKickoutFromGroup(groupId,kickerMid)}},NOTIFIED_LEAVE_GROUP=function(){this.opType=OpType.NOTIFIED_LEAVE_GROUP,this.execute=function(params){var groupId=params.getParam1(),leftMid=params.getParam2();ChatProxy.getInstance().notifyLeaveGroupInvitation(groupId,leftMid)}},NOTIFIED_LEAVE_ROOM=function(){this.opType=OpType.NOTIFIED_LEAVE_ROOM,this.execute=function(op){var chatId=op.getParam1(),updatedMid=op.getParam2();ChatProxy.getInstance().notifyLeaveRoom(chatId,updatedMid)}},RECEIVE_MESSAGE=function(){this.opType=OpType.RECEIVE_MESSAGE,this.execute=function(params,isForceFetchOps){ChatProxy.getInstance().receiveMessage(new Message(params.getMessage()),isForceFetchOps)}},RECEIVE_MESSAGE_RECEIPT=function(){this.opType=OpType.RECEIVE_MESSAGE_RECEIPT,this.execute=function(params){var readerMid=params.getParam1(),messageIdList=Utility.seperateString(params.getParam2(),CommandManager.SEPERATOR);ChatProxy.getInstance().processUpdateReadCount(readerMid,messageIdList)}},REJECT_GROUP_INVITATION=function(){this.opType=OpType.REJECT_GROUP_INVITATION,this.execute=function(params){var groupId=params.getParam1();ChatProxy.getInstance().rejectGroupInvitation(groupId)}},SEND_CONTENT=function(){this.opType=OpType.SEND_CONTENT,this.execute=function(params){var message=params.message,chatBo=ChatProxy.getInstance().isExistChat(message.to),messageBo=null;1==!!message.text?(null==chatBo&&(chatBo=ChatProxy.getInstance().makeChatUserBo(message.to)),messageBo=ChatMessageBO.getInstance().makeImageMessage(chatBo,"imageUrl"),messageBo.message.contentPreview=message.contentPreview,messageBo.status=ChatMessageBO.STATUS.SENT,0==!!chatBo.firstMsgLocalId&&(chatBo.firstMsgLocalId=messageBo.localId),chatBo.lastMessageTime=message.createdTime,ChatProxy.getInstance().updateChatBo(Utility.serialize(chatBo)),ChatProxy.getInstance().saveMessage(Utility.serialize(messageBo)),ChatProxy.getInstance().saveSuccessfulLastMessage(messageBo,null),ChatListUI.getInstance().updateChatList(),LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.CHAT_ROOM)&&(ChatUI.getInstance().paintMessageUI(messageBo,"live"),ChatProxy.getInstance().saveSuccessfulLastMessage(messageBo,null))):ChatProxy.getInstance().updateContent(message)}},SEND_MESSAGE=function(){this.opType=OpType.SEND_MESSAGE,this.execute=function(params){var opMessage=params.getMessage(),message=new Message(opMessage),chatBo=ChatProxy.getInstance().isExistChat(message.to),messageBo=null;if(-1==params.reqSeq){switch(null==chatBo&&(chatBo=ChatProxy.getInstance().makeChatUserBo(message.to)),message.contentType){case ContentType.NONE:messageBo=ChatMessageBO.getInstance().makeTextMessage(chatBo,message.text);break;case ContentType.STICKER:var metadata=message.contentMetadata;messageBo=ChatMessageBO.getInstance().makeStickerMessage(chatBo,metadata.STKPKGID,metadata.STKID,metadata.STKVER);break;case ContentType.IMAGE:return}0==!!chatBo.firstMsgLocalId&&(chatBo.firstMsgLocalId=messageBo.localId),chatBo.lastMessageTime=message.createdTime,ChatProxy.getInstance().updateChatBo(Utility.serialize(chatBo)),ChatProxy.getInstance().saveMessage(Utility.serialize(messageBo)),ChatProxy.getInstance().checkUpdateSendMessage(messageBo.localId,message,"op"),LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.CHAT_ROOM)&&(ChatUI.getInstance().paintMessageUI(messageBo,"live"),ChatProxy.getInstance().checkUpdateSendMessage(messageBo.localId,message,"op"))}else ChatProxy.getInstance().checkUpdateSendMessage(params.reqSeq,message,"op")}},ADD_CONTACT=function(){this.opType=OpType.ADD_CONTACT,this.execute=function(params){var mid=params.getParam1();ContactProxy.getInstance().getContact(mid,$.proxy(ContactProxy.getInstance().addContact,ContactProxy.getInstance()))}},BLOCK_CONTACT=function(){this.opType=OpType.BLOCK_CONTACT,this.execute=function(params){var mid=params.getParam1(),localContact=(params.getParam2(),ContactProxy.getInstance().getContactFromLocal(mid));localContact&&localContact.status!==ContactStatus.FRIEND_BLOCKED?ContactProxy.getInstance().getContactT(mid,$.proxy(this.localContactBlock,this)):localContact||ContactProxy.getInstance().getContactT(mid,$.proxy(this.localContactBlock,this))},this.localContactBlock=function(contactInfo){ContactProxy.getInstance().updateContact(contactInfo)}},ContactCommand=function(){this.cmdManager=CommandManager.getInstance(),this.cmdManager.regist(OpType.ADD_CONTACT,new ADD_CONTACT),this.cmdManager.regist(OpType.NOTIFIED_UPDATE_PROFILE,new NOTIFIED_UPDATE_PROFILE),this.cmdManager.regist(OpType.UPDATE_CONTACT,new UPDATE_CONTACT),this.cmdManager.regist(OpType.BLOCK_CONTACT,new BLOCK_CONTACT),this.cmdManager.regist(OpType.UNBLOCK_CONTACT,new UNBLOCK_CONTACT),this.cmdManager.regist(OpType.NOTIFIED_ADD_CONTACT,new NOTIFIED_ADD_CONTACT),this.cmdManager.regist(OpType.NOTIFIED_RECOMMEND_CONTACT,new NOTIFIED_RECOMMEND_CONTACT),this.cmdManager.regist(OpType.NOTIFIED_UNREGISTER_USER,new NOTIFIED_UNREGISTER_USER)},NOTIFIED_ADD_CONTACT=function(){this.opType=OpType.NOTIFIED_ADD_CONTACT,this.execute=function(params){var mid=params.getParam1(),contact=ContactProxy.getInstance().getContactFromLocal(mid);contact||ContactProxy.getInstance().getContact(mid,$.proxy(ContactProxy.getInstance().addContact,ContactProxy.getInstance()))}},NOTIFIED_RECOMMEND_CONTACT=function(){this.opType=OpType.NOTIFIED_RECOMMEND_CONTACT,this.execute=function(params){var mid=params.getParam1(),contact=ContactProxy.getInstance().getContactFromLocal(mid);contact&&contact.status!==ContactStatus.UNSPECIFIED||(ContactProxy.getInstance().getContact(mid,$.proxy(ContactProxy.getInstance().addRecommendContact,ContactProxy.getInstance())),RecommendUI.getInstance().increaseBadgeCount())}},NOTIFIED_UNREGISTER_USER=function(){this.opType=OpType.NOTIFIED_UNREGISTER_USER,this.execute=function(operation){var mid=operation.getParam1(),updatedContact=ContactProxy.getInstance().getContactFromLocal(mid);1==!!updatedContact&&(updatedContact.status=ContactStatus.UNSPECIFIED,updatedContact.unregister=!0,updatedContact.pictureStatus=null,ContactProxy.getInstance().updateContact(updatedContact))}},NOTIFIED_UPDATE_PROFILE=function(){this.opType=OpType.NOTIFIED_UPDATE_PROFILE,this.execute=function(operation){{var mid=operation.getParam1();operation.getParam2()}ContactProxy.getInstance().getContactT(mid,$.proxy(this.updateContact,this))},this.updateContact=function(contact){ContactProxy.getInstance().updateContact(contact)}},UNBLOCK_CONTACT=function(){this.opType=OpType.UNBLOCK_CONTACT,this.execute=function(params){var mid=params.getParam1(),localContact=ContactProxy.getInstance().getContactFromLocal(mid);localContact&&localContact.status!==ContactStatus.FRIEND_BLOCKED&&ContactProxy.getInstance().getContact(mid,$.proxy(this.localContactUnBlock,this))},this.localContactUnBlock=function(contactInfo){ContactProxy.getInstance().updateContact(contactInfo)}},UPDATE_CONTACT=function(){this.opType=OpType.UPDATE_CONTACT,this.execute=function(operation){var mid=operation.getParam1();ContactProxy.getInstance().getContactT(mid,$.proxy(this.updateContact,this))},this.updateContact=function(contact){ContactProxy.getInstance().updateContact(contact)}},CANCEL_INVITATION_GROUP=function(){this.opType=OpType.CANCEL_INVITATION_GROUP,this.execute=function(params){var groupId=params.getParam1(),mid=params.getParam2();GroupProxy.getInstance().removeInvitee(groupId,AuthInfoKeeper.getInstance().getAuthMid(),mid)}},CREATE_GROUP=function(){this.opType=OpType.CREATE_GROUP,this.execute=function(params){var id=params.getParam1(),group=GroupProxy.getInstance().getGroupFromLocal(id);0==!!group&&GroupProxy.getInstance().getGroup(id,function(res){ChatProxy.getInstance().createChatGroupForOP(res.id,Utility.serialize(res))})}},GroupCommand=function(){this.cmdManager=CommandManager.getInstance(),this.cmdManager.regist(OpType.CREATE_GROUP,new CREATE_GROUP),this.cmdManager.regist(OpType.NOTIFIED_CANCEL_INVITATION_GROUP,new NOTIFIED_CANCEL_INVITATION_GROUP),this.cmdManager.regist(OpType.CANCEL_INVITATION_GROUP,new CANCEL_INVITATION_GROUP)},NOTIFIED_CANCEL_INVITATION_GROUP=function(){this.opType=OpType.NOTIFIED_CANCEL_INVITATION_GROUP,this.execute=function(params){var groupId=params.getParam1(),fromMid=params.getParam2(),mid=params.getParam3();GroupProxy.getInstance().removeInvitee(groupId,fromMid,mid)}},NOTIFIED_UPDATE_GROUP=function(){this.opType=OpType.NOTIFIED_UPDATE_GROUP,this.execute=function(params){var groupId=params.getParam1(),adaptedChatId=params.getParam2(),attribute=params.getParam3();GroupProxy.getInstance().updateGroup(groupId,attribute,adaptedChatId)}},UPDATE_GROUP=function(){this.opType=OpType.UPDATE_GROUP,this.execute=function(params){var groupId=params.getParam1(),attribute=params.getParam2();GroupProxy.getInstance().updateGroup(groupId,attribute)}},ProfileCommand=function(){this.cmdManager=CommandManager.getInstance(),this.cmdManager.regist(OpType.UPDATE_PROFILE,new UPDATE_PROFILE),this.cmdManager.regist(OpType.REGISTER_USERID,new REGISTER_USERID)},REGISTER_USERID=function(){this.opType=OpType.REGISTER_USERID,this.execute=function(operation){operation.getParam1(),operation.getParam2(),operation.getParam3();ProfileProxy.getInstance().updateToLocalProfile()}},UPDATE_PROFILE=function(){this.opType=OpType.UPDATE_PROFILE,this.execute=function(operation){var param1=operation.getParam1(),profileAttribute=(operation.getParam2(),operation.getParam3(),parseInt(param1,10));profileAttribute===ProfileAttribute.PICTURE?ProfileProxy.getInstance().updateToLocalProfile():profileAttribute===ProfileAttribute.ALLOW_SEARCH_BY_USERID||ProfileProxy.getInstance().notifyUpdate()}},RegisterCommand=function(){this.cmdManager=CommandManager.getInstance()},SettingCommand=function(){this.cmdManager=CommandManager.getInstance(),this.cmdManager.regist(OpType.UPDATE_SETTINGS,new UPDATE_SETTINGS)},UPDATE_SETTINGS=function(){this.opType=OpType.UPDATE_SETTINGS,this.execute=function(operation){operation.getParam1(),operation.getParam2(),operation.getParam3();SettingProxy.getInstance().notifyUpdate()}},END_OF_OPERATION=function(){this.opType=OpType.END_OF_OPERATION,this.execute=function(){}},NOTIFIED_REDIRECT=function(){this.opType=OpType.NOTIFIED_REDIRECT,this.execute=function(params){{var lineUrlScheme=params.getParam1(),redirectType=params.getParam2();params.getParam3()}lineUrlScheme.indexOf("error")>-1||"1"==redirectType&&(DesktopPincodeInputUI.getInstance().init(params),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.ETC,subScreen:LineMain.SUB_SCREEN_TYPE.ETC_PINCODE_INPUT}))}},SystemCommand=function(){this.cmdManager=CommandManager.getInstance(),this.cmdManager.regist(OpType.END_OF_OPERATION,new END_OF_OPERATION),this.cmdManager.regist(OpType.NOTIFIED_REDIRECT,new NOTIFIED_REDIRECT)},EventManager=function(){this.listenerList=[]};EventManager.prototype={regist:function(listener){this.listenerList.push(listener)},broadCast:function(args){for(var i=0;i<this.listenerList.length;i++){var fnListener=this.listenerList[i];fnListener instanceof Function&&fnListener(args)}}},EventManager.EMPTY=function(){};var UIEventManager=function(){return null!=UIEventManager.instance?UIEventManager.instance:void _.extend(this,new EventManager)};UIEventManager.prototype={},UIEventManager.getInstance=function(){return null==UIEventManager.instance&&(UIEventManager.instance=new UIEventManager),UIEventManager.instance},UIEventManager.instance=null,UIEventManager.EVENT_RESIZE=1;var NetworkChecker=function(){return null!=NetworkChecker.instance?NetworkChecker.instance:(this.currentState=null,this.connection=null,void this.setState(1==navigator.onLine?"online":"offline"))};NetworkChecker.prototype={run:function(){window.addEventListener("online",this.stateCheck.bind(this),!1),window.addEventListener("offline",this.stateCheck.bind(this),!1),this.setState(1==navigator.onLine?"online":"offline")},stateCheck:function(event){if("online"==event.type){this.currentState="online",OperationPoller.getInstance().prevReqRevision=0,OperationPoller.getInstance().run();var settings=SettingProxy.getInstance().getSettings();1==settings.chatAutoResend&&AutoResenderProxy.getInstance().enforceResend()}else"offline"==event.type&&(this.currentState="offline")},onConnectionChange:function(){this.connection.metered},getState:function(){return this.currentState},setState:function(flag){this.currentState=flag}},NetworkChecker.getInstance=function(){return null==NetworkChecker.instance&&(NetworkChecker.instance=new NetworkChecker),NetworkChecker.instance},NetworkChecker.instance=null;var OperationParam=function(op){_.extend(this,op)};OperationParam.prototype={getParam1:function(){return this.param1},getParam2:function(){return this.param2},getParam3:function(){return this.param3},getMessage:function(){return this.message}};var OperationPoller=function(){return null!=OperationPoller.instance?OperationPoller.instance:(this.worker=null,this.store=OperationPollerPersistentStore.getInstance(),this.isRunState=!1,this.isForceRun=!1,this.runLevel=0,this.isChangeNetwork=!1,this.reqRevision=0,this.prevReqRevision=0,this.unusualPollingDate=null,this.unusualPollingCount=0,void this.initPoller())};OperationPoller.prototype={initPoller:function(){null==this.worker&&(this.worker=new JobWorker(BASE_DEFAULT+"src/worker/longPollingJob.js",EventManager.EMPTY,EventManager.EMPTY),this.worker.addListener("requestOperationPolling",this.successHandle.bind(this)),this.worker.addListener("ErrorOperationPolling",this.errorHandle.bind(this)),this.worker.addListener("requestEnforceFetch",this.successEnforceFetch.bind(this)),this.worker.addListener("ErrorEnforceFetch",this.errorEnforceFetch.bind(this)))},run:function(){1!=this.isForceRun&&0==this.isRunState&&OperationPollingStatusProvider.getInstance().isEnabled()&&(this.isRunState=!0,null==this.worker&&this.initPoller(),this.prevReqRevision!=this.store.getLastOperationId()||0==this.store.getLastOperationId()?this.worker.sendQuery("requestOperationPolling",this.store.getLastOperationId(),LineConfig.FETCH_OPERATION_COUNT,LineConfig.LONGPOLLING_TIMEOUT):this.isRunState=!1)
},enforceFetch:function(){this.prevReqRevision!=this.store.getLastOperationId()&&(this.prevReqRevision=this.store.getLastOperationId(),this.worker.sendQuery("requestEnforceFetch",this.store.getLastOperationId(),LineConfig.FETCH_OPERATION_COUNT))},stop:function(){this.isRunState=!1,this.worker.close(),this.worker=null},startPush:function(){this.prevReqRevision=0,this.isForceRun=!0},endPush:function(){this.isForceRun=!1},setBackgroundMode:function(){this.startPush()},setForegroundMode:function(){this.endPush(),this.run()},intEtcValue:function(){this.unusualPollingDate=null,this.unusualPollingCount=0},successHandle:function(opList){var endFlag=this.checkProcessOperationList(opList),sleepTime=0;endFlag&&(sleepTime=LineConfig.END_OF_OPERATION_SLEEP_INTERVAL),this.isRunState=!1,1!=this.isForceRun&&this.run()},successEnforceFetch:function(opList){this.checkProcessOperationList(opList)},errorEnforceFetch:function(error){},errorHandle:function(error){if(this.isRunState=!1,error.indexOf){var isknownError=error.indexOf("HTTP Response code: ")>-1;if(1==this.isForceRun)return;if(1==isknownError){var errNo=error.split(": ")[1];if("0"!=errNo&&1==this.isChangeNetwork&&(this.isChangeNetwork=!1),"0"==errNo){if("offline"==NetworkChecker.getInstance().getState())return;if(null==this.unusualPollingDate)this.unusualPollingDate=(new Date).getTime();else{var now=(new Date).getTime();now-this.unusualPollingDate<1e3&&(this.unusualPollingCount++,this.unusualPollingDate=now)}if(this.unusualPollingCount>=5)return;this.runLevel=0,LineConfig.LONGPOLLING_TIMEOUT=LineConfig.LONGPOLLING_TIMEOUT_TABLE[this.runLevel],this.run()}else"410"==errNo||"204"==errNo?("410"==errNo&&this.runLevel<LineConfig.LONGPOLLING_MAX_LEVEL&&(this.runLevel++,LineConfig.LONGPOLLING_TIMEOUT=LineConfig.LONGPOLLING_TIMEOUT_TABLE[this.runLevel]),this.run()):"500"==errNo||"599"==errNo||"502"==errNo?setTimeout(this.run.bind(this),5e3):(LineNetworkExceptionHandler.getInstance().unknownError(errNo),setTimeout(this.run.bind(this),5e3))}else alert(error)}else alert("what????")},checkProcessOperationList:function(opList){var endFlag=!1;if(opList instanceof Array){for(var maxRevision=this.store.getLastOperationId(),i=0;i<opList.length;i++){var op=opList[i],opType=op.type;maxRevision=Math.max(maxRevision,op.revision),opType!=OpType.END_OF_OPERATION?null!=opType&&this.broadCast(op):this.broadCast(op),opType==OpType.END_OF_OPERATION&&(endFlag=!0)}if(this.reqRevision=maxRevision,this.store.setLastOperationId(maxRevision),1==endFlag){var settings=SettingProxy.getInstance().getSettings();1==settings.chatAutoResend&&AutoResenderProxy.getInstance().enforceResend()}}return endFlag},broadCast:function(op){var operation=new OperationParam(op);CommandManager.getInstance().execute(op.type,operation,this.isForceRun)},updateConnectionServerInfo:function(){null===this.worker&&this.initPoller(),this.worker.sendQuery("pushServerInfo",PersistentStore.getInstance().get("CI_serverList"))},debugMode:function(debugInfo){this.worker.sendQuery("pushDebugInfo",debugInfo)}},OperationPoller.getInstance=function(){return null==OperationPoller.instance&&(OperationPoller.instance=new OperationPoller),OperationPoller.instance},OperationPoller.instance=null;var OperationPollingStatusProvider=function(){return null!=OperationPollingStatusProvider.instance?OperationPollingStatusProvider.instance:void 0};OperationPollingStatusProvider.prototype={isEnabled:function(){var flag=!0;return this.isApplicationInitialized()?this.isAuthorized()?this.isAccountInitialized()||(flag=!1):flag=!1:flag=!1,flag},isApplicationInitialized:function(){return RegisterStepInfoKeeper.getInstance().isApplicationInitialized()},isAuthorized:function(){return RegisterStepInfoKeeper.getInstance().isAuthorized()},isAccountInitialized:function(){return RegisterStepInfoKeeper.getInstance().isAccountInitialized()}},OperationPollingStatusProvider.getInstance=function(){return null==OperationPollingStatusProvider.instance&&(OperationPollingStatusProvider.instance=new OperationPollingStatusProvider),OperationPollingStatusProvider.instance},OperationPollingStatusProvider.instance=null;var ServerInfoChecker=function(){return null!=ServerInfoChecker.instance?ServerInfoChecker.instance:(this.timer=0,this.NETWORK_JOB_FILE=BASE_DEFAULT+"src/worker/ConnectionInfoNetworkJob.js",void(this.jobWorker=new JobWorker(this.NETWORK_JOB_FILE,LineTalkExceptionHandler.getInstance().handle,LineNetworkExceptionHandler.getInstance().handle)))};ServerInfoChecker.prototype={updateServerInfo:function(callback){0==!!callback&&(callback=function(){}),this.jobWorker.send({methodName:"requestConnectionInfoT",data:[LineConfig.DEFAULT_REGION,AuthInfoKeeper.getInstance().getMCCMNC()],success:$.proxy(function(res){clearTimeout(this.timer),res&&this.saveServerInfo(res),callback()},this),error:function(){callback()}}),this.timer=setTimeout(callback,LineConfig.MAX_WORKER_SEND_TIME)},saveServerInfo:function(res){PersistentStore.getInstance().set("CI_settings",JSON.stringify(JSON.parse(res).settings)),PersistentStore.getInstance().set("CI_serverList",JSON.stringify(JSON.parse(res).servers))}},ServerInfoChecker.getInstance=function(){return null==ServerInfoChecker.instance&&(ServerInfoChecker.instance=new ServerInfoChecker),ServerInfoChecker.instance},ServerInfoChecker.instance=null,ServerInfoChecker.connectionInfoURI="/R",ServerInfoChecker.noAuthURI="/api/v4j/TalkService.do",ServerInfoChecker.longPollingURI="/JP4",ServerInfoChecker.authURI="/JS4",ServerInfoChecker.compactSendMessageURI="/JC4",ServerInfoChecker.notifySleepURI="/JF4",ServerInfoChecker.OBS={},ServerInfoChecker.OBS.profileURI="/talk/p",ServerInfoChecker.OBS.groupProfileURI="/talk/g",ServerInfoChecker.OBS.chatImageURI="/talk/m",ServerInfoChecker.PollingPort=443,ServerInfoChecker.PollingHost={BETA:"gfp-beta.line.naver.jp",RC:"gfp-rc.line.naver.jp",REAL:"gfp.line.naver.jp"},ServerInfoChecker.ThriftPort=443,ServerInfoChecker.ThriftHost={BETA:"gf-beta.line.naver.jp",RC:"gf-rc.line.naver.jp",REAL:"gf.line.naver.jp"},ServerInfoChecker.OriginOBSPort=80,ServerInfoChecker.OriginOBSHost={BETA:"os-beta.line.naver.jp",RC:"os-rc.line.naver.jp",REAL:"os.line.naver.jp"},ServerInfoChecker.GCDNOBSPort=80,ServerInfoChecker.GCDNOBSHost={BETA:"dl.os-beta.line.naver.jp",RC:"dl.profile.line.naver.jp",REAL:"dl.profile.line.naver.jp"},ServerInfoChecker.GCDNStickerPort=80,ServerInfoChecker.GCDNStickerHost={BETA:"dl.stickershop.line.beta.naver.jp",RC:"dl.stickershop.line.naver.jp",REAL:"dl.stickershop.line.naver.jp"},ServerInfoChecker.serverList=null;var ServerInfo=function(){return null!=ServerInfo.instance?ServerInfo.instance:(this.host=null,this.port=null,this.uri=null,this.setting=function(type){"noAuth"==type?(this.host=this.getPrivateHost("ThriftHost"),this.port=this.getPrivatePort("ThriftPort"),this.uri=ServerInfo.noAuthURI):"connectionInfo"==type?(this.host=this.getPrivateHost("ThriftHost"),this.port=this.getPrivatePort("ThriftPort"),this.uri=ServerInfo.connectionInfoURI):"thrift"==type?(this.host=this.getPrivateHost("ThriftHost"),this.port=this.getPrivatePort("ThriftPort"),this.uri=ServerInfo.authURI):"longPolling"==type?(this.host=this.getPrivateHost("PollingHost"),this.port=this.getPrivatePort("PollingPort"),this.uri=ServerInfo.longPollingURI):"gCdnObs"==type?(this.host=this.getPrivateHost("GCDNOBSHost"),this.port=this.getPrivatePort("GCDNOBSPort"),this.uri=ServerInfo.authURI):"sticker"==type?(this.host=this.getPrivateHost("GCDNStickerHost"),this.port=this.getPrivatePort("GCDNStickerPort"),this.uri=ServerInfo.authURI):"originObsProfile"==type?(this.host=this.getOBSHost(),this.port=this.getOBSPort(),this.uri=ServerInfo.OBS.profileURI+"/upload.nhn"):"originObsGroupProfile"==type?(this.host=this.getOBSHost(),this.port=this.getOBSPort(),this.uri=ServerInfo.OBS.groupProfileURI+"/upload.nhn"):"originObsChatImage"==type?(this.host=this.getOBSHost(),this.port=this.getOBSPort(),this.uri=ServerInfo.OBS.chatImageURI+"/upload.nhn"):"originObsDownloadChat"===type?(this.host=ServerInfo.OriginOBSHost[LineConfig.PHASE],this.port=this.getOBSPort(),this.uri=ServerInfo.OBS.chatImageURI+"/download.nhn"):"originObsObjectInfoChat"===type?(this.host=ServerInfo.OriginOBSHost[LineConfig.PHASE],this.port=this.getOBSPort(),this.uri="/talk/m/object_info.nhn"):"originObsObjectInfoGroupProfile"===type?(this.host=ServerInfo.OriginOBSHost[LineConfig.PHASE],this.port=this.getOBSPort(),this.uri="/talk/g/object_info.nhn"):"warmup"==type?(this.host=this.getPrivateHost("ThriftHost"),this.port=443,this.uri=ServerInfo.wramupURI):"help"==type&&(this.host=this.getPrivateHost("HelpHost"))},this.setQueryString=function(options){options.ver="1.0",this.uri+="?"+$.param(options)},this.setRestfulUrl=function(){this.uri+="/delete.nhn"},this.getHost=function(){return this.host},this.getPort=function(){return this.port},void(this.getURI=function(){return this.uri}))};ServerInfo.prototype={getPrivateHost:function(type){var hostObj=this.getServerHost(type);return hostObj?hostObj[LineConfig.PHASE]:(alert("error - invalid host type : "+type),null)},getPrivatePort:function(type){var portObj=ServerInfo[type];return ServerInfo.isDebugMode&&_.size(ServerInfo.DebugPort)>0?ServerInfo.DebugPort[type]:portObj?portObj:(alert("error - invalid port type : "+type),null)},getOBSHost:function(){return this.getPrivateHost("OriginOBSHost")},getGCDNOBSHost:function(){return this.getPrivateHost("GCDNOBSHost")},getOBSPort:function(){return this.getPrivatePort("OriginOBSPort")},OriginOBSHost:function(){return this.getPrivatePort("OriginOBSPort")},getStickerHost:function(){return"http://"+this.getPrivateHost("GCDNStickerHost")},getServerHost:function(type){var serverList=ServerInfo.serverList,hostObj=ServerInfo[type];if(ServerInfo.isDebugMode&&_.size(ServerInfo.DebugHost)>0)return ServerInfo.DebugHost[type];if(!ServerInfo.serverList)return hostObj;switch(type){case"PollingHost":var pollingServers=_.findWhere(serverList,{server_type:"legy_polling",transport:"tls"}),pollingServerInfo=this.parseServerList(pollingServers);pollingServerInfo.length>0&&(hostObj[LineConfig.PHASE]=_.first(pollingServerInfo).host);break;case"ThriftHost":var thriftServers=_.pick(_.findWhere(serverList,{server_type:"legy",transport:"tls"}),"list"),thriftServerInfo=this.parseServerList(thriftServers);thriftServerInfo.length>0&&(hostObj[LineConfig.PHASE]=_.first(thriftServerInfo).host);break;case"OriginOBSHost":var obsServerList=_.pick(_.findWhere(serverList,{server_type:"obs",transport:"tls"}),"list"),obsServerInfo=this.parseServerList(obsServerList);obsServerInfo.length>0&&(hostObj[LineConfig.PHASE]=_.first(obsServerInfo).host);break;case"GCDNOBSHost":var cdnObsServerList=_.pick(_.findWhere(serverList,{server_type:"cdn_obs",transport:"raw"}),"list"),cdnObsServerInfo=this.parseServerList(cdnObsServerList);cdnObsServerInfo.length>0&&(hostObj[LineConfig.PHASE]=_.first(cdnObsServerInfo).host);break;case"GCDNStickerHost":var cdnStickerServerList=_.pick(_.findWhere(serverList,{server_type:"cdn_sticker",transport:"raw"}),"list"),cdnStickerServerInfo=this.parseServerList(cdnStickerServerList);cdnStickerServerInfo.length>0&&(hostObj[LineConfig.PHASE]=_.first(cdnStickerServerInfo).host)}return hostObj},parseServerList:function(object){var servers=_.pick(object,"list"),server=_.values(servers)[0];return server}},ServerInfo.getInstance=function(){return null==ServerInfo.instance&&(ServerInfo.instance=new ServerInfo),ServerInfo.instance},ServerInfo.instance=null,ServerInfo.connectionInfoURI="/R",ServerInfo.noAuthURI="/api/v4j/TalkService.do",ServerInfo.longPollingURI="/JP4",ServerInfo.authURI="/JS4",ServerInfo.compactSendMessageURI="/JC4",ServerInfo.notifySleepURI="/JF4",ServerInfo.wramupURI="/200",ServerInfo.OBS={},ServerInfo.OBS.profileURI="/talk/p",ServerInfo.OBS.groupProfileURI="/talk/g",ServerInfo.OBS.chatImageURI="/talk/m",ServerInfo.PollingPort=443,ServerInfo.PollingHost={BETA:"gfp-beta.line.naver.jp",RC:"gfp-rc.line.naver.jp",REAL:"gfp.line.naver.jp"},ServerInfo.ThriftPort=443,ServerInfo.ThriftHost={BETA:"gf-beta.line.naver.jp",RC:"gf-rc.line.naver.jp",REAL:"gf.line.naver.jp"},ServerInfo.OriginOBSPort=80,ServerInfo.OriginOBSHost={BETA:"os-beta.line.naver.jp",RC:"os-rc.line.naver.jp",REAL:"os.line.naver.jp"},ServerInfo.GCDNOBSPort=80,ServerInfo.GCDNOBSHost={BETA:"dl.os-beta.line.naver.jp",RC:"dl.profile.line.naver.jp",REAL:"dl.profile.line.naver.jp"},ServerInfo.GCDNStickerPort=80,ServerInfo.GCDNStickerHost={BETA:"dl.stickershop.line.beta.naver.jp",RC:"dl.stickershop.line.naver.jp",REAL:"dl.stickershop.line.naver.jp"},ServerInfo.HelpHost={BETA:"line.beta.naver.jp",RC:"line.naver.jp",REAL:"line.naver.jp"},ServerInfo.serverList=null,ServerInfo.isDebugMode=!1,ServerInfo.DebugHost={},ServerInfo.DebugPort={};var XHR=function(method){this.xhrObj=new XMLHttpRequest({mozSystem:!0,mozBackgroundRequest:!0}),this.method=method};XHR.prototype={getXHRObj:function(){return this.xhrObj},getMethod:function(){return this.method}};var CachedHeaderHttpClient=function(httpClient,type){return this.httpClient=httpClient,this.setXLSHeader(type),this.httpClient};CachedHeaderHttpClient.prototype={setXLSHeader:function(type){var cacheId="polling"==type?Thrift.Line.XLSToPolling:Thrift.Line.XLS;this.httpClient.setHeader("X-LS",cacheId)}};var ConnectionInfoHttpClient=function(xhr,region,mccmnc,serverInfo){this.xhr=xhr,this.xhrInstance=this.xhr.getXHRObj(),this.psk="4c 60 5e ff df 3d fc a1 21 7d 48 17 40 20 56 91 80 dc 23 38 a5 77 2a 80 ed 0a aa 01 bc d0 a0 8f",this.host=serverInfo.getHost(),this.port=serverInfo.getPort(),this.uri=serverInfo.getURI(),this.header={},this.reqData={type:LineConfig.OS_NAME,version:LineConfig.APPLICATION_VERSION,region:region,carrier:mccmnc,time:(new Date).getTime()};var body=_.map(_.pairs(this.reqData),function(pair){return[pair[0],"=",pair[1]].join("")}).join("&");this.setPrepareXHR(body)};ConnectionInfoHttpClient.prototype={setPrepareXHR:function(data){var url="http://"+this.getHost()+":"+this.getPort()+this.getURI();data.length>0&&(url+="?"+data),url+="&carrier=45005",url+="&key="+this.makeKey();var method=this.xhr.getMethod();this.xhrInstance.open(method,url,!1)},getXHRObj:function(){return this.xhrInstance},setHeader:function(name,value){this.header[name]=value,this.xhrInstance.setRequestHeader(name,value)},getHost:function(){return this.host},getPort:function(){return this.port},getURI:function(){return this.uri},makeKey:function(){for(var arpskList=this.psk.split(" "),data=[],stream=[],i=0;i<arpskList.length;i++)data[i]=parseInt(arpskList[i],16);stream.push(this.reqData.type),stream.push(this.reqData.version),stream.push(this.reqData.region),stream.push(this.reqData.time),stream.push(this.reqData.carrier),stream.push(hex2String(this.psk.split(" ").join("")));var hash=calcMD5(stream.join(""));return hash}};var HttpClient=function(xhr,serverInfo,async){this.xhr=xhr,this.xhrInstance=this.xhr.getXHRObj(),this.host=serverInfo.getHost(),this.port=serverInfo.getPort(),this.uri=serverInfo.getURI(),this.header={},this.body="",this.setPrepareXHR(async)};HttpClient.prototype={setPrepareXHR:function(async){var url="http://"+this.getHost()+":"+this.getPort()+this.getURI(),method=this.xhr.getMethod();this.xhrInstance.open(method,url,async?!0:!1)},getXHRObj:function(){return this.xhrInstance},setHeader:function(name,value){this.header[name]=value,this.xhrInstance.setRequestHeader(name,value)},getHost:function(){return this.host},getPort:function(){return this.port},getURI:function(){return this.uri}};var HttpClientFactory=function(){};HttpClientFactory.createConnectionInfoHttpClient=function(authToken,region,mccmnc){var serverInfo=ServerInfo.getInstance();serverInfo.setting("connectionInfo");var httpClient=new ConnectionInfoHttpClient(new XHR("GET"),region,mccmnc,serverInfo);return httpClient=new LineHeaderHttpClient(httpClient,authToken),httpClient=new ThriftHeaderHttpClient(httpClient)},HttpClientFactory.createWarmupHttpClient=function(authToken){var serverInfo=ServerInfo.getInstance();serverInfo.setting("warmup");var httpClient=new HttpClient(new XHR("GET"),serverInfo);return httpClient=new LineHeaderHttpClient(httpClient,authToken),httpClient=new ThriftHeaderHttpClient(httpClient)},HttpClientFactory.createNoAuthThriftHttpClient=function(){var serverInfo=ServerInfo.getInstance();serverInfo.setting("noAuth");var httpClient=new HttpClient(new XHR("POST"),serverInfo);return httpClient=new LineHeaderHttpClient(httpClient),httpClient=new ThriftHeaderHttpClient(httpClient)},HttpClientFactory.createThriftHttpClient=function(authToken){var serverInfo=ServerInfo.getInstance();serverInfo.setting("thrift");var httpClient=new HttpClient(new XHR("POST"),serverInfo);return httpClient=new LineHeaderHttpClient(httpClient,authToken),httpClient=new ThriftHeaderHttpClient(httpClient)},HttpClientFactory.createAsyncThriftHttpClient=function(authToken){var serverInfo=ServerInfo.getInstance();serverInfo.setting("thrift");var httpClient=new HttpClient(new XHR("POST"),serverInfo,!0);return httpClient=new LineHeaderHttpClient(httpClient,authToken),httpClient=new ThriftHeaderHttpClient(httpClient)},HttpClientFactory.createLongPollingHttpClient=function(authToken,timeout){var serverInfo=ServerInfo.getInstance();serverInfo.setting("longPolling");var httpClient=new HttpClient(new XHR("POST"),serverInfo);return httpClient=new LongPollingHeaderHttpClient(httpClient,timeout),httpClient=new LineHeaderHttpClient(httpClient,authToken),httpClient=new ThriftHeaderHttpClient(httpClient)},HttpClientFactory.createGCDNOBSHttpClient=function(){var serverInfo=ServerInfo.getInstance();serverInfo.setting("gCdnObs");var httpClient=new HttpClient(new XHR("POST"),serverInfo);return httpClient=new LineHeaderHttpClient(httpClient),httpClient=new OBSHeaderHttpClient(httpClient)},HttpClientFactory.getDefaultOBSHttpClient=function(serverInfo,authToken){var httpClient=new HttpClient(new XHR("POST"),serverInfo,!0);return httpClient=new LineHeaderHttpClient(httpClient,authToken),httpClient=new OBSUploadHeaderHttpClient(httpClient)},HttpClientFactory.createOBSProfileUploadHttpClient=function(authToken){var serverInfo=ServerInfo.getInstance();return serverInfo.setting("originObsProfile"),HttpClientFactory.getDefaultOBSHttpClient(serverInfo,authToken)},HttpClientFactory.createOBSGroupProfileUploadHttpClient=function(authToken){var serverInfo=ServerInfo.getInstance();return serverInfo.setting("originObsGroupProfile"),HttpClientFactory.getDefaultOBSHttpClient(serverInfo,authToken)},HttpClientFactory.createOBSChatImageUploadHttpClient=function(authToken){var serverInfo=ServerInfo.getInstance();return serverInfo.setting("originObsChatImage"),HttpClientFactory.getDefaultOBSHttpClient(serverInfo,authToken)},HttpClientFactory.createOBSChatImageDownloadHttpClient=function(authToken,params){var serverInfo=ServerInfo.getInstance();serverInfo.setting("originObsDownloadChat"),serverInfo.setQueryString(params);var httpClient=new HttpClient(new XHR("GET"),serverInfo,!0);return httpClient=new LineHeaderHttpClient(httpClient,authToken),httpClient=new OBSUploadHeaderHttpClient(httpClient)},HttpClientFactory.createOBSChatObjectInfoHttpClient=function(authToken){var serverInfo=ServerInfo.getInstance();serverInfo.setting("originObsObjectInfoChat");var httpClient=new HttpClient(new XHR("POST"),serverInfo,!0);return httpClient=new LineHeaderHttpClient(httpClient,authToken),httpClient=new OBSUploadHeaderHttpClient(httpClient)},HttpClientFactory.createOBSGroupProfileObjectInfoHttpClient=function(authToken){var serverInfo=ServerInfo.getInstance();serverInfo.setting("originObsObjectInfoGroupProfile");var httpClient=new HttpClient(new XHR("POST"),serverInfo,!0);return httpClient=new LineHeaderHttpClient(httpClient,authToken),httpClient=new OBSUploadHeaderHttpClient(httpClient)};var KeepAliveHttpClient=function(http){return http.setHeader("Connection","Keep-Alive"),http},LineHeaderHttpClient=function(httpClient,acToken){this.httpClient=httpClient;var lineConfig=LineConfig.getInstance();return this.setLineApplicationHeader(lineConfig.getApplicationCode(),LineConfig.APPLICATION_VERSION,LineConfig.OS_NAME,LineConfig.OS_VERSION),acToken&&this.setLineAccessTokenHeader(acToken),this.httpClient};LineHeaderHttpClient.prototype={setUserAgentHeader:function(){this.httpClient.setHeader("User-Agent","LF/100")},setLineApplicationHeader:function(applicationCode,appVersion,osName,osVersion){this.httpClient.setHeader("X-Line-Application",applicationCode+"	"+appVersion+"	"+osName+"	"+osVersion)},setLineAccessTokenHeader:function(authToken){this.httpClient.setHeader("X-Line-Access",this.generateAccessToken(authToken))},generateAccessToken:function(authToken){var result=[],timeStamp=parseInt((new Date).getTime()/1e3,10),splitedAuthKey=authToken.split(":");result.push(splitedAuthKey[0]);var strClaim="iat: "+timeStamp+"\n",strEncodedClaim=Base64.encode(strClaim);strEncodedClaim=strEncodedClaim.trim();var strCryptoInput=strEncodedClaim+".",strEncodedSecretKey=splitedAuthKey[1],strDecodedSecretKey=CryptoJS.enc.Base64.parse(strEncodedSecretKey),hashStream=CryptoJS.HmacSHA1(strCryptoInput,strDecodedSecretKey),strEncodedCrypto=CryptoJS.enc.Base64.stringify(hashStream),ywt=[strCryptoInput,".",strEncodedCrypto];return result.push(":"),result.push(ywt.join("")),result.join("")}};var LongPollingHeaderHttpClient=function(httpClient,timeout){return this.httpClient=httpClient,this.httpClient.setHeader("X-LST",timeout),this.httpClient},OBSHeaderHttpClient=function(httpClient){this.httpClient=httpClient;var authToken=AuthInfoKeeper.getInstance().getAuthToken();return this.setLineAccessTokenHeader(authToken),this.setLineApplicationHeader(LineConfig.getInstance().getApplicationCode(),LineConfig.APPLICATION_VERSION,LineConfig.OS_NAME,LineConfig.OS_VERSION),this.httpClient};OBSHeaderHttpClient.prototype={setLineApplicationHeader:function(applicationCode,appVersion,osName,osVersion){this.httpClient.setHeader("x-line-application",applicationCode+"	"+appVersion+"	"+osName+"	"+osVersion)},setLineAccessTokenHeader:function(authToken){this.httpClient.setHeader("x-line-access",this.generateAccessToken(authToken))},generateAccessToken:function(authToken){var result=[],timeStamp=parseInt((new Date).getTime()/1e3,10),splitedAuthKey=authToken.split(":");result.push(splitedAuthKey[0]);var strClaim="iat: "+timeStamp+"\n",strEncodedClaim=Base64.encode(strClaim);strEncodedClaim=strEncodedClaim.trim();var strCryptoInput=strEncodedClaim+".",strEncodedSecretKey=splitedAuthKey[1],strDecodedSecretKey=CryptoJS.enc.Base64.parse(strEncodedSecretKey),hashStream=CryptoJS.HmacSHA1(strCryptoInput,strDecodedSecretKey),strEncodedCrypto=CryptoJS.enc.Base64.stringify(hashStream),ywt=[strCryptoInput,".",strEncodedCrypto];return result.push(":"),result.push(ywt.join("")),result.join("")}};var OBSUploadHeaderHttpClient=function(httpClient){return this.httpClient=httpClient,this.setCrossDomainHeader(),this.httpClient};OBSUploadHeaderHttpClient.prototype={setCrossDomainHeader:function(){this.httpClient.setHeader("Access-Control-Allow-Origin","*")}};var ThriftHeaderHttpClient=function(httpClient){return this.httpClient=httpClient,this.httpClient.setHeader("Content-Type","application/x-thrift"),this.httpClient.setHeader("Accept","application/x-thrift"),this.httpClient},TalkClientFactory=function(){return null!=TalkClientFactory.instance?TalkClientFactory.instance:void 0};TalkClientFactory.prototype={createConnectionInfoClient:function(authToken,region,mccmnc){return HttpClientFactory.createConnectionInfoHttpClient(authToken,region,mccmnc)},createNoAuthClient:function(){var httpClient=HttpClientFactory.createNoAuthThriftHttpClient(),transport=new Thrift.Transport(httpClient,ServerInfo.noAuthURI),protocol=new Thrift.Protocol(transport);return new TalkServiceClient(protocol)},createAuthClient:function(authToken){var httpClient=HttpClientFactory.createThriftHttpClient(authToken),transport=new Thrift.Transport(httpClient,ServerInfo.authURI),protocol=new Thrift.Protocol(transport);return new TalkServiceClient(protocol)},createAsyncAuthClient:function(authToken){var httpClient=HttpClientFactory.createAsyncThriftHttpClient(authToken),transport=new Thrift.Transport(httpClient,ServerInfo.authURI),protocol=new Thrift.Protocol(transport);return new TalkServiceClient(protocol)},createLongPollingClient:function(authToken,timeout){var httpClient=HttpClientFactory.createLongPollingHttpClient(authToken,timeout),transport=new Thrift.Transport(httpClient,ServerInfo.longPollingURI),protocol=new Thrift.Protocol(transport);return new TalkServiceClient(protocol)},createWarmUpClient:function(authToken){return HttpClientFactory.createWarmupHttpClient(authToken)}},TalkClientFactory.getInstance=function(){return null==TalkClientFactory.instance&&(TalkClientFactory.instance=new TalkClientFactory),TalkClientFactory.instance},TalkClientFactory.instance=null;var AutoResenderProxy=function(){return null!=AutoResenderProxy.instance?AutoResenderProxy.instance:(this.timeLimit=null,this.isRunState=!1,this.chatDao=ChatDAO.getInstance(),void this.setConnectionInfo())};AutoResenderProxy.prototype={setConnectionInfo:function(){var connectionInfos=JSON.parse(PersistentStore.getInstance().get("CI_settings"));if(1==!!connectionInfos){var connectionInfo=connectionInfos[0];this.timeLimit=1e3*Number(connectionInfo.auto_resend_time_limit)}else this.timeLimit=LineConfig.AUTO_RESEND_INTERVAL},enforceResend:function(){this.checker()},checker:function(){1!=this.isRunState&&(this.isRunState=!0,this.chatDao.getSendingMessageAllList(this.timeLimit,this.resend.bind(this)))},resend:function(msgBoList,failMsgBoList){if(failMsgBoList.length>0)for(var i=0;i<failMsgBoList.length;i++){var messageBo=failMsgBoList[i];ChatProxy.getInstance().updateErrorMessage(messageBo.localId,{code:ErrorCode.SYSTEM_ERROR})}if("online"==NetworkChecker.getInstance().getState()){var currentTime=(new Date).getTime();if(msgBoList.length>0)for(var j=0;j<msgBoList.length;j++){var messageBo=msgBoList[j];currentTime-messageBo.message.createdTime>6e4&&ChatProxy.getInstance().resendMessage(messageBo)}}this.isRunState=!1}},AutoResenderProxy.getInstance=function(){return null==AutoResenderProxy.instance&&(AutoResenderProxy.instance=new AutoResenderProxy),AutoResenderProxy.instance},AutoResenderProxy.instance=null;var ChatEditListUI=function(){return null!=ChatEditListUI.instance?ChatEditListUI.instance:(_.extend(this,UIStructure),this.setStructureTemplate(),this.assign(),this.setEvent(),void this.resize())};ChatEditListUI.prototype={assign:function(){this.chatProxy=ChatProxy.getInstance(),this.elChatEditList=$("#_wrap_chat_edit_list"),this.elChateEditListScrollBody=this.elChatEditList.children(".MdScroll01"),this.elChatEditListUL=$("#_chat_edit_list_body"),this.elActionBtn=$("._chat_edit_list_acbar_btn"),this.elActionBtnCount=$("._checked_count"),this.checkedChatIds=[]},setEvent:function(){LineMain.getInstance().getEventManager().regist($.proxy(this.changeScreen,this)),this.setUIEvent()},setUIEvent:function(){this.elActionBtn.off(this.EVENT_CLICK).on(this.EVENT_CLICK,$.proxy(this.onClickActBtn,this)),this.elChatEditListUL.off(this.EVENT_CLICK,"li").on(this.EVENT_CLICK,"li",$.proxy(this.onClickCheckbox,this))},setStructureTemplate:function(){var template=TemplateManager.getInstance().get(ChatEditListUI.CHAT_EDIT_LIST_STRUCTURE_TEMPLATE);$("#_wrap_chat_edit_list").html(template)},showChatList:function(){this.initScreenStatus();var chatListData=this.chatProxy.getOnlyChatList(),tmp=[];0==chatListData.length||(_.each(chatListData,$.proxy(function(chatBo){var chatBo=this.chatProxy.isExistChat(chatBo.chatId),msgBo=this.chatProxy.getLastMessageByChatId(chatBo.chatId),tmpl=TemplateManager.getInstance().get(ChatEditListUI.CHAT_EDIT_LIST_ITEM_TEMPLATE),chatInfo=null;if(null!=chatBo)if(chatBo.midType==MIDType.USER){var userLI=ChatListUI.getInstance().updateChatUserItem(chatBo,msgBo,0,tmpl);tmp.push(userLI)}else if(chatBo.midType==MIDType.ROOM){chatInfo=chatBo.roomInfo;var roomLI=ChatListUI.getInstance().updateChatRoomItem(chatBo,msgBo,0,tmpl);tmp.push(roomLI)}else if(chatBo.midType==MIDType.GROUP){chatInfo=chatBo.groupInfo;var groupLI=ChatListUI.getInstance().updateChatGroupItem(chatBo,msgBo,0,tmpl);tmp.push(groupLI)}},this)),this.elChatEditListUL.html(tmp.join("")))},onClickCheckbox:function(e){if(!e.currentTarget)return!1;if(20==this.checkedChatIds.length)return void alert($.i18n.prop("MAX_COUNT_FOR_DELETE"));var currentTarget=$(e.currentTarget),checkbox=currentTarget.find("input[type=checkbox]");checkbox.prop("checked")?(checkbox.prop("checked",!1),checkbox.parent().removeClass("ExSelected"),this.checkedChatIds=_.without(this.checkedChatIds,checkbox.val())):(checkbox.prop("checked",!0),checkbox.parent().addClass("ExSelected"),this.checkedChatIds.push(checkbox.val())),this.updateCheckedBox(),this.updateBtnActivate()},onClickActBtn:function(e){return e.currentTarget?void(0!=this.checkedChatIds.length&&confirm($.i18n.prop("WILL_YOU_CLEAR_CHAT_HISTORY"))&&(this.chatProxy.deleteChat(this.checkedChatIds,EventManager.EMPTY),this.initScreenStatus(),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_LIST}))):!1},initScreenStatus:function(){this.checkedChatIds.length=0,this.elChatEditListUL.html(""),this.updateBtnActivate()},updateCheckedBox:function(){this.checkedChatIds=_.uniq(this.checkedChatIds)},updateBtnActivate:function(){var checkedCount=this.checkedChatIds.length;checkedCount>0?this.elActionBtnCount.html(checkedCount).addClass("MdIcoNum02").parent().removeClass("ExDisabled"):this.elActionBtnCount.html("").removeClass("MdIcoNum02").parent().addClass("ExDisabled")},resize:function(){var windowHeight=LineMain.WINDOW_HEIGHT,scrollAreaHeight=windowHeight-LineMain.HEADER_SIZE-LineMain.BUTTON_GROUP_SIZE;this.elChateEditListScrollBody.height(scrollAreaHeight)},changeScreen:function(options){if(options&&options.type===UIEventManager.EVENT_RESIZE)return this.resize(),!1;var screen_info=LineMain.getInstance().getScreenInfo();screen_info.subScreen===LineMain.SUB_SCREEN_TYPE.CHAT_LIST_EDIT?(this.elChatEditList.removeClass("MdNonDisp"),this.changeChatListHeader(),this.showChatList()):this.elChatEditList.addClass("MdNonDisp")},changeChatListHeader:function(){var headerView=HeaderView.getInstance();headerView.set({close:!0}).setTitle($.i18n.prop("EDIT_CHATS_LIST_TITLE")).show(),MenuView.getInstance().set(LineMain.getInstance().getScreenInfo()).hide()}},ChatEditListUI.getInstance=function(){return null==ChatEditListUI.instance&&(ChatEditListUI.instance=new ChatEditListUI),ChatEditListUI.instance},ChatEditListUI.instance=null,ChatEditListUI.CHAT_EDIT_LIST_ITEM_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatEditListItemTemplate.mustache",ChatEditListUI.CHAT_EDIT_LIST_STRUCTURE_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatEditListStructureTemplate.mustache";var ChatListUI=function(){return null!=ChatListUI.instance?ChatListUI.instance:(_.extend(this,UIStructure),this.setStructureTemplate(),this.assign(),this.setEvent(),void this.setEmptyScreenPosition())};ChatListUI.prototype={assign:function(){this.chatProxy=ChatProxy.getInstance(),this.elChatList=$("#_wrap_chat_list"),this.elChatEmptySection=this.elChatList.find("._empty_list_section"),this.elChatListSection=this.elChatList.find("._chat_list_section"),this.elChatListUL=this.elChatListSection.find("#_chat_list_body"),this.elGroupListSection=this.elChatList.find("._group_list_section"),this.elGroupListUL=this.elGroupListSection.find("#_group_list_body"),this.elUnreadMsgBadgeCount=$("#_unread_message_badge_count"),this.elChatStart=$("._chat_list_start_chat")},setEvent:function(){LineMain.getInstance().getEventManager().regist($.proxy(this.changeScreen,this)),this.setUIEvent()},setUIEvent:function(){this.elChatEmptySection.on(this.EVENT_CLICK,"a._chat_list_start_chat",$.proxy(this.onClickStartChat,this)),this.elChatListUL.off(this.EVENT_CLICK,"li"),this.elChatListUL.on(this.EVENT_CLICK,"li",$.proxy(this.onClickChat,this))},setStructureTemplate:function(){var template=TemplateManager.getInstance().get(ChatListUI.CHAT_LIST_STRUCTURE_TEMPLATE);
$("#_wrap_chat_list").html(template)},setUIEventForGroupSection:function(){this.elGroupListUL.off(this.EVENT_CLICK,"li"),this.elGroupListUL.on(this.EVENT_CLICK,"li",$.proxy(this.onClickGroup,this))},updateUnreadMsgCount:function(count){this.elUnreadMsgBadgeCount.text(0==count?"":count>999?"999+":count)},updateChatList:function(){var screen_info=LineMain.getInstance().getScreenInfo();if(screen_info.subScreen===LineMain.SUB_SCREEN_TYPE.CHAT_LIST){var chatListData=this.chatProxy.getChatAllList();0==chatListData.length?this.showEmptyChatList():(this.elChatEmptySection.addClass("MdNonDisp"),this.showGroupList(this.chatProxy.getOnlyInvitedGroupList()),this.showChatList()),0===this.chatProxy.getOnlyChatList().length?(this.elChatListSection.addClass("MdNonDisp"),HeaderView.getInstance().update({choose_friends:!0,edit_chat_list:!1})):HeaderView.getInstance().update({choose_friends:!0,edit_chat_list:!0})}},forceUpdateChatList:function(){var chatListData=this.chatProxy.getChatAllList();0==chatListData.length?this.showEmptyChatList():(this.elChatEmptySection.addClass("MdNonDisp"),this.showGroupList(this.chatProxy.getOnlyInvitedGroupList()),this.showChatList()),0===this.chatProxy.getOnlyChatList().length?(this.elChatListSection.addClass("MdNonDisp"),HeaderView.getInstance().update({choose_friends:!0,edit_chat_list:!1})):HeaderView.getInstance().update({choose_friends:!0,edit_chat_list:!0})},showEmptyChatList:function(){this.elChatListSection.addClass("MdNonDisp"),this.elGroupListSection.addClass("MdNonDisp"),this.elChatEmptySection.removeClass("MdNonDisp")},showGroupList:function(chatListData){var tmp=[];if(0==chatListData.length)return this.elGroupListSection.addClass("MdNonDisp"),void this.elGroupListUL.html("");this.elGroupListSection.removeClass("MdNonDisp"),this.setUIEventForGroupSection();var i=0;_.each(chatListData,$.proxy(function(chatBo){var chatBo=this.chatProxy.isExistChat(chatBo.chatId),msgBo=this.chatProxy.getLastMessageByChatId(chatBo.chatId),tmpl=TemplateManager.getInstance().get(ChatListUI.CHAT_LIST_ITEM_TEMPLATE);if(null!=chatBo&&chatBo.midType==MIDType.GROUP&&!chatBo.isJoinedChat()){chatBo.CT_is_first_list=!0;var groupLI=this.updateChatGroupItem(chatBo,msgBo,0,tmpl);tmp.push(groupLI)}i++},this)),this.elGroupListUL.html(tmp.join("")),Utility.lazyLoadImage(this.elGroupListUL.find("img"))},createChatListItemTmpl:function(item){var itemTmpl,tmpl=TemplateManager.getInstance().get(ChatListUI.CHAT_LIST_ITEM_TEMPLATE);if(item){var chatId=item.chatId,chatBo=this.chatProxy.isExistChat(chatId),msgBo=this.chatProxy.getLastMessageByChatId(chatId),unreadCount=this.chatProxy.getUnreadMessageCountByChatId(chatId);return null!=chatBo&&(chatBo.midType==MIDType.USER?itemTmpl=this.updateChatUserItem(chatBo,msgBo,unreadCount,tmpl):chatBo.midType==MIDType.ROOM?itemTmpl=this.updateChatRoomItem(chatBo,msgBo,unreadCount,tmpl):chatBo.midType==MIDType.GROUP&&chatBo.isJoinedChat()&&(itemTmpl=this.updateChatGroupItem(chatBo,msgBo,unreadCount,tmpl))),itemTmpl?itemTmpl:Mustache.render(tmpl,{})}return Mustache.render(tmpl,{})},showChatList:function(){this.elChatListSection.removeClass("MdNonDisp"),this.setUIEvent();for(var tmpList=[],chatList=ChatProxy.getInstance().getOnlyChatList(),i=0;i<chatList.length;i++)tmpList.push(this.createChatListItemTmpl(chatList[i]));this.elChatListUL.html(tmpList.join("")),Utility.lazyLoadImage(this.elChatListSection.find("img"))},updateChatUserItem:function(chatBo,msgBo,unreadCount,chatListItemTmpl){var contact=ContactProxy.getInstance().getContactFromLocal(chatBo.chatId),renderObj=chatBo;return renderObj.contactInfo=contact,renderObj.thumbnail=Utility.combineProfileURL(renderObj.contactInfo,LineConfig.LIST_THUMBNAIL_SIZE),renderObj.defaultThumbnail="/res/img/noimg/profile_img56x56.png",renderObj.dpName=contact.unregister?$.i18n.prop("NO_CHAT_MEMBER"):Utility.makeDisplayNameForUser(contact),1==!!msgBo&&msgBo.status==ChatMessageBO.STATUS.FAIL&&(renderObj.failure=!0),this.commonUpdateChatItem(chatBo,msgBo,unreadCount,chatListItemTmpl,renderObj)},updateChatRoomItem:function(chatBo,msgBo,unreadCount,chatListItemTmpl){var renderObj=chatBo;renderObj.thumbnail=Utility.roomProfileURL(),renderObj.defaultThumbnail="/res/img/noimg/room_img56x56.png",renderObj.memberCount=Utility.makeRoomMemeberCount(chatBo.roomInfo.contacts)+1,1==!!msgBo&&msgBo.status==ChatMessageBO.STATUS.FAIL&&(renderObj.failure=!0);var contactList=chatBo.roomInfo.contacts;return renderObj.dpName=Utility.makeDisplayNameForRoom(contactList),this.commonUpdateChatItem(chatBo,msgBo,unreadCount,chatListItemTmpl,renderObj)},updateChatGroupItem:function(chatBo,msgBo,unreadCount,tmpl){var chatListItemTmpl=tmpl,renderObj=chatBo;return 1==!!msgBo&&msgBo.status==ChatMessageBO.STATUS.FAIL&&(renderObj.failure=!0),renderObj.thumbnail=Utility.groupProfileURL(chatBo.groupInfo,56),renderObj.defaultThumbnail="/res/img/noimg/group_profile_img56x56.png",renderObj.dpName=Utility.makeDisplayNameForGroup(chatBo),renderObj.memberCount=renderObj.dpName!=$.i18n.prop("NO_MEMBER")?Utility.makeRoomMemeberCount(chatBo.groupInfo.members):1,0==chatBo.isJoinedChat()&&(renderObj.noJoin=!0),this.commonUpdateChatItem(chatBo,msgBo,unreadCount,chatListItemTmpl,renderObj)},commonUpdateChatItem:function(chatBo,msgBo,unreadCount,chatListItemTmpl,renderObj){unreadCount>0&&(renderObj.unreadCount=unreadCount),0==chatBo.notification&&(renderObj.notificationOff=!0),null!=msgBo&&(renderObj.lastMessage=msgBo.message.text,renderObj.date=DateFormatUtil.getInstance().getChatListDateFormat(msgBo.message.createdTime),msgBo.message.contentType!=ContentType.NONE?renderObj.lastMessage=this.makeLastMessageByType(msgBo):1==!!msgBo.message.location?renderObj.lastMessage=$.i18n.prop("NOT_SUPPORT_MESSAGE_FORMAT"):1==!!msgBo.message.contentMetadata&&"RECEIVER"==msgBo.message.contentMetadata.MESSAGE_TARGET&&(renderObj.lastMessage=$.i18n.prop("NOT_SUPPORT_MESSAGE_FORMAT")));var retLI=Mustache.render(chatListItemTmpl,renderObj);return renderObj=null,retLI},onClickChat:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),chatId=currentTarget.attr("data-chatId"),chatBo=this.chatProxy.getChatBoById(chatId);switch(chatBo.midType){case MIDType.USER:ChatProxy.getInstance().createChatUser(chatId,!0);break;case MIDType.ROOM:ChatProxy.getInstance().createChatRoom(chatId,null,!0);break;case MIDType.GROUP:ChatProxy.getInstance().createChatGroup(chatId,null,!0)}},onClickGroup:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),chatId=($(event.originalTarget||event.target),currentTarget.attr("data-chatId"));DimmedUI.getInstance().open("",{},{isCenter:!0}),GroupProxy.getInstance().getGroupT(chatId,function(group){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.GROUP,subScreen:LineMain.SUB_SCREEN_TYPE.GROUP_DETAIL},[group]),DimmedUI.getInstance().close()})},onClickStartChat:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_NEW})},updateBO:function(){this.syncUIFlag=!0;var screen_info=LineMain.getInstance().getScreenInfo();screen_info.subScreen===LineMain.SUB_SCREEN_TYPE.CHAT_LIST&&this.updateChatList()},makeLastMessageByType:function(messageBo){var contentType=messageBo.message.contentType,senderContact=ContactProxy.getInstance().getContactFromLocal(messageBo.message.from),text="";if(CommonMessageBO.isSupportedMessageType(contentType)){var myMid=AuthInfoKeeper.getInstance().getAuthMid(),isMine=myMid==messageBo.message.from||null==messageBo.message.from;if(isMine)switch(contentType){case ContentType.IMAGE:text=$.i18n.prop("SENT_PICTURE");break;case ContentType.STICKER:text=$.i18n.prop("SENT_STICKER")}else switch(contentType){case ContentType.IMAGE:text=$.i18n.prop("SENT_PICTURE_BYFRIEND",senderContact.printName);break;case ContentType.STICKER:text=$.i18n.prop("SENT_STICKER_BYFRIEND",senderContact.printName)}return text}return $.i18n.prop("NOT_SUPPORT_MESSAGE_FORMAT")},onChooseFriends:function(midList){FriendManagerUI.getInstance().close(),DimmedUI.getInstance().open("",{},{isCenter:!0});var size=midList.length;size>0&&(1==size?this.chatProxy.createChatUser(midList[0],!0):size>1&&this.chatProxy.createChatRoom(null,midList,!0))},onClickCreateGroup:function(midList){FriendManagerUI.getInstance().close(),GroupManagerUI.getInstance().setMemberMids(midList),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.GROUP_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.GROUP_MANAGER_NEW})},resize:function(){var windowHeight=LineMain.WINDOW_HEIGHT,scrollAreaHeight=windowHeight-LineMain.HEADER_SIZE-LineMain.MENU_BAR_SIZE;this.elChatList.find("#_chat_list_ui").height(scrollAreaHeight-1),Utility.lazyLoadImage(this.elChatListSection.find("img"))},setEmptyScreenPosition:function(){var windowHeight=LineMain.WINDOW_HEIGHT,scrollAreaHeight=windowHeight-LineMain.HEADER_SIZE-LineMain.MENU_BAR_SIZE,topSpaceHeight=scrollAreaHeight/2-LineConfig.HEIGHT_OF_EMPTY_CHAT_LIST/2;this.elChatEmptySection.css("padding-top",topSpaceHeight+"px")},changeScreen:function(options){return options&&options.type===UIEventManager.EVENT_RESIZE?(this.resize(),!1):(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.CHAT_LIST)?(this.elChatList.removeClass("MdNonDisp"),this.changeChatListHeader(),this.updateChatList(),ChatProxy.getInstance().updateUnreadMsgCount(),this.resize()):this.elChatList.addClass("MdNonDisp"),void(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_NEW)&&FriendManagerUI.getInstance().setEventBind({new_chat:$.proxy(this.onChooseFriends,this),create_group:$.proxy(this.onClickCreateGroup,this)})))},changeChatListHeader:function(){var chatListSize=ChatProxy.getInstance().getChatAllList().length,headerView=HeaderView.getInstance();headerView.set({choose_friends:!0,edit_chat_list:chatListSize>0}).setTitle($.i18n.prop("TAP_NAME_CHATS")).show(),MenuView.getInstance().set(LineMain.getInstance().getScreenInfo()).show()}},ChatListUI.getInstance=function(){return null==ChatListUI.instance&&(ChatListUI.instance=new ChatListUI),ChatListUI.instance},ChatListUI.instance=null,ChatListUI.CHAT_LIST_STRUCTURE_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatListStructureTemplate.mustache",ChatListUI.CHAT_LIST_SECTION_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatListSectionTemplate.mustache",ChatListUI.GROUP_LIST_SECTION_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatGroupListSectionTemplate.mustache",ChatListUI.CHAT_LIST_ITEM_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatListItemTemplate.mustache";var ChatProxy=function(){return null!=ChatProxy.instance?ChatProxy.instance:(this.chatListBo=ChatListBO.getInstance(),this.chatDao=ChatDAO.getInstance(),this.chatMsgBo=ChatMessageBO.getInstance(),this.chatSettingBo=ChatSettingBO.getInstance(),this.currentChatBo=null,this.eventManager=new EventManager,this.requestBlockSize=1,this.requestPageSize=20,this.msgStackCountList={},this.processCreatUser=!1,this.processCreatRoom=!1,this.callActionCount=0,this.resendingMsgLocalIdList=[],this.sendMsgStartTimeList=[],this.sendMsgEndTimeList=[],this.uploadStartTimeList=[],this.uploadEndTimeList=[],this.prepareChatData(),ContactProxy.getInstance().getEventManager().regist(this.updateContact.bind(this)),this.onOfflineCallback=function(){},void window.addEventListener("offline",$.proxy(this.onOffline,this)))};ChatProxy.prototype={getEventManager:function(){return this.eventManager},prepareChatData:function(){this.chatListBo.clear(),this.prepareChatList(LineMain.initUI),this.prepareUnreadMessageList(EventManager.EMPTY),this.prepareLastMessageList(EventManager.EMPTY)},prepareChatList:function(onSuccess){this.chatDao.getChatAllList(function(){LineMain.isChatDataOk=!0,onSuccess()}.bind(this))},prepareUnreadMessageList:function(){this.chatDao.getUnreadMessageAllList(function(){setTimeout(function(){this.updateUnreadMsgCount()}.bind(this),500)}.bind(this))},prepareLastMessageList:function(onSuccess){this.chatDao.getLastMessageAllList(function(){this.chatListBo.sortLastMessageList(),onSuccess()}.bind(this))},updateUnreadMsgCount:function(){ChatListUI.getInstance().updateUnreadMsgCount(this.getUnreadMessageListSize())},getProcessCreatRoomState:function(){return this.processCreatRoom},setProcessCreatRoomState:function(flag){this.processCreatRoom=flag},getProcessCreatUserState:function(){return this.processCreatUser},setProcessCreatUserState:function(flag){this.processCreatUser=flag},createChatByReceiveMessage:function(messageBo,onSuccess){var midType=messageBo.message.toType,chatId=messageBo.chatId,contact=ContactProxy.getInstance().getContactFromLocal(chatId);if(midType==MIDType.USER)if(1==!!contact&&contact.status!=ContactStatus.FRIEND){if(1==this.getProcessCreatUserState())return;this.setProcessCreatUserState(!0),this.insertSystemMessage(midType,chatId,SystemMessageBO.TYPE.ADD_BLOCK_ALERT,null,function(){this.createChatUser(chatId,!1,messageBo.localId,onSuccess)}.bind(this))}else this.createChatUser(chatId,!1,messageBo.localId,onSuccess)},createChatByInvitedGroup:function(chatId,groupInfo,inviterMid){if(null==groupInfo.creator){var inviterContact=ContactProxy.getInstance().getContactFromLocal(inviterMid);groupInfo.creator=inviterContact}this.createChatGroup(chatId,groupInfo,!1,inviterMid),this.updateUnreadMsgCount(),ChatListUI.getInstance().updateChatList();var chatBo=this.getChatBoById(chatId),senderContact=ContactProxy.getInstance().getContactFromLocal(inviterMid),notiText=chatBo.groupInfo.name;LinePushNotification.showNotification("inviteIntoGroup",senderContact.printName,notiText)},removeChat:function(chatId){this.chatListBo.removeChat(chatId)},createChatUser:function(chatId,isShowPage,localId,onSuccess){var chatBo=this.chatListBo.isExistChat(chatId);if(null==chatBo&&(chatBo=this.makeChatUserBo(chatId,localId)),onSuccess instanceof Function&&onSuccess(chatBo),isShowPage&&1==isShowPage){var contactInfo=ContactProxy.getInstance().getContactFromLocal(chatBo.chatId);null!=contactInfo&&null==chatBo.contactInfo&&chatBo.setContactInfo(contactInfo),this.updateChatBo(Utility.serialize(chatBo)),this.setCurrentChatBo(chatBo),this.chatListBo.removeUnreadMessageBoList(chatId),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_ROOM})}else ChatListUI.getInstance().updateChatList()},makeChatUserBo:function(chatId,localId){var chatBo=new ChatBO(MIDType.USER,chatId);1==!!localId&&(chatBo.firstMsgLocalId=localId,chatBo.lastMessageTime=(new Date).getTime());var contactInfo=ContactProxy.getInstance().getContactFromLocal(chatBo.chatId);return null!=contactInfo&&chatBo.setContactInfo(contactInfo),this.saveChatBo(chatBo.serialize()),this.setProcessCreatUserState(!1),chatBo},createChatRoom:function(chatId,contactIds,isShowPage,desktopFlag){var chatBo=null;null!=chatId&&(chatBo=this.chatListBo.isExistChat(chatId)),null==chatBo?(this.setProcessCreatRoomState(!0),chatBo=new ChatBO(MIDType.ROOM,chatId),1==!!desktopFlag&&"desktop"==desktopFlag?this.chatListBo.getRoom(chatId,$.proxy(function(room){chatBo=this.makeChatRoomBo(chatBo,room,contactIds),this.saveChatBo(chatBo.serialize(),function(){ChatListUI.getInstance().updateChatList(),isShowPage&&1==isShowPage&&(this.setProcessCreatRoomState(!1),this.setCurrentChatBo(chatBo),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_ROOM}))}.bind(this))},this)):this.chatListBo.createChatRoom(contactIds,$.proxy(function(room){chatBo=this.makeChatRoomBo(chatBo,room,contactIds),this.saveChatBo(chatBo.serialize(),function(){isShowPage&&1==isShowPage&&(this.setProcessCreatRoomState(!1),this.setCurrentChatBo(chatBo),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_ROOM}))}.bind(this))},this))):(this.updateChatBo(Utility.serialize(chatBo)),isShowPage&&1==isShowPage?(this.setCurrentChatBo(chatBo),this.chatListBo.removeUnreadMessageBoList(chatId),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_ROOM})):ChatListUI.getInstance().updateChatList())},makeChatRoomBo:function(chatBo,room,contactIds){chatBo.setRoomInfo(room),chatBo.chatId=room.mid;for(var contactList=[],i=0;i<contactIds.length;i++)contactList.push(ContactProxy.getInstance().getContactFromLocal(contactIds[i]));var messageBo=this.insertSystemMessage(MIDType.ROOM,chatBo.chatId,SystemMessageBO.TYPE.INIT_CHAT_ROOM_MESSAGE,{dpNames:Utility.makeDisplayNameForRoom(contactList)},EventManager.EMPTY);return chatBo.lastMessageTime=messageBo.message.createdTime,chatBo.firstMsgLocalId=messageBo.localId,chatBo},createChatRoomByInvitedRoom:function(chatId,roomInfo,inviterMid,inviteeMid){var chatBo=null;if(chatId&&(chatBo=this.chatListBo.isExistChat(chatId)),null==chatBo){chatBo=new ChatBO(MIDType.ROOM,chatId),chatBo.setRoomInfo(roomInfo);var myMid=AuthInfoKeeper.getInstance().getAuthMid(),inviteeList=[];_.each(roomInfo.contacts,function(contact){contact.mid!=inviterMid&&inviteeList.push(contact)});var inviterContact=ContactProxy.getInstance().getContactFromLocal(inviterMid),inviterDpName=Utility.makeDisplayNameForUser(inviterContact),inviteeDpNames=Utility.makeDisplayNameForRoom(inviteeList),messageBo=this.insertSystemMessage(MIDType.ROOM,chatBo.chatId,SystemMessageBO.TYPE.INVITE_INTO_ROOM_TO_ME,{inviterDpName:inviterDpName,inviteeDpNames:inviteeDpNames},EventManager.EMPTY);chatBo.lastMessageTime=messageBo.message.createdTime,chatBo.firstMsgLocalId=messageBo.localId,inviteeMid=_.filter(inviteeMid,function(mid){return mid!=myMid}),_.each(roomInfo.contacts,function(contact){ContactProxy.getInstance().addContact(contact)}),this.saveChatBo(chatBo.serialize(),function(){ChatListUI.getInstance().updateChatList()})}},createChatGroup:function(chatId,groupInfo,isShowPage,inviterMid){var chatBo=this.chatListBo.isExistChat(chatId);null==chatBo&&(chatBo=new ChatBO(MIDType.GROUP,chatId)),inviterMid||(inviterMid=AuthInfoKeeper.getInstance().getAuthMid()),chatBo.inviter=ContactProxy.getInstance().getContactFromLocal(inviterMid),chatBo.isClearChat=!1,groupInfo?(chatBo.updateTimestamp((new Date).getTime()),chatBo.setGroupInfo(groupInfo),1==!!chatBo.isKickoutStatus&&0==!!groupInfo.kickout&&(chatBo.isKickoutStatus=!1),this.saveChatBo(chatBo.serialize(),EventManager.EMPTY),GroupProxy.getInstance().updateGroupList(chatBo.groupInfo)):this.updateChatBo(chatBo.serialize()),isShowPage&&1==isShowPage&&(this.setCurrentChatBo(chatBo),this.chatListBo.removeUnreadMessageBoList(chatId),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_ROOM}))},createChatGroup:function(chatId,groupInfo,isShowPage,inviterMid){var chatBo=this.chatListBo.isExistChat(chatId);null==chatBo&&(chatBo=new ChatBO(MIDType.GROUP,chatId)),inviterMid||(inviterMid=AuthInfoKeeper.getInstance().getAuthMid()),chatBo.inviter=ContactProxy.getInstance().getContactFromLocal(inviterMid),chatBo.isClearChat=!1,groupInfo?(chatBo.updateTimestamp((new Date).getTime()),chatBo.setGroupInfo(groupInfo),1==!!chatBo.isKickoutStatus&&0==!!groupInfo.kickout&&(chatBo.isKickoutStatus=!1),this.saveChatBo(chatBo.serialize(),EventManager.EMPTY),GroupProxy.getInstance().updateGroupList(chatBo.groupInfo)):this.updateChatBo(chatBo.serialize()),isShowPage&&1==isShowPage&&(this.setCurrentChatBo(chatBo),this.chatListBo.removeUnreadMessageBoList(chatId),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_ROOM}))},createChatGroupForOP:function(chatId,groupInfo){var chatBo=this.chatListBo.isExistChat(chatId);null==chatBo&&(chatBo=new ChatBO(MIDType.GROUP,chatId)),chatBo.isClearChat=!0,groupInfo&&(chatBo.updateTimestamp((new Date).getTime()),chatBo.setGroupInfo(groupInfo),1==!!chatBo.isKickoutStatus&&0==!!groupInfo.kickout&&(chatBo.isKickoutStatus=!1),this.saveChatBo(chatBo.serialize(),EventManager.EMPTY),GroupProxy.getInstance().updateGroupList(chatBo.groupInfo),ContactUI.getInstance().increaseContactBadgeCount())},updateChatGroup:function(chatId,groupInfo,attribute,adaptedChatId){if(0!=!!groupInfo){var chatBo=this.getChatBoById(chatId);if(chatBo.groupInfo=groupInfo,this.isExistChat(chatId)?this.updateChatBo(Utility.serialize(chatBo)):this.saveChatBo(Utility.serialize(chatBo),EventManager.EMPTY),"1"==attribute){var adaptorDpName=null;if(1==!!adaptedChatId){var contact=ContactProxy.getInstance().getContactFromLocal(adaptedChatId);adaptorDpName=contact.displayNameOverridden||contact.displayName}else adaptorDpName=AuthInfoKeeper.getInstance().getAuthMid();var messageBo=this.insertSystemMessage(chatBo.midType,chatId,SystemMessageBO.TYPE.CHANGE_GROUP_NAME,{dpName:adaptorDpName,groupName:groupInfo.name},EventManager.EMPTY);ChatUI.getInstance().paintSystemMessageUI(chatBo,messageBo,"live")}ChatListUI.getInstance().updateChatList(),ChatUI.getInstance().changeChatRoomHeader(chatId),GroupProxy.getInstance().updateGroupList(chatBo.groupInfo),this.getEventManager().broadCast(chatBo)}},inviteIntoRoom:function(chatId,contactIds,onSuccess){this.chatListBo.inviteIntoRoom(chatId,contactIds,onSuccess)},initCallCount:function(){this.callActionCount=0},increaseCallCount:function(){this.callActionCount++},isExistChat:function(chatId){return this.chatListBo.isExistChat(chatId)},deleteChat:function(chatIdList){this.initCallCount(),DimmedUI.getInstance().open("",{},{isCenter:!0});for(var totalCnt=chatIdList.length,i=0;totalCnt>i;i++)this.doDeleteChat(chatIdList[i],null,this.successfulDeleteChat.bind(this,totalCnt-1))},doDeleteChat:function(chatId,desktopFlag,onSuccess){var chatBo=this.getChatBoById(chatId);if(0==!!chatBo)return!1;var lastMessageBo=this.chatListBo.getLastMessageByChatId(chatId),lastMessageId=lastMessageBo?lastMessageBo.message.id:null;1==!!desktopFlag&&"desktop"==desktopFlag?(this.chatDao.deleteChat(chatId,function(){this.chatListBo.removeLocalDateForDeleteChat(chatId,chatBo.midType,"desktop"),ChatListUI.getInstance().updateChatList()}.bind(this)),this.chatDao.deleteMessageBo(chatId,EventManager.EMPTY),onSuccess()):this.chatListBo.deleteChat(chatId,lastMessageId,function(){chatBo.midType!=MIDType.GROUP?this.chatDao.deleteChat(chatId,EventManager.EMPTY):(chatBo.isClearChat=!0,this.updateChatBo(chatBo.serialize())),this.chatDao.deleteMessageBo(chatId,EventManager.EMPTY),onSuccess()}.bind(this))},successfulDeleteChat:function(total){total==this.callActionCount?(this.updateUnreadMsgCount(),ChatListUI.getInstance().updateChatList(),DimmedUI.getInstance().close(),this.initCallCount()):this.increaseCallCount()},leaveGroup:function(groupId,onSuccess){var chatBo=this.getChatBoById(groupId);if(0==!!chatBo)return!1;var lastMessageBo=this.chatListBo.getLastMessageByChatId(groupId),lastMessageId=lastMessageBo?lastMessageBo.message.id:null;this.chatDao.deleteChat(groupId,EventManager.EMPTY),this.chatListBo.leaveGroup(groupId,lastMessageId,onSuccess),this.chatDao.deleteMessageBo(groupId,EventManager.EMPTY);var groupInfo=_.clone(chatBo.groupInfo);GroupProxy.getInstance().updateGroupList(groupInfo),this.getEventManager().broadCast(chatBo),ChatListUI.getInstance().updateChatList()},saveChatBo:function(serializedBo,onSuccess){this.chatListBo.saveChat(serializedBo),this.chatDao.saveChat(serializedBo,onSuccess),this.getEventManager().broadCast(serializedBo)},updateChatBo:function(serializedBo){this.chatListBo.updateChat(serializedBo,!0),this.chatDao.updateChat(serializedBo),this.getEventManager().broadCast(serializedBo)},getCurrentChatBo:function(){return this.currentChatBo},setCurrentChatBo:function(chatBo){this.currentChatBo=chatBo},getLastMessageAllList:function(){return this.chatListBo.getLastMessageAllList()},getLastMessageByChatId:function(chatId){return this.chatListBo.getLastMessageByChatId(chatId)},deleteAlertMessage:function(chatId){this.chatDao.deleteAlertMessage(chatId)},getMessageBoByLocalId:function(localId,onSuccess){return this.chatDao.getMessageBoByLocalId(localId,onSuccess)},removeAll:function(){this.chatList=null,this.setCurrentChatBo(null),this.chatListBo.clear()},getChatBoById:function(chatId){return this.chatListBo.getChatBo(chatId)},getChatAllList:function(){return this.chatListBo.getChatAllList()},getOnlyInvitedGroupList:function(){for(var allList=this.getChatAllList(),retList=[],i=0;i<allList.length;i++){var chatBo=this.isExistChat(allList[i].chatId);chatBo.midType==MIDType.GROUP&&0==chatBo.isJoinedChat()&&retList.push(chatBo)}return retList},getOnlyChatList:function(){var allList=this.getChatAllList(),retList=[];return _.each(allList,function(chatBo){for(var compareList=this.getOnlyInvitedGroupList(),flag=!1,i=0;i<compareList.length;i++)chatBo.chatId==compareList[i].chatId&&(flag=!0);0==flag&&retList.push(chatBo)}.bind(this)),retList},getOnlyGroupChatList:function(){return this.chatListBo.getOnlyGroupChatList()},getChatRoomOptionList:function(chatBo,isFriend){return this.chatSettingBo.getChatRoomOptionList(chatBo,isFriend)},deleteAllChatHistory:function(){DimmedUI.getInstance().open("",{},{isCenter:!0});var chatList=this.chatListBo.getChatAllList();if(0==chatList.length)return void DimmedUI.getInstance().close();for(var i=0;i<chatList.length;i++){var chatBo=chatList[i],chatId=chatBo.chatId;chatBo.lastMessageTime=null,chatBo.firstMsgLocalId=null,this.updateChatBo(Utility.serialize(chatBo)),this.chatListBo.removeLastMessage(chatId),i==chatList.length-1?this.chatDao.deleteMessageBo(chatId,function(){this.chatListBo.initUnreadMessageListSize(),this.updateUnreadMsgCount(),DimmedUI.getInstance().close()}.bind(this)):this.chatDao.deleteMessageBo(chatId,EventManager.EMPTY)}},deleteAllChatHistoryByChatId:function(chatId){DimmedUI.getInstance().open("",{},{isCenter:!0});var chatBo=this.isExistChat(chatId);chatBo.lastMessageTime=null,chatBo.firstMsgLocalId=null,this.updateChatBo(Utility.serialize(chatBo)),this.chatListBo.removeLastMessage(chatId),this.setCurrentChatBo(chatBo),this.chatDao.deleteMessageBo(chatId,function(){ChatUI.getInstance().removeMessageArea(),DimmedUI.getInstance().close()})},checkChatScreenForVisibility:function(){if(null!=this.currentChatBo){var chatId=this.currentChatBo.chatId,lastMessageListBo=this.getUnreadMessageListByChatId(chatId);ChatUI.getInstance().setWarmup();try{var lastMessageBo=lastMessageListBo[lastMessageListBo.length-1];this.chatListBo.removeUnreadMessageBoList(chatId),ChatProxy.getInstance().sendChatChecked(chatId,lastMessageBo.message.id)}catch(e){}}},getRequestPageSize:function(){return this.requestPageSize},increaseMsgStackCount:function(chatId){this.msgStackCountList[chatId]=1==!!this.msgStackCountList[chatId]?Number(this.msgStackCountList[chatId])+1:1},getMsgStackCount:function(chatId){return this.msgStackCountList[chatId]||0},clearMsgStackCount:function(){this.msgStackCountList[this.currentChatBo.chatId]=0},resendMessage:function(messageBo){var localId=messageBo.localId,message=messageBo.message;this.chatDao.deleteMessageBoByLocalId(localId,function(){if(message.contentType==ContentType.NONE)this.sendMessage(message.text,message.to,localId);else if(message.contentType==ContentType.STICKER){var metadata=message.contentMetadata;this.sendSticker(metadata.STKPKGID,metadata.STKID,metadata.STKVER,message.to,localId)}else message.contentType==ContentType.IMAGE&&Utility.getArrayBufferByUrl(messageBo.imageUrl,$.proxy(function(arrayBuffer){arrayBuffer!==!1&&this.sendImage(arrayBuffer,message.to,localId)},this))}.bind(this))},sendMessage:function(textMsg,chatId,prevLocalId){var chatBo=this.currentChatBo;(null==chatBo||1==!!prevLocalId)&&(chatBo=this.getChatBoById(chatId));var messageBo=this.chatMsgBo.makeTextMessage(chatBo,textMsg);return this.doSendMessage(chatId,chatBo,messageBo,prevLocalId),messageBo},sendSticker:function(pkgId,stkId,stkVer,chatId,prevLocalId){var chatBo=this.currentChatBo;(null==chatBo||1==!!prevLocalId)&&(chatBo=this.getChatBoById(chatId));var messageBo=this.chatMsgBo.makeStickerMessage(chatBo,pkgId,stkId,stkVer);return this.doSendMessage(chatId,chatBo,messageBo,prevLocalId),messageBo},sendImage:function(imageArrayBuffer,chatId,prevLocalId){var chatBo=this.currentChatBo;(null==chatBo||1==!!prevLocalId)&&(chatBo=this.getChatBoById(chatId));var imgUrl=URL.createObjectURL(new Blob([imageArrayBuffer],{type:"image/jpeg"})),messageBo=this.chatMsgBo.makeImageMessage(chatBo,imgUrl);return this.doSendMessage(chatId,chatBo,messageBo,prevLocalId),messageBo},onOffline:function(){this.onOfflineCallback()},doSendMessage:function(chatId,chatBo,messageBo,prevLocalId){1==!!chatId&&(messageBo.message.to=chatId),1==!!prevLocalId&&(this.resendingMsgLocalIdList.push({prevLocalId:prevLocalId,localId:messageBo.localId}),this.processPrevMessageSending(messageBo.localId),ChatUI.getInstance().paintMessageUI(messageBo,"live"));var serializedData=Utility.serialize(messageBo);if(this.chatDao.saveMessage(serializedData),null==chatBo.firstMsgLocalId?chatBo.firstMsgLocalId=messageBo.localId:chatBo.firstMsgLocalId==prevLocalId&&(chatBo.firstMsgLocalId=messageBo.localId),messageBo.message.contentType===ContentType.IMAGE){var NETWORK_ERR=19;this.onOfflineCallback=function(){"online"!==NetworkChecker.getInstance().getState()&&this.checkUpdateSendMessage(messageBo.localId,messageBo.message)},"offline"===NetworkChecker.getInstance().getState()&&this.onOfflineCallback(),this.chatMsgBo.sendMessage(serializedData,$.proxy(function(result){result===NETWORK_ERR?(NetworkChecker.getInstance().setState("offline"),alert($.i18n.prop("NETWORK_ERROR_INFO")),this.checkUpdateSendMessage(messageBo.localId,messageBo.message)):this.checkUpdateSendMessage(arguments[0],arguments[1]),ChatUI.getInstance().downScroll()},this))}else Debugger.isDebugging()&&this.sendMsgStartTimeList.push({id:serializedData.localId,time:(new Date).getTime()}),this.chatMsgBo.sendMessage(serializedData,this.checkUpdateSendMessage.bind(this));this.increaseMsgStackCount(chatBo.chatId)},checkUpdateSendMessage:function(localId,message){if(1==!!message.code)message.code==ErrorCode.NOT_A_MEMBER&&this.updateErrorMessage(localId,message);else switch(Debugger.isDebugging()&&this.sendMsgEndTimeList.push({id:localId,time:(new Date).getTime()}),message.contentType){case ContentType.IMAGE:this.updateSendImageMessage(localId,message);break;default:this.updateSendMessage(localId,message)}},updateErrorMessage:function(localId,message){this.chatDao.getMessageBoByLocalIdForUpdate(localId,message,function(messageBo){LinePushNotification.showNotification(messageBo.message.contentType,null,$.i18n.prop("NOTIFICATION_MESSAGE_SENDFAILED")),this.saveSuccessfulLastMessage(messageBo,null),ChatUI.getInstance().paintUpdatedSendMessageUI(messageBo),ChatListUI.getInstance().updateChatList()}.bind(this))},updateSendMessage:function(localId,message){if(0==!!message.id){var state=NetworkChecker.getInstance().getState();"online"==state&&this.chatDao.getMessageBoByLocalIdForMiddleUpdate(localId,(new Date).getTime(),function(messageBo){ChatUI.getInstance().paintUpdatedSendMessageUI(messageBo)}.bind(this))}else 0==OperationPoller.getInstance().isRunState&&(OperationPoller.getInstance().intEtcValue(),OperationPoller.getInstance().run()),this.chatDao.getMessageBoByLocalIdForUpdate(localId,message,function(messageBo){this.saveSuccessfulLastMessage(messageBo,null),ChatUI.getInstance().paintUpdatedSendMessageUI(messageBo),ChatListUI.getInstance().updateChatList()}.bind(this))},processPrevMessageSending:function(localId){ChatUI.getInstance().processPrevMessageSending(this.resendingMsgLocalIdList,localId)},updateContent:function(message){this.chatDao.updateContent(message,EventManager.EMPTY)},updateSendImageMessage:function(localId,message){var isOnline="online"===NetworkChecker.getInstance().getState();this.chatDao.getMessageBoByLocalIdForUpdate(localId,message,function(messageBo){messageBo.status!==ChatMessageBO.STATUS.FAIL&&(isOnline?messageBo.status=ChatMessageBO.STATUS.SENDING:(messageBo.status=ChatMessageBO.STATUS.FAIL,messageBo.message.code=ErrorCode.SYSTEM_ERROR),this.chatDao.updateMessageBo(Utility.serialize(messageBo)),this.processPrevMessageSending(localId),this.saveSuccessfulLastMessage(messageBo,null),ChatUI.getInstance().paintUpdatedSendMessageUI(messageBo),isOnline&&this.uploadChatImage(message.id,messageBo))
}.bind(this))},uploadChatImage:function(messageId,messageBo){var fileUploader=new FileUploader,image={name:"chat_image",type:"image/jpeg"},imgUrl=messageBo.imageUrl;messageBo.CT_Percentage=0,messageBo.status=ChatMessageBO.STATUS.UPLOADING,this.chatDao.updateMessageBo(Utility.serialize(messageBo));var message=messageBo.message;ChatUI.getInstance().paintUpdatedSendImageMessageUI(messageBo),Utility.getArrayBufferByUrl(imgUrl,$.proxy(function(arrayBuffer){return 0===arrayBuffer.byteLength||arrayBuffer===!1?(messageBo.status=ChatMessageBO.STATUS.FAIL,messageBo.message.code=ErrorCode.SYSTEM_ERROR,this.updateSendImageMessage(messageId,messageBo.message,function(result){}),void ChatUI.getInstance().paintUpdatedSendImageMessageUI(messageBo)):(this.updateSendImageMessage(messageId,messageBo.message,function(result){}),Debugger.isDebugging()&&this.uploadStartTimeList.push({id:messageBo.localId,time:(new Date).getTime()}),void fileUploader.uploadChatImage({authToken:AuthInfoKeeper.getInstance().getAuthToken(),oid:messageId,imageName:image.name,imageType:image.type,imageQuality:LineConfig.UPLOAD_IMAGE_QUALITY,imageArrayBuffer:arrayBuffer,progress:$.proxy(function(result){messageBo.status=ChatMessageBO.STATUS.UPLOADING,this.chatDao.updateMessageBo(Utility.serialize(messageBo)),this.updateSendImageMessage(message.id,message,EventManager.EMPTY),messageBo.CT_Percentage=result.percentage,ChatUI.getInstance().paintUpdatedSendImageMessageUI(messageBo)},this),complete:$.proxy(function(){Debugger.isDebugging()&&this.uploadEndTimeList.push({id:messageBo.localId,time:(new Date).getTime()}),messageBo.status=ChatMessageBO.STATUS.SENT,delete messageBo.CT_Percentage,this.chatDao.updateMessageBo(Utility.serialize(messageBo)),this.updateSendImageMessage(message.id,message,EventManager.EMPTY),messageBo.CT_Percentage=100,ChatUI.getInstance().paintUpdatedSendImageMessageUI(messageBo)},this),error:$.proxy(function(){messageBo.status=ChatMessageBO.STATUS.FAIL,message.code=ErrorCode.SYSTEM_ERROR,delete messageBo.CT_Percentage,this.chatDao.updateMessageBo(Utility.serialize(messageBo)),this.updateSendImageMessage(message.id,message,EventManager.EMPTY),messageBo.CT_Percentage=0,ChatUI.getInstance().paintUpdatedSendImageMessageUI(messageBo)},this)}))},this))},saveSuccessfulLastMessage:function(messageBo,status){NetworkChecker.getInstance().setState("online");var serializedData=Utility.serialize(messageBo);this.chatListBo.updateLastMessageBo(messageBo,status),this.chatDao.saveSuccessfulLastMessage(serializedData)},deleteMessageBoByLocalId:function(localId,prevMsgLocalId,onSuccess){if(this.chatDao.deleteMessageBoByLocalId(localId,onSuccess),null!=prevMsgLocalId)this.chatDao.getMessageBoByLocalId(prevMsgLocalId,function(messageBo){this.saveSuccessfulLastMessage(messageBo,"delete")}.bind(this));else try{var chatId=this.currentChatBo.chatId;this.chatDao.deleteLastMessageBoByChatId(chatId,EventManager.EMPTY)}catch(ex){}},saveMessage:function(serializedMessageBo){this.chatDao.saveMessage(serializedMessageBo)},receiveMessage:function(message,isForceFetchOps){var messageBo=this.chatMsgBo.receiveMessage(message),chatBo=this.getChatBoById(messageBo.chatId),serializedData=Utility.serialize(messageBo);null==chatBo?this.createChatByReceiveMessage(messageBo,function(chatBo){this.doReceiveMessage(chatBo,messageBo,isForceFetchOps)}.bind(this)):(null==chatBo.firstMsgLocalId&&(chatBo.firstMsgLocalId=messageBo.localId),chatBo.lastMessageTime=serializedData.message.createdTime,chatBo.isClearChat=!1,chatBo.isReceiveMessage=!0,this.updateChatBo(Utility.serialize(chatBo)),this.doReceiveMessage(chatBo,messageBo,isForceFetchOps))},doReceiveMessage:function(chatBo,messageBo,isForceFetchOps){var serializedData=Utility.serialize(messageBo);if(this.chatDao.saveMessage(serializedData),this.chatDao.saveSuccessfulLastMessage(messageBo),this.chatListBo.updateLastMessageBo(messageBo,null),1==isForceFetchOps?1==chatBo.notification&&this.pushNotification(messageBo):null==chatBo?this.pushNotification(messageBo):1==chatBo.notification&&(null==this.currentChatBo?this.pushNotification(messageBo):chatBo.chatId!=this.currentChatBo.chatId?this.pushNotification(messageBo):0==LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.CHAT_ROOM)&&this.pushNotification(messageBo)),null==this.currentChatBo||this.currentChatBo.chatId!=messageBo.chatId){this.chatListBo.saveUnreadMessageBo(messageBo);var size=this.getUnreadMessageListSize();ChatListUI.getInstance().updateUnreadMsgCount(size)}else 1==isForceFetchOps&&this.chatListBo.saveUnreadMessageBo(messageBo);ChatListUI.getInstance().updateChatList(),ChatUI.getInstance().onReceiveMessage(messageBo,isForceFetchOps),1==!!this.currentChatBo&&this.currentChatBo.chatId==messageBo.chatId&&this.increaseMsgStackCount(messageBo.chatId)},pushNotification:function(messageBo){var senderContact=ContactProxy.getInstance().getContactFromLocal(messageBo.message.from),notiText=messageBo.message.text,contentType=messageBo.message.contentType;contentType==ContentType.NONE&&1==!!messageBo.message.location?LinePushNotification.showNotification(contentType,senderContact.printName,$.i18n.prop("NOT_SUPPORT_MESSAGE_FORMAT")):0==CommonMessageBO.isSupportedMessageType(contentType)?LinePushNotification.showNotification(contentType,senderContact.printName,$.i18n.prop("NOT_SUPPORT_MESSAGE_FORMAT")):LinePushNotification.showNotification(contentType,senderContact.printName,notiText)},getUnreadMessageListSize:function(){var unreadCount=this.chatListBo.getUnreadMessageListSize(),invitedGroupCount=this.getOnlyInvitedGroupList().length;return unreadCount+invitedGroupCount},sendChatChecked:function(chatId,endPointId){this.chatMsgBo.sendChatChecked(chatId,endPointId,function(){this.chatDao.updateCheckedMessage(chatId,EventManager.EMPTY)}.bind(this))},getChatMessageList:function(isinit,onSuccess){try{var blockSize=1;1==isinit?(blockSize=1,this.requestBlockSize=1):blockSize=this.requestBlockSize;var chatId=this.currentChatBo.chatId;this.chatDao.getMessageBoList(chatId,blockSize,this.requestPageSize,this.getMsgStackCount(chatId),function(list){this.requestBlockSize++,isinit&&(list=this.changeUploadingToFailMessages(list));for(var tmp=list.reverse(),tmp2=[],findObj=null,i=0;i<tmp.length;i++)!tmp[i].sysMsgType||0!=tmp[i].sysMsgType&&5!=tmp[i].sysMsgType?tmp2.push(tmp[i]):findObj=tmp[i];null!=findObj&&tmp2.unshift(findObj),onSuccess(tmp2)}.bind(this))}catch(ex){}},changeUploadingToFailMessages:function(list){for(var i=0,len=list.length;len>i;i++){var messageBo=list[i];messageBo.message.contentType===ContentType.IMAGE&&(messageBo.status===ChatMessageBO.STATUS.SENDING||messageBo.status===ChatMessageBO.STATUS.UPLOADING)&&(messageBo.status=ChatMessageBO.STATUS.FAIL,this.chatDao.updateMessageBo(Utility.serialize(messageBo.status)),list[i]=messageBo)}return list},getUnreadMessageListByChatId:function(chatId){return this.chatListBo.getUnreadMessageBoListByChatId(chatId)},getUnreadMessageCountByChatId:function(chatId){var list=this.getUnreadMessageListByChatId(chatId);return list.length},insertSystemMessage:function(midType,chatId,sysMsgType,etcObj,onSuccess){var messageBo=this.chatMsgBo.makeSystemMessage(midType,chatId,sysMsgType,etcObj),serializedData=Utility.serialize(messageBo);return this.chatDao.saveMessage(serializedData,onSuccess),messageBo},updateDAO:function(statement){"needToUpdateChatList"==statement&&this.notifyUpdateChatList()},updateContact:function(contact){if(0!=!!contact){if(contact.status==ContactStatus.UNSPECIFIED&&contact.unregister){for(var allChatList=this.chatListBo.getChatAllList(contact),i=0;i<allChatList.length;i++){var chatBo=allChatList[i],messageBo=this.insertSystemMessage(chatBo.midType,chatBo.chatId,SystemMessageBO.TYPE.LEFT_CHAT,{dpName:contact.printName},EventManager.EMPTY);ChatUI.getInstance().paintSystemMessageUI(chatBo,messageBo,"live")}for(var updatedChatList=this.chatListBo.updateChatByUnRegisteredContact(contact),j=0;j<updatedChatList.length;j++)this.chatDao.updateChat(updatedChatList[j]),updatedChatList[j].midType===MIDType.GROUP&&GroupProxy.getInstance().updateGroupList(updatedChatList[j].groupInfo)}else this.deleteAlertMessage(contact.mid),ChatListUI.getInstance().updateChatList();ChatListUI.getInstance().updateChatList(),ChatUI.getInstance().updateContact(contact)}},notifyUpdateChatList:function(){this.prepareChatList(function(){ChatListUI.getInstance().updateChatList()})},notifyLeaveRoom:function(leavedChatId,leavedMid){var chatBo=this.getChatBoById(leavedChatId),leavedContact=ContactProxy.getInstance().getContactFromLocal(leavedMid),dpName=leavedContact.printName;if(0!=!!chatBo){var messageBo=this.insertSystemMessage(chatBo.midType,leavedChatId,SystemMessageBO.TYPE.LEFT_CHAT,{dpName:dpName},EventManager.EMPTY);ChatUI.getInstance().paintSystemMessageUI(chatBo,messageBo,"live"),chatBo.excludeContact(leavedMid),null!=this.currentChatBo&&chatBo.chatId==this.currentChatBo.chatId&&this.setCurrentChatBo(chatBo);var serializedData=chatBo.serialize();this.chatListBo.updateChat(serializedData,!0),this.chatDao.updateChat(serializedData),ChatListUI.getInstance().updateChatList(),ChatUI.getInstance().changeChatRoomHeader(messageBo.chatId)}},notifyInviteIntoRoom:function(chatId,updatedMids,inviterMid){var isCreatingRoom=this.getProcessCreatRoomState();if(1==isCreatingRoom);else{var chatBo=this.isExistChat(chatId),updateContactMids=[],dpNameArr=[],dpName=null,processFlag=!0;if(null==chatBo)return void this.createChatRoom(chatId,updatedMids,!1,"desktop");if(1==_.isArray(updatedMids)){for(var i=0;i<updatedMids.length;i++){var mid=updatedMids[i];1==chatBo.isGroupMember(mid)?processFlag=!1:(dpNameArr.push(Utility.makeDisplayNameForMids([mid])),updateContactMids.push(mid))}dpName=dpNameArr.join(", ")}else 1==chatBo.isGroupMember(updatedMids)?processFlag=!1:dpName=Utility.makeDisplayNameForMids([updatedMids]);if(0==processFlag)return;1==_.isArray(updatedMids)?chatBo.includeContactList(updateContactMids):chatBo.includeContact(updatedMids);var etcObj={dpName:dpName};if(1==!!inviterMid){var inviterContact=ContactProxy.getInstance().getContactFromLocal(inviterMid);etcObj.inviterDpName=inviterContact.printName}var messageBo=this.insertSystemMessage(chatBo.midType,chatId,SystemMessageBO.TYPE.INVITE_INTO_ROOM,etcObj,EventManager.EMPTY);ChatUI.getInstance().paintSystemMessageUI(chatBo,messageBo,"live"),null!=this.currentChatBo&&chatBo.chatId==this.currentChatBo.chatId&&this.setCurrentChatBo(chatBo);var serializedData=chatBo.serialize();this.chatListBo.updateChat(serializedData,!0),this.chatDao.updateChat(serializedData),ChatUI.getInstance().changeChatRoomHeader()}},notifyInviteIntoRoomForMe:function(chatId,inviterMid,inviteeMid){this.chatListBo.getRoom(chatId,function(room){this.createChatRoomByInvitedRoom(chatId,room,inviterMid,inviteeMid)}.bind(this))},processUpdateReadCount:function(readerMid,messageIdList){var msgIds=_.sortBy(messageIdList),startPoint=msgIds[0],endPoint=msgIds[msgIds.length-1];this.chatDao.updateReadCount(startPoint,endPoint,this.successfulUpdateReadCount.bind(this))},successfulUpdateReadCount:function(processedMsgBoList){processedMsgBoList.length>0&&ChatUI.getInstance().paintUpdateReadCount(processedMsgBoList[0].chatId,processedMsgBoList)},inviteIntoGroup:function(inviteChatId,inviteeMid){var tmpBo=this.getChatBoById(inviteChatId);if(null!=tmpBo){var chatBo=new ChatBO(tmpBo.midType,inviteChatId);chatBo.deSerialize(tmpBo);{Utility.makeDisplayNameForMids(inviteeMid)}if(0!=!!chatBo){chatBo.includeContactList(inviteeMid,"invitee"),null!=this.currentChatBo&&chatBo.chatId==this.currentChatBo.chatId&&this.setCurrentChatBo(chatBo);var serializedData=chatBo.serialize();this.chatListBo.updateChat(serializedData,!0),this.chatDao.updateChat(serializedData),GroupProxy.getInstance().updateGroupList(chatBo.groupInfo),ChatListUI.getInstance().updateChatList()}}},acceptGroupInvitation:function(chatId){this.commonProcessNotify(chatId,AuthInfoKeeper.getInstance().getAuthMid(),SystemMessageBO.TYPE.ACCEPT_INVITE_INTO_ROOM,"include",!1),this.updateUnreadMsgCount()},kickoutFromGroup:function(chatId,deletedMid){var chatBo=this.getChatBoById(chatId);if(0!=!!chatBo&&0!=deletedMid.length){var dpNames=Utility.makeDisplayNameForMids(deletedMid),messageBo=this.insertSystemMessage(chatBo.midType,chatId,SystemMessageBO.TYPE.KICKOUT_FROM_GROUP,{kicker:AuthInfoKeeper.getInstance().getAuthMid(),dpName:dpNames},EventManager.EMPTY);ChatUI.getInstance().paintSystemMessageUI(chatBo,messageBo,"live"),chatBo.excludeContactList(deletedMid),null!=this.currentChatBo&&chatBo.chatId==this.currentChatBo.chatId&&this.setCurrentChatBo(chatBo);var serializedData=chatBo.serialize();this.chatListBo.updateChat(serializedData,!0),this.chatDao.updateChat(serializedData),GroupProxy.getInstance().updateGroupList(chatBo.groupInfo),ChatListUI.getInstance().updateChatList(),ChatUI.getInstance().changeChatRoomHeader(messageBo.chatId)}},rejectGroupInvitation:function(chatId){this.leaveGroup(chatId,EventManager.EMPTY)},notifyAcceptGroupInvitation:function(chatId,acceptedMid){this.commonProcessNotify(chatId,acceptedMid,SystemMessageBO.TYPE.ACCEPT_INVITE_INTO_ROOM,"include",!0)},notifyLeaveGroupInvitation:function(chatId,leftMid){this.commonProcessNotify(chatId,leftMid,SystemMessageBO.TYPE.LEFT_CHAT,"exclude",!0)},notifyInviteIntoGroupForMe:function(chatId,inviterMid,isForceFetchOps){GroupProxy.getInstance().getGroupT(chatId,function(group){this.createChatByInvitedGroup(chatId,group,inviterMid,isForceFetchOps)}.bind(this))},notifyInviteIntoGroup:function(chatId,inviterMid,inviteeMid){var chatBo=this.getChatBoById(chatId);if(0!=!!chatBo){var inviterContact=ContactProxy.getInstance().getContactFromLocal(inviterMid),inviterDpName=null;inviterDpName=inviterContact?inviterContact.printName:ContactUI.UNKNOWN;var inviteeContactList=[];if(1==_.isArray(inviteeMid))for(var i=0;i<inviteeMid.length;i++)inviteeContactList.push(ContactProxy.getInstance().getContactFromLocal(inviteeMid[i]));else inviteeContactList.push(ContactProxy.getInstance().getContactFromLocal(inviteeMid));var inviteeDpNames=Utility.makeDisplayNameForRoom(inviteeContactList),messageBo=this.insertSystemMessage(chatBo.midType,chatId,SystemMessageBO.TYPE.INVITE_INTO_GROUP,{inviterDpName:inviterDpName,inviteeDpNames:inviteeDpNames},EventManager.EMPTY);ChatUI.getInstance().paintSystemMessageUI(chatBo,messageBo,"live");var midList=_.isArray(inviteeMid)?inviteeMid:[inviteeMid];chatBo.includeContactList(midList,"invitee"),null!=this.currentChatBo&&chatBo.chatId==this.currentChatBo.chatId&&this.setCurrentChatBo(chatBo);var serializedData=chatBo.serialize();this.chatListBo.updateChat(serializedData,!0),this.chatDao.updateChat(serializedData),GroupProxy.getInstance().updateGroupList(chatBo.groupInfo),this.getEventManager().broadCast(chatBo)}},notifyKickoutFromGroup:function(chatId,kickerMid){var chatBo=this.getChatBoById(chatId);if(0!=!!chatBo){var kickerContact=ContactProxy.getInstance().getContactFromLocal(kickerMid),dpName=kickerContact.printName,profile=ProfileProxy.getInstance().getProfile(),myDpName=profile.displayNameOverridden||profile.displayName,messageBo=this.insertSystemMessage(chatBo.midType,chatId,SystemMessageBO.TYPE.KICKOUT_FROM_GROUP,{kicker:dpName,dpName:myDpName},EventManager.EMPTY);ChatUI.getInstance().paintSystemMessageUI(chatBo,messageBo,"live"),chatBo.updateKickoutState(),null!=this.currentChatBo&&chatBo.chatId==this.currentChatBo.chatId&&this.setCurrentChatBo(chatBo);var serializedData=chatBo.serialize();this.chatListBo.updateChat(serializedData,!0),this.chatDao.updateChat(serializedData),GroupProxy.getInstance().updateGroupList(chatBo.groupInfo),ChatListUI.getInstance().updateChatList(),ChatUI.getInstance().changeChatRoomHeader(messageBo.chatId)}},notifyCancelInvitationGroup:function(chatId,adaptorMid,cancelledMid){if(cancelledMid===AuthInfoKeeper.getInstance().getAuthMid())return this.leaveGroup(chatId,EventManager.EMPTY),this.updateUnreadMsgCount(),!1;var chatBo=this.getChatBoById(chatId);if(0!=!!chatBo){var adaptorContact=ContactProxy.getInstance().getContactFromLocal(adaptorMid),adaptorDpName=null;adaptorDpName=adaptorMid==AuthInfoKeeper.getInstance().getAuthMid()?adaptorMid:adaptorContact?adaptorContact.printName:ContactUI.UNKNOWN;var cancelledContact=ContactProxy.getInstance().getContactFromLocal(cancelledMid),dpName=ContactProxy.getInstance().getPrintName(cancelledContact),messageBo=this.insertSystemMessage(chatBo.midType,chatId,SystemMessageBO.TYPE.CANCEL_INVITE_INTO_GROUP,{adaptor:adaptorDpName,dpName:dpName},EventManager.EMPTY);ChatUI.getInstance().paintSystemMessageUI(chatBo,messageBo,"live"),chatBo.excludeContact(cancelledMid,"invitee"),null!=this.currentChatBo&&chatBo.chatId==this.currentChatBo.chatId&&this.setCurrentChatBo(chatBo);var serializedData=chatBo.serialize();this.chatListBo.updateChat(serializedData,!0),this.chatDao.updateChat(serializedData),ChatUI.getInstance().changeChatRoomHeader(messageBo.chatId)}},commonProcessNotify:function(chatId,userMid,msgType,flag,isSysMsg){var tmpBo=this.getChatBoById(chatId);if(null!=tmpBo){var chatBo=new ChatBO(tmpBo.midType,chatId);chatBo.deSerialize(tmpBo);var contact=ContactProxy.getInstance().getContactFromLocal(userMid),dpName=ContactProxy.getInstance().getPrintName(contact),messageBo=null;1==isSysMsg&&1==chatBo.isGroupMember(AuthInfoKeeper.getInstance().getAuthMid())&&(messageBo=this.insertSystemMessage(chatBo.midType,chatId,msgType,{dpName:dpName},EventManager.EMPTY),ChatUI.getInstance().paintMessageUI(messageBo,"live",!0),chatBo=this.getChatBoById(chatBo.chatId)),"exclude"==flag?chatBo.excludeContact(userMid):chatBo.includeContact(userMid),null!=this.currentChatBo&&chatBo.chatId==this.currentChatBo.chatId&&this.setCurrentChatBo(chatBo);var serializedData=Utility.serialize(chatBo);this.chatListBo.updateChat(serializedData,!0),this.chatDao.updateChat(serializedData),this.getEventManager().broadCast(chatBo),GroupProxy.getInstance().updateGroupList(chatBo.groupInfo),ChatListUI.getInstance().updateChatList(),null!=messageBo&&ChatUI.getInstance().changeChatRoomHeader(messageBo.chatId)}},updateConnectionServerInfo:function(){this.chatListBo.updateConnectionServerInfo(),this.chatMsgBo.updateConnectionServerInfo()},debugMode:function(debugInfo){this.chatListBo.sendJobWorker.sendQuery("pushDebugInfo",debugInfo),this.chatMsgBo.sendJobWorker.sendQuery("pushDebugInfo",debugInfo)}},ChatProxy.getInstance=function(){return null==ChatProxy.instance&&(ChatProxy.instance=new ChatProxy),ChatProxy.instance},ChatProxy.instance=null,ChatProxy.KEY_LOCAL_ID="CH_localId";var ChatSettingUI=function(){return null!=ChatSettingUI.instance?ChatSettingUI.instance:(_.extend(this,UIStructure),this.assign(),void this.setEvent())};ChatSettingUI.prototype={assign:function(){this.elChatRoomSetting=$()},setEvent:function(){},paintChatRoomSetting:function(){},changeScreen:function(){var screen_info=LineMain.getInstance().getScreenInfo();screen_info.subScreen===LineMain.SUB_SCREEN_TYPE.CHAT_SETTING?(this.elChatRoomSetting.removeClass("MdNonDisp"),this.changeChatRoomHeader(),this.paintChatRoomSetting()):this.elChatRoomSetting.addClass("MdNonDisp")},changeChatRoomHeader:function(){var headerView=HeaderView.getInstance();headerView.set({closeRightBtn:!0,chatRoomOptionBtn:!0}).setTitle($.i18n.prop("CHAT_SETTINGS")).show(),MenuView.getInstance().set(LineMain.getInstance().getScreenInfo()).hide()}},ChatSettingUI.getInstance=function(){return null==ChatSettingUI.instance&&(ChatSettingUI.instance=new ChatSettingUI),ChatSettingUI.instance},ChatSettingUI.instance=null;var ChatUI=function(){return null!=ChatUI.instance?ChatUI.instance:(_.extend(this,UIStructure),this.assign(),void this.setEvent())};ChatUI.prototype={assign:function(){this.flagChatMode=!1,this.flagChatMemberList=!1,this.chatProxy=ChatProxy.getInstance(),this.stickerProxy=StickerProxy.getInstance(),this.messageItemFactory=MessageItemTemplateFactory.getInstance(),this.elChatRoom=$("#_wrap_chat_room"),this.elChatMemberList=this.elChatRoom.find("#_wrap_group_member_list"),this.wrapChatMemberList=this.elChatMemberList.parent(),this.elChatRoomScrollBody=this.elChatRoom.children(".MdScroll01"),this.elChatRoomScrollHeight=this.elChatRoomScrollBody.children(".mdScroll01Inner"),this.elChatInput=$("#_chat_room_input"),this.elChatSendBtn=$("#_chat_room_send_btn"),this.elPlusBtn=$("#_chat_room_plus_btn"),this.elStickerBtn=$("#_chat_room_sticker"),this.elChatRoomOption=$("._chat_room_option_body"),this.elChatRoomOptionUL=this.elChatRoomOption.find("ul"),this.elChatRoomNotiFlag=$("header._header_group").find("span._chat_room_noti_flag"),this.elChatRoomMemberCnt=$("header._header_group").find("span._chat_room_member_cnt"),this.elCurtainLayer=$("._curtainLayer"),this.isShowOptionLayer=!1,this.isShowStickerLayer=!1,this.isRenderChat=!1,this.isFriend=!0,this.unreadPositionCheck=!1,this.elChatEtcLayer=$("#_wrap_chat_etc"),this.wrapContextMenu=$("#_wrap_context_menu"),this.elChatSendBtn[0].value=$.i18n.prop("SEND_MESSAGE"),this.warmupInterval=null,this.warmupCount=0,this.prevMsgLoading=!1},setEvent:function(){LineMain.getInstance().getEventManager().regist($.proxy(this.changeScreen,this)),this.elChatInput.on("keypress",$.proxy(this.onSendMessage,this)),this.elChatInput.on("keyup",$.proxy(this.onKeyUp,this)),this.elChatInput.on("keydown",$.proxy(this.onKeyDown,this)),this.elChatInput.on("focus",$.proxy(this.onFocus,this)),this.elChatSendBtn.on(this.EVENT_CLICK,$.proxy(this.onClickSendBtn,this)),this.elStickerBtn.on(this.EVENT_CLICK,$.proxy(this.toggleStickerLayer,this)),this.elPlusBtn.on(this.EVENT_TOUCH,$.proxy(this.onClickPlusBtn,this)),this.elCurtainLayer.on(this.EVENT_CLICK,$.proxy(this.onClickCurtainLayer,this)),this.elChatRoomOptionUL.on(this.EVENT_CLICK,$.proxy(this.onClickOptionItem,this)),this.elChatRoom.on(this.EVENT_CLICK,"._open_image_viewer",$.proxy(this.onClickImage,this)),this.elChatRoom.on(this.EVENT_CLICK,"._failure_btn",$.proxy(this.onClickFailureButton,this)),this.elChatRoom.on(this.EVENT_CLICK,"._prev_msg_btn",$.proxy(this.onClickPrevMsgButton,this)),this.elChatEtcLayer.on(this.EVENT_CLICK,"._btn_delete_all_chat",$.proxy(this.processDeleteAllChatRecord,this)),this.elChatEtcLayer.on(this.EVENT_CLICK,"#_wrap_chat_member_list li",$.proxy(this.processOpenMemberContextMenu,this)),this.wrapChatMemberList.on(this.EVENT_CLICK,$.proxy(this.processOpenChatMemberList,this)),this.wrapContextMenu.off(this.EVENT_CLICK,".wrap_member_context_menu button").on(this.EVENT_CLICK,".wrap_member_context_menu button",$.proxy(this.onClickMemberContextMenu,this)),$(window).on("resize",$.proxy(function(){this.flagChatMode=this.elChatInput.is(":focus"),this.resize(),this.resizeCurtainLayer(),this.downScroll()},this))},setWarmup:function(){null==this.warmupInterval&&(this.doWarmup(),this.warmupInterval=setInterval(function(){this.warmupCount++,this.doWarmup()}.bind(this),2500))},doWarmup:function(){this.warmupCount>12&&this.clearWarmup();var xhrObj=new XMLHttpRequest({mozSystem:!0,mozBackgroundRequest:!0}),serverInfo=ServerInfo.getInstance();serverInfo.setting("warmup"),xhrObj.open("POST","http://"+serverInfo.getHost()+":"+serverInfo.getPort()+serverInfo.getURI(),!0),xhrObj.onreadystatechange=function(){4==xhrObj.readyState&&NetworkChecker.getInstance().setState(200==xhrObj.status?"online":"offline")}.bind(this),xhrObj.send("kjcjphP8jlDBBrcMjItBgeK8PMPFHejPSuPTE0bGHo2GnbWkuYwEFMZD7kvnffwk")},clearWarmup:function(){clearInterval(this.warmupInterval),this.warmupCount=0,this.warmupInterval=null},paintChatRoom:function(){DimmedUI.getInstance().open("",{},{isCenter:!0}),this.setWarmup(),this.paintChatMemberList(),this.clearChatRoomUI(),this.paintChatMemberCount(),this.paintNotiFlag(),this.paintAddNBlockButton(),this.resize(),this.clearInput(),this.checkRoomState(),this.checkBlockState(),StickerLayerUI.getInstance().initStickerLayer(),ChatProxy.getInstance().clearMsgStackCount(),this.chatProxy.getChatMessageList(!0,function(msgList){this.processChatMessageList(msgList,"now"),DimmedUI.getInstance().close()}.bind(this)),this.isRenderChat=!0},checkRoomState:function(){var currentChatBo=ChatProxy.getInstance().getCurrentChatBo(),contact=ContactProxy.getInstance().getContactFromLocal(currentChatBo.chatId);null!=contact&&(1==!!contact.unregister?this.paintBlockState($.i18n.prop("NO_CHAT_MEMBER")):contact.status==ContactStatus.RECOMMEND_BLOCKED||contact.status==ContactStatus.FRIEND_BLOCKED||contact.status==ContactStatus.DELETED_BLOCKED?this.paintBlockState($.i18n.prop("BLOCK")):this.paintUnBlockState())},paintChatMemberList:function(){var maxMemberCount=8,currentChatBo=ChatProxy.getInstance().getCurrentChatBo();if(0==!!currentChatBo)return!1;var chatBo=ChatProxy.getInstance().isExistChat(currentChatBo.chatId),listArr=[],thumbnailListTemplate=TemplateManager.getInstance().get(ChatUI.CHAT_MEMBER_THUM_TEMPLATE);if(chatBo.midType===MIDType.ROOM)var memberMids=_.pluck(chatBo.roomInfo.contacts.slice(0,maxMemberCount),"mid");else if(chatBo.midType===MIDType.GROUP){var memberMids=_.pluck(chatBo.groupInfo.members.slice(0,maxMemberCount),"mid");currentChatBo.isKickoutStatus&&(this.flagChatMemberList=!1)}else{this.wrapChatMemberList.addClass("MdNonDisp");var memberMids=[]}var memberList=ContactProxy.getInstance().getContactListFromMids(memberMids);0>=memberList?(this.wrapChatMemberList.addClass("MdNonDisp"),this.flagChatMemberList=!1):(_.each(memberList,$.proxy(function(contact){var output=Mustache.render(thumbnailListTemplate,contact);listArr.push(output)},this)),this.elChatMemberList.html(listArr.join("")),Utility.lazyLoadImage(this.elChatMemberList.find("img")),this.flagChatMemberList=!0)},toggleChatMemberList:function(){this.flagChatMemberList?(this.paintChatMemberList(),this.wrapChatMemberList.toggleClass("MdNonDisp")):this.wrapChatMemberList.addClass("MdNonDisp")},paintChatMemberCount:function(){var currentChatBo=ChatProxy.getInstance().getCurrentChatBo();if(0==!!currentChatBo)return!1;var chatBo=ChatProxy.getInstance().isExistChat(currentChatBo.chatId),countArea=this.elChatRoomMemberCnt,count=0;chatBo&&chatBo.midType!=MIDType.USER&&(countArea.removeClass("MdNonDisp"),chatBo.midType==MIDType.ROOM?(count=Utility.makeRoomMemeberCount(chatBo.roomInfo.contacts),count++):count=null==chatBo.groupInfo.members&&null==chatBo.groupInfo.invitee?1:Utility.makeRoomMemeberCount(chatBo.groupInfo.members),countArea.html("("+count+")"))},removeChatMemberCount:function(){var currentChatBo=ChatProxy.getInstance().getCurrentChatBo();this.elChatRoomMemberCnt.html(0==!!currentChatBo||currentChatBo.midType==MIDType.USER?"":"(0)"),this.elChatRoomMemberCnt.addClass("MdNonDisp")},paintNotiFlag:function(){var chatBo=ChatProxy.getInstance().getCurrentChatBo(),notiFlag=this.elChatRoomNotiFlag;0==chatBo.notification?(notiFlag.removeClass("mdLYR02PushOn"),notiFlag.addClass("mdLYR02PushOff"),notiFlag.removeClass("MdNonDisp")):(notiFlag.removeClass("mdLYR02PushOff"),notiFlag.addClass("mdLYR02PushOn"),notiFlag.addClass("MdNonDisp"))},removeNotiFlag:function(){var notiFlag=this.elChatRoomNotiFlag;notiFlag.removeClass("mdLYR02PushOff"),notiFlag.addClass("mdLYR02PushOn"),notiFlag.addClass("MdNonDisp")},paintAddNBlockButton:function(){var chatBo=ChatProxy.getInstance().getCurrentChatBo();if(chatBo.midType==MIDType.USER){var btnEl=null,contact=ContactProxy.getInstance().getContactFromLocal(chatBo.chatId);if(contact.status===ContactStatus.RECOMMEND_BLOCKED||contact.status==ContactStatus.DELETED_BLOCKED?contact.isBlock=!0:delete contact.isBlock,contact.status==ContactStatus.RECOMMEND||contact.status==ContactStatus.RECOMMEND_BLOCKED||contact.status==ContactStatus.DELETED||contact.status==ContactStatus.DELETED_BLOCKED){var tmpl=TemplateManager.getInstance().get(ChatUI.ADD_BLOCK_BTN_TEMPLATE);this.isFriend=!1,this.elChatRoom.before(Mustache.render(tmpl,contact)),btnEl=$("#_chat_room_btn_set"),btnEl.on(this.EVENT_CLICK,"li a",$.proxy(this.onClickAddBlock,this))}else this.isFriend=!0}else this.isFriend=!0},removeAddNBlockButton:function(){var btnEl=$("#_chat_room_btn_set");btnEl[0]&&(this.isFriend=!0,btnEl.remove())},toggleAddNBlockButton:function(){var btnEl=$("#_chat_room_btn_set");btnEl.toggleClass("MdNonDisp")},removeMessageArea:function(){this.messageItemFactory.clearMessageUI()},removeChatOptionArea:function(){this.elChatRoomOption.addClass("MdNonDisp"),this.elChatRoomOptionUL.children().remove()},clearChatRoomUI:function(){this.isShowOptionLayer=!1,this.isShowStickerLayer=!1,this.elCurtainLayer.addClass("MdNonDisp"),this.removeChatMemberCount(),this.removeNotiFlag(),this.removeChatOptionArea(),this.removeAddNBlockButton(),this.removeMessageArea()},updateContact:function(contact){if(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.CHAT_ROOM)){{var chatId=(contact.displayNameOverridden||contact.displayName,ChatProxy.getInstance().getCurrentChatBo().chatId);ChatProxy.getInstance().isExistChat(chatId)}contact.status==ContactStatus.UNSPECIFIED&&contact.unregister&&(this.removeAddNBlockButton(),this.changeChatRoomHeader(),this.checkRoomState(),this.resize()),this.paintChatMemberList()}},toggleStickerLayer:function(){var currentChatBo=ChatProxy.getInstance().getCurrentChatBo(),contact=ContactProxy.getInstance().getContactFromLocal(currentChatBo.chatId);this.isBlockStatus()||1==!!contact&&1==contact.unregister||(this.isShowStickerLayer=!this.isShowStickerLayer,this.resizeCurtainLayer(),this.isShowOptionLayer&&this.toggleChatOptionLayer(),1==this.isShowStickerLayer&&this.setWarmup(),StickerLayerUI.getInstance().toggleStickerLayer())},toggleCurtainLayer:function(){this.resizeCurtainLayer(),this.elCurtainLayer.toggleClass("MdNonDisp")},onClickCurtainLayer:function(){this.isShowOptionLayer?this.toggleChatOptionLayer():this.isShowStickerLayer&&this.toggleStickerLayer()},openPhotoSelector:function(){ActivityHelper({type:"pick",dataType:"image/jpeg",imageQuality:.1,success:$.proxy(function(image){oSegmReq=new FileReader,oSegmReq.readAsArrayBuffer(image),oSegmReq.onload=$.proxy(function(e){var imageArrayBuffer=e.target.result;this.onSendImage(imageArrayBuffer),this.isShowOptionLayer&&this.toggleChatOptionLayer()},this)},this)})},onClickPlusBtn:function(){var currentChatBo=ChatProxy.getInstance().getCurrentChatBo(),contact=ContactProxy.getInstance().getContactFromLocal(currentChatBo.chatId);this.isBlockStatus()||1==!!contact&&1==contact.unregister||this.openPhotoSelector()},onClickSendBtn:function(){return document.getElementById("_chat_room_input").focus(),this.elChatInput.parent().addClass("ExPlaceholder"),this.doSendMessage(),!1},checkBlockState:function(){this.isBlockStatus()?this.paintBlockState():this.paintUnBlockState()},isBlockStatus:function(){var flag=!1,chatBo=ChatProxy.getInstance().getCurrentChatBo(),optList=ChatProxy.getInstance().getChatRoomOptionList(chatBo,this.isFriend);return optList.block&&optList.block.active&&1==optList.block.active&&(flag=!0),flag},paintBlockState:function(placeHolderTxt){var oField=this.elChatInput[0];oField.value.length>0&&(oField.value="",this.elChatSendBtn.addClass("ExDisabled")),oField.placeholder=1==!!placeHolderTxt?placeHolderTxt:$.i18n.prop("BLOCK"),oField.disabled=!0,this.elStickerBtn.parent().addClass("ExDisabled"),this.elStickerBtn.attr("disabled","disabled"),this.elPlusBtn.parent().addClass("ExDisabled"),this.elPlusBtn.attr("disabled","disabled"),this.elChatRoomOption.find("._chat_room_option_photo").addClass("ExDisabled"),this.elChatInput.parent().addClass("ExPlaceHolder")},paintUnBlockState:function(){var oField=this.elChatInput[0];oField.placeholder="",oField.disabled=!1,this.elStickerBtn.parent().removeClass("ExDisabled"),this.elStickerBtn.removeAttr("disabled"),this.elPlusBtn.parent().removeClass("ExDisabled"),this.elPlusBtn.removeAttr("disabled"),this.elChatRoomOption.find("._chat_room_option_photo").removeClass("ExDisabled")},onClickFailureButton:function(e){var localId=$(e.currentTarget).attr("data-local-id"),messageType=$(e.currentTarget).attr("data-message-type"),template=TemplateManager.getInstance().get(ChatUI.CHAT_IMAGE_CONTEXT_MENU_TEMPLATE),renderContextMenu=function(isResendAvail){var html=Mustache.render(template,{printName:"",isResendAvailable:isResendAvail,localId:localId});
this.wrapContextMenu.html(html),this.wrapContextMenu.removeClass("MdNonDisp"),this.wrapContextMenu.off(this.EVENT_CLICK,".wrap_chat_image_context_menu button").on(this.EVENT_CLICK,".wrap_chat_image_context_menu button",$.proxy(this.onClickFailureContextMenu,this))};if("image"===messageType)ChatProxy.getInstance().chatDao.getMessageBoByLocalId(localId,function(messageBo){Utility.getArrayBufferByUrl(messageBo.imageUrl,$.proxy(function(arrayBuffer){var isImageExist=0!==arrayBuffer.byteLength&&arrayBuffer!==!1,isResendAvail="image"===messageType&&isImageExist===!0;renderContextMenu.apply(this,[isResendAvail])},this))}.bind(this));else{var isResendAvail=!0;renderContextMenu.apply(this,[isResendAvail])}},onClickPrevMsgButton:function(evt){if(!evt.currentTarget)return!1;if(1!=this.prevMsgLoading){var currentTarget=$(evt.currentTarget);currentTarget.text($.i18n.prop("LOADING")),this.prevMsgLoading=!0,this.chatProxy.getChatMessageList(!1,function(msgList){var currentTarget=$(evt.currentTarget),dateDiv=currentTarget.next();currentTarget.remove(),ChatProxy.getInstance().clearMsgStackCount(),this.processChatMessageList(msgList,"prev",dateDiv),this.prevMsgLoading=!1}.bind(this))}},checkChatScreenForVisibility:function(){ChatProxy.getInstance().checkChatScreenForVisibility()},processChatMessageList:function(messageBoList,position,prevDateDivision){var lastUnreadMessageBo=null,isChangeDate=!1,prevMsgDate=null,currentChatBo=ChatProxy.getInstance().getCurrentChatBo(),firstDateDivisionFlag=!1;if(messageBoList.length>0){MessageItemTemplateFactory.getInstance().clearTmpListUL(),this.processPrevMsgBtn(messageBoList);for(var i=0;i<messageBoList.length;i++){var messageBo=messageBoList[i];if(0==i&&(messageBo.sysMsgType==SystemMessageBO.TYPE.ADD_BLOCK_ALERT?firstDateDivisionFlag=!0:this.paintDateDivisionMessageUI(DateFormatUtil.getInstance().getChatRoomDateDivisionFormat(messageBo.message.createdTime),messageBo.message.createdTime,"backup")),1==i&&1==firstDateDivisionFlag&&(firstDateDivisionFlag=!1,this.paintDateDivisionMessageUI(DateFormatUtil.getInstance().getChatRoomDateDivisionFormat(messageBo.message.createdTime),messageBo.message.createdTime,"backup")),messageBo.sysMsgType!=SystemMessageBO.TYPE.ADD_BLOCK_ALERT){if(null!=prevMsgDate){var isSameDate=DateFormatUtil.getInstance().isSameDay(new Date(prevMsgDate),new Date(messageBo.message.createdTime));0==isChangeDate&&0==isSameDate&&(isChangeDate=!0),1==isChangeDate&&(this.paintDateDivisionMessageUI(DateFormatUtil.getInstance().getChatRoomDateDivisionFormat(messageBo.message.createdTime),messageBo.message.createdTime,"backup"),isChangeDate=!1)}prevMsgDate=messageBo.message.createdTime}if(i==messageBoList.length-1&&1==!!prevDateDivision){var currentPaintDate=$(prevDateDivision.children()[0]),prevPaintDate=messageBo.message.createdTime,currentPaintDateTimestamp=Number(currentPaintDate.attr("data-time"));1==DateFormatUtil.getInstance().isSameDay(new Date(prevPaintDate),new Date(currentPaintDateTimestamp))?prevDateDivision.remove():(currentPaintDate.text(DateFormatUtil.getInstance().getChatRoomDateDivisionFormat(prevPaintDate)),currentPaintDate.attr("data-time",prevpaintDate))}switch(messageBo.status){case ChatMessageBO.STATUS.SYSTEM:this.paintSystemMessageUI(currentChatBo,messageBo,"backup");break;default:this.paintMessageUI(messageBo,"backup")}messageBo.status==ChatMessageBO.STATUS.RECEIVED&&0==!!messageBo.sysMsgType&&(lastUnreadMessageBo=messageBo)}MessageItemTemplateFactory.getInstance().paintBackupMessageList(position),"now"==position?(this.downScroll(),this.downScroll(150)):this.upScroll(),null!=lastUnreadMessageBo&&ChatProxy.getInstance().sendChatChecked(currentChatBo.chatId,lastUnreadMessageBo.message.id),Utility.lazyLoadImage(this.elChatRoomScrollBody.find("img"))}},processPrevMsgBtn:function(messageBoList){var currentChatBo=ChatProxy.getInstance().getCurrentChatBo();if(ChatProxy.getInstance().getRequestPageSize()==messageBoList.length){var firstMsgBo=_.find(messageBoList,function(msgBo){return msgBo.localId==currentChatBo.firstMsgLocalId?msgBo:void 0})||null;null==firstMsgBo&&this.paintPrevBtnUI("backup")}},onKeyUp:function(){var oField=this.elChatInput[0],oInputDiv=this.elChatInput.parent();oField.value.length>0?(oInputDiv.removeClass("ExPlaceholder"),this.elChatSendBtn.removeClass("ExDisabled")):(oInputDiv.addClass("ExPlaceholder"),this.elChatSendBtn.addClass("ExDisabled"))},onKeyDown:function(){var oField=this.elChatInput[0],oInputDiv=this.elChatInput.parent();oField.value.length>0?oInputDiv.removeClass("ExPlaceholder"):oInputDiv.addClass("ExPlaceholder")},onFocus:function(){this.setWarmup(),this.onClickCurtainLayer()},onSendSticker:function(pkgId,stkId,stkVer){this.toggleStickerLayer(),this.clearWarmup();var messageBo=this.chatProxy.sendSticker(pkgId,stkId,stkVer);this.paintMessageUI(messageBo,"live")},onSendMessage:function(event){return 13==event.keyCode?(this.doSendMessage(),!1):void 0},doSendMessage:function(){var textMsg=this.elChatInput.val().trim();if(""==textMsg)return!1;this.clearInput(),this.onClickCurtainLayer(),this.clearWarmup();var messageBo=this.chatProxy.sendMessage(textMsg);this.paintMessageUI(messageBo,"live")},onSendImage:function(imageArrayBuffer){this.clearWarmup();var messageBo=this.chatProxy.sendImage(imageArrayBuffer);this.paintMessageUI(messageBo,"live"),Utility.lazyLoadImage(this.elChatRoom.find("img"))},onReceiveMessage:function(messageBo,isForceFetchOps){var currentChatBo=ChatProxy.getInstance().getCurrentChatBo();null!=currentChatBo&&currentChatBo.chatId==messageBo.chatId&&(0==isForceFetchOps?(this.unreadPositionCheck=!1,ChatProxy.getInstance().sendChatChecked(currentChatBo.chatId,messageBo.message.id)):0==this.unreadPositionCheck&&(this.unreadPositionCheck=!0),this.paintMessageUI(messageBo,"live"),this.downScroll())},paintMessageUI:function(messageBo,status,isSystemMsg){var isCurrentChat=!1,chatBo=ChatProxy.getInstance().getCurrentChatBo();if("live"==status){if(null!=chatBo?(isCurrentChat=!0,0==DateFormatUtil.getInstance().isSameDay(new Date(chatBo.lastMessageTime),new Date(messageBo.message.createdTime))&&this.paintDateDivisionMessageUI(DateFormatUtil.getInstance().getChatRoomDateDivisionFormat(messageBo.message.createdTime),messageBo.message.createdTime,status)):chatBo=this.chatProxy.getChatBoById(messageBo.chatId),chatBo.lastMessageTime=messageBo.message.createdTime,ChatProxy.getInstance().updateChatBo(Utility.serialize(chatBo)),1==isCurrentChat&&ChatProxy.getInstance().setCurrentChatBo(chatBo),1==isCurrentChat&&messageBo.chatId==chatBo.chatId)if(1==!!isSystemMsg&&1==isSystemMsg)this.paintSystemMessageUI(chatBo,messageBo,status);else{var senderContact=ContactProxy.getInstance().getContactFromLocal(messageBo.message.from);this.messageItemFactory.paintMessageUI(messageBo,senderContact,status)}}else if(1==!!isSystemMsg&&1==isSystemMsg)this.paintSystemMessageUI(chatBo,messageBo,status);else{var senderContact=ContactProxy.getInstance().getContactFromLocal(messageBo.message.from);this.messageItemFactory.paintMessageUI(messageBo,senderContact,status)}},deleteMessageUI:function(localId){$("#_chat_item_"+localId).remove()},paintSystemMessageUI:function(chatBo,messageBo,status){var currentChatBo=ChatProxy.getInstance().getCurrentChatBo();null!=currentChatBo&&currentChatBo.chatId==chatBo.chatId&&(this.messageItemFactory.paintSystemMessageUI(chatBo,messageBo,status),"live"==status&&this.downScroll())},paintUnreadPositionMessageUI:function(){this.messageItemFactory.paintUnreadPositionMessageUI()},paintDateDivisionMessageUI:function(date,timestamp,status){this.messageItemFactory.paintDateDivisionMessageUI(date,timestamp,status)},paintPrevBtnUI:function(){this.messageItemFactory.paintPrevBtnUI()},clearInput:function(){this.elChatInput.val("")},downScroll:function(time){0==!!time?this.elChatRoomScrollBody[0].scrollTop=this.elChatRoomScrollHeight.height():setTimeout(function(){this.elChatRoomScrollBody[0].scrollTop=this.elChatRoomScrollHeight.height()}.bind(this),time)},upScroll:function(time){0==!!time?this.elChatRoomScrollBody[0].scrollTop=0:setTimeout($.proxy(function(){this.elChatRoomScrollBody[0].scrollTop=0},this),time)},paintUpdatedSendMessageUI:function(messageBo){var localId=messageBo.localId,targetEl=$("#_chat_item_"+localId);0==targetEl.length?this.paintMessageUI(messageBo):this.messageItemFactory.paintUpdatedSendMessageUI(messageBo)},processPrevMessageSending:function(resendList,localId){for(var i=0;i<resendList.length;i++)resendList[i].localId==localId&&this.deleteMessageUI(resendList[i].prevLocalId)},paintUpdatedSendImageMessageUI:function(messageBo){var localId=messageBo.localId,targetEl=$("#_chat_item_"+localId);if(0==targetEl.length){var status="live";this.paintMessageUI(messageBo,status)}else this.messageItemFactory.paintUpdatedSendImageMessageUI(messageBo);this.messageItemFactory.loadChatImages()},paintUpdateReadCount:function(chatId,processedMsgBoList){var currentChatBo=ChatProxy.getInstance().getCurrentChatBo();null!=currentChatBo&&currentChatBo.chatId==chatId&&this.messageItemFactory.paintUpdatedReadCountUI(processedMsgBoList)},toggleChatOptionLayer:function(){var chatBo=ChatProxy.getInstance().getCurrentChatBo(),optList=ChatProxy.getInstance().getChatRoomOptionList(chatBo,this.isFriend),optItemTmpl=TemplateManager.getInstance().get(ChatUI.CHAT_OPTION_ITEM_TEMPLATE),optList=Mustache.render(optItemTmpl,optList);this.elChatRoomOptionUL.html(optList),this.isShowOptionLayer=!this.isShowOptionLayer;var optBtn=$("#_wrap_page_header").find("li._chatroom_option");optBtn.toggleClass("mdTOP02OptionOpen mdTOP02OptionClose"),this.elChatRoomOption.toggleClass("MdNonDisp"),this.setHeaderView(),this.toggleCurtainLayer()},onClickOptionItem:function(event){if(!event.currentTarget)return!1;var originTarget=$(event.originalTarget||event.target).parent();originTarget.hasClass("ExDisabled")||(originTarget.hasClass("_chat_room_option_invite")?this.processInviteItem():originTarget.hasClass("_chat_room_option_notification")?this.processNotificationItem():originTarget.hasClass("_chat_room_option_block")?originTarget.hasClass("mdLYR02Unblock")?this.processUnblockItem(originTarget):this.processBlockItem(originTarget):originTarget.hasClass("_chat_room_option_photo")?this.processPhotoItem():originTarget.hasClass("_chat_room_option_setting")?this.processSettingItem():originTarget.hasClass("_chat_room_options_createGroup")?this.processCreateGroupItem():originTarget.hasClass("_chat_room_options_eiditGroup")?this.processEditGroupItem():originTarget.hasClass("_chat_room_options_leave")&&this.processLeaveItem())},processOpenChatMemberList:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_MEMBER_LIST})},onClickAddBlock:function(event){if(!event.currentTarget)return!1;var chatBo=ChatProxy.getInstance().getCurrentChatBo(),mid=chatBo.chatId,currentTarget=$(event.currentTarget);currentTarget.hasClass("_btn_add")?this.processAddFriend(mid):currentTarget.hasClass("blocked")?this.processUnBlockFriend(mid):currentTarget.hasClass("unblocked")&&this.processBlockFriend(mid)},removeAlertMessage:function(){var alertMessage=this.elChatRoom.find(".mdMN11Info");alertMessage.addClass("MdNonDisp")},toggleBlockButton:function(){var btnEl=$("#_chat_room_btn_set"),btnBlock=btnEl.find("._btn_block");btnBlock.hasClass("unblocked")?btnBlock.removeClass("unblocked").addClass("blocked").text($.i18n.prop("UNBLOCK")):btnBlock.removeClass("blocked").addClass("unblocked").text($.i18n.prop("BLOCK")),this.toggleBlockBtnInOption(),this.toggleInviteBtn()},processAddFriend:function(mid){ContactProxy.getInstance().findAndAddContactsByMid(mid),this.removeAddNBlockButton(),this.removeAlertMessage(),this.chatProxy.deleteAlertMessage(mid),this.isFriend=!0,this.resize()},processUnBlockFriend:function(mid){DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().unBlockContact(mid,function(){this.toggleBlockButton(),this.paintUnBlockState(),DimmedUI.getInstance().close()}.bind(this))},processBlockFriend:function(mid){DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().blockContact(mid,function(){this.toggleBlockButton(),this.paintBlockState(),DimmedUI.getInstance().close()}.bind(this))},processInviteItem:function(){var chatBo=ChatProxy.getInstance().getCurrentChatBo();chatBo.midType===MIDType.USER?(FriendManagerUI.getInstance().setEventBind({choose:$.proxy(this.onCreateChatRoom,this)}).setExcludeMid([chatBo.chatId]),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_CHOOSE})):chatBo.midType===MIDType.ROOM?(FriendManagerUI.getInstance().setEventBind({choose:$.proxy(this.onAddRoomMember,this)}).setExcludeMid(chatBo.getExcludeContactMid()),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_CHOOSE})):chatBo.midType===MIDType.GROUP&&(FriendManagerUI.getInstance().setEventBind({choose:$.proxy(this.onAddGroupMember,this)}).setExcludeMid(chatBo.getExcludeContactMid()),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_CHOOSE})),this.toggleChatOptionLayer()},onCreateChatRoom:function(contactIds){var chatBo=ChatProxy.getInstance().getCurrentChatBo(),roomMemberMids=_.union(contactIds,chatBo.contactInfo.mid);FriendManagerUI.getInstance().removeAll(),this.isRenderChat=!1,this.clearChatRoomUI(),this.chatProxy.createChatRoom(null,roomMemberMids,!0)},onAddRoomMember:function(contactIds){var chatBo=ChatProxy.getInstance().getCurrentChatBo();this.chatProxy.inviteIntoRoom(chatBo.chatId,contactIds,EventManager.EMPTY),FriendManagerUI.getInstance().close()},onAddGroupMember:function(mids){var chatBo=ChatProxy.getInstance().getCurrentChatBo(),chooseMids=_.uniq(mids);FriendManagerUI.getInstance().close();var groupMemberCount=_.size(chatBo.groupInfo.invitee)+_.size(chatBo.groupInfo.members)+_.size(chooseMids)-1;return groupMemberCount>=LineConfig.MAX_GROUP_MEMBER_COUNT?(alert($.i18n.prop("MSG_OVER_MAXIMUM_MEMBER",LineConfig.MAX_GROUP_MEMBER_COUNT)),!1):void GroupProxy.getInstance().inviteIntoGroup(chatBo.chatId,chooseMids)},processNotificationItem:function(){var chatBo=ChatProxy.getInstance().getCurrentChatBo(),notiArea=this.elChatRoomOptionUL.find("._chat_room_option_notification");chatBo.notification=!chatBo.notification,this.chatProxy.updateChatBo(chatBo.serialize()),notiArea.toggleClass("mdLYR02PushOn mdLYR02PushOff"),this.elChatRoomNotiFlag.toggleClass("MdNonDisp")},processBlockItem:function(){var chatBo=ChatProxy.getInstance().getCurrentChatBo();this.processBlockFriend(chatBo.chatId)},processUnblockItem:function(){var chatBo=ChatProxy.getInstance().getCurrentChatBo();this.processUnBlockFriend(chatBo.chatId)},toggleBlockBtnInOption:function(){var btnBlockInOption=$("._chat_room_option_block");btnBlockInOption.hasClass("mdLYR02Block")?btnBlockInOption.removeClass("mdLYR02Block").addClass("mdLYR02Unblock").find(".mdLYR02Txt").text($.i18n.prop("UNBLOCK")):btnBlockInOption.addClass("mdLYR02Block").removeClass("mdLYR02Unblock").find(".mdLYR02Txt").text($.i18n.prop("BLOCK"))},toggleInviteBtn:function(){var btnInvite=$("._chat_room_option_invite");btnInvite.hasClass("ExDisabled")?btnInvite.removeClass("ExDisabled"):btnInvite.addClass("ExDisabled")},processPhotoItem:function(){this.openPhotoSelector()},processLeaveItem:function(){var chatBo=ChatProxy.getInstance().getCurrentChatBo();if(this.toggleChatOptionLayer(),chatBo.midType===MIDType.ROOM){if(!confirm($.i18n.prop("ROOM_LEAVE_WARNING_TEXT")))return!1;DimmedUI.getInstance().open("",{},{isCenter:!0}),ChatProxy.getInstance().doDeleteChat(chatBo.chatId,null,function(){DimmedUI.getInstance().close(),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_LIST})})}else{if(0==confirm($.i18n.prop("GROUP_LEAVE_WARNING_TEXT")))return!1;DimmedUI.getInstance().open("",{},{isCenter:!0}),GroupProxy.getInstance().leaveGroup(chatBo.chatId,$.proxy(function(){DimmedUI.getInstance().close(),ChatProxy.getInstance().leaveGroup(chatBo.chatId,EventManager.EMPTY),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_LIST})},this))}},leaveGroupByOtherDevice:function(chatId){var chatBo=ChatProxy.getInstance().getCurrentChatBo();chatBo.chatId===chatId&&LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_LIST})},processCreateGroupItem:function(){var chatBo=ChatProxy.getInstance().getCurrentChatBo(),roomMemberMids=_.pluck(chatBo.roomInfo.contacts,"mid");GroupManagerUI.getInstance().setMemberMids(roomMemberMids),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.GROUP_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.GROUP_MANAGER_NEW}),this.toggleChatOptionLayer()},processEditGroupItem:function(){this.toggleChatOptionLayer();var chatBo=ChatProxy.getInstance().getCurrentChatBo();DimmedUI.getInstance().open("",{},{isCenter:!0}),GroupProxy.getInstance().getGroup(chatBo.chatId,$.proxy(function(groupInfo){GroupManagerUI.getInstance().setGroupInfo(groupInfo),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.GROUP_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.GROUP_MANAGER_EDIT}),DimmedUI.getInstance().close()},this))},processSettingItem:function(){this.toggleChatOptionLayer(),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_SETTING})},processDeleteAllChatRecord:function(e){if(!confirm($.i18n.prop("WILL_YOU_CLEAR_CHAT_HISTORY")))return!1;if(!e.currentTarget)return!1;var currentTarget=$(e.currentTarget),chatId=currentTarget.attr("data-chat-id");ChatProxy.getInstance().deleteAllChatHistoryByChatId(chatId)},processOpenMemberContextMenu:function(e){if(!e.currentTarget)return!1;var currentTarget=$(e.currentTarget),mid=currentTarget.attr("data-mid");return mid===AuthInfoKeeper.getInstance().getAuthMid()?!1:void this.showMemberContextMenu(mid)},showMemberContextMenu:function(mid){var contact=ContactProxy.getInstance().getContactFromLocal(mid);(contact.status===ContactStatus.FRIEND||contact.status===ContactStatus.FRIEND_BLOCKED)&&(contact.isFriend=!0),contact.status===ContactStatus.FRIEND_BLOCKED||contact.status===ContactStatus.RECOMMEND_BLOCKED||contact.status===ContactStatus.DELETED_BLOCKED?contact.isBlocked=!0:delete contact.isBlocked,contact.settings===ContactSetting.CONTACT_SETTING_CONTACT_HIDE?contact.isHidden=!0:delete contact.isHidden;var template=TemplateManager.getInstance().get(ChatUI.MEMBER_CONTEXT_MENU_TEMPLATE),html=Mustache.render(template,contact);this.wrapContextMenu.html(html),this.wrapContextMenu.removeClass("MdNonDisp")},onClickFailureContextMenu:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),actionInfo=currentTarget.attr("data-action").split("-"),action=actionInfo[0],localId=actionInfo[1];switch(action){case"resend":this.onResend(localId);break;case"delete":var removeTargetElement=$("#_chat_item_"+localId),beforeElement=removeTargetElement.prev(),beforeLocalId=beforeElement.attr("data-local-id");this.chatProxy.deleteMessageBoByLocalId(localId,beforeLocalId,$.proxy(function(){removeTargetElement.remove()},this));break;case"cancel":this.wrapContextMenu.addClass("MdNonDisp")}this.wrapContextMenu.addClass("MdNonDisp")},onResend:function(localId){"offline"==NetworkChecker.getInstance().getState()?alert($.i18n.prop("COMMON_NETWORK_ERROR")):this.chatProxy.getMessageBoByLocalId(localId,$.proxy(function(messageBo){ChatProxy.getInstance().resendMessage(messageBo)}))},onClickMemberContextMenu:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),actionInfo=currentTarget.attr("data-action").split("-"),action=actionInfo[0],mid=actionInfo[1];switch(action){case"add":ContactProxy.getInstance().findAndAddContactsByMid(mid);break;case"block":confirm($.i18n.prop("WILL_YOU_BLOCK_USERS",1))&&ContactProxy.getInstance().blockContact(mid,EventManager.EMPTY);break;case"unblock":ContactProxy.getInstance().unBlockContact(mid,EventManager.EMPTY);break;case"hide":confirm($.i18n.prop("WILL_YOU_HIDE_USERS",1))&&ContactProxy.getInstance().hideContact(mid,EventManager.EMPTY);break;case"unhide":ContactProxy.getInstance().unHideContact(mid,EventManager.EMPTY);break;case"cancel":this.wrapContextMenu.addClass("MdNonDisp")}this.wrapContextMenu.addClass("MdNonDisp")},resize:function(){if(this.flagChatMode===!0)return!1;var windowHeight=LineMain.WINDOW_HEIGHT,scrollAreaHeight=0;0==this.isFriend?(scrollAreaHeight=windowHeight-LineMain.HEADER_SIZE-LineMain.CHAT_INPUT_SIZE,scrollAreaHeight-=LineMain.CHAT_BLOCK_BTN_SIZE):scrollAreaHeight=windowHeight-LineMain.HEADER_SIZE-LineMain.CHAT_INPUT_SIZE,this.elChatRoomScrollBody.height(scrollAreaHeight),this.wrapChatMemberList.css("top",this.elChatRoomScrollBody.offset().top+"px"),this.elChatEtcLayer.find(".MdScroll01").height(windowHeight-LineMain.HEADER_SIZE)},resizeCurtainLayer:function(){var windowHeight=LineMain.WINDOW_HEIGHT,scrollAreaHeight=windowHeight-LineMain.CHAT_INPUT_SIZE-LineMain.HEADER_SIZE;this.elCurtainLayer.css({top:LineMain.HEADER_SIZE+"px"}),this.elCurtainLayer.height(scrollAreaHeight)},changeScreen:function(options){if(options&&options.type===UIEventManager.EVENT_RESIZE)return this.resize(),!1;if(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.CHAT_ROOM))this.elChatRoomMemberCnt.removeClass("MdNonDisp"),this.elChatRoom.removeClass("MdNonDisp"),this.changeChatRoomHeader(),0==this.isRenderChat?this.paintChatRoom():(0==this.isFriend&&this.toggleAddNBlockButton(),this.downScroll()),this.resize();else if(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.CHAT_SETTING)){this.elChatRoomMemberCnt.addClass("MdNonDisp"),0==this.isFriend&&this.toggleAddNBlockButton();var chatBo=ChatProxy.getInstance().getCurrentChatBo(),headerView=HeaderView.getInstance();headerView.set({back:{}}).setTitle($.i18n.prop("CHAT_SETTINGS")).show();var settingsTmpl=TemplateManager.getInstance().get(ChatUI.CHAT_SETTINGS_TEMPLATE),html=Mustache.render(settingsTmpl,chatBo);this.elChatEtcLayer.html(html),this.elChatEtcLayer.removeClass("MdNonDisp")}else if(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_CHOOSE))0==this.isFriend&&this.toggleAddNBlockButton();else if(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.CHAT_MEMBER_LIST)){this.elChatRoomMemberCnt.addClass("MdNonDisp");var chatBo=ChatProxy.getInstance().getCurrentChatBo();if(chatBo.midType===MIDType.ROOM)var memberMids=_.pluck(chatBo.roomInfo.contacts,"mid");else{if(chatBo.midType!==MIDType.GROUP)return!1;var memberMids=_.pluck(chatBo.groupInfo.members,"mid")}var chatMemberList=ContactProxy.getInstance().getContactListFromMids(memberMids),headerView=HeaderView.getInstance();headerView.set({back:{}}).setTitle($.i18n.prop("JOINED_CHAT_MEMBER",chatMemberList.length)).show();var settingsTmpl=TemplateManager.getInstance().get(ChatUI.CHAT_MEMBERLIST_TEMPLATE),html=Mustache.render(settingsTmpl,{members:chatMemberList});this.elChatEtcLayer.html(html),this.elChatEtcLayer.removeClass("MdNonDisp"),this.resize()}else this.elChatRoomMemberCnt.addClass("MdNonDisp"),LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.GROUP_MANAGER)||LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.ETC)||LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER)||(clearInterval(this.warmupInterval),this.warmupInterval=null,this.isRenderChat=!1,this.chatProxy.setCurrentChatBo(null),this.chatProxy.resendingMsgLocalIdList=[],this.clearChatRoomUI(),this.elChatRoom.addClass("MdNonDisp"))},changeChatRoomHeader:function(){if(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.CHAT_ROOM)){var chatBo=ChatProxy.getInstance().getCurrentChatBo(),chatMidType=chatBo.midType,title="";if(chatBo=this.chatProxy.getChatBoById(chatBo.chatId),chatMidType==MIDType.USER){var contact=ContactProxy.getInstance().getContactFromLocal(chatBo.chatId);title=null!=contact&&1==!!contact.unregister?$.i18n.prop("NO_CHAT_MEMBER"):Utility.makeDisplayNameForUser(contact)}else title=chatMidType==MIDType.ROOM?Utility.makeDisplayNameForRoom(chatBo.roomInfo.contacts):Utility.makeDisplayNameForGroup(chatBo);this.paintChatMemberCount(),this.setHeaderView(title),chatMidType!==MIDType.USER&&(this.paintChatMemberList(),HeaderView.getInstance().update({header_link:{action:$.proxy(this.toggleChatMemberList,this)}})),MenuView.getInstance().set(LineMain.getInstance().getScreenInfo()).hide(),DimmedUI.getInstance().close()}},setHeaderView:function(title){var headerView=HeaderView.getInstance();headerView.update({chat_room_option:{toggle:!0,toggleOn:this.isShowOptionLayer,action:$.proxy(function(){this.toggleChatOptionLayer()},this)},back:{action:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_LIST})}}}),title&&headerView.setTitle(title),headerView.show()},onClickImage:function(e){var oid=$(e.currentTarget).attr("data-oid");if(oid){if("offline"==NetworkChecker.getInstance().getState())return void alert($.i18n.prop("COMMON_NETWORK_ERROR"));CommonUI.getInstance().openImageViewer({title:$.i18n.prop("PHOTOS"),callback:function(){ChatUI.getInstance().downScroll()}}),DimmedUI.getInstance().open("",{},{isCenter:!0}),FileDownloader.getInstance().getChatImageURL(oid,function(url){CommonUI.getInstance().openImageViewer({title:$.i18n.prop("PHOTOS"),url:url,callback:function(){ChatUI.getInstance().downScroll()}}),DimmedUI.getInstance().close()},function(){DimmedUI.getInstance().close()})}else{var localUrl=$(e.currentTarget).attr("data-url");CommonUI.getInstance().openImageViewer({title:$.i18n.prop("PHOTOS"),url:localUrl})}}},ChatUI.getInstance=function(){return null==ChatUI.instance&&(ChatUI.instance=new ChatUI,Mustache.parse(ChatUI.ADD_BLOCK_BTN_TEMPLATE),Mustache.parse(ChatUI.CHAT_OPTION_ITEM_TEMPLATE),Mustache.parse(ChatUI.CHAT_SETTINGS_TEMPLATE),Mustache.parse(ChatUI.CHAT_MEMBER_THUM_TEMPLATE),Mustache.parse(ChatUI.CHAT_MEMBERLIST_TEMPLATE),Mustache.parse(ChatUI.MEMBER_CONTEXT_MENU_TEMPLATE),Mustache.parse(ChatUI.CHAT_IMAGE_CONTEXT_MENU_TEMPLATE),Mustache.parse(ChatUI.CHAT_ROOM_STRUCTURE_TEMPLATE)),ChatUI.instance},ChatUI.instance=null,ChatUI.ADD_BLOCK_BTN_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatRoomAddNBlockTemplate.mustache",ChatUI.CHAT_OPTION_ITEM_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatSettingItemTemplate.mustache",ChatUI.CHAT_SETTINGS_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatSettingsTemplate.mustache",ChatUI.CHAT_MEMBER_THUM_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatMemberThumTemplate.mustache",ChatUI.CHAT_MEMBERLIST_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatMemberListTemplate.mustache",ChatUI.MEMBER_CONTEXT_MENU_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatMemberContextMenuTemplate.mustache",ChatUI.CHAT_IMAGE_CONTEXT_MENU_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatImageContextMenuTemplate.mustache",ChatUI.CHAT_ROOM_STRUCTURE_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatRoomStructureTemplate.mustache";var ChatBO=function(midType,chatId){this.midType=midType,this.contactInfo=null,this.roomInfo=null,this.groupInfo=null,this.chatId=chatId,this.notification=!0,this.createTime=(new Date).getTime(),this.updateTime=this.createTime,this.lastMessageTime=null,this.isKickoutStatus=!1,this.isClearChat=!1,this.firstMsgLocalId=null,this.setContactInfo=function(args){this.contactInfo=new Contact(args)},this.setRoomInfo=function(args){this.roomInfo=new Room(args)},this.setGroupInfo=function(args){this.groupInfo=new Group(args),1==!!args.kickout&&(this.groupInfo.kickout=!0)},this.isNotification=function(){return this.notification},this.setNotification=function(flag){this.notification=flag}};ChatBO.prototype={getMidType:function(){return this.midType},getChatId:function(){return this.chatId},getContactDpName:function(){return this.contactInfo.displayNameOverridden||this.contactInfo.displayName},getRoomMemberListString:function(){for(var tmpList=[],contactList=this.roomInfo.contacts,i=0;i<contactList.length;i++){var contact=contactList[i],dpName=contact.displayNameOverridden||contact.displayName;tmpList.push(dpName)}return tmpList.toString()},getRoomMemberSize:function(){return this.roomInfo.contacts.length},getGroupDPName:function(){return this.groupInfo.name},getGroupMemberSize:function(){return this.groupInfo.members?this.groupInfo.members.length:0},getGroupInviteeSize:function(){return this.groupInfo.invitee?this.groupInfo.invitee.length:0},isJoinedChat:function(){var myMid=AuthInfoKeeper.getInstance().getAuthMid(),flag=!1,members=this.groupInfo.members;return _.find(members,function(contact){1==!!contact&&contact.mid==myMid&&(flag=!0)}),flag},excludeContact:function(excludeMid,listType){var memberList=null,newMemberList=[];if(this.midType==MIDType.USER?memberList=this.contactInfo:this.midType==MIDType.ROOM?memberList=this.roomInfo.contacts:this.midType==MIDType.GROUP&&(memberList=listType&&"invitee"==listType?this.groupInfo.invitee:this.groupInfo.members),1==_.isArray(memberList))for(var i=0;i<memberList.length;i++){var contact=memberList[i];1==!!contact&&contact.mid!=excludeMid&&newMemberList.push(contact)}else memberList&&memberList.mid==excludeMid&&(newMemberList=null);this.updateMemberList(newMemberList,listType)},getExcludeContactMid:function(){return this.midType===MIDType.USER?[this.contactInfo.mid]:this.midType===MIDType.ROOM?_.pluck(this.roomInfo.contacts,"mid"):this.midType===MIDType.GROUP?_.pluck(_.without(_.union(this.groupInfo.members,this.groupInfo.invitee),null),"mid"):void 0},includeContact:function(includeMid){var memberList=null,inviteeList=null,newMemberList=[],flag=!1;this.midType==MIDType.ROOM?memberList=this.roomInfo.contacts:this.midType==MIDType.GROUP&&(memberList=this.groupInfo.members,inviteeList=this.groupInfo.invitee);for(var i=0;i<memberList.length;i++){var contact=memberList[i];1==!!contact&&contact.mid==includeMid&&(flag=!0)}0==flag&&(newMemberList=memberList,newMemberList.push(ContactProxy.getInstance().getContactFromLocal(includeMid)),this.midType==MIDType.GROUP&&this.excludeContact(includeMid,"invitee")),this.updateMemberList(newMemberList)},includeContactList:function(includeMids,listType){var memberList=null,newMemberList=[];this.midType==MIDType.ROOM?memberList=this.roomInfo.contacts:this.midType==MIDType.GROUP&&(memberList=listType&&"invitee"==listType?this.groupInfo.invitee:this.groupInfo.members),newMemberList=null==memberList?[]:memberList;for(var i=0;i<includeMids.length;i++){var bIsMember=!1;_.each(newMemberList,function(contact){1==!!contact&&contact.mid===includeMids[i]&&(bIsMember=!0)}),0==bIsMember&&newMemberList.push(ContactProxy.getInstance().getContactFromLocal(includeMids[i]))}this.updateMemberList(newMemberList,listType)},excludeContactList:function(excludeMids,listType){var memberList=null,newMemberList=[];this.midType==MIDType.ROOM?memberList=this.roomInfo.contacts:this.midType==MIDType.GROUP&&(memberList=listType&&"invitee"==listType?this.groupInfo.invitee:this.groupInfo.members),null!=memberList&&(_.each(memberList,function(contact){_.each(excludeMids,function(mid){1==!!contact&&contact.mid!=mid&&newMemberList.push(contact)})}),0==newMemberList.length&&(newMemberList=null),this.updateMemberList(newMemberList,listType))},updateMemberList:function(newMemberList,listType){this.midType==MIDType.USER?this.contactInfo=newMemberList:this.midType==MIDType.ROOM?this.roomInfo.contacts=newMemberList:this.midType==MIDType.GROUP&&(listType&&"invitee"==listType?this.groupInfo.invitee=newMemberList:this.groupInfo.members=newMemberList)},updateKickoutState:function(){var myMid=AuthInfoKeeper.getInstance().getAuthMid();this.isKickoutStatus=!0,this.groupInfo.kickout=!0,this.updateMemberList(null,"invitee");var newMembers=[],members=this.groupInfo.members;
_.each(members,function(contact){1==!!contact&&contact.mid==myMid&&newMembers.push(contact)}),this.updateMemberList(newMembers)},updateTimestamp:function(timestamp){this.updateTime=timestamp},updateLastMessageTime:function(timestamp){this.lastMessageTime=timestamp},serialize:function(){return Utility.serialize(this)},deSerialize:function(serializedChatBo){this.midType=serializedChatBo.midType,this.chatId=serializedChatBo.chatId,this.notification=serializedChatBo.notification,this.createTime=serializedChatBo.createTime,this.updateTime=serializedChatBo.updateTime,this.isKickoutStatus=serializedChatBo.isKickoutStatus,this.lastMessageTime=serializedChatBo.lastMessageTime,this.isClearChat=serializedChatBo.isClearChat,this.firstMsgLocalId=serializedChatBo.firstMsgLocalId,this.inviter=serializedChatBo.inviter,null!=serializedChatBo.contactInfo&&this.setContactInfo(serializedChatBo.contactInfo),null!=serializedChatBo.roomInfo&&this.setRoomInfo(serializedChatBo.roomInfo),null!=serializedChatBo.groupInfo&&this.setGroupInfo(serializedChatBo.groupInfo)},isGroupMember:function(mid){var bIsMember=!1,memberList=null;return this.midType==MIDType.ROOM?memberList=this.roomInfo.contacts:this.midType==MIDType.GROUP&&(memberList=this.groupInfo.members),_.each(memberList,function(contact){1==!!contact&&contact.mid===mid&&(bIsMember=!0)}),bIsMember},isContainedContact:function(contact){var isMutliChatMember=this.isGroupMember(contact.mid),isSingleChatMember=!1;return this.midType==MIDType.USER&&(isSingleChatMember=this.chatId==contact.mid),!(0==isMutliChatMember&&0==isSingleChatMember)}};var ChatListBO=function(){return null!=ChatListBO.instance?ChatListBO.instance:(this.sendJobWorker=new JobWorker(ChatListBO.NETWORK_JOB_FILE,LineTalkExceptionHandler.getInstance().handle,LineNetworkExceptionHandler.getInstance().handle),this.eventManager=new EventManager,this.chatList=[],this.lastMessageList=[],void(this.unreadMessageList=[]))};ChatListBO.prototype={getEventManager:function(){return this.eventManager},isExistChat:function(chatId){for(var serializedChatBo=null,chatBo=null,i=0;i<this.chatList.length;i++){var chatBoObj=this.chatList[i];chatBoObj.chatId==chatId&&(serializedChatBo=chatBoObj)}return null!=serializedChatBo&&(chatBo=new ChatBO,chatBo.deSerialize(serializedChatBo)),chatBo},removeChat:function(chatId){for(var tmpList=[],i=0;i<this.chatList.length;i++)this.chatList[i].chatId!=chatId&&tmpList.push(this.chatList[i]);this.chatList.length=0,this.chatList=tmpList},createChatRoom:function(contactIds,onSuccess){this.sendJobWorker.send({methodName:"createRoomT",data:[contactIds],success:onSuccess})},inviteIntoRoom:function(roomId,contactIds,onSuccess){this.sendJobWorker.send({methodName:"inviteIntoRoomT",data:[roomId,contactIds],success:onSuccess})},saveChat:function(serializedBo){for(var flag=!0,i=0;i<this.chatList.length;i++)this.chatList[i].chatId==serializedBo.chatId&&(flag=!1);1==flag&&(this.chatList.push(serializedBo),this.sortChatList())},updateChat:function(serializedBo,isSort){for(var i=0;i<this.chatList.length;i++)this.chatList[i].chatId==serializedBo.chatId&&(this.chatList[i]=serializedBo);1==isSort&&this.sortChatList()},updateChatByUnRegisteredContact:function(unRegisterContact){for(var chatList=this.getChatAllList(),retChatList=[],i=0;i<chatList.length;i++){var chatBo=new ChatBO(null,null);chatBo.deSerialize(chatList[i]),chatBo.excludeContact(unRegisterContact.mid),chatBo.excludeContact(unRegisterContact.mid,"invitee");var serializedData=chatBo.serialize();this.updateChat(serializedData,!1),retChatList.push(serializedData)}return this.sortChatList(),retChatList},clear:function(){this.chatList.length=0,this.lastMessageList.length=0,this.unreadMessageList.length=0},deleteChat:function(chatId,messageId,onSuccess){var chatBo=new ChatBO;chatBo.deSerialize(this.getChatBo(chatId));var midType=chatBo.midType;midType==MIDType.USER?null==messageId?(this.removeLocalDateForDeleteChat(chatId,MIDType.USER),onSuccess()):this.sendChatRemoved(chatId,messageId,function(){this.removeLocalDateForDeleteChat(chatId,MIDType.USER),onSuccess()}.bind(this)):midType==MIDType.ROOM?this.leaveRoom(chatId,function(){this.removeLocalDateForDeleteChat(chatId,MIDType.ROOM),onSuccess()}.bind(this)):(this.removeLocalDateForDeleteChat(chatId,MIDType.GROUP),onSuccess())},removeLocalDateForDeleteChat:function(chatId,type,desktopFlag){type==MIDType.GROUP?(this.removeLastMessage(chatId),this.removeUnreadMessageBoList(chatId),1==!!desktopFlag&&"desktop"==desktopFlag&&this.removeChat(chatId)):(this.removeChat(chatId),this.removeLastMessage(chatId),this.removeUnreadMessageBoList(chatId))},realDeleteGroup:function(groupId){this.removeChat(groupId),this.removeLastMessage(groupId),this.removeUnreadMessageBoList(groupId)},leaveGroup:function(chatId,messageId,onSuccess){var chatBo=new ChatBO;chatBo.deSerialize(this.getChatBo(chatId)),this.removeChat(chatId),this.removeLastMessage(chatId),this.removeUnreadMessageBoList(chatId),this.sendChatRemoved(chatId,messageId,onSuccess),onSuccess()},getChatAllList:function(contact){var retList=[];if(1==!!contact)for(var allChatList=this.chatList,i=0;i<allChatList.length;i++){var chatBo=new ChatBO;chatBo.deSerialize(allChatList[i]),chatBo.isContainedContact(contact)&&retList.push(allChatList[i])}else retList=_.filter(this.chatList,function(chatBo){return chatBo.midType==MIDType.GROUP&&1==chatBo.isClearChat?!1:!0});return retList},getOnlyGroupChatList:function(){for(var retList=[],allChatList=this.chatList,i=0;i<allChatList.length;i++){var chatBo=new ChatBO;chatBo.deSerialize(allChatList[i]),chatBo.midType==MIDType.GROUP&&retList.push(allChatList[i])}return retList},sortChatList:function(){var chatList=this.chatList;chatList.sort(function(obj1,obj2){var a=obj1.lastMessageTime||obj1.updateTime,b=obj2.lastMessageTime||obj2.updateTime;return b>a?1:a>b?-1:0}),this.chatList=chatList},getChatBo:function(chatId){for(var chatBo=null,serializedChatBo=null,i=0;i<this.chatList.length;i++)this.chatList[i].chatId==chatId&&(serializedChatBo=this.chatList[i]);return null!=serializedChatBo&&(chatBo=new ChatBO,chatBo.deSerialize(serializedChatBo)),chatBo},sendChatRemoved:function(chatId,lastMsgId,onSuccess){var uniqueKey=(new Date).getTime();this.sendJobWorker.send({methodName:"sendChatRemovedT",data:[chatId,lastMsgId,uniqueKey],uniquekey:uniqueKey,success:onSuccess,error:EventManager.EMPTY})},leaveRoom:function(chatId,onSuccess){this.sendJobWorker.send({methodName:"leaveRoomT",data:[chatId],success:onSuccess,error:EventManager.EMPTY})},getRoom:function(roomId,onSuccess){this.sendJobWorker.send({methodName:"getRoomT",data:[roomId],success:onSuccess,error:EventManager.EMPTY})},saveLastMessageBo:function(messageBo){this.lastMessageList.push(messageBo)},getLastMessageAllList:function(){return this.lastMessageList},removeLastMessage:function(chatId){var tmpList=[];this.lastMessageList=_.each(this.lastMessageList,function(el){el.chatId!=chatId&&tmpList.push(el)}),this.lastMessageList=tmpList},getLastMessageByChatId:function(chatId){for(var messageBo=null,i=0;i<this.lastMessageList.length;i++){var savedMessageBo=this.lastMessageList[i];savedMessageBo.chatId==chatId&&(messageBo=this.lastMessageList[i])}return messageBo},updateLastMessageBo:function(messageBo,status){for(var updateFlag=!1,i=0;i<this.lastMessageList.length;i++){var savedMessageBo=this.lastMessageList[i];if(savedMessageBo.chatId==messageBo.chatId)if(savedMessageBo.localId>messageBo.localId){if(1!=!!status||"delete"!=status)return!1;this.lastMessageList[i]=messageBo,updateFlag=!0}else this.lastMessageList[i]=messageBo,updateFlag=!0}0==updateFlag&&this.saveLastMessageBo(messageBo),this.sortLastMessageList(),this.getEventManager().broadCast(null)},sortLastMessageList:function(){var lastMsgList=this.getLastMessageAllList();lastMsgList.sort(function(obj1,obj2){var a=obj1.message.createdTime,b=obj2.message.createdTime;return b>a?-1:a>b?1:0}),this.lastMessageList=lastMsgList.reverse()},isEqualLocalChatBO:function(serializedBo){var emptyChatBO=new ChatBO;return emptyChatBO.deSerialize(this.getChatBo(serializedBo.chatId)),_.isEqual(emptyChatBO,serializedBo)?!0:void 0},saveUnreadMessageBo:function(messageBo){this.unreadMessageList.push(messageBo)},getUnreadMessageListSize:function(){return this.unreadMessageList.length},initUnreadMessageListSize:function(){this.unreadMessageList=[]},getUnreadMessageBoListByChatId:function(chatId){return _.filter(this.unreadMessageList,function(messageBo){return messageBo.chatId==chatId})},removeUnreadMessageBoList:function(chatId){var newList=_.filter(this.unreadMessageList,function(messageBo){return messageBo.chatId!=chatId});this.unreadMessageList=newList},updateConnectionServerInfo:function(){this.sendJobWorker.sendQuery("pushServerInfo",PersistentStore.getInstance().get("CI_serverList"))}},ChatListBO.getInstance=function(){return null==ChatListBO.instance&&(ChatListBO.instance=new ChatListBO),ChatListBO.instance},ChatListBO.NETWORK_JOB_FILE=BASE_DEFAULT+"src/worker/ChatNetworkJob.js";var ChatMessageBO=function(){return null!=ChatMessageBO.instance?ChatMessageBO.instance:void(this.sendJobWorker=new JobWorker(ChatMessageBO.NETWORK_JOB_FILE,LineTalkExceptionHandler.getInstance().handle,LineNetworkExceptionHandler.getInstance().handle))};ChatMessageBO.prototype={makeTextMessage:function(chatBo,textMsg){var midType=chatBo.getMidType(),message=this.initMessage(chatBo.getChatId(),midType);return new TextMessageBO(message,textMsg)},makeStickerMessage:function(chatBo,pkgId,stkId,stkVer){var midType=chatBo.getMidType(),message=this.initMessage(chatBo.getChatId(),midType);return new StickerMessageBO(message,pkgId,stkId,stkVer)},makeImageMessage:function(chatBo,imgUrl){var midType=chatBo.getMidType(),message=this.initMessage(chatBo.getChatId(),midType);return new ImageMessageBO(message,imgUrl)},makeSystemMessage:function(midType,chatId,sysMsgType,etcObj){var message=this.initMessage(chatId,midType);return new SystemMessageBO(message,sysMsgType,etcObj)},initMessage:function(chatId,midType){var message=new Message;return message.from=null,message.to=chatId,message.toType=midType,message.createdTime=(new Date).getTime(),message},sendMessage:function(serializedData,onSuccess){this.sendJobWorker.send({methodName:"aSyncSendMessageT",data:[serializedData],success:onSuccess})},receiveMessage:function(message){var messageBo=null;switch(message.contentType){case ContentType.NONE:messageBo=new TextMessageBO(message);break;case ContentType.STICKER:messageBo=new StickerMessageBO(message);break;case ContentType.IMAGE:messageBo=new ImageMessageBO(message);break;default:messageBo=new CommonMessageBO(message)}return messageBo},sendChatChecked:function(chatId,messageId,onSuccess){this.sendJobWorker.send({methodName:"sendChatCheckedT",data:[chatId,messageId],success:onSuccess})},updateConnectionServerInfo:function(){this.sendJobWorker.sendQuery("pushServerInfo",PersistentStore.getInstance().get("CI_serverList"))}},ChatMessageBO.getInstance=function(){return null==ChatMessageBO.instance&&(ChatMessageBO.instance=new ChatMessageBO),ChatMessageBO.instance},ChatMessageBO.instance=null,ChatMessageBO.NETWORK_JOB_FILE=BASE_DEFAULT+"src/worker/ChatNetworkJob.js",ChatMessageBO.STATUS={FAIL:0,SENDING:1,SENT:2,RECEIVED:3,CHECKED:4,UPLOADING:5,UPLOADED:6,SYSTEM:1004};var ChatSettingBO=function(){return null!=ChatSettingBO.instance?ChatSettingBO.instance:void 0};ChatSettingBO.prototype={getChatRoomOptionList:function(chatBo,isFriend){var optList=null,contact=null;switch(chatBo.midType){case MIDType.USER:if(contact=ContactProxy.getInstance().getContactFromLocal(chatBo.chatId),optList=1==isFriend?ChatSettingBO.USER:ChatSettingBO.NONE_USER,contact.unregister)return optList=ChatSettingBO.UNREGISTER_USER;break;case MIDType.ROOM:optList=ChatSettingBO.ROOM;break;case MIDType.GROUP:optList=1==chatBo.isKickoutStatus?ChatSettingBO.KICKOUT_GROUP:ChatSettingBO.GROUP}return 1==chatBo.isKickoutStatus?optList:(1==chatBo.notification?optList.notification.inactive&&(delete optList.notification.inactive,optList.notification.active=!0):optList.notification&&optList.notification.active&&(delete optList.notification.active,optList.notification.inactive=!0),chatBo.midType==MIDType.USER&&(contact=ContactProxy.getInstance().getContactFromLocal(chatBo.chatId),contact.status==ContactStatus.FRIEND_BLOCKED||contact.status==ContactStatus.RECOMMEND_BLOCKED||contact.status==ContactStatus.DELETED_BLOCKED?(delete optList.block.inactive,delete optList.invite.active,optList.block.active=!0,optList.invite.inactive=!0):(delete optList.block.active,optList.block.inactive=!0,1==isFriend&&(delete optList.invite.inactive,optList.invite.active=!0))),optList)}},ChatSettingBO.getInstance=function(){return null==ChatSettingBO.instance&&(ChatSettingBO.instance=new ChatSettingBO),ChatSettingBO.instance},ChatSettingBO.instance=null,ChatSettingBO.USER={invite:{active:!0},notification:{active:!0},block:{active:!0},photo:!0,setting:!0,"default":!0},ChatSettingBO.NONE_USER={invite:{inactive:!0},notification:{active:!0},block:{active:!0},photo:!0,setting:!0,"default":!0},ChatSettingBO.UNREGISTER_USER={"default":!0,default2:!0,setting:!0},ChatSettingBO.ROOM={invite:{active:!0},notification:{active:!0},leave:!0,createGroup:!0,photo:!0,setting:!0},ChatSettingBO.GROUP={editGroup:!0,invite:!0,notification:{active:!0},leave:!0,photo:!0,setting:!0},ChatSettingBO.KICKOUT_GROUP={editGroup:{inactive:!0},invite:{inactive:!0},notification:{active:!0,kickout:!0},leave:{inactive:!0},photo:!0,setting:!0};var CommonMessageBO=function(message){this.message=message,this.status=ChatMessageBO.STATUS.RECEIVED,this.localId=CommonMessageBO.getProcessingLocalID(),this.chatId=message.to==AuthInfoKeeper.getInstance().getAuthMid()?message.from:message.to};CommonMessageBO.prototype={getMessage:function(){return this.message}},CommonMessageBO.isSupportedMessageType=function(type){for(var flag=!1,supportedType=[ContentType.NONE,ContentType.STICKER,ContentType.IMAGE,ContentType.FXOS_EVENT],i=0;i<supportedType.length;i++)supportedType[i]==type&&(flag=!0);return flag},CommonMessageBO.getProcessingLocalID=function(){var localIdValue=PersistentStore.getInstance().get(ChatProxy.KEY_LOCAL_ID);(null==localIdValue||""==localIdValue)&&(PersistentStore.getInstance().set(ChatProxy.KEY_LOCAL_ID,1e3),localIdValue=1e3);var localId=Number(localIdValue);return localId++,PersistentStore.getInstance().set(ChatProxy.KEY_LOCAL_ID,localId),localId};var GiftMessageBO=function(message,metadata){this.message=message;var localIdValue=0,localId=0;metadata||(this.chatId=message.from,this.status=ChatMessageBO.STATUS.RECEIVED,localIdValue=PersistentStore.getInstance().get(ChatProxy.KEY_LOCAL_ID),(null==localIdValue||""==localIdValue)&&(PersistentStore.getInstance().set(ChatProxy.KEY_LOCAL_ID,1e3),localIdValue=1e3),localId=Number(localIdValue),this.localId=localId++,PersistentStore.getInstance().set(ChatProxy.KEY_LOCAL_ID,localId))};GiftMessageBO.prototype={getMessage:function(){return this.message}};var ImageMessageBO=function(message,imgUrl){this.message=message,this.imageUrl=imgUrl;imgUrl?(this.message.contentType=ContentType.IMAGE,this.message.hasContent=!0,this.chatId=message.to,this.readCount=0,this.status=ChatMessageBO.STATUS.SENDING):(this.chatId=message.to==AuthInfoKeeper.getInstance().getAuthMid()?message.from:message.to,this.status=ChatMessageBO.STATUS.RECEIVED),this.localId=CommonMessageBO.getProcessingLocalID()};ImageMessageBO.prototype={getMessage:function(){return this.message}};var StickerMessageBO=function(message,pkgId,stkId,stkVer){this.message=message,pkgId?(this.message.contentType=ContentType.STICKER,this.message.contentMetadata={STKID:stkId,STKPKGID:pkgId,STKVER:stkVer},this.chatId=message.to,this.readCount=0,this.status=ChatMessageBO.STATUS.SENDING):(this.chatId=message.to==AuthInfoKeeper.getInstance().getAuthMid()?message.from:message.to,this.status=ChatMessageBO.STATUS.RECEIVED),this.localId=CommonMessageBO.getProcessingLocalID()};StickerMessageBO.prototype={getMessage:function(){return this.message}};var SystemMessageBO=function(message,sysMsgType,etcObj){this.message=message,this.message.contentType=ContentType.FXOS_EVENT,this.message.hasContent=!1,this.status=ChatMessageBO.STATUS.SYSTEM,this.chatId=message.to,this.additionInfo=etcObj,this.sysMsgType=sysMsgType,this.localId=CommonMessageBO.getProcessingLocalID()};SystemMessageBO.prototype={getMessage:function(){return this.message}},SystemMessageBO.TYPE={ADD_BLOCK_ALERT:0,UNREAD_POSITION:1,INIT_CHAT_ROOM_MESSAGE:2,LEFT_CHAT:3,INVITE_INTO_ROOM:4,INVITE_INTO_ROOM_TO_ME:5,ACCEPT_INVITE_INTO_ROOM:6,KICKOUT_FROM_GROUP:7,CHANGE_GROUP_NAME:8,CANCEL_INVITE_INTO_GROUP:9,INVITE_INTO_GROUP:10};var TextMessageBO=function(message,textMsg){this.message=message,1==!!textMsg?(this.message.text=textMsg,this.message.contentType=ContentType.NONE,this.message.hasContent=!1,this.chatId=message.to,this.readCount=0,this.status=ChatMessageBO.STATUS.SENDING):(this.chatId=message.to==AuthInfoKeeper.getInstance().getAuthMid()?message.from:message.to,this.status=ChatMessageBO.STATUS.RECEIVED),this.localId=CommonMessageBO.getProcessingLocalID()};TextMessageBO.prototype={getMessage:function(){return this.message}};var ChatDAO=function(){return null!=ChatDAO.instance?ChatDAO.instance:(this.chatStore=DatabaseStoreFactory.getInstance().getChatListStore(),this.messageStore=DatabaseStoreFactory.getInstance().getChatMessageListStore(),this.lastMessageStore=DatabaseStoreFactory.getInstance().getChatLastMessageListStore(),void(this.eventManager=new EventManager))};ChatDAO.prototype={getEventManager:function(){return this.eventManager},saveChat:function(serializedData,onSuccess){this.chatStore.put(serializedData,onSuccess)},getChat:function(chatId,onSuccess){this.chatStore.search(ChatListStore.INDEX_CHAT_ID,chatId,onSuccess)},updateChat:function(serializedData){this.chatStore.put(serializedData)},deleteChat:function(chatId,onSuccess){this.chatStore.deleteChat(chatId,onSuccess)},getChatAllList:function(onSuccess){this.chatStore.getChatAllList(onSuccess)},saveMessage:function(serializedData,onSuccess){this.messageStore.add(serializedData,onSuccess)},deleteAlertMessage:function(chatId){this.messageStore.deleteAlertMessageByChatId(chatId)},saveSuccessfulLastMessage:function(serializedData){this.lastMessageStore.put(serializedData)},updateMessageBo:function(serializeData){this.messageStore.put(serializeData)},getLastMessageAllList:function(onSuccess){this.lastMessageStore.getLastMessageAllList(onSuccess)},getLastMessageByChatId:function(chatId,onSuccess){this.messageStore.getMessageBoByChatId(chatId,onSuccess)},getSuccessfulLastMessageByChatId:function(chatId,onSuccess,onFailure){this.messageStore.getSuccessfulMessageBoByChatId(chatId,onSuccess,onFailure)},getMessageBoList:function(chatId,blockSize,pageSize,msgStackCount,onSuccess){this.messageStore.getMessageBoList(chatId,blockSize,pageSize,msgStackCount,onSuccess)},getMessageBoByLocalIdForMiddleUpdate:function(localId,message,onSuccess){this.messageStore.getMessageBoByLocalIdForMiddleUpdate(localId,message,onSuccess)},getMessageBoByLocalIdForUpdate:function(localId,message,onSuccess){this.messageStore.getMessageBoByLocalIdForUpdate(localId,message,onSuccess)},getMessageBoByLocalId:function(localId,onSuccess){this.messageStore.getMessageBoByLocalId(localId,onSuccess)},deleteMessageBoByLocalId:function(localId,onSuccess){this.messageStore.deleteMessageBoByLocalId(localId,onSuccess)},deleteMessageBo:function(chatId,onSuccess){this.messageStore.deleteMessageBoByChatId(chatId,onSuccess),this.deleteLastMessageBoByChatId(chatId,EventManager.EMPTY)},deleteLastMessageBoByChatId:function(chatId,onSuccess){this.lastMessageStore.deleteMessageBoByChatId(chatId,onSuccess)},getUnreadMessageAllList:function(onSuccess){this.messageStore.getUnreadMessageAllList(onSuccess)},updateReadCount:function(startPoint,endPoint,onSuccess){this.messageStore.updateReadCount(startPoint,endPoint,onSuccess)},updateCheckedMessage:function(chatId,onSuccess){this.messageStore.updateCheckedMessage(chatId,onSuccess)},updateContent:function(message,onSuccess){this.messageStore.updateContent(message,onSuccess)},getSendingMessageAllList:function(timeGap,onSuccess){this.messageStore.getSendingMessageAllList(timeGap,onSuccess)}},ChatDAO.getInstance=function(){return null==ChatDAO.instance&&(ChatDAO.instance=new ChatDAO),ChatDAO.instance},ChatDAO.instance=null;var MessageItemTemplateFactory=function(){return null!=MessageItemTemplateFactory.instance?MessageItemTemplateFactory.instance:(this.msgListUL=$("#_chat_room_msg_list"),this.tmpListUL=[],this.statusAndDateTpl=TemplateManager.getInstance().get(MessageItemTemplateFactory.STATUS_DATE_TEMPLATE),void this.attachOnlineImageHandleEvent())};MessageItemTemplateFactory.prototype={clearMessageUI:function(){this.msgListUL.empty()},paintMessageUI:function(messageBo,contact,status){var contentType=messageBo.message.contentType,msgLI=null;switch(messageBo=this.setCustomAttributeForUI(messageBo,contact),contentType){case ContentType.NONE:msgLI=TextMessageItem.getInstance().makeMessageUI(messageBo);break;case ContentType.STICKER:msgLI=StickerMessageItem.getInstance().makeMessageUI(messageBo);break;case ContentType.IMAGE:msgLI=ImageMessageItem.getInstance().makeMessageUI(messageBo);break;default:msgLI=UnSupportedMessageItem.getInstance().makeUnSupportedMessageUI(messageBo)}contentType==ContentType.NONE&&(1==!!messageBo.message.location?msgLI=UnSupportedMessageItem.getInstance().makeUnSupportedMessageUI(messageBo):1==!!messageBo.message.contentMetadata&&"RECEIVER"==messageBo.message.contentMetadata.MESSAGE_TARGET&&(msgLI=UnSupportedMessageItem.getInstance().makeUnSupportedMessageUI(messageBo))),this.processMessageUI(status,msgLI,contentType)},paintSystemMessageUI:function(chatBo,messageBo,status){var msgLI=ChatSystemMessageItem.getInstance().makeMessageUI(chatBo,messageBo);this.processMessageUI(status,msgLI)},paintUnreadPositionMessageUI:function(status){var msgLI=ChatSystemMessageItem.getInstance().makeUnreadPositionMessageUI();this.processMessageUI(status,msgLI)},paintDateDivisionMessageUI:function(date,timestamp,status){var msgLI=ChatSystemMessageItem.getInstance().makeDateDivisionMessageUI(date,timestamp);this.processMessageUI(status,msgLI)},paintPrevBtnUI:function(status){var msgLI='<a class="mdMN11Link _prev_msg_btn" href="#">'+$.i18n.prop("LOAD_PREMESSAGE")+"</a>";this.processMessageUI(status,msgLI)},paintUpdatedSendMessageUI:function(messageBo){var obj=null,localId=messageBo.localId;if(messageBo.status!=ChatMessageBO.STATUS.FAIL){if(messageBo.message.contentType===ContentType.IMAGE)return;if(Debugger.isDebugging()){var startTimeObj=_.find(ChatProxy.getInstance().sendMsgStartTimeList,function(obj){return obj.id==messageBo.localId?!0:void 0}),endTimeObj=_.find(ChatProxy.getInstance().sendMsgEndTimeList,function(obj){return obj.id==messageBo.localId?!0:void 0});try{obj={date:Number(endTimeObj.time-startTimeObj.time)+" ms : T"}}catch(e){obj={date:DateFormatUtil.getInstance().getChatRoomDateFormat(messageBo.message.createdTime)}}}else obj={date:DateFormatUtil.getInstance().getChatRoomDateFormat(messageBo.message.createdTime)};var tmp=Mustache.render(this.statusAndDateTpl,obj);$("#_chat_room_msg_"+localId).html(tmp)}else $("#_chat_room_msg_"+localId).addClass("MdNonDisp"),$("#_chat_room_upload_"+localId).addClass("MdNonDisp"),$("#_chat_room_msg_"+localId).siblings(".MdIcoFailure02").removeClass("MdNonDisp");ChatUI.getInstance().downScroll()},paintUpdatedSendImageMessageUI:function(messageBo){var localId=messageBo.localId,uploadPercent=messageBo.CT_Percentage||0;if($("#_chat_room_upload_"+localId).removeClass("MdNonDisp"),100===uploadPercent){$("#_chat_room_upload_"+localId).addClass("MdNonDisp");var sTime=messageBo.message.createdTime,convertTime=DateFormatUtil.getInstance().getChatRoomDateFormat(sTime),obj={date:convertTime};if(Debugger.isDebugging()){var uploadStartTimeObj=_.find(ChatProxy.getInstance().uploadStartTimeList,function(obj){return obj.id==messageBo.localId?!0:void 0}),uploadEndTimeObj=_.find(ChatProxy.getInstance().uploadEndTimeList,function(obj){return obj.id==messageBo.localId?!0:void 0}),uploadTime=Number(uploadEndTimeObj.time-uploadStartTimeObj.time)+" ms : U";obj={date:uploadTime}}var tmp=Mustache.render(this.statusAndDateTpl,obj);$("#_chat_room_msg_"+localId).html(tmp),ChatUI.getInstance().downScroll()}else $("#_chat_room_msg_"+localId).html("").addClass("MdNonDisp"),$("#_chat_room_upload_"+localId).find("._upload_meter").css("width",messageBo.CT_Percentage+"%").html(messageBo.CT_Percentage+"%");messageBo.status==ChatMessageBO.STATUS.FAIL?($("#_chat_room_msg_"+localId).addClass("MdNonDisp"),$("#_chat_room_upload_"+localId).addClass("MdNonDisp"),$("#_fail_btn_"+localId).removeClass("MdNonDisp")):($("#_chat_room_msg_"+localId).removeClass("MdNonDisp"),$("#_fail_btn_"+localId).addClass("MdNonDisp"))},paintUpdatedReadCountUI:function(messageBoList){for(var i=0;i<messageBoList.length;i++){var msgBo=messageBoList[i],targetEl=$("#_chat_room_msg_read_"+msgBo.localId),midType=msgBo.message.toType,readCount=msgBo.readCount;targetEl.removeClass("MdNonDisp"),targetEl.text(midType!=MIDType.USER?$.i18n.prop("READ_COUNT",readCount):$.i18n.prop("READ_MESSAGE"))}},setCustomAttributeForUI:function(messageBo,contact){if(messageBo.CT_thumbnail=Utility.combineProfileURL(contact,LineConfig.LIST_THUMBNAIL_SIZE),messageBo.CT_isMine=null==messageBo.message.from,messageBo.CT_isSending=messageBo.status==ChatMessageBO.STATUS.SENDING,messageBo.CT_isSent=messageBo.status==ChatMessageBO.STATUS.SENT,messageBo.CT_isUploading=messageBo.status==ChatMessageBO.STATUS.UPLOADING,messageBo.CT_isFail=messageBo.status==ChatMessageBO.STATUS.FAIL,messageBo.CT_date=DateFormatUtil.getInstance().getChatRoomDateFormat(messageBo.message.createdTime),messageBo.message.toType==MIDType.USER&&(messageBo.CT_isUser=!0),messageBo.readCount>0&&(messageBo.CT_read=!0,messageBo.CT_readText=messageBo.message.toType==MIDType.USER?$.i18n.prop("READ_MESSAGE"):$.i18n.prop("READ_COUNT",messageBo.readCount)),messageBo.CT_imageUrl=messageBo.imageUrl,messageBo.message.contentPreview?(messageBo.CT_isContentPreview=!0,messageBo.CT_contentPreview="data:image/jpeg;base64,"+messageBo.message.contentPreview):(messageBo.CT_isContentPreview=!1,messageBo.CT_contentPreview=null),messageBo.CT_isMine){var profile=ProfileProxy.getInstance().getProfile();messageBo.CT_displayName=profile.displayNameOverridden||profile.displayName}else messageBo.CT_displayName=1==contact.unregister?ContactUI.UNKNOWN:contact.printName;return messageBo},processMessageUI:function(status,msgLI,type){"live"==status?(this.msgListUL.append(msgLI),this.loadChatImages(!0),ChatUI.getInstance().downScroll(),1==!!type&&type==ContentType.STICKER?ChatUI.getInstance().downScroll(1500):ChatUI.getInstance().downScroll()):this.tmpListUL.push(msgLI)},loadImage:function(messageBo,callback){var oid=messageBo.message.id,localImageUrl=messageBo.imageUrl;if(messageBo.message.contentPreview)callback("data:image/jpeg;base64,"+messageBo.message.contentPreview);else if(oid)FileDownloader.getChatObjectInfoByOid(oid,$.proxy(function(info){"exist"===info.status},this)),FileDownloader.getInstance().getChatPreviewImageURL(oid,function(url){var tempImg=new Image;tempImg.src=url,tempImg.onload=function(){callback(url)},tempImg.onerror=function(){callback(localImageUrl)}},function(){var tempImg=new Image;tempImg.onload=function(){callback(localImageUrl)},tempImg.onerror=function(){callback(MessageItemTemplateFactory.ERROR_IMAGE_URL)},tempImg.src=localImageUrl});else{var tempImg=new Image;tempImg.onload=function(){callback(localImageUrl)},tempImg.onerror=function(){callback(MessageItemTemplateFactory.ERROR_IMAGE_URL)},tempImg.src=localImageUrl}},loadChatImages:function(downScrollFlag){clearInterval(this.loadImageIntervalId);var imgs=this.msgListUL.find('._lazy_chat_image[data-loaded="false"]'),self=this;downScrollFlag&&($.fn.reverse=[].reverse,imgs=imgs.reverse()),imgs.each(function(){var elImage=$(this),localId=elImage.attr("data-local-id");ChatProxy.getInstance().chatDao.getMessageBoByLocalId(localId,function(messageBo){this.loadImage(messageBo,function(url){var img=new Image;img.src=url,img.onload=function(){elImage.attr("src",url).attr("data-loaded","true"),downScrollFlag&&ChatUI.getInstance().downScroll()},downScrollFlag&&ChatUI.getInstance().downScroll()})}.bind(self))})},attachOnlineImageHandleEvent:function(){var RETRY_SLEEP_TIME=5e3,RETRY_COUNT=3;clearInterval(this.loadImageIntervalId);var attachOnlineImage=$.proxy(function(){clearInterval(this.loadImageIntervalId),this.retryCount=0,"hidden"!==document.visibilityState&&LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.CHAT_ROOM)&&(this.loadImageIntervalId=setInterval($.proxy(function(){var imgs=this.msgListUL.find("._lazy_chat_image");imgs.each(function(){$(this).attr("src")===MessageItemTemplateFactory.ERROR_IMAGE_URL&&$(this).attr("data-loaded","false")}),this.loadChatImages(),imgs=this.msgListUL.find('._lazy_chat_image[data-loaded="false"]'),(0===imgs.length||this.retryCount>RETRY_COUNT)&&clearInterval(this.loadImageIntervalId),this.retryCount++},this),RETRY_SLEEP_TIME))},this);window.addEventListener("online",attachOnlineImage,!1)},paintBackupMessageList:function(position){this.msgListUL.prepend(this.tmpListUL.join("")),this.loadChatImages("now"==position),this.tmpListUL=[]},clearTmpListUL:function(){this.tmpListUL=[]}},MessageItemTemplateFactory.getInstance=function(){return null==MessageItemTemplateFactory.instance&&(MessageItemTemplateFactory.instance=new MessageItemTemplateFactory),MessageItemTemplateFactory.instance},MessageItemTemplateFactory.instance=null,MessageItemTemplateFactory.ERROR_IMAGE_URL="/res/img/img_error.png",MessageItemTemplateFactory.STATUS_DATE_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/StatusAndDateTemplate.mustache";var ChatSystemMessageItem=function(){return null!=ChatSystemMessageItem.instance?ChatSystemMessageItem.instance:(this.tpl=TemplateManager.getInstance().get(ChatSystemMessageItem.TEMPLATE),this.postionTpl=TemplateManager.getInstance().get(ChatSystemMessageItem.UNREAD_POSITION_TEMPLATE),void(this.divisionTpl=TemplateManager.getInstance().get(ChatSystemMessageItem.DATE_DIVISION_TEMPLATE)))};ChatSystemMessageItem.prototype={makeMessageUI:function(chatBo,messageBo,panelIdx){var sysMsgText="",roomInfo=null,dpName=null,dpNames=null,profile=null,myDpName=null,inviterDpName=null;switch(messageBo.sysMsgType){case SystemMessageBO.TYPE.INIT_CHAT_ROOM_MESSAGE:roomInfo=chatBo.roomInfo,dpNames=messageBo.additionInfo.dpNames,profile=ProfileProxy.getInstance().getProfile(),myDpName=profile.displayNameOverridden||profile.displayName,sysMsgText=$.i18n.prop("INVITE_FRIENDS_NOTI",myDpName,dpNames);break;case SystemMessageBO.TYPE.ADD_BLOCK_ALERT:sysMsgText=$.i18n.prop("CHAT_WARNING_STRANGER");break;case SystemMessageBO.TYPE.LEFT_CHAT:dpName=messageBo.additionInfo.dpName,sysMsgText=$.i18n.prop("LEFT_CHAT_MEMBER",dpName);break;case SystemMessageBO.TYPE.INVITE_INTO_ROOM:roomInfo=chatBo.roomInfo,dpNames=messageBo.additionInfo.dpName,1==!!messageBo.additionInfo.inviterDpName?inviterDpName=messageBo.additionInfo.inviterDpName:(profile=ProfileProxy.getInstance().getProfile(),inviterDpName=profile.displayNameOverridden||profile.displayName),sysMsgText=$.i18n.prop("INVITE_FRIENDS_NOTI",inviterDpName,dpNames);break;case SystemMessageBO.TYPE.INVITE_INTO_ROOM_TO_ME:roomInfo=chatBo.roomInfo,dpName=messageBo.additionInfo.inviterDpName,dpNames=messageBo.additionInfo.inviteeDpNames,profile=ProfileProxy.getInstance().getProfile(),myDpName=profile.displayName;var combineDpNames="";combineDpNames=dpNames==$.i18n.prop("NO_MEMBER")?myDpName:dpNames+", "+myDpName,sysMsgText=$.i18n.prop("INVITE_FRIENDS_NOTI",dpName,combineDpNames);break;case SystemMessageBO.TYPE.ACCEPT_INVITE_INTO_ROOM:roomInfo=chatBo.roomInfo,dpNames=messageBo.additionInfo.dpName,sysMsgText=$.i18n.prop("ACCEPT_INVITE_INTO_ROOM",dpNames);break;case SystemMessageBO.TYPE.KICKOUT_FROM_GROUP:roomInfo=chatBo.roomInfo,dpNames=messageBo.additionInfo.dpName;
var kickerDpName=null;if(messageBo.additionInfo.kicker==AuthInfoKeeper.getInstance().getAuthMid()){var profile=ProfileProxy.getInstance().getProfile();kickerDpName=profile.displayNameOverridden||profile.displayName}else kickerDpName=messageBo.additionInfo.kicker;sysMsgText=$.i18n.prop("KICKOUT_FROM_GROUP",kickerDpName,dpNames);break;case SystemMessageBO.TYPE.CHANGE_GROUP_NAME:groupInfo=chatBo.groupInfo;var groupName=messageBo.additionInfo.groupName;if(messageBo.additionInfo.dpName==AuthInfoKeeper.getInstance().getAuthMid()){var profile=ProfileProxy.getInstance().getProfile();dpName=profile.displayNameOverridden||profile.displayName}else dpName=messageBo.additionInfo.dpName;sysMsgText=$.i18n.prop("UPDATE_GROUP_NAME",dpName,groupName);break;case SystemMessageBO.TYPE.CANCEL_INVITE_INTO_GROUP:groupInfo=chatBo.groupInfo,dpName=messageBo.additionInfo.dpName;var adaptorDpName=null;if(messageBo.additionInfo.adaptor==AuthInfoKeeper.getInstance().getAuthMid()){var profile=ProfileProxy.getInstance().getProfile();adaptorDpName=profile.displayNameOverridden||profile.displayName}else adaptorDpName=messageBo.additionInfo.adaptor;sysMsgText=$.i18n.prop("CANCEL_INVITE_INTO_GROUP",adaptorDpName,dpName);break;case SystemMessageBO.TYPE.INVITE_INTO_GROUP:dpName=messageBo.additionInfo.inviterDpName,dpNames=messageBo.additionInfo.inviteeDpNames,sysMsgText=$.i18n.prop("INVITE_FRIENDS_NOTI",dpName,dpNames)}return Mustache.render(this.tpl,{text:sysMsgText,panelIdx:panelIdx})},makeUnreadPositionMessageUI:function(){return Mustache.render(this.postionTpl)},makeDateDivisionMessageUI:function(date,timestamp){return Mustache.render(this.divisionTpl,{date:date,timestamp:timestamp})}},ChatSystemMessageItem.getInstance=function(){return null==ChatSystemMessageItem.instance&&(ChatSystemMessageItem.instance=new ChatSystemMessageItem),ChatSystemMessageItem.instance},ChatSystemMessageItem.instance=null,ChatSystemMessageItem.TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/SystemMessageTemplate.mustache",ChatSystemMessageItem.UNREAD_POSITION_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatRoomUnReadPositionTemplate.mustache",ChatSystemMessageItem.DATE_DIVISION_TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ChatRoomDateDivideItemTemplate.mustache";var ImageMessageItem=function(){return null!=ImageMessageItem.instance?ImageMessageItem.instance:void(this.tpl=TemplateManager.getInstance().get(ImageMessageItem.TEMPLATE))};ImageMessageItem.prototype={makeMessageUI:function(messageBo){return messageBo.message&&(messageBo.oid=messageBo.message.id),Mustache.render(this.tpl,messageBo)}},ImageMessageItem.getInstance=function(){return null==ImageMessageItem.instance&&(ImageMessageItem.instance=new ImageMessageItem),ImageMessageItem.instance},ImageMessageItem.instance=null,ImageMessageItem.TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/ImageMessageTemplate.mustache";var StickerMessageItem=function(){return null!=StickerMessageItem.instance?StickerMessageItem.instance:void(this.tpl=TemplateManager.getInstance().get(StickerMessageItem.TEMPLATE))};StickerMessageItem.prototype={makeMessageUI:function(messageBo){return Mustache.render(this.tpl,this.processMetadata(messageBo))},processMetadata:function(messageBo){var metadata=messageBo.message.contentMetadata,stkTxt=$.i18n.prop("STICKER_LOADING");return messageBo.stickerTxt=stkTxt,messageBo.stickerUrl=this.makeStickerUrlForRemote(null==messageBo.message.from||messageBo.message.from==AuthInfoKeeper.getInstance().getAuthMid()?metadata:metadata),messageBo},makeStickerUrlForError:function(){return StickerProxy.getInstance().getStickerImage(stkPkgId,stkId)},makeStickerUrlForRemote:function(metadata){var stkId=metadata.STKID,stkPkgId=metadata.STKPKGID,stkVer=metadata.STKVER,stickerUrl=[],retStr=null;return stickerUrl.push(ServerInfo.getInstance().getStickerHost()),stickerUrl.push("/products/"),stickerUrl.push(this.createPackageVersionPath(stkPkgId,stkVer)),stickerUrl.push("/"),stickerUrl.push(stkPkgId),stickerUrl.push("/"),stickerUrl.push("BlackBerry"),stickerUrl.push("/stickers/"),stickerUrl.push(stkId),stickerUrl.push(".png"),retStr=stickerUrl.join("")},createPackageVersionPath:function(packageId,packageVersion){var path1=Math.floor(packageVersion/1e6),path2=Math.floor(packageVersion/1e3),path3=packageVersion%1e3,str=[];return""==packageVersion&&(path3=100),str.push(path1),str.push("/"),str.push(path2),str.push("/"),str.push(path3),str.join("")}},StickerMessageItem.getInstance=function(){return null==StickerMessageItem.instance&&(StickerMessageItem.instance=new StickerMessageItem),StickerMessageItem.instance},StickerMessageItem.instance=null,StickerMessageItem.TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/StickerMessageTemplate.mustache";var TextMessageItem=function(){return null!=TextMessageItem.instance?TextMessageItem.instance:void(this.tpl=TemplateManager.getInstance().get(TextMessageItem.TEMPLATE))};TextMessageItem.prototype={makeMessageUI:function(messageBo){return messageBo.message.text=Utility.escapeString(messageBo.message.text),messageBo.message.text=Utility.autoLink(messageBo.message.text),Mustache.render(this.tpl,messageBo)}},TextMessageItem.getInstance=function(){return null==TextMessageItem.instance&&(TextMessageItem.instance=new TextMessageItem),TextMessageItem.instance},TextMessageItem.instance=null,TextMessageItem.TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/TextMessageTemplate.mustache";var UnSupportedMessageItem=function(){return null!=UnSupportedMessageItem.instance?UnSupportedMessageItem.instance:void(this.tpl=TemplateManager.getInstance().get(UnSupportedMessageItem.TEMPLATE))};UnSupportedMessageItem.prototype={makeUnSupportedMessageUI:function(messageBo){return messageBo.message.text=$.i18n.prop("NOT_SUPPORT_MESSAGE_FORMAT"),Mustache.render(this.tpl,messageBo)}},UnSupportedMessageItem.getInstance=function(){return null==UnSupportedMessageItem.instance&&(UnSupportedMessageItem.instance=new UnSupportedMessageItem),UnSupportedMessageItem.instance},UnSupportedMessageItem.instance=null,UnSupportedMessageItem.TEMPLATE=BASE_DEFAULT+"src/proxy/chat/ui/template/TextMessageTemplate.mustache";var AlertUI=function(){return null!=AlertUI.instance?AlertUI.instance:(_.extend(this,UIStructure),void this.assigne())};AlertUI.prototype={assigne:function(){this.CONFIRM_TEMPLATE=BASE_DEFAULT+"src/proxy/common/ui/items/Alert.mustache",this.wrapEtcLayer=$("#_wrap_alert")},dynamicAssign:function(){this.btnConfirm=this.wrapEtcLayer.find("._btn_confirm")},dynamicSetEvent:function(){this.wrapEtcLayer.find("._alert_ui").on("submit",function(){return!1}),this.btnConfirm.on(this.EVENT_CLICK,$.proxy(this.onClickConfirm,this))},open:function(htObject){if(!htObject.button)throw"something undefined...";this.confirmObject=htObject,htObject.message&&(htObject.message=htObject.message.replace(/\n/g,"<br>"));var template=TemplateManager.getInstance().get(this.CONFIRM_TEMPLATE),html=Mustache.render(template,htObject);this.wrapEtcLayer.html(html),this.wrapEtcLayer.removeClass("MdNonDisp"),this.dynamicAssign(),this.dynamicSetEvent()},onClickConfirm:function(){this.confirmObject.button.callback&&this.confirmObject.button.callback(),this.close()},close:function(){this.wrapEtcLayer.addClass("MdNonDisp")}},AlertUI.getInstance=function(){return null==AlertUI.instance&&(AlertUI.instance=new AlertUI),AlertUI.instance},AlertUI.instance=null;var CommonUI=function(){return null!=CommonUI.instance?CommonUI.instance:(this.init(),this.loadTemplates(),void LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this)))};CommonUI.prototype={loadTemplates:function(){TemplateManager.getInstance().get(BASE_DEFAULT+"src/proxy/common/ui/items/Confirm.mustache"),TemplateManager.getInstance().get(BASE_DEFAULT+"src/proxy/common/ui/items/LoadingDefault.mustache"),TemplateManager.getInstance().get(BASE_DEFAULT+"src/proxy/common/ui/screen/PincodeInput.mustache"),TemplateManager.getInstance().get(BASE_DEFAULT+"src/proxy/common/ui/screen/SingleInput.mustache"),TemplateManager.getInstance().get(BASE_DEFAULT+"src/proxy/common/ui/screen/ImageViewer.mustache")},init:function(){this.wrapEtcLayer=$("#_wrap_etc")},changeScreen:function(options){return options&&options.type===UIEventManager.EVENT_RESIZE?(this.resize(),!1):void 0},resizeImageViewer:function(imageViewerElement,scrollAreaHeight){imageViewerElement.height(scrollAreaHeight);var imgElement=imageViewerElement.find("._image"),contentAvailHeight=scrollAreaHeight;Utility.imageLoad(imgElement,function(){var topY=(contentAvailHeight-imgElement.height())/2;imgElement.css("margin-top",topY+"px")})},resize:function(){this.wrapBottom=this.wrapEtcLayer.find("._wrap_bottom");var headerSize=HeaderView.getInstance().isShow()?LineMain.HEADER_SIZE:0,scrollAreaHeight=LineMain.WINDOW_HEIGHT-headerSize-this.wrapBottom.height(),imageViewerElement=this.wrapEtcLayer.find("._imageViewer");imageViewerElement&&this.resizeImageViewer(imageViewerElement,scrollAreaHeight)},openSingleInputPage:function(options){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.ETC,subScreen:LineMain.SUB_SCREEN_TYPE.ETC_SINGLE_INPUT_PAGE}),HeaderView.getInstance().set({back:!0}).setTitle(options.title).show(),MenuView.getInstance().hide(),SingleInputView.getInstance().init(options)},openImageViewer:function(options){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.ETC,subScreen:LineMain.SUB_SCREEN_TYPE.ETC_SINGLE_INPUT_PAGE}),HeaderView.getInstance().set({close:{action:function(){LineMain.getInstance().moveBack(),options.callback=options.callback?options.callback:function(){},options.callback()}}}).setTitle(options.title).show(),MenuView.getInstance().hide(),ImageViewer.getInstance().init(options),this.resize()}},CommonUI.getInstance=function(){return null==CommonUI.instance&&(CommonUI.instance=new CommonUI),CommonUI.instance},CommonUI.instance=null;var ConfirmUI=function(){return null!=ConfirmUI.instance?ConfirmUI.instance:(_.extend(this,UIStructure),void this.assigne())};ConfirmUI.prototype={assigne:function(){this.CONFIRM_TEMPLATE=BASE_DEFAULT+"src/proxy/common/ui/items/Confirm.mustache",this.wrapEtcLayer=$("#_wrap_confirm")},dynamicAssign:function(){this.btnLeft=this.wrapEtcLayer.find("._btn_left"),this.btnRight=this.wrapEtcLayer.find("._btn_right")},dynamicSetEvent:function(){this.wrapEtcLayer.find("._confirm_ui").on("submit",function(){return!1}),this.btnLeft.on(this.EVENT_CLICK,$.proxy(this.onClickLeftButton,this)),this.btnRight.on(this.EVENT_CLICK,$.proxy(this.onClickRightButton,this))},open:function(htObject){if(!htObject.button||!htObject.button.left||!htObject.button.right)throw"something undefined...";this.confirmObject=htObject,htObject.message&&(htObject.message=htObject.message.replace(/\n/g,"<br>"));var template=TemplateManager.getInstance().get(this.CONFIRM_TEMPLATE),html=Mustache.render(template,htObject);this.wrapEtcLayer.html(html),this.wrapEtcLayer.removeClass("MdNonDisp"),this.dynamicAssign(),this.dynamicSetEvent()},onClickLeftButton:function(){this.confirmObject.button.left.callback&&this.confirmObject.button.left.callback(),this.close()},onClickRightButton:function(){this.confirmObject.button.right.callback&&this.confirmObject.button.right.callback(),this.confirmObject.closeByCallbackFlag||this.close()},close:function(){this.wrapEtcLayer.addClass("MdNonDisp")}},ConfirmUI.getInstance=function(){return null==ConfirmUI.instance&&(ConfirmUI.instance=new ConfirmUI),ConfirmUI.instance},ConfirmUI.instance=null;var DesktopPincodeInputUI=function(){return null!=DesktopPincodeInputUI.instance?DesktopPincodeInputUI.instance:(_.extend(this,UIStructure),this.assign(),void this.setEvent())};DesktopPincodeInputUI.prototype={assign:function(){this.limitTimer=0,this.TEMPLATE=BASE_DEFAULT+"src/proxy/common/ui/screen/PincodeInput.mustache",this.wrapEtcLayer=$("#_wrap_etc")},setEvent:function(){LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this))},dynamicAssign:function(){this.inputPincode=this.wrapEtcLayer.find("#_input_desktop_picode"),this.btnPincodeOK=this.wrapEtcLayer.find("#_btn_pincode_ok")},dynamicSetEvent:function(){this.inputPincode.off(this.EVENT_INPUT).on(this.EVENT_INPUT,$.proxy(this.inputHandler,this)),this.btnPincodeOK.off(this.EVENT_CLICK).on(this.EVENT_CLICK,$.proxy(this.verifyPhone,this))},changeScreen:function(options){return options&&options.type===UIEventManager.EVENT_RESIZE?!1:(LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.ETC)&&this.wrapEtcLayer.removeClass("MdNonDisp"),void(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.ETC_PINCODE_INPUT)&&this.renderScreen()))},renderScreen:function(){HeaderView.getInstance().update({close:{action:$.proxy(this.close,this)}}).setTitle($.i18n.prop("ENFORCE_SECURITY_LABLE")).show();var template=TemplateManager.getInstance().get(this.TEMPLATE),html=Mustache.render(template,{});this.wrapEtcLayer.html(html),this.dynamicAssign(),this.dynamicSetEvent(),this.setTimer()},inputHandler:function(e){if(!e.currentTarget)return!1;var input=$(e.currentTarget),pincode=input.val();return pincode.length>0?input.parent().removeClass("ExPlaceholder"):input.parent().addClass("ExPlaceholder"),this.isValidPincode()?this.btnPincodeOK.removeClass(this.btnPincodeOK.attr("data-disabled-class")):this.btnPincodeOK.addClass(this.btnPincodeOK.attr("data-disabled-class")),pincode.length>=4&&!Utility.isSystemKey(e)?void e.preventDefault():void 0},isValidPincode:function(){var pincode=this.inputPincode.val();return pincode&&4==pincode.length?!0:!1},verifyPhone:function(){if(this.btnPincodeOK.hasClass(this.btnPincodeOK.attr("data-disabled-class")))return!1;var verifier=this.lineUrlScheme.substr(_.lastIndexOf(this.lineUrlScheme,"/")+1),pinCode=this.inputPincode.val();DimmedUI.getInstance().open("",{},{isCenter:!0}),SettingProxy.getInstance().verifyQrcode(verifier,pinCode,$.proxy(this.onAuthSuccess,this))},setTimer:function(){clearTimeout(this.limitTimer),this.limitTimer=setTimeout($.proxy(this.authFailed,this),1e3*this.expireSec)},onAuthSuccess:function(res){return DimmedUI.getInstance().close(),!res||res.code?(alert($.i18n.prop("WRONG_ENFORCE_SECURITY_NUMBER")),this.inputPincode.val(""),this.inputPincode.parent().addClass("ExPlaceholder"),!1):(alert($.i18n.prop("OK_ENFORCE_SECURITY")),void this.close())},close:function(){clearTimeout(this.limitTimer),LineMain.getInstance().moveBack()},authFailed:function(){alert($.i18n.prop("EXCEED_ENFORCE_SECURITY_TIME")),this.close()},init:function(params){this.lineUrlScheme=params.getParam1(),this.expireSec=params.getParam3(),this.setTimer()}},DesktopPincodeInputUI.getInstance=function(){return null==DesktopPincodeInputUI.instance&&(DesktopPincodeInputUI.instance=new DesktopPincodeInputUI),DesktopPincodeInputUI.instance},DesktopPincodeInputUI.instance=null;var DimmedUI=function(){return null!=DimmedUI.instance?DimmedUI.instance:(_.extend(this,UIStructure),void this.assigne())};DimmedUI.prototype={assigne:function(){this.timer=0,this.DEFAULT=BASE_DEFAULT+"src/proxy/common/ui/items/LoadingDefault.mustache",this.wrapDimmed=$("#_wrap_dimmed"),this.wrapDimmedContent=$("#_wrap_dimmed_content"),this.wrapDimmedLayer=$("#_dimmed_layer")},openTo:function(){},open:function(templateURL,htObject,htOption){clearTimeout(this.timer),this.timer=setTimeout($.proxy(this.autoClose,this),LineConfig.MAX_DIMMED_TIME);var contentURL=this.DEFAULT;templateURL&&(contentURL=templateURL),htObject||(htObject={}),htOption||(htOption={});var recommendContextTemplate=TemplateManager.getInstance().get(contentURL),html=Mustache.render(recommendContextTemplate,htObject);this.wrapDimmedContent.html(html),this.wrapDimmed.removeClass("MdNonDisp"),htOption.dimmedStyle&&this.wrapDimmedLayer.css(htOption.dimmedStyle),htOption.isCenter&&this.contentMoveToCenter()},contentMoveToCenter:function(){var content=this.wrapDimmedContent.children();content.css({"margin-left":$(window).width()/2-content.width()/2,"margin-top":LineMain.WINDOW_HEIGHT/2-content.height()/2})},close:function(){clearTimeout(this.timer),this.wrapDimmedContent.css({"margin-left":0,"margin-top":0}),this.wrapDimmed.addClass("MdNonDisp")},autoClose:function(){this.close()}},DimmedUI.getInstance=function(){return null==DimmedUI.instance&&(DimmedUI.instance=new DimmedUI),DimmedUI.instance},DimmedUI.instance=null;var ImageViewer=function(){return null!=ImageViewer.instance?ImageViewer.instance:void 0};ImageViewer.prototype={IMAGE_VIEWER_VIEW:BASE_DEFAULT+"src/proxy/common/ui/screen/ImageViewer.mustache",init:function(options){this.options=_.extend({url:""},options),this.assign(),this.changeWrapperWithTemplate(),this.setEvents()},changeWrapperWithTemplate:function(){DimmedUI.getInstance().open("",{},{isCenter:!0});var tmpl=Mustache.render(TemplateManager.getInstance().get(this.IMAGE_VIEWER_VIEW),{src:this.options.url});this.wrapEtcLayer.html(tmpl);var btnEl=$("#_chat_room_btn_set");0==btnEl.hasClass("MdNonDisp")&&btnEl.toggleClass("MdNonDisp"),this.changeSrc(this.options.url),$("#_image_viewer_frame").height(LineMain.WINDOW_HEIGHT-LineMain.HEADER_SIZE)},changeSrc:function(src){var imageElement=this.wrapEtcLayer.find("._image")[0];return""===src?void $(imageElement).hide():(setTimeout(function(){DimmedUI.getInstance().close()},LineConfig.DIMMED_TIMEOUT),Utility.imageLoad($(imageElement),function(){$(imageElement).show(),DimmedUI.getInstance().close()}),imageElement.src=src,$(imageElement).hide(),void(imageElement.onerror=function(){DimmedUI.getInstance().close(),imageElement.src="/res/img/img_error.png",$(imageElement).css("width","83px").show()}))},assign:function(){this.wrapEtcLayer=$("#_wrap_etc"),this.wrapEtcLayer.show()},setEvents:function(){this.wrapEtcLayer.find("._save_to_local").on(UIStructure.EVENT_CLICK,$.proxy(function(){if(!navigator.getDeviceStorage)return!1;var imageElement=this.wrapEtcLayer.find("._image")[0];if(!imageElement)return!1;DimmedUI.getInstance().open("",{},{isCenter:!0});var xhr=new XMLHttpRequest;xhr.open("GET",imageElement.src,!0),xhr.responseType="blob",xhr.onreadystatechange=$.proxy(function(){if(xhr.readyState==xhr.DONE){var blob=xhr.response;this.saveImageFile(blob)}},this),xhr.send()},this))},saveImageFile:function(blobObject){Utility.getSDCardStatus($.proxy(function(status){return"unavailable"===status?(alert($.i18n.prop("SD_CARD_STORAGE_FAIL_NO_SDCARD_ERROR")),DimmedUI.getInstance().close(),!1):void Utility.getSDCardFreeSpace($.proxy(function(size){var sdcard=navigator.getDeviceStorage("sdcard"),fileName="Line/"+(new Date).getTime()+".jpg";if(blobObject.size>size)return alert($.i18n.prop("SD_CARD_STORAGE_FAIL_OUT_OF_MEMORY_ERROR")),DimmedUI.getInstance().close(),!1;var request=sdcard.addNamed(blobObject,fileName);request.onsuccess=function(){this.result;alert($.i18n.prop("IMAGE_SAVE_SUCCESS")),DimmedUI.getInstance().close()},request.onerror=function(){alert($.i18n.prop("SD_CARD_STORAGE_FAIL_UNKNOWN_ERROR")),DimmedUI.getInstance().close()}},this))},this))}},ImageViewer.getInstance=function(){return null==ImageViewer.instance&&(ImageViewer.instance=new ImageViewer),ImageViewer.instance},ImageViewer.instance=null;var ListUI=function(element,settings){this.container=element,this._settings=_.extend({dataSource:function(){return[]},idAttribute:"chatid",itemHeight:50,template:"",useHandle:!1,useCss3d:!1,renderer:null},settings),this.dataSource=[],this.assignElements(),this.setEvents(),this.settings("useHandle")&&this.initMoveHandle()};ListUI.prototype={ITEM_HEIGHT:null,ITEM_LENGTH:null,BUFFER_LENGTH:null,settings:function(prop){return this._settings[prop]},bindDataSource:function(){this.dataSource=this.settings("dataSource")()},reload:function(){this.bindDataSource(),this.refresh()},refresh:function(){this.assignProperties(),this.assignElements(),this.resize(),this.initBuffers(),this.initItems(),this.initDraw()},update:function(filter){for(var scrollTop=this.container[0].scrollTop,targetIndex=null,i=this.startIndex;i<this.ITEM_LENGTH+this.startIndex;i++){var source=this.dataSource[i];if(source){var target=_.where([source],filter);if(target.length>0){targetIndex=i;break}}}if(null===targetIndex)this.reload();else{this.bindDataSource();for(var idx=targetIndex;idx<this.ITEM_LENGTH+this.startIndex;idx++)if(this.checkExistItemByDataIdx(idx)){var posY=idx*this.ITEM_HEIGHT;target=_.where(this.buffers,{dataIdx:idx}),target.length>0&&(this.setElementPosition(target[0].element,0,posY),this.changeItemUI(idx,target[0].element))}else this.reRenderItem(idx);this.resize(),this.rePosition()}this.container[0].scrollTop=scrollTop},addItem:function(data){this.dataSource.push(data),this.resize(),this.rePosition()},deleteItem:function(index){this.dataSource.splice(index,1),this.clearAllBuffers(),this.resize(),this.rePosition()},addItemTo:function(index,data){this.dataSource.splice(index,0,data),this.clearAllBuffers(),this.resize(),this.rePosition()},initMoveHandle:function(){var drag=!1;if(this.handleElement=$("._move_handle"),this.handleElement){var min=this.container.offset().top,max=this.container.offset().top+this.container.height()-this.handleElement.height(),left=this.container.offset().left+this.container.width()-this.handleElement.width();this.handleElement.css({top:min+"px",left:left+"px"});var self=this,onMoveHandle=function(e){if(drag){var y="touchmove"===e.type?e.changedTouches[0].pageY-10:e.pageY-10;min>=y&&(y=min),y>=max&&(y=max);var scrollHeight=self.container[0].scrollHeight,percent=parseInt((y-min)/(max-min)*100,10),target=scrollHeight*percent/100;self.handleElement.css("top",y+"px"),self.container[0].scrollTop=target}};this.handleElement.on("mousedown touchstart",$.proxy(function(){drag=!0,itemHeight=this.dummyArea.height()},this)),$(document).on("mousemove touchmove",$.proxy(onMoveHandle,this)).on("mouseup touchend touchcancel",function(){drag=!1})}},rePositionMoveHandle:function(){var scrollHeight=this.container[0].scrollHeight,percent=this.y/scrollHeight*100,posY=this.height*percent/100+this.container.offset().top,max=this.container.offset().top+this.container.height()-this.handleElement.height();posY>max&&(posY=max),this.handleElement.css("top",posY+"px")},assignElements:function(){this.surface=this.container.find("._surf"),this.dummyArea=this.container.find("._area"),this.itemTmpl=this.settings("template")},setEvents:function(){this.container.on("resize",$.proxy(this.resize,this)).on("scroll",$.proxy(this.rePosition,this))},resize:function(){this.dummyArea.height(0),this.width=this.container.width(),this.height=this.container.height(),this.ITEM_LENGTH=Math.floor(this.container.height()/this.ITEM_HEIGHT)+3,this.BUFFER_LENGTH=this.ITEM_LENGTH+1,this.offset.top=this.container.offset().top,this.offset.left=this.container.offset().left,this.dummyArea.height(this.getData().length*this.ITEM_HEIGHT)},getData:function(idx){return idx?this.dataSource[idx]:this.dataSource},rePosition:function(){this.x=this.container[0].scrollLeft,this.y=this.container[0].scrollTop,this.settings("useHandle")&&this.rePositionMoveHandle(),this.hideOverflowItems(),this.draw()},assignProperties:function(){this.buffers=[],this.cache=[],this.offset={},this.item={idx:null,dataIdx:null,element:null,hidden:!1,data:{}},this.x=0,this.y=0,this.ITEM_HEIGHT=this.settings("itemHeight")},initBuffers:function(){for(var obj,i=0;i<this.BUFFER_LENGTH;i++)obj=_.clone(this.item),obj.idx=i,this.buffers.push(obj)},initItems:function(){this.surface.empty();for(var i=0;i<this.BUFFER_LENGTH;i++){i<this.ITEM_LENGTH&&(this.buffers[i].dataIdx=i);var dataIdx=this.buffers[i].dataIdx;if(this.settings("renderer"))var renderFunc=this.settings("renderer"),tmpl=renderFunc(this.dataSource[dataIdx]);else var tmpl=Mustache.render(this.itemTmpl,this.dataSource[dataIdx]);this.buffers[i].element=$($(tmpl)[0]).addClass("_list_item"),i>=this.ITEM_LENGTH&&this.clearBufferByIndex(i),0===dataIdx?this.buffers[i].element.addClass("mdMN02LiF"):this.buffers[i].element.removeClass("mdMN02LiF"),this.surface.append(this.buffers[i].element)}},clearBufferByIndex:function(bufferIdx){this.buffers[bufferIdx].dataIdx=null,this.buffers[bufferIdx].hidden=!0,this.buffers[bufferIdx].element.hide()},clearAllBuffers:function(){for(var i=0;i<this.BUFFER_LENGTH;i++)this.clearBufferByIndex(i)},checkInBoundary:function(element){var offset=element.offset();return offset.top-this.offset.top+offset.height>0&&offset.top-this.offset.top<=this.height},initDraw:function(){for(var itemLength=this.ITEM_LENGTH,i=0;itemLength>i;i++)this.buffers[i].dataIdx=i,this.setElementPosition(this.buffers[i].element,0,this.y+i*this.ITEM_HEIGHT);this.rePosition()},setElementPosition:function(element,x,y){this.useCss3d?(element.css("-webkit-transform","translateY("+y+"px)"),element.css("transform","translateY("+y+"px)"),element.css("-moz-transform","translateY("+y+"px)")):element.css("top",y+"px")},hideOverflowItems:function(){for(var buffer,element,dataIdx,i=0;i<this.buffers.length;i++)buffer=this.buffers[i],element=buffer.element,dataIdx=buffer.dataIdx,this.checkInBoundary(element)&&this.dataSource[dataIdx]||(buffer.dataIdx=null,buffer.hidden=!0,element.css("display","none"))},checkExistItemByDataIdx:function(dataIdx){return 0!==_.filter(this.buffers,function(obj){return obj.dataIdx===dataIdx}).length},draw:function(){var startIndex=0,topHeight=this.surface.position().top+this.y,dummyHeight=this.dummyArea.height(),offsetY=0;this.y>=topHeight?(startIndex=Math.ceil(this.y/this.ITEM_HEIGHT)-Math.ceil(topHeight/this.ITEM_HEIGHT)-1,offsetY=topHeight-this.y):this.surface.position().top<=0&&(startIndex=Math.ceil(this.y/this.ITEM_HEIGHT)),this.startIndex=startIndex;for(var height=this.height,idx=startIndex,endIndex=this.ITEM_LENGTH+startIndex;endIndex>idx;idx++){var itemPosY=idx*this.ITEM_HEIGHT;itemPosY>=dummyHeight||itemPosY+offsetY>height||this.checkExistItemByDataIdx(idx)||this.reRenderItem(idx)}},reRenderItem:function(dataIdx){var posY=dataIdx*this.ITEM_HEIGHT,hiddenItemIndex=this.popHiddenBufferIndex(),buffer=this.buffers[hiddenItemIndex],element=buffer.element;this.setElementPosition(element,0,posY),buffer.hidden=!1,buffer.dataIdx=dataIdx,0===dataIdx?element.addClass("mdMN02LiF"):element.removeClass("mdMN02LiF"),this.changeItemUI(dataIdx,element)},changeItemUI:function(dataIdx,element){var template=this.itemTmpl;if(this.settings("renderer")){var renderFunc=this.settings("renderer");renderedTemplate=$(renderFunc(this.dataSource[dataIdx])).html()}else renderedTemplate=$(Mustache.render(template,this.dataSource[dataIdx])).html();if(this.dataSource[dataIdx]){var idAttr=this.settings("idAttribute");this.dataSource[dataIdx][idAttr]&&element.attr("data-"+idAttr,this.dataSource[dataIdx][idAttr])}element.html(renderedTemplate).show(),Utility.lazyLoadImage(element.find("img"))},popHiddenBufferIndex:function(){for(var hiddenIdx=null,j=0;j<this.buffers.length;j++)if(this.buffers[j].hidden===!0){hiddenIdx=j;break}return hiddenIdx}};var MediaPickerUI=function(config){_.extend(this,UIStructure),this.config={photo:{callback:function(){}}},_.extend(this.config,config),this.assigne(),this.setEvent()};MediaPickerUI.prototype={assigne:function(){this.TEMPLATE=BASE_DEFAULT+"src/proxy/common/ui/items/PickMediaContextMenu.mustache",this.wrapContextMenu=$("#_wrap_context_menu")},setEvent:function(){this.wrapContextMenu.off(this.EVENT_CLICK,".wrap_media_context_menu button").on(this.EVENT_CLICK,".wrap_media_context_menu button",$.proxy(this.onClickMediaContextMenu,this))},pickMedia:function(){var template=TemplateManager.getInstance().get(this.TEMPLATE),html=Mustache.render(template,this.config);this.wrapContextMenu.html(html),this.wrapContextMenu.removeClass("MdNonDisp")},onClickMediaContextMenu:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),action=currentTarget.attr("data-action");switch(action){case"photo":this.onClickPhotoActionMenu();break;case"delete":this.onClickDeleteActionMenu();break;case"cancel":this.wrapContextMenu.addClass("MdNonDisp")}this.wrapContextMenu.addClass("MdNonDisp")},onClickPhotoActionMenu:function(){ActivityHelper({type:"pick",dataType:"image/jpeg",imageQuality:LineMain.UPLOAD_IMAGE_QUALITY,success:$.proxy(function(image){this.config.photo&&this.config.photo.callback&&this.config.photo.callback.apply(this.config.photo.callback,[image])},this)})},onClickDeleteActionMenu:function(){this.config.remove&&this.config.remove.callback&&this.config.remove.callback()}};var SingleInputModule=function(element,maxCount,customEvent){this.wrapper=$(element),this.maxLength=maxCount,this.inputElement=this.wrapper.find("._input_text"),this.currentTextLength=this.wrapper.find("._current_text_lenght"),this.maxTextLength=this.wrapper.find("._max_text_length"),this.inputElement.on("keyup blur change",$.proxy(this.onChangeInput,this)),this.maxTextLength.html(this.maxLength),this.customEvent=customEvent,this.customEvent||(this.customEvent=function(){}),this.inputElement.trigger("change")};SingleInputModule.prototype={onChangeInput:function(e){var text=$(e.target).val(),textLength=text.length;return this.customEvent.apply(this.customEvent),textLength>0&&this.inputElement.parent().attr("data-placeholder-class")?this.inputElement.removeClass(this.inputElement.parent().attr("data-placeholder-class")):this.inputElement.addClass(this.inputElement.parent().attr("data-placeholder-class")),textLength>this.maxLength?(this.inputElement.val(text.substr(0,this.maxLength)),!1):(this.currentTextLength.html(textLength),!0)}};var SingleInputView=function(){return null!=SingleInputView.instance?SingleInputView.instance:void 0};SingleInputView.prototype={SINGLE_INPUT_VIEW:BASE_DEFAULT+"src/proxy/common/ui/screen/SingleInput.mustache",DEFAULT_MAX_LENGTH:20,init:function(options){this.options=_.extend({defaultMessage:"",warnMessage:"",title:"",lowercase:!1,inputTitle:"",passInput:!1,buttonLabel:$.i18n.prop("SAVE"),minLength:0,maxLength:this.DEFAULT_MAX_LENGTH,template:this.SINGLE_INPUT_VIEW,alertMinMax:!1,submit:function(){},onChangeInput:function(){}},options),this.assign(),this.changeWrapperWithTemplate(),this.setEvents(),this.initStrLengthChecker()},changeWrapperWithTemplate:function(){var tmpl=Mustache.render(TemplateManager.getInstance().get(this.options.template),{defaultMessage:this.options.defaultMessage,buttonLabel:this.options.buttonLabel,warnMessage:this.options.warnMessage,inputTitle:this.options.inputTitle,lowercase:this.options.lowercase});this.wrapEtcLayer.html(tmpl),this.textInputElement=this.wrapEtcLayer.find("._text_input"),this.confirmButtonElement=this.wrapEtcLayer.find("._confirm_btn"),setTimeout($.proxy(function(){var input=this.textInputElement[0];input.setAttribute("autocomplete","off"),input.focus();var val=input.value;input.value="",input.value=val},this),200)},assign:function(){this.wrapEtcLayer=$("#_wrap_etc")},setEvents:function(){this.textInputElement.on("keyup keypress blur change",$.proxy(this.onChangeInput,this)),this.confirmButtonElement.on(UIStructure.EVENT_CLICK,$.proxy(this.onTabConfirmBtn,this))},onTabConfirmBtn:function(){var value=$.trim(this.textInputElement.val());if(0===$.trim(this.textInputElement.val()).length&&0!==this.textInputElement.val().length&&this.options.alertMinMax===!0)return alert($.i18n.prop("SETTINGS_PROFILE_FIELD_MIN_MAX_TEXT")),void this.textInputElement.val(value).focus();var textLength=value.length,minLength=this.options.minLength;if(0===textLength&&this.options.minLength>0?(this.confirmButtonElement.addClass("ExDisabled"),this.textInputElement.parent().addClass("ExPlaceholder")):(this.confirmButtonElement.removeClass("ExDisabled"),this.textInputElement.parent().removeClass("ExPlaceholder")),value.length<minLength&&minLength>0){if(!this.options.passInput)return!1;this.options.submit(value)}else value.length>=this.options.minLength&&this.options.submit(value)},onChangeInput:function(e){$.trim(this.textInputElement.val());this.options.onChangeInput(e);var text=$(e.target).val(),textLength=text.length;return 0===textLength&&this.options.minLength>0?(this.confirmButtonElement.addClass("ExDisabled"),this.textInputElement.parent().addClass("ExPlaceholder")):(this.confirmButtonElement.removeClass("ExDisabled"),this.textInputElement.parent().removeClass("ExPlaceholder")),textLength>this.options.maxLength?(this.textInputElement.html(text.substr(0,this.options.maxLength)),!1):(this.wrapEtcLayer.find("._current_length").html(textLength),!0)
},initStrLengthChecker:function(){this.wrapEtcLayer.find("._max_length").html(this.options.maxLength),this.textInputElement.attr("maxlength",this.options.maxLength).trigger("blur")}},SingleInputView.getInstance=function(){return null==SingleInputView.instance&&(SingleInputView.instance=new SingleInputView),SingleInputView.instance},SingleInputView.instance=null;var ContactProxy=function(){return null!=ContactProxy.instance?ContactProxy.instance:(this.assigneeElement(),this.setEvent(),this.lastSyncTime=null,void(this.customStore=PersistentStore.getInstance()))};ContactProxy.prototype={getEventManager:function(){return this.eventManager},assigneeElement:function(){this.isChangedSync=null,this.contactListBO=ContactListBO.getInstance(),this.contactListDAO=ContactListDAO.getInstance(),this.localContactListBO=LocalContactListBO.getInstance(),this.localContactListDAO=LocalContactListDAO.getInstance(),this.newFriendStore=NewFriendPersistentArrayStore.getInstance(),this.eventManager=new EventManager,this.localContactListBo=LocalContactListBO.getInstance()},setEvent:function(){this.contactListBO.getEventManager().regist(this.updateContactList.bind(this)),GroupProxy.getInstance().getEventManager().regist(this.updateGroup.bind(this))},prepareDataStart:function(onSuccess){this.syncContacts(onSuccess)},prepareContactData:function(onSuccess){var tempArr=[];this.contactListDAO.getAllContactList($.proxy(function(event){var cursor=event.target.result;if(cursor){var contactBO=cursor.value;contactBO.printName=ContactProxy.getInstance().getPrintName(contactBO),tempArr.push(contactBO),cursor.continue()}else this.contactListBO.setContactList(tempArr),LineMain.isContactDataOk=!0,this.completeRestore(),onSuccess()},this))},completeRestore:function(){this.newFriendStore.update()},addLocalContact:function(htLocalContact){var localContact=Utility.serialize(new LocalContactBO(htLocalContact));this.localContactListBO.saveContact(localContact),this.localContactListDAO.saveContact(localContact)},addContact:function(htContact){var serializedContact=Utility.serialize(new Contact(htContact));if(!serializedContact.mid)return!1;if(serializedContact.mid===AuthInfoKeeper.getInstance().getAuthMid())return!1;if(this.contactListBO.isEqualLocalContact(serializedContact)&&serializedContact.status!==ContactStatus.RECOMMEND)return!1;this.contactListBO.isNewFriend(serializedContact)&&LineMain.isContactDataOk&&ContactUI.getInstance().increaseContactBadgeCount(serializedContact.mid);var customSerializeContact=this.contactListBO.saveContact(serializedContact);this.contactListDAO.saveContact(customSerializeContact)},addRecommendContact:function(htContact){htContact.status===ContactStatus.UNSPECIFIED&&(htContact.status=ContactStatus.RECOMMEND),this.addContact(htContact)},updateContact:function(htContact){this.addContact(htContact)},getContactListFromMids:function(mids){var memberList=_.map(mids,function(mid){return ContactProxy.getInstance().getContactFromLocal(mid)});return memberList},getNewContactList:function(){var newFriendMids=this.newFriendStore.get(),newContactList=_.map(newFriendMids,$.proxy(function(mid){var contact=_.clone(this.getContactFromLocal(mid));return contact.isNew=!0,contact},this));return newContactList},getFriendList:function(){return this.contactListBO.getFriendList()},getRecommendList:function(){return RecommendProxy.getInstance().getRecommendList()},getBlockedList:function(){return this.contactListBO.getBlockedList()},getHideList:function(){return this.contactListBO.getHideList()},getRecommendByMid:function(mid){return RecommendProxy.getInstance().getRecommendByMid(mid)},getMatchedFriendList:function(search_text){var contactList=this.contactListBO.getFriendList(),searchContactList=_.filter(contactList,function(contact){var searchName=contact.printName,strIndex=searchName.toLowerCase().indexOf(search_text.toLowerCase());return strIndex>-1});return searchContactList},getContactT:function(mid,customCallback){this.contactListBO.getContactT(mid,customCallback)},getContactFromLocal:function(mid){if(mid===AuthInfoKeeper.getInstance().getAuthMid()){var contactMe=this.profileConvertToContact(mid);return contactMe}var contact=this.contactListBO.getContactFromLocal(mid);return contact},profileConvertToContact:function(mid){var contact=new Contact(ProfileProxy.getInstance().getProfile());return _.extend(contact,{mid:mid,attributes:0,capableBuddy:!1,capableMyhome:!1,capableVideoCall:!1,capableVoiceCall:!1,createdTime:0,displayNameOverridden:null,favoriteTime:0,relation:2,settings:0,status:0,statusMessage:null,thumbnailUrl:null,type:null}),contact.thumbnail=Utility.combineProfileURL(contact,LineConfig.LIST_THUMBNAIL_SIZE),contact.printName=ContactProxy.getInstance().getPrintName(contact),contact},getContact:function(mid,customCallback){var contact=this.getContactFromLocal(mid);contact?customCallback(contact):this.contactListBO.getContactT(mid,customCallback)},findContactByUserid:function(userid,callback){this.contactListBO.findContactByUseridT(userid,callback)},findAndAddContactsByUserid:function(userid){var contact=this.contactListBO.findAndAddContactsByUseridT(userid);this.addContact(contact)},findAndAddContactsByMid:function(mid,callback){callback||(callback=function(){}),this.contactListBO.findAndAddContactsByMidT(mid,$.proxy(function(htContact){this.addContact(htContact),callback()},this))},blockContact:function(mid,callback){var contact=_.clone(this.getContactFromLocal(mid));if(!contact)throw"not find mid in friend list";if(contact.status===ContactStatus.FRIEND)contact.status=ContactStatus.FRIEND_BLOCKED;else if(contact.status===ContactStatus.RECOMMEND)contact.status=ContactStatus.RECOMMEND_BLOCKED;else{if(contact.status!==ContactStatus.DELETED)throw"is blocked contact";contact.status=ContactStatus.DELETED_BLOCKED}this.contactListBO.blockContact(contact,$.proxy(function(res){callback.apply(callback,[res]),this.contactListDAO.updateContact(contact)},this))},unBlockContact:function(mid,callback){var contact=_.clone(this.getContactFromLocal(mid));if(!contact)throw"not find mid in blocked contact list";if(contact.status===ContactStatus.FRIEND_BLOCKED)contact.status=ContactStatus.FRIEND;else if(contact.status===ContactStatus.RECOMMEND_BLOCKED)contact.status=ContactStatus.RECOMMEND;else{if(contact.status!==ContactStatus.DELETED_BLOCKED)throw"is unblocked contact";contact.status=ContactStatus.DELETED}this.contactListBO.unBlockContact(contact,$.proxy(function(res){this.contactListDAO.updateContact(contact),callback.apply(callback,[res])},this))},onBlockContactList:function(mids,callback){var totalBlockContactCount=mids.length,blockCount=0;callback||(callback=function(){}),_.each(mids,$.proxy(function(mid){this.blockContact(mid,$.proxy(function(){blockCount++,blockCount===totalBlockContactCount&&callback()},this))},this))},hideContact:function(mid,callback){var contact=_.clone(this.getContactFromLocal(mid));if(!contact)throw"not find mid in friend list";contact.settings=ContactSetting.CONTACT_SETTING_CONTACT_HIDE,this.contactListBO.hideContact(contact,$.proxy(function(res){callback.apply(callback,[res]),this.contactListDAO.updateContact(contact)},this))},unHideContact:function(mid,callback){var contact=_.clone(this.getContactFromLocal(mid));if(!contact)throw"not find mid in friend list";contact.settings=0,this.contactListBO.unHideContact(contact,$.proxy(function(res){this.contactListDAO.updateContact(contact),callback.apply(callback,[res])},this))},onHideContactList:function(mids,callback){var totalHideContactCount=mids.length,hideCount=0;callback||(callback=function(){}),_.each(mids,$.proxy(function(mid){this.hideContact(mid,$.proxy(function(){hideCount++,hideCount===totalHideContactCount&&callback()},this))},this))},deleteContact:function(mid,callback){var contact=_.clone(this.getContactFromLocal(mid));if(!contact)throw"not find mid in friend list";contact.settings=ContactSetting.CONTACT_SETTING_DELETE,this.contactListBO.deleteContact(contact,$.proxy(function(res){this.contactListDAO.updateContact(contact),callback.apply(callback,[res])},this))},updateProfile:function(){ContactUI.getInstance().initProfile()},updateContact:function(contactInfo){this.contactListBO.updateContact(contactInfo),this.contactListDAO.updateContact(contactInfo)},updateGroup:function(group){ContactUI.getInstance().isReady()&&ContactUI.getInstance().updateGroupList(group)},updateContactList:function(serializedContact){ContactUI.getInstance().isReady()&&(this.newFriendStore.update(),ContactUI.getInstance().updateNewFriendList(serializedContact),ContactUI.getInstance().updateFriendList(serializedContact),this.eventManager.broadCast(serializedContact))},removeAll:function(){this.newFriendStore.clear(),this.contactListBO.clear(),this.contactListDAO.clearStore(),ContactUI.instance=null},refreshLastSyncTime:function(){try{SettingProxy.getInstance().getServerTime($.proxy(function(time){var lastSyncTime=Number(time);this.customStore.set("SD_lastSyncTime",lastSyncTime),this.lastSyncTime=lastSyncTime},this))}catch(e){this.lastSyncTime=(new Date).getTime()}},getLastSyncTime:function(){return this.lastSyncTime},loadLocalContactList:function(onSuccess){this.localContactListDAO.getAllContactList(onSuccess)},syncContacts:function(customCallback){this.isChangedSync=!0,this.localContactListBo.parseLocalContact(customCallback)},syncContactsForceAll:function(customCallback){this.isChangedSync=!1,this.localContactListBo.parseLocalContact(customCallback)},migrateContacts:function(callback){LineMain.isMigrateContactOk=!1;var flags=[],resultIds=[];flags.getAllContactIds=!1,flags.getBlockedContactIds=!1,flags.getRecommendationIds=!1,flags.getBlockedRecommendationIds=!1;var flagLength=0;for(var i in flags)flagLength++;var onThriftEnded=$.proxy(function(ids){resultIds=resultIds.concat(ids);var doneCount=0;for(var i in flags)1==flags[i]&&doneCount++;if(doneCount===flagLength){var ids=_.uniq(resultIds);this.migrateContactsToLocal(ids,callback)}},this);this.getAllContactIds($.proxy(function(ids){flags.getAllContactIds=!0,onThriftEnded(ids)},this)),this.getBlockedContactIds($.proxy(function(ids){flags.getBlockedContactIds=!0,onThriftEnded(ids)},this)),this.getRecommendationIds($.proxy(function(ids){flags.getRecommendationIds=!0,onThriftEnded(ids)},this)),this.getBlockedRecommendationIds($.proxy(function(ids){flags.getBlockedRecommendationIds=!0,onThriftEnded(ids)},this))},migrateContactsToLocal:function(ids,callback){return 0===ids.length?(LineMain.isMigrateContactOk=!0,void callback()):void this.getContacts(ids,$.proxy(function(contacts){_.each(contacts,$.proxy(function(contact){this.addContact(contact)},this)),LineMain.isMigrateContactOk=!0,callback()},this))},getAllContactIds:function(callback){this.contactListBO.getAllContactIdsT(callback)},getBlockedContactIds:function(callback){this.contactListBO.getBlockedContactIdsT(callback)},getRecommendationIds:function(callback){this.contactListBO.getRecommendationIdsT(callback)},getBlockedRecommendationIds:function(callback){this.contactListBO.getBlockedRecommendationIdsT(callback)},getContacts:function(ids,callback){this.contactListBO.getContactsT(ids,callback)},processThrifitSync:function(customCallback){this.refreshLastSyncTime(),customCallback||(customCallback=function(){});var localContactList=ContactProxy.getInstance().getLocalContactList(),syncContactList=[];if(this.isChangedSync){var changedLocalContactIds=this.localContactListBo.getChangedLocalContactIds(),changedLocalContactList=_.filter(localContactList,function(contact){return _.contains(changedLocalContactIds,contact.luid)});syncContactList=changedLocalContactList}else syncContactList=localContactList;var maxPartition=100,partions=_.groupBy(syncContactList,function(localContact,key){return Math.floor(key/maxPartition)}),processingCount=0,totalProcessingCount=_.size(partions);if(0===totalProcessingCount||!SettingProxy.getInstance().getProp("privacySyncContacts")&&this.isChangedSync)return this.prepareContactData(customCallback),!1;ContactUI.getInstance().openSyncLoading();var callback=$.proxy(function(res){if(!res)return this.prepareContactData(customCallback),!1;var percent=Math.ceil(++processingCount/totalProcessingCount*100);ContactUI.getInstance().syncProgress(percent),this.localContactListBO.mappingContact(res),100===percent&&(ContactUI.getInstance().SYNC_COMPLETE=!0,this.localContactListBo.clearChangedLocalContact(),this.prepareContactData(customCallback))},this);_.each(partions,$.proxy(function(localContactListPartion){this.contactListBO.syncContactsT(localContactListPartion,callback)},this))},getLocalContactList:function(){return this.localContactListBO.getLocalContactList()},getContactSyncMap:function(){return this.localContactListBO.getContactSyncMap()},getPrintName:function(contact){if(!contact)return!1;var contactSyncMap=this.getContactSyncMap();if(!contactSyncMap)return contact.displayNameOverridden||contact.displayName;var luid=contactSyncMap[contact.mid],localContactList=LocalContactListBO.getInstance().getLocalContactList(),localContact=_.findWhere(localContactList,{luid:luid});return localContact||(localContact={}),contact.displayNameOverridden||localContact.name||contact.displayName},changeDisplayName:function(mid,name,customCallback){this.contactListBO.changeDisplayNameT(mid,name,customCallback)},updateConnectionServerInfo:function(){this.contactListBO.updateConnectionServerInfo()},saveContactBadgeCount:function(count){this.customStore.set("CD_contactBadgeCount",count)},getContactBadgeCount:function(){return this.customStore.get("CD_contactBadgeCount")},debugMode:function(debugInfo){this.contactListBO.jobWorker.sendQuery("pushDebugInfo",debugInfo)}},ContactProxy.getInstance=function(){return null==ContactProxy.instance&&(ContactProxy.instance=new ContactProxy),ContactProxy.instance},ContactProxy.instance=null;var ContactUI=function(){return null!=ContactUI.instance?ContactUI.instance:(_.extend(this,UIStructure),this.assign(),void this.setEvent())};ContactUI.prototype={assign:function(){this.increasedMids=[],this.initUIFlag=!1,this.badgeCount=0,this.hasFriend=!1,this.hasGroup=!1,this.searchTimeout=0,this.wrapContactUI=$("#_wrap_contact_list"),this.wrapDimmedContent=$("#_wrap_dimmed_content"),this.newFriendBadget=$("#_new_friend_badge"),this.WRAP_CONTACT_LIST=BASE_DEFAULT+"src/proxy/contact/ui/items/ContactCollapseItem.mustache",this.PROFILE_ITEM=BASE_DEFAULT+"src/proxy/contact/ui/items/ProfileItem.mustache",this.CONTACT_ITEM=BASE_DEFAULT+"src/proxy/contact/ui/items/ContactItem.mustache",this.INVITEE_ITEM=BASE_DEFAULT+"src/proxy/contact/ui/items/InviteeItem.mustache",this.GROUP_ITEM=BASE_DEFAULT+"src/proxy/contact/ui/items/GroupItem.mustache",this.FRIEND_EMPTY_ITEM=BASE_DEFAULT+"src/proxy/contact/ui/items/FriendEmptyItem.mustache",this.FRIEND_CONTEXT_MENU=BASE_DEFAULT+"src/proxy/contact/ui/items/FriendContextMenuItem.mustache",this.GROUP_CONTEXT_MENU=BASE_DEFAULT+"src/proxy/contact/ui/items/GroupContextMenuItem.mustache",this.SYNC_LOADING_TEMPLATE=BASE_DEFAULT+"src/proxy/contact/ui/items/SyncContactProgress.mustache",TemplateManager.getInstance().get(this.WRAP_CONTACT_LIST),TemplateManager.getInstance().get(this.PROFILE_ITEM),TemplateManager.getInstance().get(this.CONTACT_ITEM),TemplateManager.getInstance().get(this.INVITEE_ITEM),TemplateManager.getInstance().get(this.GROUP_ITEM),TemplateManager.getInstance().get(this.FRIEND_EMPTY_ITEM),TemplateManager.getInstance().get(this.FRIEND_CONTEXT_MENU),TemplateManager.getInstance().get(this.GROUP_CONTEXT_MENU),TemplateManager.getInstance().get(this.SYNC_LOADING_TEMPLATE)},dynamicAssign:function(){this.wrapSearchForm=this.wrapContactUI.find("#_contact_search_form"),this.searchInput=this.wrapSearchForm.find("._search_text"),this.wrapSearchInput=this.searchInput.parent(),this.wrapCancelSearchBtn=this.wrapSearchForm.find("._wrap_btn_cancel"),this.wrapSearchContactList=this.wrapContactUI.find("#_mode_search_list"),this.wrapSearchedGroups=this.wrapSearchContactList.find("#_wrap_searched_groups"),this.searchedGroupList=this.wrapSearchContactList.find("#_searched_group_list"),this.searchedGroupCount=this.wrapSearchContactList.find("#_searched_group_count"),this.wrapSearchedFriends=this.wrapSearchContactList.find("#_wrap_searched_friends"),this.searchedFriendList=this.wrapSearchContactList.find("#_searched_friend_list"),this.searchedFriendCount=this.wrapSearchContactList.find("#_searched_friend_count"),this.wrapSearchedEmpty=this.wrapSearchContactList.find("#_wrap_searched_empty"),this.wrapContactList=this.wrapContactUI.find("#_mode_contact_list"),this.listUI=new ListUI(this.wrapContactList,{dataSource:function(){return ContactProxy.getInstance().getFriendList()},idAttribute:"mid",itemHeight:56,renderer:$.proxy(this.createChatListItemTmpl,this)}),this.wrapProfileList=this.wrapContactList.find("#_contact_list_profile"),this.wrapNewFriendList=this.wrapContactList.find("#_wrap_new_friends"),this.newFriendList=this.wrapNewFriendList.find("#_new_friend_list"),this.newFriendCount=this.wrapNewFriendList.find("#_new_friend_count"),this.wrapInviteeList=this.wrapContactList.find("#_wrap_invitee"),this.inviteeList=this.wrapInviteeList.find("#_invitee_list"),this.inviteeCount=this.wrapInviteeList.find("#_invitee_count"),this.wrapGroupList=this.wrapContactList.find("#_wrap_groups"),this.groupList=this.wrapGroupList.find("#_group_list"),this.groupCount=this.wrapGroupList.find("#_group_count"),this.wrapFriendList=this.wrapContactList.find("#_wrap_friends"),this.friendCount=this.wrapFriendList.find("#_friend_count"),this.wrapEmptyFriendList=this.wrapContactList.find("#_wrap_empty_friends"),this.wrapContextMenu=$("#_wrap_context_menu"),this.EMPTY_SEARCH_HEIGHT=this.wrapSearchedEmpty.height()},setEvent:function(){LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this))},dynamicSetEvent:function(){ProfileProxy.getInstance().getEventManager().regist(this.updateProfile.bind(this)),this.wrapSearchForm.off("keyup","._search_text").on("keyup","._search_text",$.proxy(this.searchContactList,this)),this.wrapContactUI.off(this.EVENT_CLICK,"._btn_cancel").on(this.EVENT_CLICK,"._btn_cancel",$.proxy(this.cancelSearchMode,this)),this.wrapContactList.off(this.EVENT_CLICK,"#_contact_list_profile li").on(this.EVENT_CLICK,"#_contact_list_profile li",$.proxy(this.onClickProfile,this)),this.wrapGroupList.off(this.EVENT_TAP,"#_group_list li").on(this.EVENT_TAP,"#_group_list li",$.proxy(this.onClickGroup,this)),this.wrapGroupList.off(this.EVENT_LONG_TAP,"#_group_list li").on(this.EVENT_LONG_TAP,"#_group_list li",$.proxy(this.onLongTapGroup,this)),this.wrapSearchedGroups.off(this.EVENT_TAP,"#_searched_group_list li").on(this.EVENT_TAP,"#_searched_group_list li",$.proxy(this.onClickGroup,this)),this.wrapSearchedGroups.off(this.EVENT_LONG_TAP,"#_searched_group_list li").on(this.EVENT_LONG_TAP,"#_searched_group_list li",$.proxy(this.onLongTapGroup,this)),this.wrapNewFriendList.off(this.EVENT_TAP,"#_new_friend_list li").on(this.EVENT_TAP,"#_new_friend_list li",$.proxy(this.onClickFriend,this)),this.wrapNewFriendList.off(this.EVENT_LONG_TAP,"#_new_friend_list li").on(this.EVENT_LONG_TAP,"#_new_friend_list li",$.proxy(this.onLongTapFriend,this)),this.wrapFriendList.off(this.EVENT_TAP,"#_friend_list li").on(this.EVENT_TAP,"#_friend_list li",$.proxy(this.onClickFriend,this)),this.wrapFriendList.off(this.EVENT_LONG_TAP,"#_friend_list li").on(this.EVENT_LONG_TAP,"#_friend_list li",$.proxy(this.onLongTapFriend,this)),this.wrapFriendList.off(this.EVENT_TAP,"#_friend_list li").on(this.EVENT_TAP,"#_friend_list li",$.proxy(this.onClickFriend,this)),this.wrapSearchContactList.off(this.EVENT_TAP,"#_searched_friend_list li").on(this.EVENT_TAP,"#_searched_friend_list li",$.proxy(this.onClickFriend,this)),this.wrapSearchContactList.off(this.EVENT_LONG_TAP,"#_searched_friend_list li").on(this.EVENT_LONG_TAP,"#_searched_friend_list li",$.proxy(this.onLongTapFriend,this)),this.wrapSearchContactList.off(this.EVENT_TAP,"#_searched_friend_list li").on(this.EVENT_TAP,"#_searched_friend_list li",$.proxy(this.onClickFriend,this)),this.wrapContextMenu.off(this.EVENT_TAP,".wrap_friend_context_menu button").on(this.EVENT_TAP,".wrap_friend_context_menu button",$.proxy(this.onClickFriendContextMenu,this)),this.wrapContextMenu.off(this.EVENT_TAP,".wrap_group_context_menu button").on(this.EVENT_TAP,".wrap_group_context_menu button",$.proxy(this.onClickGroupContextMenu,this)),this.wrapContactList.off(this.EVENT_TAP,"._btn_add_friend").on(this.EVENT_TAP,"._btn_add_friend",$.proxy(this.onClickAddFriends,this)),this.wrapContactList.off(this.EVENT_TAP,"._btn_setting").on(this.EVENT_TAP,"._btn_setting",$.proxy(this.onClickSetting,this))},changeScreen:function(options){if(this.initUIFlag&&options&&options.type===UIEventManager.EVENT_RESIZE)return this.resize(),!1;if(LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.FRIENDS)?($("body").removeClass("bgTypeG01").removeClass("bgTypeG03"),this.wrapContactUI.removeClass("MdNonDisp")):this.wrapContactUI.addClass("MdNonDisp"),LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.FRIEND_LIST)){var contactCount=ContactProxy.getInstance().getFriendList().length;if(HeaderView.getInstance().update({create_group:!0,edit_friend_list:contactCount?!0:!1}).setTitle([$.i18n.prop("TAP_NAME_FRIENDS"),"(",contactCount,")"].join("")).show(),MenuView.getInstance().set(LineMain.getInstance().getScreenInfo()).show(),this.initUIFlag===!1){var contactListTemplate=TemplateManager.getInstance().get(this.WRAP_CONTACT_LIST);this.wrapContactUI.html(contactListTemplate),this.dynamicAssign(),this.dynamicSetEvent(),this.initSearchForm(),this.initProfile(),this.initNewFriendList(),this.initGroupList(),this.initFriendList(),DimmedUI.getInstance().close(),this.initUIFlag=!0,this.resize(),this.checkEmptyList(),this.SYNC_COMPLETE=!0}else this.checkEmptyList(),this.updateNewFriendList(),this.listUI.refresh(),Utility.lazyLoadImage(this.wrapFriendList.find("img")),this.updateFriendCount()}else LineMain.getInstance().prevSubScreen(LineMain.SUB_SCREEN_TYPE.FRIEND_LIST)&&this.inActivateContactBadge();LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_EDIT)&&FriendManagerUI.getInstance().setEventBind({block:$.proxy(this.onBlockContactList,this),hide:$.proxy(this.onHideContactList,this)})},initSearchForm:function(){this.wrapSearchInput.addClass("ExPlaceholder")},startSearchMode:function(){this.wrapContactList.addClass("MdNonDisp"),this.wrapSearchContactList.removeClass("MdNonDisp"),this.wrapSearchInput.removeClass("ExPlaceholder"),this.wrapCancelSearchBtn.removeClass("MdNonDisp")},cancelSearchMode:function(){this.searchInput.val(""),this.wrapSearchInput.addClass("ExPlaceholder"),this.wrapCancelSearchBtn.addClass("MdNonDisp"),this.wrapContactList.removeClass("MdNonDisp"),this.wrapSearchContactList.addClass("MdNonDisp"),this.resize()},searchContactList:function(){clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout($.proxy(function(){var searchText=$.trim(this.searchInput.val());searchText?(this.startSearchMode(),this.updateSearchList(searchText)):this.cancelSearchMode()},this),200)},updateSearchList:function(searchText){var searchedGroupList=GroupProxy.getInstance().getMatchedGroupList(searchText),searchedGroupCount=searchedGroupList.length,searchedContactList=ContactProxy.getInstance().getMatchedFriendList(searchText),searchedContactCount=searchedContactList.length;0===searchedGroupCount&&0===searchedContactCount?(this.wrapSearchedEmpty.removeClass("MdNonDisp"),this.wrapSearchedGroups.addClass("MdNonDisp"),this.wrapSearchedFriends.addClass("MdNonDisp")):(this.wrapSearchedEmpty.addClass("MdNonDisp"),this.updateSearchGroup(searchedGroupList),this.updateSearchFriend(searchedContactList))},updateSearchGroup:function(searchedGroupList){var searchedGroupCount=searchedGroupList.length;if(this.searchedGroupCount.html(searchedGroupCount),0===searchedGroupCount)this.wrapSearchedGroups.addClass("MdNonDisp");else{var groupTemplate=TemplateManager.getInstance().get(this.GROUP_ITEM),listArr=[];_.each(searchedGroupList,$.proxy(function(group){var output=Mustache.render(groupTemplate,group);listArr.push(output)},this)),this.searchedGroupList.html(listArr.join("")),Utility.lazyLoadImage(this.searchedGroupList.find("img")),this.wrapSearchedGroups.removeClass("MdNonDisp")}},updateSearchFriend:function(searchedContactList){var MAX_SEARCH_COUNT=40,searchedContactCount=searchedContactList.length;if(searchedContactCount>MAX_SEARCH_COUNT&&(searchedContactCount=MAX_SEARCH_COUNT+"+"),searchedContactList=searchedContactList.splice(0,MAX_SEARCH_COUNT),this.searchedFriendCount.html(searchedContactCount),0===searchedContactCount)this.wrapSearchedFriends.addClass("MdNonDisp"),this.wrapSearchedFriends.removeClass("MdM0");else{this.wrapSearchedFriends.addClass("MdM0");var elContactItemTmpl=TemplateManager.getInstance().get(this.CONTACT_ITEM),listArr=[];_.each(searchedContactList,$.proxy(function(contact){var output=Mustache.render(elContactItemTmpl,contact);listArr.push(output)},this)),this.searchedFriendList.html(listArr.join("")),Utility.lazyLoadImage(this.searchedFriendList.find("img")),this.wrapSearchedFriends.removeClass("MdNonDisp")}},initProfile:function(){var profile=ProfileProxy.getInstance().getProfile();profile.thumbnail=Utility.combineProfileURL(profile,56,"myProfile");var profileTemplate=TemplateManager.getInstance().get(this.PROFILE_ITEM),html=Mustache.render(profileTemplate,profile);this.wrapProfileList.html(html),Utility.lazyLoadImage(this.wrapProfileList.find("img")),this.wrapProfileList.find(".mdMN02Li").eq(0).addClass("mdMN02LiF")},updateProfile:function(){this.initProfile()},initNewFriendList:function(){if(!this.initUIFlag)return!1;var newContactList=ContactProxy.getInstance().getNewContactList(),contactCount=newContactList.length,newFriendTemplate=TemplateManager.getInstance().get(this.CONTACT_ITEM);if(this.newFriendCount&&this.newFriendCount.html(contactCount),this.wrapNewFriendList=this.wrapContactList.find("#_wrap_new_friends"),this.newFriendList=this.wrapNewFriendList.find("#_new_friend_list"),0===contactCount)this.newFriendList.addClass("MdNonDisp"),this.wrapNewFriendList.addClass("MdNonDisp");else{var htmlArr=[];_.each(newContactList,$.proxy(function(contact){htmlArr.push(Mustache.render(newFriendTemplate,contact))},this)),this.newFriendList.html(htmlArr.join("")),Utility.lazyLoadImage(this.newFriendList.find("img")),this.newFriendList.removeClass("MdNonDisp"),this.wrapNewFriendList.removeClass("MdNonDisp")}this.newFriendList.find(".mdMN02Li").eq(0).addClass("mdMN02LiF")},updateNewFriendList:function(){this.initNewFriendList()},initInviteeGroupList:function(){var inviteeList=GroupProxy.getInstance().getInviteeList(),groupCount=inviteeList.length;if(this.inviteeCount.html(groupCount),groupCount>0){var groupTemplate=TemplateManager.getInstance().get(this.INVITEE_ITEM),listArr=[];_.each(inviteeList,$.proxy(function(group){var offsetTime=(new Date).getTime()-new Date(group.createdTime).getTime()+LineMain.SERVER_TIME_OFFSET;group.isNew=offsetTime<=LineConfig.NEW_FRIEND_CHECK_TIME,group.thumbnail=Utility.combineProfileURL(group,LineConfig.LIST_THUMBNAIL_SIZE);var output=Mustache.render(groupTemplate,group);listArr.push(output)},this)),this.inviteeList.html(listArr.join("")),Utility.lazyLoadImage(this.inviteeList.find("img")),this.wrapInviteeList.removeClass("MdNonDisp")}else this.wrapInviteeList.addClass("MdNonDisp")},updateInviteeList:function(){this.initInviteeGroupList()},initGroupList:function(){var groupList=GroupProxy.getInstance().getGroupList(),groupCount=groupList.length;if(this.groupCount.html(groupCount),groupCount>0){var groupTemplate=TemplateManager.getInstance().get(this.GROUP_ITEM),listArr=[];_.each(groupList,$.proxy(function(group){var offsetTime=(new Date).getTime()-new Date(group.createdTime).getTime()+LineMain.SERVER_TIME_OFFSET;group.isNew=offsetTime<=LineConfig.NEW_FRIEND_CHECK_TIME,group.thumbnail=Utility.groupProfileURL(group,LineConfig.LIST_THUMBNAIL_SIZE);var output=Mustache.render(groupTemplate,group);listArr.push(output)},this)),this.groupList.html(listArr.join("")),Utility.lazyLoadImage(this.groupList.find("img")),this.wrapGroupList.removeClass("MdNonDisp"),this.hasGroup=!0}else this.wrapGroupList.addClass("MdNonDisp"),this.hasGroup=!1;this.wrapGroupList.find(".mdMN02Li").eq(0).addClass("mdMN02LiF")},updateGroupList:function(){this.initGroupList(),this.checkEmptyList()},initFriendList:function(){var contactList=ContactProxy.getInstance().getFriendList(),friendCount=contactList.length;0===friendCount?(this.hasFriend=!1,this.wrapFriendList.addClass("MdNonDisp")):(this.wrapFriendList.removeClass("MdNonDisp"),this.listUI.bindDataSource(),this.hasFriend=!0),this.updateFriendCount(),this.checkAvailableEditFriend()},updateFriendList:function(serializedContact){if(!serializedContact)return!1;var contactList=ContactProxy.getInstance().getFriendList(),friendCount=contactList.length;0===friendCount?(this.hasFriend=!1,this.wrapFriendList.addClass("MdNonDisp")):(this.wrapFriendList.removeClass("MdNonDisp"),this.listUI.update({mid:serializedContact.mid}),Utility.lazyLoadImage(this.wrapFriendList.find("img")),this.hasFriend=!0),this.updateFriendCount(),this.checkAvailableEditFriend(),this.checkEmptyList()},createChatListItemTmpl:function(contact){var tmpl=TemplateManager.getInstance().get(this.CONTACT_ITEM);return Mustache.render(tmpl,contact)},updateFriendCount:function(){if(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.FRIEND_LIST)){var contactCount=ContactProxy.getInstance().getFriendList().length;this.updateFriendTitle(),this.friendCount.html(contactCount)}},checkEmptyList:function(){if(this.hasGroup===!1&&this.hasFriend===!1){var friendEmptyTemplate=TemplateManager.getInstance().get(this.FRIEND_EMPTY_ITEM),element=Mustache.render(friendEmptyTemplate,SettingProxy.getInstance().getSettings());this.wrapEmptyFriendList.html(element),this.wrapEmptyFriendList.removeClass("MdNonDisp")}else this.wrapEmptyFriendList.addClass("MdNonDisp")},updateFriendTitle:function(){var contactList=ContactProxy.getInstance().getFriendList(),friendCount=contactList.length;HeaderView.getInstance().setTitle([$.i18n.prop("TAP_NAME_FRIENDS"),"(",friendCount,")"].join(""))},checkAvailableEditFriend:function(){if(!LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.FRIEND_LIST))return!1;var contactList=ContactProxy.getInstance().getFriendList(),friendCount=contactList.length;HeaderView.getInstance().update(friendCount>0?{create_group:!0,edit_friend_list:!0}:{create_group:!0,edit_friend_list:!1})},getEventManager:function(){return this.eventManager},onClickProfile:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_PROFILE})},onClickGroup:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),groupId=currentTarget.attr("data-id");this.showGroupDetail(groupId)},showGroupDetail:function(groupId){DimmedUI.getInstance().open("",{},{isCenter:!0}),GroupProxy.getInstance().getGroupT(groupId,function(group){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.GROUP,subScreen:LineMain.SUB_SCREEN_TYPE.GROUP_DETAIL},[group]),DimmedUI.getInstance().close()})},onLongTapGroup:function(event){var currentTarget=$(event.currentTarget),groupId=currentTarget.attr("data-id");this.showGroupContextMenu(groupId)},onClickFriend:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),mid=currentTarget.attr("data-mid");ChatProxy.getInstance().createChatUser(mid,!0)},onLongTapFriend:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),mid=currentTarget.attr("data-mid");this.showFriendContextMenu(mid)},onBlockContactList:function(mids){confirm($.i18n.prop("WILL_YOU_BLOCK_USERS",mids.length))&&(DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().onBlockContactList.apply(ContactProxy.getInstance(),[mids,$.proxy(function(){DimmedUI.getInstance().close(),FriendManagerUI.getInstance().close()
},this)]))},onHideContactList:function(mids){confirm($.i18n.prop("WILL_YOU_HIDE_USERS",mids.length))&&(DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().onHideContactList.apply(ContactProxy.getInstance(),[mids,$.proxy(function(){DimmedUI.getInstance().close(),FriendManagerUI.getInstance().close()},this)]))},onClickAddFriends:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.ADD_CONTACT,subScreen:LineMain.SUB_SCREEN_TYPE.ADD_CONTACT_LIST})},onClickSetting:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_INVITE_FRIENDS})},resize:function(){var windowHeight=LineMain.WINDOW_HEIGHT,scrollAreaHeight=windowHeight-LineMain.HEADER_SIZE-LineMain.MENU_BAR_SIZE-LineMain.SEARCH_BAR_SIZE;this.wrapContactList.height(scrollAreaHeight),this.wrapSearchContactList.height(scrollAreaHeight),this.listUI.refresh(),Utility.lazyLoadImage(this.wrapFriendList.find("img")),this.wrapEmptyFriendList.css("margin-top",20),this.wrapSearchedEmpty.css("padding-top",scrollAreaHeight/2-this.EMPTY_SEARCH_HEIGHT/2)},increaseContactBadgeCount:function(mid){if(_.contains(this.increasedMids,mid))return!1;this.increasedMids.push(mid);var badgeCount=++this.badgeCount;badgeCount>LineConfig.NEW_FRIEND_MAX_BADGE_COUNT&&(badgeCount=LineConfig.NEW_FRIEND_MAX_BADGE_COUNT+"+"),this.newFriendBadget.text(badgeCount),ContactProxy.getInstance().saveContactBadgeCount(badgeCount)},inActivateContactBadge:function(){this.newFriendBadget.text(""),this.badgeCount=0,ContactProxy.getInstance().saveContactBadgeCount(this.badgeCount)},showFriendContextMenu:function(mid){var contact=ContactProxy.getInstance().getContactFromLocal(mid),friendContextMenuTemplate=TemplateManager.getInstance().get(this.FRIEND_CONTEXT_MENU),html=Mustache.render(friendContextMenuTemplate,contact);this.wrapContextMenu.html(html),this.wrapContextMenu.removeClass("MdNonDisp")},showGroupContextMenu:function(groupId){var groupInfo=GroupProxy.getInstance().getGroupFromLocal(groupId),friendContextMenuTemplate=TemplateManager.getInstance().get(this.GROUP_CONTEXT_MENU),html=Mustache.render(friendContextMenuTemplate,groupInfo);this.wrapContextMenu.html(html),this.wrapContextMenu.removeClass("MdNonDisp")},onClickFriendContextMenu:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),actionInfo=currentTarget.attr("data-action").split("-"),action=actionInfo[0],mid=actionInfo[1];switch(action){case"changeName":this.openChangeNameScreen(mid);break;case"chat":ChatProxy.getInstance().createChatUser(mid,!0);break;case"block":confirm($.i18n.prop("WILL_YOU_BLOCK_USERS",1))&&(DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().blockContact(mid,function(){DimmedUI.getInstance().close()}));break;case"hide":confirm($.i18n.prop("WILL_YOU_HIDE_USERS",1))&&(DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().hideContact(mid,function(){DimmedUI.getInstance().close()}));break;case"cancel":this.wrapContextMenu.addClass("MdNonDisp")}this.wrapContextMenu.addClass("MdNonDisp")},openChangeNameScreen:function(mid){var contact=ContactProxy.getInstance().getContactFromLocal(mid);CommonUI.getInstance().openSingleInputPage({defaultMessage:contact.printName,warnMessage:"",maxLength:20,minLength:1,title:$.i18n.prop("TITLE_CHANGE_NAME"),inputTitle:$.i18n.prop("ENTER_YOUR_NAME"),buttonLabel:$.i18n.prop("SAVE"),submit:$.proxy(function(name){this.changeFriendName(contact,name)},this),onChangeInput:function(){}})},changeFriendName:function(contact,name){DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().changeDisplayName(contact.mid,name,$.proxy(function(){DimmedUI.getInstance().close(),LineMain.getInstance().moveBack()},this))},onClickGroupContextMenu:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),actionInfo=currentTarget.attr("data-action").split("-"),action=actionInfo[0],id=actionInfo[1];switch(action){case"chat":ChatProxy.getInstance().createChatGroup(id,null,!0);break;case"leave":if(!confirm($.i18n.prop("GROUP_LEAVE_WARNING_TEXT")))return!1;GroupProxy.getInstance().leaveGroup(id,function(){ChatProxy.getInstance().leaveGroup(id,EventManager.EMPTY)});break;case"detail":this.showGroupDetail(id);break;case"cancel":this.wrapContextMenu.addClass("MdNonDisp")}this.wrapContextMenu.addClass("MdNonDisp")},openSyncLoading:function(){this.SYNC_COMPLETE||(DimmedUI.getInstance().open(this.SYNC_LOADING_TEMPLATE,{},{isCenter:!0,dimmedStyle:{}}),this.SYNC_COMPLETE=!0),this.progressPercentText=this.wrapDimmedContent.find("#_percent_txt"),this.progressPercentGraphe=this.wrapDimmedContent.find("#_percent_graph")},syncProgress:function(percent){this.progressPercentText.text(percent),100>percent?this.progressPercentGraphe.animate({width:percent+"%"},200):this.progressPercentGraphe.animate({width:"100%"},0)},closeSyncLoading:function(){DimmedUI.getInstance().close()},isReady:function(){return this.initUIFlag}},ContactUI.getInstance=function(){return null==ContactUI.instance&&(ContactUI.instance=new ContactUI),ContactUI.instance},ContactUI.instance=null,ContactUI.UNKNOWN="unknown";var FriendManagerUI=function(){return null!=FriendManagerUI.instance?FriendManagerUI.instance:(_.extend(this,UIStructure),this.initProperty(),this.assigne(),this.setEvent(),void this.preLoad())};FriendManagerUI.prototype={initProperty:function(){this.checkedMids=[],this.selectedMids=[],this.contactList=ContactProxy.getInstance().getFriendList()},assigne:function(){this.initUIFlag=!1,this.isBtnActivate=!1,this.wrapFriendManager=$("#_wrap_friend_manager"),this.WRAP_FRIEND_MANAGER=BASE_DEFAULT+"src/proxy/contact/ui/items/FriendManagerTemplate.mustache",this.FRIEND_MANAGER_ITEM=BASE_DEFAULT+"src/proxy/contact/ui/items/FriendManagerItem.mustache"},dynamicAssigne:function(){this.wrapHeader=this.wrapFriendManager.find("._wrap_header"),this.wrapHeaderTitle=this.wrapHeader.find("._wrap_friend_manager_title"),this.wrapSearch=this.wrapFriendManager.find("._wrap_search"),this.wrapScrollArea=this.wrapFriendManager.find("._wrap_scroll_area"),this.wrapFriendCount=this.wrapFriendManager.find("._wrap_friend_count"),this.wrapFriendList=this.wrapFriendManager.find("._wrap_friend_list"),this.wrapBottom=this.wrapFriendManager.find("._wrap_bottom"),this.wrapNoResult=this.wrapFriendManager.find("._wrap_no_result"),this.wrapNoFriend=this.wrapFriendManager.find("._wrap_no_friend"),this.wrapEditFriendBtn=this.wrapFriendManager.find("._wrap_edit_friend_btn"),this.wrapChooseFriendBtn=this.wrapFriendManager.find("._wrap_choose_friend_btn"),this.wrapNewBtn=this.wrapFriendManager.find("._wrap_chat_room_btn"),this.btnClose=this.wrapFriendManager.find("._btn_close")},setEvent:function(){this.callback={block:function(){},hide:function(){},choose:function(){},new_chat:function(){},create_group:function(){}},LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this))},preLoad:function(){TemplateManager.getInstance().get(this.WRAP_FRIEND_MANAGER),TemplateManager.getInstance().get(this.FRIEND_MANAGER_ITEM)},initComponent:function(){this.elContactItemTmpl=TemplateManager.getInstance().get(this.FRIEND_MANAGER_ITEM),this.listUI=new ListUI(this.wrapScrollArea,{dataSource:$.proxy(function(){return this.getContactListData()},this),idAttribute:"mid",itemHeight:56,renderer:$.proxy(this.createFriendListItemTmpl,this)})},createFriendListItemTmpl:function(contact){var cloneContact=_.clone(contact);return cloneContact?(_.contains(this.checkedMids,cloneContact.mid)?cloneContact.isChecked=!0:delete cloneContact.isChecked,Mustache.render(this.elContactItemTmpl,cloneContact)):Mustache.render(this.elContactItemTmpl,{})},dynamicSetEvent:function(){this.wrapSearch.off("keyup","._search_text").on("keyup","._search_text",$.proxy(this.searchContactList,this)),this.wrapSearch.off(this.EVENT_RELEASE,"._btn_cancel").on(this.EVENT_RELEASE,"._btn_cancel",$.proxy(this.cancelSearchMode,this)),this.wrapScrollArea.off(this.EVENT_CLICK,"._wrap_friend_list_searched li").on(this.EVENT_CLICK,"._wrap_friend_list_searched li",$.proxy(this.onClickCheckbox,this)),this.wrapFriendManager.off(this.EVENT_CLICK,"._btn_close").on(this.EVENT_CLICK,"._btn_close",$.proxy(this.close,this)),this.wrapFriendManager.off(this.EVENT_CLICK,"._wrap_friend_list li").on(this.EVENT_CLICK,"._wrap_friend_list li",$.proxy(this.onClickCheckbox,this)),this.wrapFriendManager.off(this.EVENT_CLICK,"._btn_hide").on(this.EVENT_CLICK,"._btn_hide",$.proxy(this.onClickHide,this)),this.wrapFriendManager.off(this.EVENT_CLICK,"._btn_block").on(this.EVENT_CLICK,"._btn_block",$.proxy(this.onClickBlock,this)),this.wrapFriendManager.off(this.EVENT_CLICK,"._btn_choose").on(this.EVENT_CLICK,"._btn_choose",$.proxy(this.onClickChoose,this)),this.wrapFriendManager.off(this.EVENT_CLICK,"._btn_chat").on(this.EVENT_CLICK,"._btn_chat",$.proxy(this.onClickNewChat,this)),this.wrapFriendManager.off(this.EVENT_CLICK,"._btn_group").on(this.EVENT_CLICK,"._btn_group",$.proxy(this.onClickCreateGroup,this))},setEventBind:function(callbackObject){return _.extend(this.callback,callbackObject),this},setExcludeMid:function(mids){return this.selectedMids=mids,this},changeScreen:function(options){if(this.initUIFlag&&options&&options.type===UIEventManager.EVENT_RESIZE)return this.resize(),!1;if(LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER)){if(this.initUIFlag===!1){var contactCollapseTmpl=TemplateManager.getInstance().get(this.WRAP_FRIEND_MANAGER);this.wrapFriendManager.html(contactCollapseTmpl),this.dynamicAssigne(),this.contactListData=[],this.initComponent(),this.dynamicSetEvent(),this.cancelSearchMode(),this.initUIFlag=!0}this.initFriendList(),this.allBtnGroupHide(),this.wrapFriendManager.removeClass("MdNonDisp"),this.resize()}else this.wrapFriendManager.addClass("MdNonDisp");LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_EDIT)&&(this.wrapHeaderTitle.text($.i18n.prop("EDIT_FRIENDS")),this.wrapEditFriendBtn.removeClass("MdNonDisp")),LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_CHOOSE)&&(this.wrapHeaderTitle.text($.i18n.prop("CHOOSE_FRIEND_CHATS")),this.wrapChooseFriendBtn.removeClass("MdNonDisp")),LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_NEW)&&(this.wrapHeaderTitle.text($.i18n.prop("CHOOSE_FRIEND_CHATS")),this.wrapNewBtn.removeClass("MdNonDisp"))},resize:function(){var windowHeight=LineMain.WINDOW_HEIGHT,scrollAreaHeight=windowHeight-LineMain.HEADER_SIZE-LineMain.SEARCH_BAR_SIZE-LineMain.BUTTON_GROUP_SIZE;this.wrapScrollArea.height(scrollAreaHeight),this.wrapNoResult.css("margin-top",scrollAreaHeight/2-12),this.wrapNoFriend.css("margin-top",scrollAreaHeight/2-12),this.listUI.refresh(),Utility.lazyLoadImage(this.wrapFriendList.find("img"))},allBtnGroupHide:function(){this.wrapChooseFriendBtn.addClass("MdNonDisp"),this.wrapEditFriendBtn.addClass("MdNonDisp"),this.wrapNewBtn.addClass("MdNonDisp")},onClickCheckbox:function(e){if(!e.currentTarget)return!1;var currentTarget=$(e.currentTarget),checkbox=currentTarget.find("input[type=checkbox]"),toggleBox=checkbox.parent();checkbox.prop("checked")?(toggleBox.removeClass(toggleBox.attr("data-toggle-class")),checkbox.prop("checked",!1),this.checkedMids=_.without(this.checkedMids,checkbox.val())):(toggleBox.addClass(toggleBox.attr("data-toggle-class")),checkbox.prop("checked",!0),this.checkedMids.push(checkbox.val())),this.updateCheckedBox(),this.updateBtnActivate()},updateCheckedBox:function(){this.checkedMids=_.uniq(this.checkedMids)},updateBtnActivate:function(){var checkedCount=this.checkedMids.length;checkedCount>0?(this.isBtnActivate=!0,this.wrapBottom.find("a").each(function(){$(this).removeClass($(this).attr("data-disabled-class"))}),this.wrapBottom.find("._checked_count").each(function(){$(this).addClass($(this).attr("data-show-class")).text(checkedCount)})):(this.isBtnActivate=!1,this.wrapBottom.find("a").each(function(){$(this).addClass($(this).attr("data-disabled-class"))}),this.wrapBottom.find("._checked_count").each(function(){$(this).removeClass($(this).attr("data-show-class")).text("")}))},startSearchMode:function(){this.wrapSearch.find("._search_text").parent().removeClass("ExPlaceholder")},cancelSearchMode:function(){this.wrapSearch.find("._search_text").val("").parent().addClass("ExPlaceholder"),this.wrapSearch.find("._wrap_btn_cancel").addClass("ExDisabled").addClass("MdNonDisp"),this.wrapNoResult.addClass("MdNonDisp"),this.initFriendList(),this.fadeInBtnGroup()},searchContactList:function(e){var searchText=$.trim($(e.currentTarget).val());searchText?(this.startSearchMode(),this.updateSearchFriend(searchText),this.wrapSearch.find("._wrap_btn_cancel").removeClass("ExDisabled").removeClass("MdNonDisp")):this.cancelSearchMode(),0===searchText.length?$(e.currentTarget).parent().addClass("ExPlaceholder"):$(e.currentTarget).parent().removeClass("ExPlaceholder")},updateSearchFriend:function(searchText){var searchedContactList=ContactProxy.getInstance().getMatchedFriendList(searchText),filterContactList=this.filterList(searchedContactList),count=filterContactList.length;0===count?(this.wrapNoResult.removeClass("MdNonDisp"),this.wrapNoFriend.addClass("MdNonDisp"),this.fadeOutBtnGroup()):(this.wrapNoResult.addClass("MdNonDisp"),this.wrapNoFriend.addClass("MdNonDisp"),this.fadeInBtnGroup()),this.renderList(filterContactList),this.updateFriendCount(count)},initFriendList:function(){if(this.initUIFlag){var contactList=ContactProxy.getInstance().getFriendList(),filterContactList=this.filterList(contactList),count=filterContactList.length;count>0?(this.wrapNoFriend.addClass("MdNonDisp"),this.wrapFriendList.removeClass("MdNonDisp"),this.renderList(filterContactList)):(this.wrapNoFriend.removeClass("MdNonDisp"),this.wrapFriendList.addClass("MdNonDisp")),this.updateFriendCount(count)}},getContactListData:function(){return this.contactListData},renderList:function(contactList){this.contactListData=contactList,this.listUI.reload(),Utility.lazyLoadImage(this.wrapFriendList.find("img"))},filterList:function(contactList){return _.filter(contactList,$.proxy(function(contact){return!_.contains(this.selectedMids,contact.mid)},this))},updateFriendCount:function(count){this.wrapFriendCount.html(count)},fadeOutBtnGroup:function(){this.wrapBottom.animate({opacity:0},300)},fadeInBtnGroup:function(){this.wrapBottom.animate({opacity:1},300)},close:function(){this.removeAll(),LineMain.getInstance().moveBack()},onClickHide:function(e){return e.currentTarget?void(this.isBtnActivate&&this.callback.hide.apply(this,[this.checkedMids])):!1},onClickBlock:function(e){return e.currentTarget?void(this.isBtnActivate&&this.callback.block.apply(this,[this.checkedMids])):!1},onClickChoose:function(e){return e.currentTarget?void(this.isBtnActivate&&this.callback.choose.apply(this,[this.checkedMids])):!1},onClickNewChat:function(e){return e.currentTarget?void(this.isBtnActivate&&this.callback.new_chat.apply(this,[this.checkedMids])):!1},onClickCreateGroup:function(e){return e.currentTarget?void(this.isBtnActivate&&this.callback.create_group.apply(this,[this.checkedMids])):!1},removeAll:function(){this.checkedMids=[],this.selectedMids=[],this.initUIFlag=!1}},FriendManagerUI.getInstance=function(){return null==FriendManagerUI.instance&&(FriendManagerUI.instance=new FriendManagerUI),FriendManagerUI.instance},FriendManagerUI.instance=null;var ContactListBO=function(){return null!=ContactListBO.instance?ContactListBO.instance:(this.contactList=[],this.jobWorker=new JobWorker(this.NETWORK_JOB_FILE,LineTalkExceptionHandler.getInstance().handle,LineNetworkExceptionHandler.getInstance().handle),this.eventManager=new EventManager,void(this.store=new PersistentStore))};ContactListBO.prototype={getEventManager:function(){return this.eventManager},getContactList:function(){return this.contactList},getFriendList:function(){var contactList=_.filter(this.contactList,function(contact){return 1==!!contact&&contact.status===ContactStatus.FRIEND&&contact.settings!==ContactSetting.CONTACT_SETTING_CONTACT_HIDE});return contactList||[]},getBlockedList:function(){var contactList=_.filter(this.contactList,function(contact){return 1==!!contact&&(contact.status===ContactStatus.FRIEND_BLOCKED||contact.status===ContactStatus.RECOMMEND_BLOCKED)&&contact.status!==ContactStatus.DELETED_BLOCKED&&contact.settings!==ContactSetting.CONTACT_SETTING_DELETE});return contactList||[]},getHideList:function(){var contactList=_.filter(this.contactList,function(contact){return 1==!!contact&&contact.settings===ContactSetting.CONTACT_SETTING_CONTACT_HIDE&&contact.status!==ContactStatus.DELETED&&contact.settings!==ContactSetting.CONTACT_SETTING_DELETE});return contactList||[]},getRecommendList:function(){var contactList=_.filter(this.contactList,function(contact){return 1==!!contact&&contact.status===ContactStatus.RECOMMEND});return contactList=_.map(contactList,$.proxy(function(contact){return contact.thumbnail=Utility.combineProfileURL(contact,LineConfig.LIST_THUMBNAIL_SIZE),contact},this)),contactList||[]},getContactFromLocal:function(mid){var contact=_.findWhere(this.contactList,{mid:mid});return contact||null},saveContact:function(serializedContact){return this.contactList=_.filter(this.contactList,function(contact){return contact.mid!==serializedContact.mid}),serializedContact.thumbnail=Utility.combineProfileURL(serializedContact,LineConfig.LIST_THUMBNAIL_SIZE),serializedContact.printName=ContactProxy.getInstance().getPrintName(serializedContact),this.contactList.push(serializedContact),this.getEventManager().broadCast(serializedContact),this.contactList=_.sortBy(this.contactList,function(value){return value.printName}),serializedContact},isEqualLocalContact:function(serializedContact){var localContact=ContactProxy.getInstance().getContactFromLocal(serializedContact.mid);return localContact?_.isEqual(new Contact(localContact),new Contact(serializedContact))?!0:!1:!1},isNewFriend:function(serializedContact){var localContact=ContactProxy.getInstance().getContactFromLocal(serializedContact.mid);return localContact||serializedContact.status!==ContactStatus.FRIEND||serializedContact.settings===ContactSetting.CONTACT_SETTING_CONTACT_HIDE?localContact&&localContact.status!==ContactStatus.FRIEND&&localContact.status!==ContactStatus.FRIEND_BLOCKED&&serializedContact.status!==ContactStatus.RECOMMEND&&serializedContact.settings!==ContactSetting.CONTACT_SETTING_CONTACT_HIDE?!0:!1:!0},updateContact:function(contact){return contact.mid?void this.saveContact(contact):!1},loadComplete:function(){this.getEventManager().broadCast()},blockContact:function(contact,callback){this.blockContactT(contact.mid,$.proxy(function(res){this.updateContact(contact),callback.apply(callback,[res])},this))},unBlockContact:function(contact,callback){this.unBlockContactT(contact.mid,$.proxy(function(res){this.updateContact(contact),callback.apply(callback,[res])},this))},hideContact:function(contact,callback){this.hideContactT(contact.mid,$.proxy(function(res){this.updateContact(contact),callback.apply(callback,[res])},this))},unHideContact:function(contact,callback){this.unHideContactT(contact.mid,$.proxy(function(res){this.updateContact(contact),callback.apply(callback,[res])},this))},deleteContact:function(contact,callback){this.deleteContactT(contact.mid,$.proxy(function(res){this.updateContact(contact),callback.apply(callback,[res])},this))},NETWORK_JOB_FILE:BASE_DEFAULT+"src/worker/ContactNetworkJob.js",getContactT:function(mid,callback){this.jobWorker.send({methodName:"getContactT",data:[mid],success:$.proxy(function(contact){contact&&ContactProxy.getInstance().addContact(contact),callback.apply(callback,[contact])},this),error:function(){}})},findContactByUseridT:function(userid,callback){this.jobWorker.send({methodName:"findContactByUseridT",data:[userid],success:callback,error:function(){}})},findAndAddContactsByUseridT:function(userid){var contactHash=TalkClientFactory.getInstance().createAuthClient().findAndAddContactsByUserid(0,userid);return contactHash[userid]||{}},findAndAddContactsByMidT:function(mid,callback){this.jobWorker.send({methodName:"findAndAddContactsByMidT",data:[mid],success:callback,error:function(){}})},blockContactT:function(mid,callback){var uniqueKey=LineConfig.getInstance().createUUID();this.jobWorker.send({methodName:"blockContactT",data:[mid,uniqueKey],uniquekey:uniqueKey,success:callback,error:function(){}})},unBlockContactT:function(mid,callback){this.jobWorker.send({methodName:"unBlockContactT",data:[mid],success:callback,error:function(){}})},hideContactT:function(mid,callback){var uniqueKey=LineConfig.getInstance().createUUID();this.jobWorker.send({methodName:"hideContactT",data:[mid,uniqueKey],uniquekey:uniqueKey,success:callback,error:function(){}})},unHideContactT:function(mid,callback){this.jobWorker.send({methodName:"unHideContactT",data:[mid],success:callback,error:function(){}})},deleteContactT:function(mid,callback){this.jobWorker.send({methodName:"deleteContactT",data:[mid],success:callback,error:function(){}})},syncContactsT:function(localContactListPartion,callback){this.jobWorker.send({methodName:"syncContactsT",data:[localContactListPartion],success:$.proxy(function(res){if(callback.apply(callback,[res]),res)if(0===_.keys(res).length);else{var contactList=_.pluck(res,"contact");_.each(contactList,$.proxy(function(contact){ContactProxy.getInstance().addContact(contact)},this))}},this)})},getAllContactIdsT:function(callback){this.jobWorker.send({methodName:"getAllContactIdsT",data:[],success:$.proxy(function(res){callback(res)}),error:function(){}})},getBlockedContactIdsT:function(callback){this.jobWorker.send({methodName:"getBlockedContactIdsT",data:[],success:$.proxy(function(res){callback(res)}),error:function(){}})},getRecommendationIdsT:function(callback){this.jobWorker.send({methodName:"getRecommendationIdsT",data:[],success:$.proxy(function(res){callback(res)}),error:function(){}})},getBlockedRecommendationIdsT:function(callback){this.jobWorker.send({methodName:"getBlockedRecommendationIdsT",data:[],success:$.proxy(function(res){callback(res)}),error:function(){}})},getContactsT:function(ids,callback){this.jobWorker.send({methodName:"getContactsT",data:[ids],success:$.proxy(function(res){callback(res)}),error:function(){}})},changeDisplayNameT:function(mid,name,callback){this.jobWorker.send({methodName:"updateSettingsT",data:[mid,ContactSetting.CONTACT_SETTING_DISPLAY_NAME_OVERRIDE,name],success:$.proxy(function(){callback()}),error:function(){}})},setContactList:function(arr){arr=_.sortBy(arr,function(value){return value.printName}),this.contactList=arr,this.getEventManager().broadCast(arr[0])},clear:function(){this.contactList=[]},updateConnectionServerInfo:function(){this.jobWorker.sendQuery("pushServerInfo",PersistentStore.getInstance().get("CI_serverList"))}},ContactListBO.getInstance=function(){return null==ContactListBO.instance&&(ContactListBO.instance=new ContactListBO),ContactListBO.instance},ContactListBO.instance=null;var ContactListDataCache=function(customOption){return null!=ContactListDataCache.instance?ContactListDataCache.instance:void _.extend(this,new DataCache(customOption))};ContactListDataCache.prototype={getFriendByMid:function(mid){var cachedData=_.flatten(this.getTotalCachedBlock()),contact=_.findWhere(cachedData,{mid:mid});return contact}},ContactListDataCache.getInstance=function(){return null==ContactListDataCache.instance&&(ContactListDataCache.instance=new ContactListDataCache),ContactListDataCache.instance},ContactListDataCache.instance=null;var LocalContactBO=function(localContactInfo){_.extend(this,{type:localContactInfo.type||ModificationType.ADD,luid:localContactInfo.id+"",phones:_.pluck(localContactInfo.tel,"value")||[],emails:_.pluck(localContactInfo.emails,"value")||[],userids:localContactInfo.userids||[],name:localContactInfo.name.join("")||"",mid:localContactInfo.mid||""}),_.extend(this,new ContactModification(this))};LocalContactBO.prototype={};var LocalContactListBO=function(){return null!=LocalContactListBO.instance?LocalContactListBO.instance:(this.localContactList=[],this.eventManager=new EventManager,this.onSuccesCustomCallback=function(){},this.store=new PersistentStore,void this.setEvent())};LocalContactListBO.prototype={getEventManager:function(){return this.eventManager},setEvent:function(){},loadLocalContactList:function(callback){ContactProxy.getInstance().loadLocalContactList($.proxy(function(event){var cursor=event.target.result;if(cursor){var localContact=cursor.value;this.localContactList.push(localContact),cursor.continue()}else callback()},this))},getLocalContactList:function(){return this.localContactList},saveContact:function(serializedContact){var oldLocalContact=_.findWhere(this.localContactList,{luid:serializedContact.luid});_.isEqual(oldLocalContact,serializedContact)||this.addChangedLocalContact(serializedContact.luid,"update"),this.localContactList=_.filter(this.localContactList,function(contact){return contact.luid!==serializedContact.luid}),this.localContactList.push(serializedContact),this.getEventManager().broadCast()},parseLocalContact:function(customCallback){this.loadLocalContactList($.proxy(function(){if(customCallback&&(this.onSuccesCustomCallback=customCallback),!window.navigator.mozContacts)return ContactProxy.getInstance().addLocalContact({type:ModificationType.ADD,id:"01056567878",tel:[{value:"01056567878"}],emails:[],userids:[],name:["ggggg"]}),ContactProxy.getInstance().addLocalContact({type:ModificationType.ADD,id:"09044445555",tel:[{value:"09044445555"}],emails:[],userids:[],name:["09044445555"]}),ContactProxy.getInstance().processThrifitSync(customCallback),!1;var localContactObject=$(window.navigator.mozContacts.getAll({}));localContactObject.on("success",$.proxy(this.successParseLocaleContact,this)),localContactObject.on("error",$.proxy(this.errorParseLocaleContact,this))},this))},successParseLocaleContact:function(event){var cursor=event.target;cursor.result?(ContactProxy.getInstance().addLocalContact(cursor.result),cursor.continue()):ContactProxy.getInstance().processThrifitSync(this.onSuccesCustomCallback)},errorParseLocaleContact:function(){ContactProxy.getInstance().prepareContactData(this.onSuccesCustomCallback)},mappingContact:function(syncContactList){var syncMap=this.getContactSyncMap()||{};_.each(syncContactList,$.proxy(function(syncContact){syncMap[syncContact.contact.mid]=syncContact.luid},this)),this.store.set("SC_contactSyncMap",JSON.stringify(syncMap))},getContactSyncMap:function(){return JSON.parse(this.store.get("SC_contactSyncMap"))},addChangedLocalContact:function(contactId,reason){var syncMap=JSON.parse(this.store.get("SC_changedLocalContacts"))||{};"remove"!=reason&&(syncMap[contactId]=reason,this.store.set("SC_changedLocalContacts",JSON.stringify(syncMap)))},getChangedLocalContactIds:function(){var changedLocalContacts=JSON.parse(this.store.get("SC_changedLocalContacts"))||{};return _.keys(changedLocalContacts)},clearChangedLocalContact:function(){this.store.set("SC_changedLocalContacts","{}")}},LocalContactListBO.getInstance=function(){return null==LocalContactListBO.instance&&(LocalContactListBO.instance=new LocalContactListBO),LocalContactListBO.instance},LocalContactListBO.instance=null;var ContactListDAO=function(){return null!=ContactListDAO.instance?ContactListDAO.instance:void(this.store=DatabaseStoreFactory.getInstance().getContactListStore())};ContactListDAO.prototype={getAllContactList:function(onSuccess){this.store.getAllContactList(onSuccess)},updateContact:function(serializedData){this.store.put(serializedData)},saveContact:function(serializedData,callback){serializedData.thumbnail=Utility.combineProfileURL(serializedData,LineConfig.LIST_THUMBNAIL_SIZE),this.store.put(serializedData,callback)},clearStore:function(){this.store.clear()},indexDBInsertTest:function(){var trans=this.store.getTransaction(this.store.objName,"readwrite"),store=trans.objectStore(this.store.objName);trans.oncomplete=$.proxy(function(){},this);for(var i=0;5e3>i;i++){var contact={mid:"asdasd222"+i,displayName:"test_"+i,displayNameOverridden:"test_"+i,asdfasdfasdf:"asdfasdf",asdfsqwerqwer:"asdfasdfas",asdfqwerqwer:"asdfasdfasdf",printName:"test_"+i,relation:0,settings:0,status:1,type:0};store.add(Utility.serialize(contact))}}},ContactListDAO.getInstance=function(){return null==ContactListDAO.instance&&(ContactListDAO.instance=new ContactListDAO),ContactListDAO.instance},ContactListDAO.instance=null;var LocalContactListDAO=function(){return null!=LocalContactListDAO.instance?LocalContactListDAO.instance:void(this.store=DatabaseStoreFactory.getInstance().getLocalContactListStore())};LocalContactListDAO.prototype={getAllContactList:function(onSuccess){this.store.getAllContactList(onSuccess)},updateLocalContact:function(){this.clearStore();var localContactList=ContactProxy.getInstance().getLocalContactList();_.each(localContactList,$.proxy(function(contact){this.saveContact(Utility.serialize(contact))},this))},saveContact:function(serializedData){try{this.store.put(serializedData)}catch(e){alert(JSON.stringify(e))}},clearStore:function(){this.store.clear()}},LocalContactListDAO.getInstance=function(){return null==LocalContactListDAO.instance&&(LocalContactListDAO.instance=new LocalContactListDAO),LocalContactListDAO.instance},LocalContactListDAO.instance=null;var GroupManagerUI=function(){return null!=GroupManagerUI.instance?GroupManagerUI.instance:(_.extend(this,UIStructure),this.initProperty(),this.assigne(),void this.setEvent())};GroupManagerUI.prototype={MODE:0,MAX_GROUP_MEMBER_COUNT:LineConfig.MAX_GROUP_MEMBER_COUNT,initProperty:function(){this.groupMemberMids=[],this.groupInviteeMids=[],this.inviteMids=[],this.kickoutMids=[],this.excludeMids=[]},assigne:function(){this.initUIFlag=!1,this.isBtnActivate=!1,this.wrapGroupManager=$("#_wrap_group_manager"),this.WRAP_GROUP_MANAGER_NEW=BASE_DEFAULT+"src/proxy/group/ui/items/GroupManagerNewTemplate.mustache",this.WRAP_GROUP_MANAGER_EDIT=BASE_DEFAULT+"src/proxy/group/ui/items/GroupManagerEditTemplate.mustache",this.GROUP_MEMBER_ITEM=BASE_DEFAULT+"src/proxy/group/ui/items/GroupMemberItem.mustache"},dynamicAssigne:function(){this.wrapScrollArea=this.wrapGroupManager.find("._wrap_scroll_area"),this.wrapGroupMemberList=this.wrapGroupManager.find("._wrap_member_list"),this.wrapBottom=this.wrapGroupManager.find("._wrap_bottom"),this.inputGroupName=this.wrapGroupManager.find("._group_name"),new SingleInputModule("._single_input_module",20,$.proxy(this.updateBtnActivate,this)),this.wrapChooseFriendBtn=this.wrapGroupManager.find("._wrap_choose_friend_btn"),this.btnNewMember=this.wrapGroupManager.find("._btn_new_memeber")},setEvent:function(){this.callback={create_group:function(){}},LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this)),ChatProxy.getInstance().getEventManager().regist(this.updateGroupList.bind(this))},dynamicSetEvent:function(){this.btnNewMember.off(this.EVENT_CLICK).on(this.EVENT_CLICK,$.proxy(this.openMemberSelectWindow,this)),this.wrapGroupMemberList.off(this.EVENT_CLICK,"._btn_remove").on(this.EVENT_CLICK,"._btn_remove",$.proxy(this.removeMember,this)),this.wrapGroupManager.off(this.EVENT_CLICK,"._change_group_image").on(this.EVENT_CLICK,"._change_group_image",$.proxy(this.onClickChangeGroupImage,this)),this.wrapGroupManager.off(this.EVENT_CLICK,"._btn_close").on(this.EVENT_CLICK,"._btn_close",$.proxy(this.close,this)),this.wrapGroupManager.off(this.EVENT_CLICK,"._btn_create").on(this.EVENT_CLICK,"._btn_create",$.proxy(this.onClickCreateGroup,this)),this.wrapGroupManager.off(this.EVENT_CLICK,"._btn_edit").on(this.EVENT_CLICK,"._btn_edit",$.proxy(this.onClickUpdateGroup,this))},setMemberMids:function(mids){this.inviteMids=mids,this.setExcludeMids(mids)},setGroupInfo:function(groupInfo){this.groupInfo=new GroupDetailBO(groupInfo),_.extend(this.groupInfo,groupInfo)},changeScreen:function(options){if(this.initUIFlag&&options.type===UIEventManager.EVENT_RESIZE)return this.resize(),!1;
if(LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.GROUP_MANAGER)?this.wrapGroupManager.removeClass("MdNonDisp"):this.wrapGroupManager.addClass("MdNonDisp"),LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.GROUP_MANAGER_NEW)){if(this.MODE=LineMain.SUB_SCREEN_TYPE.GROUP_MANAGER_NEW,this.initUIFlag===!1){var template=TemplateManager.getInstance().get(this.WRAP_GROUP_MANAGER_NEW),html=Mustache.render(template,{});this.wrapGroupManager.html(html),this.dynamicAssigne(),this.dynamicSetEvent(),this.updateGroupMemberList(),this.initUIFlag=!0}this.resize()}if(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.GROUP_MANAGER_EDIT)){if(this.MODE=LineMain.SUB_SCREEN_TYPE.GROUP_MANAGER_EDIT,this.initUIFlag===!1){var template=TemplateManager.getInstance().get(this.WRAP_GROUP_MANAGER_EDIT),html=Mustache.render(template,this.groupInfo);this.wrapGroupManager.html(html),Utility.lazyLoadImage(this.wrapGroupManager.find("img")),FileDownloader.getGroupProfileObjectInfoByOid(this.groupInfo.id,function(res){}),this.dynamicAssigne(),this.dynamicSetEvent(),this.initUIFlag=!0,this.initGroup()}this.resize()}},resize:function(){var windowHeight=LineMain.WINDOW_HEIGHT;this.wrapScrollArea.height(0);var scrollAreaHeight=windowHeight-$("#_wrap_group_manager").height();this.wrapScrollArea.height(scrollAreaHeight)},initGroup:function(){this.initProperty(),this.myMid=AuthInfoKeeper.getInstance().getAuthMid(),this.groupMemberMids=_.pluck(this.groupInfo.members,"mid"),this.groupInviteeMids=_.pluck(this.groupInfo.invitee,"mid"),this.setExcludeMids(_.union(this.groupMemberMids,this.groupInviteeMids,this.inviteMids)),this.updateGroupMemberList(),this.updateBtnActivate()},setExcludeMids:function(mids){var filterMids=_.union(this.myMid,this.kickoutMids);this.excludeMids=_.difference(mids,filterMids)},allBtnGroupHide:function(){this.wrapChooseFriendBtn.addClass("MdNonDisp"),this.wrapEditFriendBtn.addClass("MdNonDisp"),this.wrapNewBtn.addClass("MdNonDisp")},openMemberSelectWindow:function(){FriendManagerUI.getInstance().setEventBind({choose:$.proxy(this.onAddGroupMember,this)}).setExcludeMid(this.excludeMids),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_CHOOSE})},onAddGroupMember:function(mids){var memberMids=_.intersection(mids,this.kickoutMids);this.kickoutMids=_.difference(this.kickoutMids,memberMids),this.inviteMids=_.uniq(_.union(this.inviteMids,_.difference(mids,memberMids))),FriendManagerUI.getInstance().close(),this.setExcludeMids(_.union(this.groupMemberMids,this.groupInviteeMids,this.inviteMids)),this.updateGroupMemberList()},updateGroupMemberList:function(){var filterMids=_.union(this.kickoutMids,this.myMid),midList=_.difference(_.union(this.groupMemberMids,this.inviteMids),filterMids);this.renderList(midList),this.updateBtnActivate()},renderList:function(midList){var listArr=[],memberTemplate=TemplateManager.getInstance().get(this.GROUP_MEMBER_ITEM);_.each(midList,$.proxy(function(mid){var contact=ContactProxy.getInstance().getContactFromLocal(mid),output=Mustache.render(memberTemplate,contact);listArr.push(output)},this)),this.wrapGroupMemberList.html(listArr.join("")),Utility.lazyLoadImage(this.wrapGroupMemberList.find("img"))},updateBtnActivate:function(){this.isValidation()?(this.isBtnActivate=!0,this.wrapBottom.find("a").each(function(){$(this).removeClass($(this).attr("data-disabled-class"))})):(this.isBtnActivate=!1,this.wrapBottom.find("a").each(function(){$(this).addClass($(this).attr("data-disabled-class"))}))},isValidation:function(){var isOk=!0;return this.inputGroupName.val().length<=0&&(isOk=!1),isOk},close:function(){LineMain.getInstance().moveBack(),this.removeAll()},removeMember:function(e){if(!e.currentTarget)return!1;var currentTarget=$(e.currentTarget),mid=currentTarget.attr("data-mid"),contact=ContactProxy.getInstance().getContactFromLocal(mid),profileName=contact.printName;return confirm($.i18n.prop("GROUP_DELETE_MEMBER_CONFIRM",profileName))?(-1!=_.indexOf(this.groupMemberMids,mid)&&this.kickoutMids.push(mid),this.inviteMids=_.without(this.inviteMids,mid),this.setExcludeMids(_.union(this.groupMemberMids,this.groupInviteeMids,this.inviteMids)),currentTarget.parents("li").remove(),void this.updateBtnActivate()):!1},onClickChangeGroupImage:function(e){var groupId=$(e.currentTarget).attr("data-chat-id"),openMediaPickerUI=function(){var hasImage=this.groupProfileImageArrayBuffer?!0:!1;this.groupInfo&&(hasImage=this.groupInfo.pictureStatus?!0:!1);var pickerConfig={photo:{callback:$.proxy(function(image){var oSegmReq=new FileReader;oSegmReq.readAsArrayBuffer(image),oSegmReq.onload=$.proxy(function(e){this.groupProfileImageArrayBuffer=e.target.result},this);var url=URL.createObjectURL(image);$("._img_element")[0].src=url},this)}};hasImage&&(pickerConfig.remove={callback:$.proxy(function(){var noImage="/res/img/noimg/group_profile_img90x90.png";$("._img_element")[0].src=noImage,this.groupInfo&&(this.groupInfo.pictureStatus=null),this.groupProfileImageArrayBuffer=null},this)}),new MediaPickerUI(pickerConfig).pickMedia()};groupId?GroupProxy.getInstance().getGroup(groupId,$.proxy(function(groupInfo){hasImage=null!==groupInfo.pictureStatus,openMediaPickerUI.apply(this)},this)):openMediaPickerUI.apply(this)},onClickCreateGroup:function(e){if(!e.currentTarget)return!1;var groupMemberCount=this.inviteMids.length;return groupMemberCount>=this.MAX_GROUP_MEMBER_COUNT?(alert($.i18n.prop("MSG_OVER_MAXIMUM_MEMBER",this.MAX_GROUP_MEMBER_COUNT)),!1):void(this.isBtnActivate&&(DimmedUI.getInstance().open("",{},{isCenter:!0}),GroupProxy.getInstance().createGroup(this.inputGroupName.val(),this.inviteMids,$.proxy(function(res){this.uploadGroupProfile(res.id),ChatProxy.getInstance().createChatGroupForOP(res.id,Utility.serialize(res)),DimmedUI.getInstance().close(),this.removeAll(),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIENDS,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_LIST})},this))))},onClickUpdateGroup:function(e){if(!e.currentTarget)return!1;this.groupInfo.name=this.inputGroupName.val();var group=GroupProxy.getInstance().convertObjectToGroup(this.groupInfo);if(this.isBtnActivate){var groupMemberCount=this.groupMemberMids.length+this.groupInviteeMids.length+this.inviteMids.length-this.kickoutMids.length-1;if(groupMemberCount>this.MAX_GROUP_MEMBER_COUNT)return alert($.i18n.prop("MSG_OVER_MAXIMUM_MEMBER",this.MAX_GROUP_MEMBER_COUNT)),!1;DimmedUI.getInstance().open("",{},{isCenter:!0}),this.inviteMids.length>0&&GroupProxy.getInstance().inviteIntoGroup(this.groupInfo.id,this.inviteMids,function(){}),this.kickoutMids.length>0&&GroupProxy.getInstance().kickoutFromGroup(this.groupInfo.id,this.kickoutMids,function(){}),GroupProxy.getInstance().updateGroupSyncT(group,$.proxy(this.onSuccessUpdateGroup,this))}},onSuccessUpdateGroup:function(groupInfo){this.uploadGroupProfile(groupInfo.id),ChatProxy.getInstance().updateChatGroup(groupInfo.id,groupInfo),FriendManagerUI.getInstance().close(),DimmedUI.getInstance().close(),this.removeAll()},uploadGroupProfile:function(groupId){if(this.groupProfileImageArrayBuffer){var fileUploader=new FileUploader,image={name:"group_image",type:"image/jpeg"};fileUploader.uploadGroupProfileImage({authToken:AuthInfoKeeper.getInstance().getAuthToken(),oid:groupId,imageName:image.name,imageType:image.type,imageQuality:LineConfig.UPLOAD_IMAGE_QUALITY,imageArrayBuffer:this.groupProfileImageArrayBuffer,complete:function(){GroupProxy.getInstance().getGroup(groupId,EventManager.EMPTY)},progress:function(){}})}},close:function(){LineMain.getInstance().moveBack(),this.removeAll()},removeAll:function(){this.initUIFlag=!1,this.initProperty(),this.inputGroupName.val(""),this.groupProfileImageArrayBuffer=null,this.isBtnActivate=!1,this.updateBtnActivate()},updateGroupList:function(chatBo){if(this.checkIgnoreCase(chatBo))return!1;if(LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.GROUP_MANAGER))if(chatBo.kickout&&1==chatBo.kickout){this.removeAll();var firstScreenInfo={screen:LineMain.MAIN_SCREEN_TYPE.FRIENDS,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_LIST};LineMain.getInstance().changeScreen(firstScreenInfo)}else this.setGroupInfo(chatBo.groupInfo),this.initGroup()},checkIgnoreCase:function(chatBo){return LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.GROUP_MANAGER)?chatBo.isReceiveMessage?!0:this.MODE===LineMain.SUB_SCREEN_TYPE.GROUP_MANAGER_NEW?!0:_.isEqual(new Group(chatBo.groupInfo),new Group(this.groupInfo))?!1:!0:!0}},GroupManagerUI.getInstance=function(){return null==GroupManagerUI.instance&&(GroupManagerUI.instance=new GroupManagerUI),GroupManagerUI.instance},GroupManagerUI.instance=null;var GroupProxy=function(){return null!=GroupProxy.instance?GroupProxy.instance:(this.eventManager=new EventManager,this.groupBO=GroupBO.getInstance(),void this.groupBO.getEventManager().regist(this.updateGroupList.bind(this)))};GroupProxy.prototype={getEventManager:function(){return this.eventManager},getGroupFromLocal:function(groupId){var groupList=_.without(_.pluck(ChatProxy.getInstance().getOnlyGroupChatList(),"groupInfo"),null),group=_.filter(groupList,function(group){return group.id===groupId});return group[0]||null},getGroup:function(groupId,customCallback){var group=this.getGroupFromLocal(groupId);group?1==!!group.kickout?this.groupBO.getGroupT(groupId,customCallback):customCallback(group):this.groupBO.getGroupT(groupId,customCallback)},getGroupT:function(groupId,customCallback){this.groupBO.getGroupT(groupId,customCallback)},getGroupMemberList:function(groupId){var group=this.getGroupFromLocal(groupId);if(!group)return!1;var groupMemberList=_.map(group.members,function(object){return ContactProxy.getInstance().getContactFromLocal(object.mid)});return groupMemberList},convertObjectToGroup:function(object){var group=object;return group.creator=new Contact(object.creator),group.members=_.map(object.members,function(object){return new Contact(object)}),group.invitee=_.map(object.invitee,function(object){return new Contact(object)}),group},getInviteeList:function(){var myMid=AuthInfoKeeper.getInstance().getAuthMid(),groupList=_.without(_.pluck(ChatProxy.getInstance().getOnlyGroupChatList(),"groupInfo"),null);return groupList=_.filter(groupList,function(group){return _.contains(_.pluck(group.invitee,"mid"),myMid)})},getGroupList:function(){var myMid=AuthInfoKeeper.getInstance().getAuthMid(),groupList=_.without(_.pluck(ChatProxy.getInstance().getOnlyGroupChatList(),"groupInfo"),null);return groupList=_.filter(groupList,function(group){if(group.kickout&&1==group.kickout)return!1;for(var flag=!1,i=0;i<group.members.length;i++){var contact=group.members[i];1==!!contact&&contact.mid==myMid&&(flag=!0)}return flag})},getMatchedGroupList:function(searchText){var groupList=this.getGroupList(),searchGroupList=_.filter(groupList,function(group){var strIndex=group.name.toLowerCase().indexOf(searchText.toLowerCase());return strIndex>-1});return searchGroupList},createGroup:function(groupName,mids,customCallback){this.groupBO.createGroupT(groupName,mids,customCallback)},updateGroup:function(groupId,attribute,adaptedChatId){this.groupBO.updateGroup(groupId,$.proxy(function(groupInfo){ChatProxy.getInstance().updateChatGroup(groupInfo.id,groupInfo,attribute,adaptedChatId)},this))},updateGroupT:function(groupInfo,customCallback){this.groupBO.updateGroupT(groupInfo,customCallback)},updateGroupSyncT:function(groupInfo,customCallback){return this.groupBO.updateGroupSyncT(new Group(groupInfo),customCallback)},rejectGroupInvitation:function(groupId,customCallback){this.groupBO.rejectGroupInvitationT(groupId,customCallback)},acceptGroupInvitation:function(groupId,customCallback){this.groupBO.acceptGroupInvitationT(groupId,customCallback)},inviteIntoGroup:function(groupId,mids,customCallback){this.groupBO.inviteIntoGroupT(groupId,mids,customCallback)},leaveGroup:function(groupId,customCallback){this.groupBO.leaveGroupT(groupId,customCallback)},updateGroupList:function(group){0!=!!group&&(group.isLeaveGroup?ChatProxy.getInstance().leaveGroup(group.id,function(){this.getEventManager().broadCast(group)}.bind(this)):this.getEventManager().broadCast(group))},removeAll:function(){},kickoutFromGroup:function(groupId,mids,customCallback){this.groupBO.kickoutFromGroupT(groupId,mids,customCallback)},cancelGroupInvitation:function(groupId,mids,customCallback){this.groupBO.cancelGroupInvitationT(groupId,mids,customCallback)},removeInvitee:function(chatId,fromMid,mid){var chatRoom=ChatProxy.getInstance().getChatBoById(chatId);if(0!=!!chatRoom&&0!=!!chatRoom.groupInfo){var groupInfo=chatRoom.groupInfo;if(mid===AuthInfoKeeper.getInstance().getAuthMid()&&GroupUI.getInstance().cancelledInvitation(),groupInfo){var targetInvitee=_.findWhere(groupInfo.invitee,{mid:mid});targetInvitee&&(groupInfo.invitee=_.without(groupInfo.invitee,targetInvitee),ChatProxy.getInstance().notifyCancelInvitationGroup(chatId,fromMid,mid),GroupUI.getInstance().updateGroupInfo(groupInfo))}}},updateConnectionServerInfo:function(){this.groupBO.updateConnectionServerInfo()},migrateGroups:function(callback){LineMain.isMigrateGroupOk=!1;var flags=[],resultIds=[];flags.getGroupIdsJoined=!1,flags.getGroupIdsInvited=!1;var flagLength=0;for(var i in flags)flagLength++;var onThriftEnded=$.proxy(function(ids){resultIds=resultIds.concat(ids);var doneCount=0;for(var i in flags)1==flags[i]&&doneCount++;if(doneCount===flagLength){var ids=_.uniq(resultIds);this.migrateGroupsToLocal(ids,callback)}},this);this.getGroupIdsJoined($.proxy(function(ids){flags.getGroupIdsJoined=!0,onThriftEnded(ids)},this)),this.getGroupIdsInvited($.proxy(function(ids){flags.getGroupIdsInvited=!0,onThriftEnded(ids)},this))},migrateGroupsToLocal:function(ids,callback){var result=[];return 0===ids.length?(LineMain.isMigrateGroupOk=!0,void callback()):void _.each(ids,$.proxy(function(id){this.getGroup(id,function(group){ChatProxy.getInstance().createChatGroup(group.id,group,!1),result.push(!0),result.length===ids.length&&(LineMain.isMigrateGroupOk=!0,callback())})},this))},getGroupIdsJoined:function(callback){this.groupBO.getGroupIdsJoinedT(callback)},getGroupIdsInvited:function(callback){this.groupBO.getGroupIdsInvitedT(callback)},debugMode:function(debugInfo){this.groupBO.jobWorker.sendQuery("pushDebugInfo",debugInfo)}},GroupProxy.getInstance=function(){return null==GroupProxy.instance&&(GroupProxy.instance=new GroupProxy),GroupProxy.instance},GroupProxy.instance=null;var GroupUI=function(){return null!=GroupUI.instance?GroupUI.instance:(_.extend(this,UIStructure),this.initProperty(),this.assigne(),void this.setEvent())};GroupUI.prototype={initProperty:function(){this.inviteedMids=[]},assigne:function(){this.initUIFlag=!1,this.isBtnActivate=!1,this.wrapGroup=$("#_wrap_group")},dynamicAssigne:function(){this.wrapScrollArea=this.wrapGroup.find("._wrap_scroll_area"),this.wrapChatMemberList=this.wrapGroup.find("._wrap_member_list"),this.wrapGroupPendingList=this.wrapGroup.find("._wrap_pending_list"),this.wrapBottom=this.wrapGroup.find("._wrap_bottom"),this.inputGroupName=this.wrapGroup.find("._group_name"),this.wrapCreatorDesc=this.wrapGroup.find("._wrap_creator_desc"),this.wrapChooseFriendBtn=this.wrapGroup.find("._wrap_choose_friend_btn")},setEvent:function(){this.callback={create_group:function(){}},LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this)),GroupProxy.getInstance().getEventManager().regist(this.updateGroupList.bind(this))},dynamicSetEvent:function(){this.wrapChatMemberList.off(this.EVENT_CLICK,"._btn_remove").on(this.EVENT_CLICK,"._btn_remove",$.proxy(this.removeMember,this)),this.wrapGroup.off(this.EVENT_CLICK,"._btn_close").on(this.EVENT_CLICK,"._btn_close",$.proxy(this.close,this)),this.wrapGroup.off(this.EVENT_CLICK,"._btn_invite").on(this.EVENT_CLICK,"._btn_invite",$.proxy(this.openMemberSelectWindow,this)),this.wrapGroup.off(this.EVENT_CLICK,"._btn_edit").on(this.EVENT_CLICK,"._btn_edit",$.proxy(this.openEditGroupWindow,this)),this.wrapGroup.off(this.EVENT_CLICK,"._btn_leave").on(this.EVENT_CLICK,"._btn_leave",$.proxy(this.onClickLeaveGroup,this)),this.wrapGroup.off(this.EVENT_CLICK,"._btn_chat").on(this.EVENT_CLICK,"._btn_chat",$.proxy(this.onClickChat,this)),this.wrapGroup.off(this.EVENT_CLICK,"._btn_decline").on(this.EVENT_CLICK,"._btn_decline",$.proxy(this.onClickDecline,this)),this.wrapGroup.off(this.EVENT_CLICK,"._btn_join").on(this.EVENT_CLICK,"._btn_join",$.proxy(this.onClickJoin,this)),this.wrapGroup.off(this.EVENT_CLICK,"input._btn_remove").on(this.EVENT_CLICK,"input._btn_remove",$.proxy(this.onClickCancelInvite,this))},setEventBind:function(callbackObject){_.extend(this.callback,callbackObject)},changeScreen:function(options){if(this.initUIFlag&&options&&options.type===UIEventManager.EVENT_RESIZE)return this.resize(),!1;if(LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.GROUP)?this.wrapGroup.removeClass("MdNonDisp"):this.wrapGroup.addClass("MdNonDisp"),LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.GROUP_DETAIL)){if(this.initUIFlag===!1&&(this.initUIFlag=!0),options&&options.data&&options.data.length>0){var group=options.data[0];this.updateGroupInfo(group)}this.resize()}},resize:function(){if(!this.initUIFlag)return!1;var windowHeight=LineMain.WINDOW_HEIGHT,scrollAreaHeight=windowHeight-LineMain.HEADER_SIZE-this.wrapGroup.find("._wrap_bottom").height()-90;this.wrapScrollArea.height(scrollAreaHeight)},allBtnGroupHide:function(){this.wrapChooseFriendBtn.addClass("MdNonDisp"),this.wrapEditFriendBtn.addClass("MdNonDisp"),this.wrapNewBtn.addClass("MdNonDisp")},updateGroupInfo:function(groupInfo){this.groupBo=new GroupDetailBO(groupInfo);var template=TemplateManager.getInstance().get(GroupUI.GROUP_DETAIL),html=Mustache.render(template,this.groupBo);this.wrapGroup.html(html),Utility.lazyLoadImage(this.wrapGroup.find("img")),this.dynamicAssigne(),this.dynamicSetEvent();var chatBo=ChatProxy.getInstance().getChatBoById(this.groupBo.id);if(0!=!!chatBo){var inviter=chatBo.inviter;inviter||(inviter=groupInfo.members[0]),inviter&&this.creatorUpdate(ContactProxy.getInstance().getPrintName(inviter)),this.resize(),DimmedUI.getInstance().close()}},creatorUpdate:function(creatorName){this.wrapCreatorDesc.html($.i18n.prop("THE_PERSON_WHO_INVITED_GROUP_INFO","<em>"+creatorName+"</em>"))},updateBtnActivate:function(){var checkedCount=this.inviteedMids.length;checkedCount>0?(this.isBtnActivate=!0,this.wrapBottom.find("a").each(function(){$(this).removeClass($(this).attr("data-disabled-class"))}),this.wrapBottom.find("._checked_count").each(function(){$(this).addClass($(this).attr("data-show-class")).text(checkedCount)})):(this.isBtnActivate=!1,this.wrapBottom.find("a").each(function(){$(this).addClass($(this).attr("data-disabled-class"))}),this.wrapBottom.find("._checked_count").each(function(){$(this).removeClass($(this).attr("data-show-class")).text("")}))},close:function(){LineMain.getInstance().moveBack(),this.removeAll()},removeMember:function(e){if(!e.currentTarget)return!1;var currentTarget=$(e.currentTarget),mid=currentTarget.attr("data-mid");this.inviteedMids=_.without(this.inviteedMids,mid),currentTarget.parents("li").remove(),this.updateBtnActivate()},openMemberSelectWindow:function(){FriendManagerUI.getInstance().setEventBind({choose:$.proxy(this.onAddGroupMember,this)}).setExcludeMid(this.groupBo.getExcludeContactMid()),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_CHOOSE})},openEditGroupWindow:function(e){if(!e.currentTarget)return!1;var currentTarget=$(e.currentTarget),chatId=currentTarget.attr("data-chatId");DimmedUI.getInstance().open("",{},{isCenter:!0}),GroupProxy.getInstance().getGroup(chatId,$.proxy(this.onSuccessGetGroupInfo,this))},onSuccessGetGroupInfo:function(groupInfo){GroupManagerUI.getInstance().setGroupInfo(groupInfo),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.GROUP_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.GROUP_MANAGER_EDIT}),DimmedUI.getInstance().close()},onAddGroupMember:function(mids){FriendManagerUI.getInstance().close();var chooseMids=_.uniq(mids),tempGroup=new Group(this.groupBo),groupMemberCount=tempGroup.invitee.length+tempGroup.members.length+chooseMids.length-1;return groupMemberCount>LineConfig.MAX_GROUP_MEMBER_COUNT?(alert($.i18n.prop("MSG_OVER_MAXIMUM_MEMBER",LineConfig.MAX_GROUP_MEMBER_COUNT)),!1):void GroupProxy.getInstance().inviteIntoGroup(this.groupBo.id,chooseMids,$.proxy(function(){_.each(chooseMids,function(mid){var contact=ContactProxy.getInstance().getContactFromLocal(mid);tempGroup.invitee.push(contact)}),ChatProxy.getInstance().inviteIntoGroup(this.groupBo.id,chooseMids)},this))},onClickLeaveGroup:function(e){if(!e.currentTarget)return!1;if(!confirm($.i18n.prop("GROUP_LEAVE_WARNING_TEXT")))return!1;var currentTarget=$(e.currentTarget),chatId=currentTarget.attr("data-chatId");DimmedUI.getInstance().open("",{},{isCenter:!0}),GroupProxy.getInstance().leaveGroup(chatId,$.proxy(function(){ChatProxy.getInstance().leaveGroup(chatId,EventManager.EMPTY),DimmedUI.getInstance().close(),this.close()},this))},onClickChat:function(e){if(!e.currentTarget)return!1;var currentTarget=$(e.currentTarget),chatId=currentTarget.attr("data-chatId");ChatProxy.getInstance().createChatGroup(chatId,null,!0)},onClickDecline:function(e){if(!e.currentTarget)return!1;var currentTarget=$(e.currentTarget),chatId=currentTarget.attr("data-chatId");DimmedUI.getInstance().open("",{},{isCenter:!0}),GroupProxy.getInstance().rejectGroupInvitation(chatId,$.proxy(function(){DimmedUI.getInstance().close(),this.close()},this))},onClickJoin:function(e){if(!e.currentTarget)return!1;var currentTarget=$(e.currentTarget),chatId=currentTarget.attr("data-chatId");DimmedUI.getInstance().open("",{},{isCenter:!0}),GroupProxy.getInstance().acceptGroupInvitation(chatId,$.proxy(function(){DimmedUI.getInstance().close(),this.showConfirmMoveTo(chatId)},this))},showConfirmMoveTo:function(groupId){ConfirmUI.getInstance().open({message:$.i18n.prop("SUCCESS_GROUP_JOIN"),button:{left:{label:"Chat",callback:function(){ChatProxy.getInstance().createChatGroup(groupId,null,!0)},"class":"recommend"},right:{label:"Ok",callback:function(){var screenInfo={screen:LineMain.MAIN_SCREEN_TYPE.FRIENDS,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_LIST};LineMain.getInstance().changeScreen(screenInfo)},"class":""}}})},onClickCancelInvite:function(e){if(!e.currentTarget)return!1;if(!confirm($.i18n.prop("WILL_YOU_CANCEL_INVITATION")))return!1;var currentTarget=$(e.currentTarget),mid=currentTarget.attr("data-mid");DimmedUI.getInstance().open("",{},{isCenter:!0}),GroupProxy.getInstance().cancelGroupInvitation(this.groupBo.id,[mid],$.proxy(function(){GroupProxy.getInstance().removeInvitee(this.groupBo.id,mid),DimmedUI.getInstance().close()},this))},close:function(){LineMain.getInstance().moveBack(),this.removeAll()},cancelledInvitation:function(){LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.GROUP)&&(alert($.i18n.prop("CANCEL_INVITATION")),this.closeAndMoveList())},closeAndMoveList:function(){this.removeAll();var screenInfo={screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_LIST};LineMain.getInstance().changeScreen(screenInfo)},removeAll:function(){this.initUIFlag=!1,this.inviteedMids=[]},updateGroupList:function(serializedGroupInfo){var chatBo=ChatProxy.getInstance().getChatBoById(serializedGroupInfo.id);LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.GROUP)&&(serializedGroupInfo.kickout&&1==serializedGroupInfo.kickout||!!chatBo==!1?this.closeAndMoveList():this.groupBo&&this.groupBo.id===serializedGroupInfo.id&&chatBo.groupInfo&&this.updateGroupInfo(chatBo.groupInfo))}},GroupUI.getInstance=function(){return null==GroupUI.instance&&(GroupUI.instance=new GroupUI),GroupUI.instance},GroupUI.instance=null,GroupUI.GROUP_DETAIL=BASE_DEFAULT+"src/proxy/group/ui/items/GroupManagerDetailTemplate.mustache",GroupUI.GROUP_MEMBER_ITEM=BASE_DEFAULT+"src/proxy/group/ui/items/GroupMemberItem.mustache";var GroupBO=function(){return null!=GroupBO.instance?GroupBO.instance:(this.jobWorker=new JobWorker(GroupBO.NETWORK_JOB_FILE,LineTalkExceptionHandler.getInstance().handle,LineNetworkExceptionHandler.getInstance().handle),void(this.eventManager=new EventManager))};GroupBO.prototype={getEventManager:function(){return this.eventManager},updateGroup:function(groupId,callback){this.getGroupT(groupId,$.proxy(function(group){callback.apply(callback,[group]),this.getEventManager().broadCast(group)},this))},getGroupT:function(groupId,customCallback){customCallback||(customCallback=function(res){}),this.jobWorker.send({methodName:"getGroupT",data:[groupId],success:$.proxy(function(group){this.parseGroupInfo(group),customCallback.apply(customCallback,[group])},this),error:function(){}})},parseGroupInfo:function(groupInfo){var groupContactList=_.without(_.uniq(_.union(groupInfo.invitee,groupInfo.members)),null);_.each(groupContactList,function(contact){var localContact=ContactProxy.getInstance().getContactFromLocal(contact.mid);localContact||ContactProxy.getInstance().addContact(contact)})},createGroupT:function(groupName,mids,customCallback){customCallback||(customCallback=function(res){}),this.jobWorker.send({methodName:"createGroupT",data:[groupName,mids],success:$.proxy(function(group){customCallback.apply(customCallback,[group]),this.parseGroupInfo(group),this.getEventManager().broadCast(group)},this),error:function(){}})},rejectGroupInvitationT:function(groupId,customCallback){customCallback||(customCallback=function(res){}),this.jobWorker.send({methodName:"rejectGroupInvitationT",data:[groupId],success:customCallback,error:function(){}})},acceptGroupInvitationT:function(groupId,customCallback){customCallback||(customCallback=function(res){}),this.jobWorker.send({methodName:"acceptGroupInvitationT",data:[groupId],success:customCallback,error:function(){}})},inviteIntoGroupT:function(groupId,mids,customCallback){customCallback||(customCallback=function(res){}),this.jobWorker.send({methodName:"inviteIntoGroupT",data:[groupId,mids],success:customCallback,error:function(){}})},leaveGroupT:function(groupId,customCallback){customCallback||(customCallback=function(res){}),this.jobWorker.send({methodName:"leaveGroupT",data:[groupId],success:customCallback,error:function(){}})},updateGroupT:function(groupInfo,customCallback){customCallback||(customCallback=function(res){}),this.jobWorker.send({methodName:"updateGroupT",data:groupInfo,success:customCallback,error:function(){}})},updateGroupSyncT:function(groupInfo,customCallback){try{TalkClientFactory.getInstance().createAuthClient(AuthInfoKeeper.getInstance().getAuthToken()).updateGroup(0,groupInfo),customCallback(groupInfo)}catch(e){LineNetworkExceptionHandler.getInstance().handle()}},kickoutFromGroupT:function(groupId,mids,customCallback){customCallback||(customCallback=function(res){}),this.jobWorker.send({methodName:"kickoutFromGroupT",data:[groupId,mids],success:customCallback,error:function(){}})},cancelGroupInvitationT:function(groupId,mids,customCallback){customCallback||(customCallback=function(res){}),this.jobWorker.send({methodName:"cancelGroupInvitationT",data:[groupId,mids],success:customCallback,error:function(){}})},getGroupIdsJoinedT:function(customCallback){customCallback||(customCallback=function(res){}),this.jobWorker.send({methodName:"getGroupIdsJoinedT",data:[],success:customCallback,error:function(){}})},getGroupIdsInvitedT:function(customCallback){customCallback||(customCallback=function(res){}),this.jobWorker.send({methodName:"getGroupIdsInvitedT",data:[],success:customCallback,error:function(){}})},updateConnectionServerInfo:function(){this.jobWorker.sendQuery("pushServerInfo",PersistentStore.getInstance().get("CI_serverList"))}},GroupBO.getInstance=function(){return null==GroupBO.instance&&(GroupBO.instance=new GroupBO),GroupBO.instance},GroupBO.instance=null,GroupBO.NETWORK_JOB_FILE=BASE_DEFAULT+"src/worker/GroupNetworkJob.js";var GroupDetailBO=function(groupInfo){_.extend(this,groupInfo),this.isGroupMember=this.checkGroupMember(),this.makeGroupProfile(),this.contactCheck()};GroupDetailBO.prototype={makeGroupProfile:function(){this.thumbnail=Utility.groupProfileURL(this,90)},checkGroupMember:function(){var myMid=AuthInfoKeeper.getInstance().getAuthMid(),groupMemberIds=_.pluck(this.members,"mid");return _.contains(groupMemberIds,myMid)},contactCheck:function(){var myMid=AuthInfoKeeper.getInstance().getAuthMid();this.members=_.map(this.members,function(contact){var localContact=ContactProxy.getInstance().getContactFromLocal(contact.mid);return localContact&&myMid===localContact.mid&&(localContact=_.extend(localContact,ProfileProxy.getInstance().getProfile()),localContact.thumbnail=Utility.combineSettingProfileURL(localContact,56)),localContact}),this.invitee=_.map(this.invitee,function(contact){var localContact=ContactProxy.getInstance().getContactFromLocal(contact.mid);return localContact&&myMid===localContact.mid&&(localContact=_.extend(localContact,ProfileProxy.getInstance().getProfile()),localContact.thumbnail=Utility.combineSettingProfileURL(localContact,56)),localContact})},getExcludeContactMid:function(){return _.pluck(_.union(this.members,this.invitee),"mid")}};var ProfileProxy=function(){return null!=ProfileProxy.instance?ProfileProxy.instance:(this.eventManager=new EventManager,this.store=ProfilePersistentStore.getInstance(),this.profileBo=ProfileBO.getInstance(),this.setEvent(),this.initFromStore(),void(this.jobWorker=new JobWorker(BASE_DEFAULT+"src/worker/ProfileNetworkJob.js",LineTalkExceptionHandler.getInstance().handle,LineNetworkExceptionHandler.getInstance().handle)))};ProfileProxy.prototype={initFromStore:function(){var storedProfile=this.store.get();this.profileBo.setProfile(storedProfile)},getJobWorker:function(){return this.jobWorker},setEvent:function(){},notifyUpdate:function(){this.eventManager.broadCast()},getEventManager:function(){return this.eventManager},getProfile:function(){return this.profileBo.getProfile()},isEqualProfile:function(a,b){return delete a.mid,delete a.phone,delete b.mid,delete b.phone,_.isEqual(a,b)},setProfile:function(data){var targetModel=_.clone(data),originModel=this.profileBo.getProfile();this.profileBo.setProfile(data),this.store.set(this.profileBo.getProfile()),this.isEqualProfile(targetModel,originModel)||this.eventManager.broadCast()},updateProfile:function(data,callback){this.setProfile(data),this.updateToServerProfile(callback)},updateProfileAttribute:function(key,value,callback){callback=callback?callback:EventManager.EMPTY,this.profileBo.updateProfileAttributeT(ProfileAttribute[key],value,$.proxy(function(result){this.profileBo.setProfileAttribute(key,value),this.store.set(this.profileBo.getProfile()),this.eventManager.broadCast(null),callback(result)},this))},updateToLocalProfile:function(callback){callback=callback?callback:function(){},this.profileBo.getProfileT($.proxy(function(profile){this.setProfile(profile),callback(profile)},this))},updateToServerProfile:function(callback){var profile=this.getProfile();this.profileBo.updateProfileT(profile,callback)},isUseridAvailable:function(userid,callback){this.profileBo.isUseridAvailableT(userid,callback)},registerUserId:function(userid,callback){this.profileBo.registerUserIdT(userid,$.proxy(function(result){this.setProfile({userid:userid}),LineMain.getInstance().getEventManager().broadCast(),callback(result)},this))},togglePublicUserId:function(flag,callback){DimmedUI.getInstance().open("",{},{isCenter:!0}),ProfileBO.getInstance().updateProfileAttributeT(ProfileAttribute.ALLOW_SEARCH_BY_USERID,flag,$.proxy(function(){ProfileBO.getInstance().setProfileAttribute("ALLOW_SEARCH_BY_USERID",flag),ProfileProxy.getInstance().store.set(ProfileBO.getInstance().getProfile()),DimmedUI.getInstance().close(),callback(flag)},this))},removeAll:function(){this.profileBo.removeAll()},updateConnectionServerInfo:function(){this.jobWorker.sendQuery("pushServerInfo",PersistentStore.getInstance().get("CI_serverList"))
},debugMode:function(debugInfo){this.jobWorker.sendQuery("pushDebugInfo",debugInfo)}},ProfileProxy.getInstance=function(){return null==ProfileProxy.instance&&(ProfileProxy.instance=new ProfileProxy),ProfileProxy.instance},ProfileProxy.instance=null;var ProfileUI=function(){if(null!=ProfileUI.instance)return ProfileUI.instance;this.initElements(),this.profileTmpl=TemplateManager.getInstance().get(ProfileUI.PROFILE_VIEW),TemplateManager.getInstance().get(SingleInputView.getInstance().SINGLE_INPUT_VIEW),ProfileProxy.getInstance().getEventManager().regist($.proxy(this.init,this)),SettingPersistentStore.getInstance().getEventManager().regist($.proxy(this.init,this));var profile=ProfileProxy.getInstance().getProfile();this.pictureStatus=profile.pictureStatus};ProfileUI.prototype={MAX_IMAGE_UPDATE_RETRY_COUNT:3,init:function(){LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.SETTING_PROFILE)&&(this.changeWrapperWithTemplate(),this.initElements(),this.setEvents())},getProfileModel:function(){var profile=ProfileProxy.getInstance().getProfile();return profile.authorizedPhoneNumber=AuthInfoKeeper.getInstance().getPhoneNumber(),profile.thumbnail=Utility.combineSettingProfileURL(profile),profile},changeWrapperWithTemplate:function(){var profile=this.getProfileModel(),tmpl=Mustache.render(this.profileTmpl,profile);this.wrapSetting.html(tmpl),this.elWrapProfile=$("._profile_view"),Utility.lazyLoadImage(this.wrapSetting.find("img"))},initElements:function(){this.elWrapProfile=$("._profile_view"),this.wrapSetting=$("#_wrap_setting")},setEvents:function(){this.elWrapProfile.find("._user_id_add_btn").on("click",function(){var userId=$("._user_id_txt").val();ProfileProxy.getInstance().registerUserId(userId)}),this.elWrapProfile.find("._delete_account").on("click",function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_DELETE_ACCOUNT})}),this.elWrapProfile.find("._change_display_name").on(UIStructure.EVENT_CLICK,$.proxy(function(e){this.onTabChangeDisplayName(e)},this)),this.elWrapProfile.find("._change_status_message").on(UIStructure.EVENT_CLICK,$.proxy(function(e){this.onTabChangeStatusMessage(e)},this)),this.elWrapProfile.find("._toggle_pub_userid_btn").on(UIStructure.EVENT_CLICK,$.proxy(function(e){this.togglePublicUserId(e.currentTarget)},this)),this.elWrapProfile.find("._profile_image").on(UIStructure.EVENT_CLICK,$.proxy(this.onClickPhotoImage,this)),this.elWrapProfile.find("._add_user_id").on(UIStructure.EVENT_CLICK,$.proxy(this.onTabAddUserId,this))},togglePublicUserId:function(element){var profile=ProfileProxy.getInstance().getProfile(),value=profile.allowSearchByUserid;value="false"!==value&&value?!1:!0,ProfileProxy.getInstance().togglePublicUserId(value,function(){value?$(element).removeClass("mdMN13IsOff").addClass("mdMN13IsOn"):$(element).removeClass("mdMN13IsOn").addClass("mdMN13IsOff")})},onClickPhotoImage:function(){this.pickImage($.proxy(this.uploadImage,this))},pickImage:function(callback){var profile=ProfileProxy.getInstance().getProfile(),hasImage=""!==profile.pictureStatus&&null!==profile.pictureStatus,pickerConfig={photo:{callback:$.proxy(function(image){DimmedUI.getInstance().open("",{},{isCenter:!0}),callback(image)},this)}};hasImage&&(pickerConfig.remove={callback:$.proxy(function(){DimmedUI.getInstance().open("",{},{isCenter:!0}),ProfileProxy.getInstance().updateProfileAttribute("PICTURE","",$.proxy(function(){var noImage="/res/img/noimg/profile_img90x90.png";this.elWrapProfile.find("img").attr("src",noImage),DimmedUI.getInstance().close(),ProfileProxy.getInstance().updateToLocalProfile(EventManager.EMPTY)},this))},this)}),new MediaPickerUI(pickerConfig).pickMedia()},uploadImage:function(image){ProfileProxy.getInstance().setProfile({pictureStatus:null,picturePath:null}),ProfileProxy.getInstance().updateProfile(ProfileProxy.getInstance().getProfile(),$.proxy(function(){var oSegmReq=new FileReader;oSegmReq.readAsArrayBuffer(image),oSegmReq.onload=$.proxy(function(e){var arrayBuffer=e.target.result,authToken=AuthInfoKeeper.getInstance().getAuthToken(),fileUploader=new FileUploader;fileUploader.uploadProfileImage({authToken:authToken,oid:AuthInfoKeeper.getInstance().getAuthMid(),imageName:image.name,imageType:image.type,imageQuality:LineConfig.UPLOAD_IMAGE_QUALITY,imageArrayBuffer:arrayBuffer,complete:$.proxy(function(){this.retryCount=0,this.updateProfileImage()},this),progress:function(){DimmedUI.getInstance().open("",{},{isCenter:!0})},error:function(){alert($.i18n.prop("NETWORK_ERROR_INFO")),DimmedUI.getInstance().close()}})},this)},this))},updateProfileImage:function(){ProfileProxy.getInstance().updateToLocalProfile($.proxy(function(){var profile=ProfileProxy.getInstance().getProfile();if(null===profile.pictureStatus&&this.retryCount<this.MAX_IMAGE_UPDATE_RETRY_COUNT)this.retryTimer=setTimeout($.proxy(this.updateProfileImage,this),1e3);else{if(null!==profile.pictureStatus)return clearTimeout(this.retryTimer),DimmedUI.getInstance().close(),this.init(),void(this.retryCount=100);clearTimeout(this.retryTimer),this.retryCount=0,DimmedUI.getInstance().close()}this.retryCount++},this))},onTabChangeDisplayName:function(e){var defaultValue=$(e.currentTarget).attr("data-value");CommonUI.getInstance().openSingleInputPage({defaultMessage:defaultValue,maxLength:LineConfig.SETTING_DISPLAY_NAME_LENGTH,minLength:1,alertMinMax:!0,title:$.i18n.prop("PROFILE"),inputTitle:$.i18n.prop("DISPLAY_NAME"),submit:function(value){return value===defaultValue?void LineMain.getInstance().moveBack():(DimmedUI.getInstance().open("",{},{isCenter:!0}),ProfileProxy.getInstance().updateProfileAttribute("DISPLAY_NAME",value,function(){DimmedUI.getInstance().close()}),void LineMain.getInstance().moveBack())}})},onTabChangeStatusMessage:function(e){var defaultValue=$(e.currentTarget).attr("data-value");CommonUI.getInstance().openSingleInputPage({defaultMessage:$(e.currentTarget).attr("data-value"),maxLength:20,minLength:0,title:$.i18n.prop("PROFILE"),inputTitle:$.i18n.prop("STATUS_MESSAGE"),submit:function(value){return value===defaultValue?void LineMain.getInstance().moveBack():(DimmedUI.getInstance().open("",{},{isCenter:!0}),ProfileProxy.getInstance().updateProfileAttribute("STATUS_MESSAGE",value,function(){DimmedUI.getInstance().close()}),void LineMain.getInstance().moveBack())}})},onTabAddUserId:function(){CommonUI.getInstance().openSingleInputPage({defaultMessage:ProfileProxy.getInstance().getProfile().userid,warnMessage:$.i18n.prop("SET_LINE_ID_INFO_TEXT"),maxLength:20,minLength:1,passInput:!0,lowercase:!0,title:$.i18n.prop("PROFILE"),inputTitle:$.i18n.prop("USER_ID"),buttonLabel:$.i18n.prop("ID_CHECK"),submit:$.proxy(this.handleRegisterUserId,this),onChangeInput:$.proxy(function(){this.changeUserIdInputStatus(!1)},this)})},handleRegisterUserId:function(value){value=$.trim(value).toLowerCase();var invalidStrCheck=function(value){return/[^a-z0-9\-\._]/.test(value)};return value.length<4||value.length>20?void $("._warn_message").html($.i18n.prop("INVALID_LENGTH_OF_LINE_ID_ERROR_TEXT")):invalidStrCheck(value)?void $("._warn_message").html($.i18n.prop("INVALID_CHARS_IN_LINE_ID_ERROR_TEXT")):(DimmedUI.getInstance().open("",{},{isCenter:!0}),void ProfileProxy.getInstance().isUseridAvailable(value,$.proxy(function(availableFlag){DimmedUI.getInstance().close(),availableFlag?($("._warn_message").html($.i18n.prop("IT_IS_USABLE_LINE_ID_WILL_YOU_USE_IT")),this.changeUserIdInputStatus(!0,value)):$("._warn_message").html($.i18n.prop("ID_IS_NOT_USABLE"))},this)))},changeUserIdInputStatus:function(flag,value){flag?($("._confirm_btn").addClass("MdNonDisp"),$("._register_btn").removeClass("MdNonDisp").removeClass("ExDisabled").html($.i18n.prop("SAVE")).off(UIStructure.EVENT_CLICK).on(UIStructure.EVENT_CLICK,function(){var userId=value.toLowerCase();DimmedUI.getInstance().open("",{},{isCenter:!0}),ProfileProxy.getInstance().registerUserId(userId,function(result){return DimmedUI.getInstance().close(),LineMain.getInstance().moveBack(),result.code===ErrorCode.INVALID_LENGTH?void alert($.i18n.prop("ID_IS_NOT_USABLE")):void 0})})):($("._warn_message").html($.i18n.prop("SET_LINE_ID_INFO_TEXT")),$("._confirm_btn").removeClass("MdNonDisp"),$("._register_btn").addClass("MdNonDisp"))}},ProfileUI.getInstance=function(){return null==ProfileUI.instance&&(ProfileUI.instance=new ProfileUI),ProfileUI.instance},ProfileUI.instance=null,ProfileUI.PROFILE_VIEW=BASE_DEFAULT+"src/proxy/profile/ui/screen/Profile.mustache";var ProfileBO=function(){return null!=ProfileBO.instance?ProfileBO.instance:(_.extend(this,BOStructure),void this.initProperty())};ProfileBO.prototype={initProperty:function(){this.allowSearchByEmail=null,this.allowSearchByUserid=null,this.displayName=null,this.phoneticName=null,this.email=null,this.thumbnailUrl=null,this.picturePath=null,this.pictureStatus=null,this.statusMessage=null,this.userid=null,this.regionCode=null},getProfile:function(){var profile=_.clone(this);return Utility.serialize(profile)},setProfile:function(userData){var data=Utility.serialize(userData);delete data.mid,delete data.phone,_.extend(this,data)},setProfileAttribute:function(attr,value){var attrMap={};attrMap[ProfileAttribute.ALL]=null,attrMap[ProfileAttribute.EMAIL]="email",attrMap[ProfileAttribute.DISPLAY_NAME]="displayName",attrMap[ProfileAttribute.PHONETIC_NAME]="phoneticName",attrMap[ProfileAttribute.PICTURE]="picture",attrMap[ProfileAttribute.STATUS_MESSAGE]="statusMessage",attrMap[ProfileAttribute.ALLOW_SEARCH_BY_USERID]="allowSearchByUserid",attrMap[ProfileAttribute.ALLOW_SEARCH_BY_EMAIL]="allowSearchByEmail",attrMap[ProfileAttribute.BUDDY_STATUS]="";var attributeNumber=ProfileAttribute[attr],property=attrMap[attributeNumber];if(!property)throw"No such attribute in Settings : "+attr;this[property]=value},getProfileT:function(callback){var uniqueKey=(new Date).getTime();callback=callback?callback:function(){};var options={methodName:"getProfileT",data:[uniqueKey],uniquekey:uniqueKey,success:$.proxy(function(result){callback(result)},this),error:function(){}};ProfileProxy.getInstance().getJobWorker().send(options)},updateProfileT:function(profile,callback){callback=callback?callback:function(){};var options={methodName:"updateProfileT",data:[profile],success:$.proxy(function(result){callback(result)},this),error:function(){}};ProfileProxy.getInstance().getJobWorker().send(options)},updateProfileAttributeT:function(key,value,callback){callback=callback?callback:function(){};var options={methodName:"updateProfileAttributeT",data:[0,key,value+""],success:$.proxy(function(result){callback(result)},this),error:function(){}};ProfileProxy.getInstance().getJobWorker().send(options)},isUseridAvailableT:function(userId,callback){callback=callback?callback:function(){};var options={methodName:"isUseridAvailableT",data:[userId],success:$.proxy(function(result){result.reason?alert(result.reason):callback(result)},this),error:function(){}};ProfileProxy.getInstance().getJobWorker().send(options)},registerUserIdT:function(userId,callback){callback=callback?callback:function(){};var options={methodName:"registerUseridT",data:[0,userId],success:$.proxy(function(result){result.reason?alert(result.reason):callback(result)},this),error:function(){}};ProfileProxy.getInstance().getJobWorker().send(options)},removeAll:function(){this.initProperty()}},ProfileBO.getInstance=function(){return null==ProfileBO.instance&&(ProfileBO.instance=new ProfileBO),ProfileBO.instance},ProfileBO.instance=null;var RecommendProxy=function(){return null!=RecommendProxy.instance?RecommendProxy.instance:(this.contactListBO=ContactListBO.getInstance(),this.contactListDAO=ContactListDAO.getInstance(),this.customStore=PersistentStore.getInstance(),void this.contactListBO.getEventManager().regist(this.updateContactList.bind(this)))};RecommendProxy.prototype={getRecommendList:function(){return this.contactListBO.getRecommendList()},getRecommendByMid:function(mid){return this.contactListBO.getContactFromLocal(mid)},updateContactList:function(){RecommendUI.getInstance().renderPage()},removeAll:function(){},saveRecommendBadgeCount:function(count){this.customStore.set("CD_recommendBadgeCount",count)},getRecommendBadgeCount:function(){return this.customStore.get("CD_recommendBadgeCount")}},RecommendProxy.getInstance=function(){return null==RecommendProxy.instance&&(RecommendProxy.instance=new RecommendProxy),RecommendProxy.instance},RecommendProxy.instance=null;var RecommendUI=function(){return null!=RecommendUI.instance?RecommendUI.instance:(_.extend(this,UIStructure),this.assigne(),this.setEvent(),void this.loadBadgeCount())};RecommendUI.prototype={assigne:function(){this.initUIFlag=!1,this.recommendBadgeCount=null,this.recommendProxy=RecommendProxy.getInstance(),this.ADD_FRIENDS_TEMPLATE=BASE_DEFAULT+"src/proxy/recommend/ui/items/AddFriendsTemplate.mustache",this.RECOMMEND_ITEM=BASE_DEFAULT+"src/proxy/recommend/ui/items/RecommendItem.mustache",this.RECOMMEND_CONTEXT_MENU=BASE_DEFAULT+"src/proxy/recommend/ui/items/RecommendContextMenuItem.mustache",this.wrapContextMenu=$("#_wrap_context_menu"),this.wrapAddFriends=$("#_wrap_add_friends"),this.wrapRecommendBadgeCount=$("#_recommend_badge_count")},dynamicAssigne:function(){this.btnSearchById=this.wrapAddFriends.find("._btn_search_by_id"),this.wrapFriendsRecommendationList=this.wrapAddFriends.find("._wrap_friends_recommendations_list"),this.wrapFriendsRecommendationEmpty=this.wrapAddFriends.find("._wrap_friends_empty_txt"),this.friendsRecommendationCount=this.wrapAddFriends.find("._friends_recommendations_count"),this.friendsRecommendationList=this.wrapAddFriends.find("._friends_recommendations_list")},setEvent:function(){LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this))},dynamicSetEvent:function(){this.btnSearchById.off(this.EVENT_CLICK).on(this.EVENT_CLICK,$.proxy(this.onClickSearchById,this)),this.friendsRecommendationList.off(this.EVENT_CLICK,"li").on(this.EVENT_CLICK,"li",$.proxy(this.onClickRecommend,this)),this.wrapContextMenu.off(this.EVENT_CLICK,".wrap_recommend_context_menu button").on(this.EVENT_CLICK,".wrap_recommend_context_menu button",$.proxy(this.onClickContextMenu,this))},changeScreen:function(options){return this.initUIFlag&&options&&options.type===UIEventManager.EVENT_RESIZE?(this.resize(),!1):(LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.ADD_CONTACT)?this.wrapAddFriends.removeClass("MdNonDisp"):this.wrapAddFriends.addClass("MdNonDisp"),void(LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.ADD_CONTACT_LIST)&&($("body").removeClass("bgTypeG03").addClass("bgTypeG01"),HeaderView.getInstance().update({friend_option:{action:this.onClickSetting}}).setTitle($.i18n.prop("ADD_AS_FRIEND")).show(),MenuView.getInstance().set(LineMain.getInstance().getScreenInfo()).show(),this.renderPage(),this.clearBadgeCount(),this.resize())))},resize:function(){var windowHeight=LineMain.WINDOW_HEIGHT,scrollAreaHeight=windowHeight-LineMain.HEADER_SIZE-LineMain.MENU_BAR_SIZE-LineMain.SEARCH_BAR_SIZE;this.wrapAddFriends.find(".MdScroll01").height(scrollAreaHeight),this.wrapFriendsRecommendationEmpty.removeAttr("style").css("padding-top",scrollAreaHeight/2-this.wrapFriendsRecommendationEmpty.height()/2)},renderPage:function(){if(!this.initUIFlag){var addFriendsTemplate=TemplateManager.getInstance().get(this.ADD_FRIENDS_TEMPLATE),html=Mustache.render(addFriendsTemplate,{});this.wrapAddFriends.html(html),this.dynamicAssigne(),this.dynamicSetEvent(),this.initUIFlag=!0}this.updateRecommendList()},updateRecommendList:function(){var recommendList=RecommendProxy.getInstance().getRecommendList(),recommendListCount=recommendList.length;if(this.updateRecommendCount(recommendListCount),recommendListCount>0){var template=TemplateManager.getInstance().get(this.RECOMMEND_ITEM),listArr=[];_.each(recommendList,$.proxy(function(item){var output=Mustache.render(template,item);listArr.push(output)},this)),this.friendsRecommendationList.html(listArr.join("")),this.friendsRecommendationList.find(".mdMN02Li").eq(0).addClass("mdMN02LiF"),Utility.lazyLoadImage(this.friendsRecommendationList.find("img")),this.wrapFriendsRecommendationList.removeClass("MdNonDisp"),this.wrapFriendsRecommendationEmpty.addClass("MdNonDisp")}else this.wrapFriendsRecommendationList.addClass("MdNonDisp"),this.wrapFriendsRecommendationEmpty.removeClass("MdNonDisp"),this.clearBadgeCount()},updateRecommendCount:function(count){this.friendsRecommendationCount.text(count)},showRecommendContextMenu:function(mid){var item=this.recommendProxy.getRecommendByMid(mid),recommendContextTemplate=TemplateManager.getInstance().get(this.RECOMMEND_CONTEXT_MENU),html=Mustache.render(recommendContextTemplate,item);this.wrapContextMenu.html(html),this.wrapContextMenu.removeClass("MdNonDisp")},onClickSearchById:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.ETC,subScreen:LineMain.SUB_SCREEN_TYPE.SEARCH_BY_USERID})},increaseBadgeCount:function(){this.recommendBadgeCount++,this.updateBadgeCount(),RecommendProxy.getInstance().saveRecommendBadgeCount(this.recommendBadgeCount)},updateBadgeCount:function(){var badgeCount=this.recommendBadgeCount;badgeCount>LineConfig.RECOMMEND_FRIEND_MAX_BADGE_COUNT&&(badgeCount=LineConfig.RECOMMEND_FRIEND_MAX_BADGE_COUNT+"+"),this.wrapRecommendBadgeCount.text(badgeCount)},clearBadgeCount:function(){this.recommendBadgeCount=null,this.updateBadgeCount(),RecommendProxy.getInstance().saveRecommendBadgeCount(0)},onClickRecommend:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),mid=currentTarget.attr("data-mid");this.showRecommendContextMenu(mid)},onClickContextMenu:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),actionInfo=currentTarget.attr("data-action").split("-"),action=actionInfo[0],mid=actionInfo[1];switch(action){case"block":confirm($.i18n.prop("WILL_YOU_BLOCK_USERS",1))&&(DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().blockContact(mid,$.proxy(function(){DimmedUI.getInstance().close()},this)));break;case"add":DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().findAndAddContactsByMid(mid,$.proxy(function(){DimmedUI.getInstance().close()},this));break;case"cancel":this.wrapContextMenu.addClass("MdNonDisp")}this.wrapContextMenu.addClass("MdNonDisp")},onClickSetting:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_FRIENDS})},loadBadgeCount:function(){var badgeCount=RecommendProxy.getInstance().getRecommendBadgeCount();badgeCount>0&&(this.recommendBadgeCount=badgeCount,this.updateBadgeCount())}},RecommendUI.getInstance=function(){return null==RecommendUI.instance&&(RecommendUI.instance=new RecommendUI),RecommendUI.instance},RecommendUI.instance=null;var SearchByIdUI=function(){return null!=SearchByIdUI.instance?SearchByIdUI.instance:(_.extend(this,UIStructure),this.assigne(),void this.setEvent())};SearchByIdUI.prototype={assigne:function(){this.WRAP_ADD_FRIEND_FORM=BASE_DEFAULT+"src/proxy/recommend/ui/items/AddFriendForm.mustache",this.ID_SEARCHING=BASE_DEFAULT+"src/proxy/recommend/ui/items/IdSearchingItem.mustache",this.ID_SEARCH_RESULT=BASE_DEFAULT+"src/proxy/recommend/ui/items/IdSearchResultItem.mustache",this.wrapEtcLayer=$("#_wrap_etc"),this.wrapSearchFriend=null,this.wrapSearchFriendResult=null},dynamicAssign:function(){this.btnUseridSetting=this.wrapEtcLayer.find("._btn_userid_set"),this.wrapSearchFriend=this.wrapEtcLayer.find("#_wrap_search_friend"),this.wrapSearchFriendResult=this.wrapEtcLayer.find("#_wrap_search_result"),this.inputUserId=this.wrapSearchFriend.find("#_input_userid"),this.btnSearchCancel=this.wrapEtcLayer.find("._btn_cancel")},setEvent:function(){LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this))},dynamicSetEvent:function(){this.btnUseridSetting.off(this.EVENT_CLICK).on(this.EVENT_CLICK,$.proxy(this.moveUseridSetting,this)),this.wrapSearchFriend.off(this.EVENT_CLICK).on(this.EVENT_CLICK,"#_btn_search",$.proxy(this.searchFriend,this)),this.inputUserId.off("keyup").on("keyup",$.proxy(this.onChangeSearchId,this)),this.wrapSearchFriend.off(this.EVENT_CLICK,"._btn_cancel").on(this.EVENT_CLICK,"._btn_cancel",$.proxy(this.cancelSearchInput,this))},changeScreen:function(options){if(options&&options.type===UIEventManager.EVENT_RESIZE)return!1;if(LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.ETC)?this.wrapEtcLayer.removeClass("MdNonDisp"):this.wrapEtcLayer.addClass("MdNonDisp").html(""),LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.SEARCH_BY_USERID)){$("body").removeClass("bgTypeG03").addClass("bgTypeG01");var headerView=HeaderView.getInstance();headerView.set({close:!0}).setTitle($.i18n.prop("SEARCH_FRIEND_BY_ID")).show(),this.renderSearchForm()}},renderSearchForm:function(){var profile=ProfileProxy.getInstance().getProfile(),addFriendForm=TemplateManager.getInstance().get(this.WRAP_ADD_FRIEND_FORM),html=Mustache.render(addFriendForm,profile);this.wrapEtcLayer.html(html),this.dynamicAssign(),this.dynamicSetEvent()},moveUseridSetting:function(){ProfileUI.getInstance().onTabAddUserId()},onChangeSearchId:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),userid=currentTarget.val();userid.length>0?(currentTarget.parent().removeClass("ExPlaceholder"),this.btnSearchCancel.removeClass("MdNonDisp")):(currentTarget.parent().addClass("ExPlaceholder"),this.btnSearchCancel.addClass("MdNonDisp"))},cancelSearchInput:function(){this.btnSearchCancel.addClass("MdNonDisp"),this.inputUserId.val("").parent().addClass("ExPlaceholder"),setTimeout($.proxy(function(){this.inputUserId.focus()},this),0)},searchFriend:function(){var userId=this.inputUserId.val();if(!userId)return!1;var idSearchingTemplate=TemplateManager.getInstance().get(this.ID_SEARCHING),searching=Mustache.render(idSearchingTemplate,{});this.wrapSearchFriendResult.html(searching);var emptyPadding=($(window).height()-this.wrapSearchFriendResult.offset().top)/2-this.wrapSearchFriendResult.height()/2;this.wrapSearchFriendResult.css("padding-top",emptyPadding),ContactProxy.getInstance().findContactByUserid(userId,$.proxy(this.successSearchFriend,this))},successSearchFriend:function(searchedContact){if(searchedContact.code===ErrorCode.EXCESSIVE_ACCESS)return alert($.i18n.prop("NUMBER_OF_FIND_FRIEND_LIMIT_EXCEED_WARNING_TEXT")),this.wrapSearchFriendResult.html(""),!1;var idSearchResultTemplate=TemplateManager.getInstance().get(this.ID_SEARCH_RESULT);searchedContact.thumbnail=Utility.combineProfileURL(searchedContact,90),searchedContact.mid===AuthInfoKeeper.getInstance().getAuthMid()?searchedContact.isYou=!0:searchedContact.status===ContactStatus.FRIEND&&(searchedContact.isFriend=!0);var searching=Mustache.render(idSearchResultTemplate,Utility.serialize(searchedContact));this.wrapSearchFriendResult.html(searching),Utility.lazyLoadImage(this.wrapSearchFriendResult.find("img"));var SEARCH_RESULT_HTML_HEIGHT=174,emptyPadding=($(window).height()-this.wrapSearchFriendResult.offset().top)/2-SEARCH_RESULT_HTML_HEIGHT/2;this.wrapSearchFriendResult.css("padding-top",emptyPadding),this.wrapSearchFriendResult.off(this.EVENT_CLICK).on(this.EVENT_CLICK,"#_btn_add_contact",$.proxy(this.addFriend,this))},addFriend:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),mid=currentTarget.attr("data-mid");ContactProxy.getInstance().findAndAddContactsByMid(mid),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIENDS,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_LIST})}},SearchByIdUI.getInstance=function(){return null==SearchByIdUI.instance&&(SearchByIdUI.instance=new SearchByIdUI),SearchByIdUI.instance},SearchByIdUI.instance=null;var RegisterEmailUI=function(){return null!=RegisterEmailUI.instance?RegisterEmailUI.instance:void _.extend(this,new RegisterUI)};RegisterEmailUI.prototype={handleRegisterEmailError:function(result){var errorMsg=null;switch(result.code){case ErrorCode.INTERNAL_ERROR:errorMsg=$.i18n.prop("EMAIL_AUTHENTICATION_EXPIRED_PIN");break;case ErrorCode.INVALID_PIN_CODE:errorMsg=$.i18n.prop("WRONG_ENFORCE_SECURITY_NUMBER");break;case ErrorCode.NOT_AVAILABLE_PIN_CODE_SESSION:errorMsg=$.i18n.prop("EMAIL_AUTHENTICATION_EXPIRED_PIN");break;case ErrorCode.NOT_AVAILABLE_SESSION:errorMsg=$.i18n.prop("REGISTRATION_DIALOG_SESSION_EXPIRED");break;case ErrorCode.ILLEGAL_ARGUMENT:errorMsg=$.i18n.prop("MULTIDEVICE_REGISTER_IDENTITY_CREDENTIAL_ERROR_MSG_FAILED_EMAIL");break;case ErrorCode.NOT_AVAILABLE_IDENTITY_IDENTIFIER:errorMsg=$.i18n.prop("ALREADY_REGISTERED_EMAIL_ADDRESS_ERROR_TEXT")}return errorMsg},checkEmailValidation:function(alertFlag,email,password,rePassword){if(!Utility.isValidEmail(email))return alertFlag&&alert($.i18n.prop("INVALID_EMAIL_ADDRESS_FORMAT_ERROR_TEXT")),!1;if(void 0!==password){var passwordLength=$.trim(password).length;if(passwordLength<LineConfig.MIN_PASSWORD_LENGTH||passwordLength>LineConfig.MAX_PASSWORD_LENGTH)return alertFlag&&alert($.i18n.prop("VALID_PASSWORD_INFO_TEXT",LineConfig.MIN_PASSWORD_LENGTH,LineConfig.MAX_PASSWORD_LENGTH)),!1}return void 0!==password&&void 0!==rePassword&&password!==rePassword?(alertFlag&&alert($.i18n.prop("INVALID_PASSWORD_CONFIRM_TEXT")),!1):!0},setOnConfirm:function(callback){this.onConfirm=callback},setOnCancel:function(callback){this.onCancel=callback},assignEmailRegister:function(){this.container=this.wrapElement.find("._email_register_view")},setEventEmailRegister:function(){this.container.on(UIStructure.EVENT_INPUT,"._email_login_text",$.proxy(this.onChangeEmailText,this)).on(UIStructure.EVENT_INPUT,"._email_password_text",$.proxy(this.onChangePasswordText,this)).on(UIStructure.EVENT_INPUT,"._email_re_password_text",$.proxy(this.onChangeRePasswordText,this)).on(UIStructure.EVENT_CLICK,"._confirm_btn",$.proxy(this.onClickConfirmRegisterBtn,this)).on(UIStructure.EVENT_CLICK,"._cancel_btn",$.proxy(this.onClickCancelRegisterBtn,this)),this.container.find("._email_login_text").trigger("keyup"),this.container.find("._email_password_text").trigger("keyup"),this.container.find("._email_re_password_text").trigger("keyup")},onClickCancelRegisterBtn:function(){this.onCancel()},onClickConfirmRegisterBtn:function(e){var myEmail=SettingProxy.getInstance().getProp("identityIdentifier"),emailConfirm={email:$.trim(this.container.find("._email_login_text").val()),password:$.trim(this.container.find("._email_password_text").val()),rePassword:$.trim(this.container.find("._email_re_password_text").val())};return $(e.currentTarget).hasClass("ExDisabled")?void 0:emailConfirm.email===myEmail?void alert($.i18n.prop("ALREADY_REGISTERED_EMAIL_ADDRESS_ERROR_TEXT"),myEmail):void(this.checkEmailValidation(!0,emailConfirm.email,emailConfirm.password,emailConfirm.rePassword)&&this.checkInputValidation()&&(DimmedUI.getInstance().open("",{},{isCenter:!0}),RegisterStepInfoKeeper.getInstance().setUserInputEmail(emailConfirm.email),RegisterStepInfoKeeper.getInstance().setUserInputEmailPassword(emailConfirm.password),RegisterStepInfoKeeper.getInstance().setIgnoreDuplication(!1),this.requestEmailConfirmation($.proxy(function(result){DimmedUI.getInstance().close(),result.code===ErrorCode.NOT_AVAILABLE_IDENTITY_IDENTIFIER?ConfirmUI.getInstance().open({message:$.i18n.prop("ALREADY_REGISTERED_EMAIL_ADDRESS_OVERRIDE_CONFIRM_TEXT"),button:{left:{label:$.i18n.prop("CANCEL"),callback:function(){}},right:{label:$.i18n.prop("CONFIRM"),callback:$.proxy(function(){RegisterStepInfoKeeper.getInstance().setIgnoreDuplication(!0),this.requestEmailConfirmation($.proxy(function(result){this.onConfirm(result),DimmedUI.getInstance().close()},this))},this)}}}):this.onConfirm(result)},this))))},setEmailRegisterElements:function(){this.container=this.wrapElement.find("#_email_register_view")},setEmailRegisterEvent:function(){this.container.on(UIStructure.EVENT_INPUT,"._email_login_text",$.proxy(this.onChangeEmailText,this)).on(UIStructure.EVENT_INPUT,"._email_password_text",$.proxy(this.onChangePasswordText,this)).on(UIStructure.EVENT_INPUT,"._email_re_password_text",$.proxy(this.onChangeRePasswordText,this)).on(UIStructure.EVENT_CLICK,"._confirm_btn",$.proxy(this.onClickConfirmBtn,this)).on(UIStructure.EVENT_CLICK,"._cancel_btn",$.proxy(this.onClickCancelBtn,this))},onChangeEmailText:function(e){this.changeInputStatus($(e.currentTarget)),this.checkInputValidation()},getEmailInput:function(){return{email:$.trim(this.container.find("._email_login_text").val()),password:$.trim(this.container.find("._email_password_text").val()),rePassword:$.trim(this.container.find("._email_re_password_text").val())}},checkInputValidation:function(){var emailConfirm=this.getEmailInput();return 0===emailConfirm.email.length||0===emailConfirm.password.length||0===emailConfirm.rePassword.length?(this.container.find("._confirm_btn").addClass("ExDisabled"),!1):(this.container.find("._confirm_btn").removeClass("ExDisabled"),!0)},onChangePasswordText:function(e){this.changePasswordInputStatus($(e.currentTarget));var textLength=$.trim($(e.currentTarget).val()).length;this.container.find("._password_count").html(textLength+"/20"),this.checkInputValidation()},onChangeRePasswordText:function(e){this.changePasswordInputStatus($(e.currentTarget)),this.checkInputValidation()},onClickConfirmBtn:function(e){this.container.find("input").blur();var emailConfirm=this.getEmailInput();$(e.currentTarget).hasClass("ExDisabled")||this.checkEmailValidation(!0,emailConfirm.email,emailConfirm.password,emailConfirm.rePassword)&&(RegisterStepInfoKeeper.getInstance().setUserInputEmail(emailConfirm.email),RegisterStepInfoKeeper.getInstance().setUserInputEmailPassword(emailConfirm.password),this.requestEmailConfirmation($.proxy(function(){},this)))},onClickCancelBtn:function(){this.container.find("input").blur(),RegisterProxy.getInstance().onRegisterFinish()},setChangeEmailElements:function(){this.container=this.wrapElement.find("#_email_change_address_view")},setChangeEmailEvent:function(){this.container.on(UIStructure.EVENT_INPUT,"._email_login_text",$.proxy(this.onChangeEmailText,this)).on(UIStructure.EVENT_INPUT,"._email_password_text",$.proxy(this.onChangePasswordText,this)).on(UIStructure.EVENT_INPUT,"._email_re_password_text",$.proxy(this.onChangeRePasswordText,this)).on(UIStructure.EVENT_CLICK,"._confirm_btn",$.proxy(this.onClickConfirmRegisterBtn,this)),this.container.find("._email_login_text").trigger("keyup"),this.container.find("._email_password_text").trigger("keyup"),this.container.find("._email_re_password_text").trigger("keyup")},setInputPinCodeElements:function(){this.container=this.wrapElement.find("#_email_input_pin_code_view")},setInputPinCodeEvent:function(){this.container.on(UIStructure.EVENT_INPUT,"._pincode_text",$.proxy(this.onChangePinCodeText,this)).on(UIStructure.EVENT_CLICK,"._confirm_btn",$.proxy(this.onClickPinCodeConfirmBtn,this)).on(UIStructure.EVENT_CLICK,"._resend_pin_code_btn",$.proxy(this.onClickResendPinCodeBtn,this))},onChangePinCodeText:function(e){var pinNumberLength=$.trim($(e.currentTarget).val()).length;return pinNumberLength<LineConfig.REGISTER_PIN_NUMBER_MIN_LENGTH?this.container.find("._confirm_btn").addClass("ExDisabled"):this.container.find("._confirm_btn").removeClass("ExDisabled"),Utility.setOnlyNumber($(e.currentTarget)),pinNumberLength>=LineConfig.MAX_PINCODE_LENGTH&&!Utility.isSystemKey(e)?void e.preventDefault():(this.bindEnterEvent(e,this.container.find("._confirm_btn")),void this.changeInputStatus(this.container.find("._pincode_text")))},onClickPinCodeConfirmBtn:function(){if(!this.onProceed){var pinCode=$.trim(this.container.find("._pincode_text").val());0!==pinCode.length&&(DimmedUI.getInstance().open("",{},{isCenter:!0}),setTimeout($.proxy(function(){this.onProceed=!1},this),LineConfig.MAX_WORKER_SEND_TIME),this.onProceed=!0,RegisterProxy.getInstance().confirmEmail(pinCode,$.proxy(function(result){result=result?result:{};var errorMsg=this.handleRegisterEmailError(result);
if(result.code===ErrorCode.INTERNAL_ERROR||null!==errorMsg)return alert(errorMsg),DimmedUI.getInstance().close(),this.onProceed=!1,void((result.code===ErrorCode.NOT_AVAILABLE_SESSION||result.code===ErrorCode.NOT_AVAILABLE_PIN_CODE_SESSION)&&LineMain.getInstance().moveBack());this.onProceed=!1,DimmedUI.getInstance().close();var email=RegisterStepInfoKeeper.getInstance().getUserInputEmail();DimmedUI.getInstance().open("",{},{isCenter:!0}),SettingProxy.getInstance().setEmailIdentityCredential(email,RegisterStepInfoKeeper.getInstance().getUserInputEmailPassword(),$.proxy(function(result){SettingProxy.getInstance().setSettings({identityIdentifier:email}),ProfileProxy.getInstance().setProfile({email:email}),SettingProxy.getInstance().updateToLocalSettings(EventManager.EMPTY),DimmedUI.getInstance().close(),this.onConfirm(result)},this))},this)))}},onClickResendPinCodeBtn:function(e){return this.container.find("input").blur(),$(e.currentTarget).hasClass("ExDisabled")?!1:void this.requestEmailConfirmation($.proxy(function(){setTimeout($.proxy(function(){this.container.find("._resend_pin_code_btn")&&this.container.find("._resend_pin_code_btn").removeClass("ExDisabled")},this),LineConfig.SMS_RESEND_TIMEOUT),this.container.find("._resend_pin_code_btn").addClass("ExDisabled"),this.container.find("._pincode_text").val(""),alert($.i18n.prop("GET_SMS_AGAIN"))},this))},setChangePasswordElements:function(){this.container=this.wrapElement.find("#_email_change_password_view")},setChangePasswordEvent:function(){this.container.on(UIStructure.EVENT_INPUT,"._email_old_password_text",$.proxy(this.onChangeOldPasswordText,this)).on(UIStructure.EVENT_INPUT,"._email_password_text",$.proxy(this.onChangeNewPasswordText,this)).on(UIStructure.EVENT_INPUT,"._email_re_password_text",$.proxy(this.onChangeNewRePasswordText,this)).on(UIStructure.EVENT_CLICK,"._confirm_btn",$.proxy(this.onClickConfirmChangePasswordBtn,this)),this.container.find("._email_old_password_text").trigger("keyup"),this.container.find("._email_password_text").trigger("keyup"),this.container.find("._email_re_password_text").trigger("keyup")},onClickConfirmChangePasswordBtn:function(){var passwords={oldPassword:this.container.find("._email_old_password_text").val(),password:this.container.find("._email_password_text").val(),rePassword:this.container.find("._email_re_password_text").val()};if(this.checkPasswordInputValidation()&&this.checkPasswordDataValidation(passwords)){var email=SettingProxy.getInstance().getProp("identityIdentifier"),newPassword=passwords.password;DimmedUI.getInstance().open("",{},{isCenter:!0}),RegisterProxy.getInstance().verifyIdentityCredential(email,passwords.oldPassword,function(result){return result.code===ErrorCode.INVALID_IDENTITY_CREDENTIAL?(DimmedUI.getInstance().close(),void alert($.i18n.prop("WRONG_EMAIL_ACCOUNT_ERROR_TEXT"))):void SettingProxy.getInstance().setEmailIdentityCredential(email,newPassword,function(){DimmedUI.getInstance().close(),alert($.i18n.prop("PASSWORD_IS_CHANGED_TEXT")),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_EMAIL_ACCOUNTS})})})}},onChangeOldPasswordText:function(e){this.changePasswordInputStatus($(e.currentTarget)),this.checkPasswordInputValidation()},onChangeNewPasswordText:function(e){var textLength=$.trim($(e.currentTarget).val()).length;textLength>LineConfig.MAX_PASSWORD_LENGTH||(this.container.find("._password_count").html(textLength+"/20"),this.changePasswordInputStatus($(e.currentTarget)),this.checkPasswordInputValidation())},onChangeNewRePasswordText:function(e){this.changePasswordInputStatus($(e.currentTarget)),this.checkPasswordInputValidation()},checkPasswordInputValidation:function(){return 0===this.container.find("._email_old_password_text").val().length||0===this.container.find("._email_password_text").val().length||0===this.container.find("._email_re_password_text").val().length?(this.container.find("._confirm_btn").addClass("ExDisabled"),!1):(this.container.find("._confirm_btn").removeClass("ExDisabled"),!0)},checkPasswordDataValidation:function(passwords){if(passwords.password!==passwords.rePassword)return alert($.i18n.prop("INVALID_PASSWORD_CONFIRM_TEXT")),!1;var passwordLength=passwords.password.length;return passwordLength<LineConfig.MIN_PASSWORD_LENGTH||passwordLength>LineConfig.MAX_PASSWORD_LENGTH?(alert($.i18n.prop("VALID_PASSWORD_INFO_TEXT",LineConfig.MIN_PASSWORD_LENGTH,LineConfig.MAX_PASSWORD_LENGTH)),!1):!0},clearIdentity:function(){DimmedUI.getInstance().open("",{},{isCenter:!0}),setTimeout(function(){DimmedUI.getInstance().close()},LineConfig.DIMMED_TIMEOUT),SettingProxy.getInstance().clearIdentityCredential(function(){SettingProxy.getInstance().setSettings({identityIdentifier:"",emailConfirmationStatus:0}),SettingProxy.getInstance().updateToLocalSettings(function(){DimmedUI.getInstance().close(),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_ACCOUNTS})})})},setCancelEmailRegistrationElements:function(){this.container=this.wrapElement.find("#_email_identification_view")},setCancelEmailRegistrationEvent:function(){this.container.find("._email_text").on(UIStructure.EVENT_INPUT,$.proxy(this.onChangeCancelEmailRegistrationEmailText,this)),this.container.find("._password_text").on(UIStructure.EVENT_INPUT,$.proxy(this.onChangeCancelEmailRegistrationPasswordText,this)),this.container.on(UIStructure.EVENT_CLICK,"._confirm_btn",$.proxy(this.onClickCancelRegistrationConfirmBtn,this)).on(UIStructure.EVENT_CLICK,"._forgot_password_btn",$.proxy(this.onClickForgotPasswordBtn,this)),this.wrapElement.find("._reset_md").on(UIStructure.EVENT_INPUT,"._reset_email_text",$.proxy(this.onChangeResetEmailText,this)).on(UIStructure.EVENT_CLICK,"._cancel_reset_password_btn",$.proxy(this.onClickCancelResetPasswordBtn,this)).on(UIStructure.EVENT_CLICK,"._reset_password_btn",$.proxy(this.onClickResetPasswordBtn,this)),this.container.find("._email_text").trigger("keyup"),this.container.find("._password_text").trigger("keyup")},onChangeCancelEmailRegistrationEmailText:function(e){this.changeInputStatus($(e.currentTarget)),this.checkCancelEmailRegistrationInputValidation()},onChangeCancelEmailRegistrationPasswordText:function(e){this.changePasswordInputStatus($(e.currentTarget)),this.checkCancelEmailRegistrationInputValidation()},checkCancelEmailRegistrationInputValidation:function(){var email=$.trim(this.container.find("._email_text").val()),password=$.trim(this.container.find("._password_text").val());return 0===email.length||0===password.length?(this.container.find("._confirm_btn").addClass("ExDisabled"),!1):(this.container.find("._confirm_btn").removeClass("ExDisabled"),!0)},onClickCancelRegistrationConfirmBtn:function(){var email=$.trim(this.container.find("._email_text").val()),password=$.trim(this.container.find("._password_text").val());if(this.checkCancelEmailRegistrationInputValidation()){if(!this.checkEmailValidation(!0,email,password))return!1;if(email!==SettingProxy.getInstance().getSettings().identityIdentifier)return void alert($.i18n.prop("FAIL_EMAIL_PASSWORD"));DimmedUI.getInstance().open("",{},{isCenter:!0}),RegisterProxy.getInstance().verifyIdentityCredential(email,password,$.proxy(function(result){return DimmedUI.getInstance().close(),result.code===ErrorCode.INVALID_IDENTITY_CREDENTIAL?void alert($.i18n.prop("WRONG_EMAIL_ACCOUNT_ERROR_TEXT")):void this.verifyAfterCallback(result)},this))}},onChangeResetEmailText:function(e){var targetElement=$(e.currentTarget);0===$.trim(targetElement.val()).length?(targetElement.addClass("ExPlaceholder"),this.wrapElement.find("._reset_password_btn").addClass("ExDisabled")):(targetElement.removeClass("ExPlaceholder"),this.wrapElement.find("._reset_password_btn").removeClass("ExDisabled"))},onClickForgotPasswordBtn:function(){var overlayElement=this.wrapElement.find("._reset_md_overlay"),modalElement=this.wrapElement.find("._reset_md");overlayElement.removeClass("MdNonDisp"),modalElement.removeClass("MdNonDisp");var scrollAreaHeight=LineMain.WINDOW_HEIGHT-LineMain.HEADER_SIZE,centerBoxElements=this.wrapElement.find("._center_box");centerBoxElements.each(function(){var containerHeight=$(this).height();$(this).css("top",(scrollAreaHeight-containerHeight)/2+"px")})},onClickResetPasswordBtn:function(){var emailText=$.trim(this.wrapElement.find("._reset_email_text").val());return 0===emailText.length?!1:this.checkEmailValidation(!0,emailText)?(DimmedUI.getInstance().open("",{},{isCenter:!0}),void RegisterProxy.getInstance().requestEmailAccountPasswordReset(emailText,$.proxy(function(result){DimmedUI.getInstance().close(),result.code===ErrorCode.INVALID_IDENTITY_CREDENTIAL&&alert($.i18n.prop("NOT_REGISTERED_EMAIL_ERROR_TEXT")),result.hasOwnProperty("code")||(this.hideModal(),alert($.i18n.prop("PASSWORD_RESET_MAIL_IS_SENT")))},this))):!1},onClickCancelResetPasswordBtn:function(){this.hideModal()},hideModal:function(){var overlayElement=this.wrapElement.find("._reset_md_overlay"),modalElement=this.wrapElement.find("._reset_md");overlayElement.addClass("MdNonDisp"),modalElement.addClass("MdNonDisp")},requestEmailConfirmation:function(callback){callback=callback?callback:function(){},DimmedUI.getInstance().open("",{},{isCenter:!0}),RegisterProxy.getInstance().requestEmailConfirmation($.proxy(function(result){DimmedUI.getInstance().close();var errorMsg=this.handleRegisterEmailError(result);return null!==errorMsg&&result.code!==ErrorCode.NOT_AVAILABLE_IDENTITY_IDENTIFIER?void alert(errorMsg):(DimmedUI.getInstance().close(),void callback(result))},this))},changePasswordInputStatus:function(targetElement){0===$.trim(targetElement.val()).length?(targetElement.parent().addClass("ExPlaceholder"),setTimeout(function(){targetElement.attr("type","text")},0)):(targetElement.parent().removeClass("ExPlaceholder"),setTimeout(function(){targetElement.attr("type","password")},0))}},RegisterEmailUI.getInstance=function(){return null==RegisterEmailUI.instance&&(RegisterEmailUI.instance=new RegisterEmailUI),RegisterEmailUI.instance},RegisterEmailUI.instance=null;var RegisterProxy=function(){return null!=RegisterProxy.instance?RegisterProxy.instance:(this.eventManager=new EventManager,this.verificationBo=VerificationBO.getInstance(),this.registerBo=RegisterBO.getInstance(),this.emailConfirmationBo=EmailConfirmationBO.getInstance(),void(this.jobWorker=new JobWorker(BASE_DEFAULT+"src/worker/RegisterNetworkJob.js",LineTalkExceptionHandler.getInstance().handle,LineNetworkExceptionHandler.getInstance().handle)))};RegisterProxy.prototype={getEventManager:function(){return this.eventManager},getJobWorker:function(){return this.jobWorker},getUserInputImage:function(){return this.verificationBo.getUserInputImage()},setUserInputImage:function(image){this.verificationBo.setUserInputImage(image)},setRegion:function(countryCode){RegisterStepInfoKeeper.getInstance().setRegion(countryCode)},getRegion:function(){return RegisterStepInfoKeeper.getInstance().getRegion()||LineConfig.DEFAULT_REGION},setUserInputEmailInfo:function(email,password){RegisterStepInfoKeeper.getInstance().setUserInputEmail(email),this.verificationBo.setUserEmailPassword(password)},setEmailAccountInitialized:function(){RegisterStepInfoKeeper.getInstance().setEmailAccountInitialized(!0)},clearEmailIdentityCredential:function(){RegisterStepInfoKeeper.getInstance().setUserInputEmail(null),RegisterStepInfoKeeper.getInstance().setEmailAccountInitialized(!1)},startVerification:function(callback){this.verificationBo.startVerificationT(callback)},resendPinCodeBySMS:function(callback){this.verificationBo.resendPinCodeBySMST(callback)},verifyPhone:function(pinCode,callback){return this.verificationBo.verifyPhoneT(pinCode,callback)},registerDevice:function(callback){this.verificationBo.registerDeviceT(callback)},registerDeviceWithIdentityCredential:function(callback){this.verificationBo.registerDeviceWithIdentityCredentialT(callback)},verifyIdentityCredential:function(id,password,callback){this.verificationBo.verifyIdentityCredentialT(id,password,callback)},getRSAKeyValuePair:function(identifier,password,callback){this.verificationBo.getRSAKeyValuePair(identifier,password,callback)},requestEmailConfirmation:function(callback){this.emailConfirmationBo.requestEmailConfirmation(callback)},requestAccountPasswordReset:function(provider,identifier,locale,callback){this.emailConfirmationBo.requestAccountPasswordResetT(provider,identifier,locale,callback)},requestEmailAccountPasswordReset:function(identifier,callback){this.emailConfirmationBo.requestAccountPasswordResetT(IdentityProvider.LINE,identifier,LineMain.PREFERENCE_LOCALE,callback)},resendEmailConfirmation:function(){this.emailConfirmationBo.resendEmailConfirmationT()},confirmEmail:function(pinCode,callback){var verifier=RegisterStepInfoKeeper.getInstance().getEmailConfirmationSessionVerifier();this.emailConfirmationBo.confirmEmailT(verifier,pinCode,callback)},startVerificationWithSendSMS:function(callback){this.registerBo.startVerificationWithSendSMS(callback)},onRegisterFinish:function(){this.registerBo.onRegisterFinish()},clearLoginInfo:function(){RegisterStepInfoKeeper.getInstance().clearLoginInfo()},removeAll:function(){VerificationBO.getInstance().removeAll(),EmailConfirmationBO.getInstance().removeAll()}},RegisterProxy.getInstance=function(){return null===RegisterProxy.instance&&(RegisterProxy.instance=new RegisterProxy),RegisterProxy.instance},RegisterProxy.instance=null;var RegisterUI=function(){return null!=RegisterUI.instance?RegisterUI.instance:(SelectCountryUI.getInstance(),_.extend(this,UIStructure),setTimeout(function(){_.each(RegisterUI.TEMPLATE,function(templatePath){TemplateManager.getInstance().get(templatePath)})},10),this.assign(),this.initFunctionReferences(),void LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this)))};RegisterUI.prototype={initFunctionReferences:function(){var subScreenType=LineMain.SUB_SCREEN_TYPE,reference=[];reference[subScreenType.REGISTER_NEW_LINE]=this.showNewLine,reference[subScreenType.REGISTER_EMAIL_LOGIN]=this.showEmailLogin,reference[subScreenType.REGISTER_INPUT_PHONE]=this.showInputPhone,reference[subScreenType.REGISTER_CONFIRM_TERM]=this.showConfirmTerm,reference[subScreenType.REGISTER_INPUT_PIN_CODE]=this.showInputPinCode,reference[subScreenType.REGISTER_CONFIRM_USE_CONTACTS]=this.showConfirmUseContacts,reference[subScreenType.REGISTER_INPUT_PROFILE]=this.showInputProfile,reference[subScreenType.REGISTER_EMAIL_REGISTER]=this.showEmailRegister,reference[subScreenType.REGISTER_EMAIL_REGISTER_INPUT_PINCODE]=this.showEmailRegisterInputPincode,reference[subScreenType.REGISTER_CONFIRM_SAME_DEVICE]=this.showConfirmSameDevice,this.reference=reference},setContent:function(src,data){var template=TemplateManager.getInstance().get(src);this.wrapElement.empty().html(Mustache.render(template,data||{}))},preLoad:function(registerViewID){TemplateManager.getInstance().get(RegisterUI.TEMPLATE[registerViewID])},assign:function(){this.wrapElement=$("#_wrap_register")},setWrapperVisible:function(){LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.REGISTER)?(this.wrapElement.removeClass("MdNonDisp"),this.resize()):this.wrapElement.addClass("MdNonDisp")},bindEnterEvent:function(e,confirmElement){e.keyCode===UIStructure.ENTER_KEY_CODE&&(confirmElement.trigger(UIStructure.EVENT_CLICK),$(e.currentTarget).blur())},changePasswordInputStatus:function(target,maxLength){maxLength=maxLength?maxLength:20,0===$.trim(target.val()).length?target.attr("type","text").parent().addClass("ExPlaceholder"):target.attr("type","password").parent().removeClass("ExPlaceholder");var text=target.val(),textLength=text.length;return textLength>=maxLength?(target.val(text.substr(0,maxLength)),!1):void 0},changeInputStatus:function(targetElement){0===$.trim(targetElement.val()).length?targetElement.parent().addClass("ExPlaceholder"):targetElement.parent().removeClass("ExPlaceholder")},getFunction:function(subScreen){if(this.reference[subScreen])return $.proxy(this.reference[subScreen],this);throw"Undefined Function : "+subScreen},changeScreen:function(options){if(options&&options.type===UIEventManager.EVENT_RESIZE)return this.resize(),!1;var screenInfo=LineMain.getInstance().getScreenInfo();LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.REGISTER)&&($("body").addClass("bgTypeG03"),this.getFunction(screenInfo.subScreen)(),this.setWrapperVisible())},resize:function(){var headerSize=HeaderView.getInstance().isShow()?LineMain.HEADER_SIZE:0;this.scrollAreaHeight=LineMain.WINDOW_HEIGHT-headerSize,this.wrapElement.height(this.scrollAreaHeight),this.rePositionCenterTargetElement(),LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.REGISTER_CONFIRM_TERM)?this.resizeContainerOverflow($("._confirm_term_view"),24):LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.REGISTER_CONFIRM_USE_CONTACTS)&&this.resizeContainerOverflow($("._confirm_use_contacts_view"),13)},rePositionCenterTargetElement:function(){var contentCenterElement=this.wrapElement.find("._content_center"),imgElements=contentCenterElement.find("img"),ignoreHeight=0;this.wrapElement.find("._content_ignore").each(function(){ignoreHeight+=$(this).height()});var contentAvailHeight=this.scrollAreaHeight-ignoreHeight,resizeWrapper=function(){var topY=(contentAvailHeight-contentCenterElement.height())/2-6;contentCenterElement.css({"margin-top":topY+"px","margin-bottom":topY+"px"})};resizeWrapper(),Utility.imageLoad(imgElements,resizeWrapper)},resizeContainerOverflow:function(containerElement,extraMargin){var ignoreHeight=0,resizeElements=containerElement.find("._resize_overflow"),self=this;resizeElements.each(function(){ignoreHeight+=self.getContainerBoundaryHeight($(this))}).addClass("MdNonDisp");var withoutOverflowSize=containerElement.height()+this.getContainerBoundaryHeight(containerElement),targetSize=this.scrollAreaHeight-withoutOverflowSize-ignoreHeight-extraMargin,resizeToFrame=targetSize/resizeElements.length;resizeElements.removeClass("MdNonDisp").css({"max-height":resizeToFrame+"px",height:resizeToFrame+"px"})},getContainerBoundaryHeight:function(element){return parseInt(element.css("padding-top").replace(/px$/,""),10)+parseInt(element.css("padding-bottom").replace(/px$/,""),10)+parseInt(element.css("margin-top").replace(/px$/,""),10)+parseInt(element.css("margin-bottom").replace(/px$/,""),10)},showEmailRegister:function(){EmailRegisterView.getInstance().initEmailRegister(),HeaderView.getInstance().set().setTitle($.i18n.prop("REGISTER_EMAIL")).show(),MenuView.getInstance().hide()},showEmailRegisterInputPincode:function(){EmailRegisterView.getInstance().initInputPinCode(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("REGISTER_EMAIL")).show(),MenuView.getInstance().hide()},showConfirmSameDevice:function(){ConfirmSameDeviceView.getInstance().init(),HeaderView.getInstance().set({back:{action:$.proxy(this.showConfirmMoveToInputPhone,this)}}).setTitle($.i18n.prop("REGISTRATION")).show(),MenuView.getInstance().hide()},showInputProfile:function(){InputProfileView.getInstance().init(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("REGISTRATION")).show(),MenuView.getInstance().hide()},showConfirmUseContacts:function(){ConfirmUseContactsView.getInstance().init(),HeaderView.getInstance().set({back:{action:$.proxy(this.showConfirmMoveToInputPhone,this)}}).setTitle($.i18n.prop("ADD_AS_FRIEND")).show(),MenuView.getInstance().hide(),this.preLoad("INPUT_PROFILE_VIEW")},showConfirmAccountInit:function(){ConfirmSameDeviceView.getInstance().initAccountInitUI(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("REGISTRATION")).show(),MenuView.getInstance().hide()},showConfirmTerm:function(){ConfirmTermView.getInstance().init(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("REGISTRATION")).show(),MenuView.getInstance().hide(),this.preLoad("INPUT_PIN_CODE_VIEW")},showInputPinCode:function(){InputPinCodeView.getInstance().init(),HeaderView.getInstance().set({back:{action:$.proxy(this.showConfirmMoveToInputPhone,this)}}).setTitle($.i18n.prop("REGISTRATION")).show(),MenuView.getInstance().hide(),this.preLoad("CONFIRM_USE_CONTACTS_VIEW")},showInputPhone:function(){AuthInfoKeeper.getInstance().removeAll(),InputPhoneView.getInstance().init(),HeaderView.getInstance().set({back:{action:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE})}}}).setTitle($.i18n.prop("REGISTRATION")).show(),MenuView.getInstance().hide(),this.preLoad("CONFIRM_TERM_VIEW")},showNewLine:function(){NewLineView.getInstance().init(),HeaderView.getInstance().hide(),MenuView.getInstance().hide(),this.preLoad("INPUT_PHONE_VIEW"),this.preLoad("EMAIL_REGISTER_VIEW")},showEmailLogin:function(){EmailLoginView.getInstance().init(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("LINE_USER_LOGIN")).show(),MenuView.getInstance().hide()},showConfirmMoveToInputPhone:function(){ConfirmUI.getInstance().open({message:$.i18n.prop("SMS_RESENT_WARNING_TEXT"),button:{left:{label:$.i18n.prop("CANCEL"),callback:function(){}},right:{label:$.i18n.prop("CONFIRM"),callback:$.proxy(function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PHONE})},this)}}})},handleRegisterError:function(result){return result.code===ErrorCode.ILLEGAL_ARGUMENT||result.code===ErrorCode.NOT_AVAILABLE_SESSION?(alert($.i18n.prop("REGISTRATION_DIALOG_SESSION_EXPIRED")),DimmedUI.getInstance().close(),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE}),!1):!0},hide:function(){this.wrapElement.addClass("MdNonDisp")},show:function(){this.wrapElement.removeClass("MdNonDisp")}},RegisterUI.getInstance=function(){return null==RegisterUI.instance&&(RegisterUI.instance=new RegisterUI),RegisterUI.instance},RegisterUI.instance=null,RegisterUI.COUNTRY_LIST_ITEM=BASE_DEFAULT+"src/proxy/register/ui/template/CountryListTemplate.mustache",RegisterUI.TEMPLATE_LOCATION=BASE_DEFAULT+"src/proxy/register/ui/screen/",RegisterUI.TEMPLATE={},RegisterUI.TEMPLATE.NEW_LINE_VIEW=RegisterUI.TEMPLATE_LOCATION+"NewLine.mustache",RegisterUI.TEMPLATE.EMAIL_LOGIN_VIEW=RegisterUI.TEMPLATE_LOCATION+"EmailLogin.mustache",RegisterUI.TEMPLATE.INPUT_PHONE_VIEW=RegisterUI.TEMPLATE_LOCATION+"InputPhone.mustache",RegisterUI.TEMPLATE.SELECT_COUNTRY_VIEW=RegisterUI.TEMPLATE_LOCATION+"SelectCountry.mustache",RegisterUI.TEMPLATE.INPUT_PROFILE_VIEW=RegisterUI.TEMPLATE_LOCATION+"InputProfile.mustache",RegisterUI.TEMPLATE.CONFIRM_TERM_VIEW=RegisterUI.TEMPLATE_LOCATION+"ConfirmTerm.mustache",RegisterUI.TEMPLATE.INPUT_PIN_CODE_VIEW=RegisterUI.TEMPLATE_LOCATION+"InputPhonePinCode.mustache",RegisterUI.TEMPLATE.CONFIRM_SAME_DEVICE_VIEW=RegisterUI.TEMPLATE_LOCATION+"ConfirmSameDevice.mustache",RegisterUI.TEMPLATE.CONFIRM_USE_CONTACTS_VIEW=RegisterUI.TEMPLATE_LOCATION+"ConfirmUseContacts.mustache",RegisterUI.TEMPLATE.EMAIL_REGISTER_VIEW=RegisterUI.TEMPLATE_LOCATION+"EmailRegister.mustache",RegisterUI.TEMPLATE.EMAIL_REGISTER_INPUT_PIN_CODE_VIEW=RegisterUI.TEMPLATE_LOCATION+"EmailRegisterInputPinCode.mustache";var SelectCountryUI=function(){return null!=SelectCountryUI.instance?SelectCountryUI.instance:(_.extend(this,UIStructure),this.assigne(),void this.setEvent())};SelectCountryUI.prototype={assigne:function(){this.wrapEtcLayer=$("#_wrap_etc")},setEvent:function(){LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this))},getCountryListItem:function(){return TemplateManager.getInstance().get(RegisterUI.COUNTRY_LIST_ITEM)},setContent:function(){this.wrapEtcLayer.empty(),0===this.wrapEtcLayer.find("._country_list").length&&this.wrapEtcLayer.html(Mustache.render(TemplateManager.getInstance().get(RegisterUI.TEMPLATE.SELECT_COUNTRY_VIEW))),this.countryListElement=this.wrapEtcLayer.find("._country_list")},setElementEvent:function(){this.countryListElement.off(UIStructure.EVENT_CLICK).on(UIStructure.EVENT_CLICK,"li",$.proxy(function(e){var region=$(e.currentTarget).attr("data-countryCode");RegisterProxy.getInstance().setRegion(region),this.scrollTop=this.wrapEtcLayer.find("#_select_country_list_ui").scrollTop()+$(e.currentTarget).offset().top-LineMain.HEADER_SIZE,LineMain.getInstance().moveBack()},this))},resize:function(){var windowHeight=LineMain.WINDOW_HEIGHT,scrollAreaHeight=windowHeight-LineMain.HEADER_SIZE;this.wrapEtcLayer.height(scrollAreaHeight),$("#_select_country_list_ui").height(scrollAreaHeight)},changeScreen:function(options){if(options&&options.type===UIEventManager.EVENT_RESIZE&&LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.SELECT_COUNTRY)&&this.resize(),LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.ETC)?this.wrapEtcLayer.removeClass("MdNonDisp"):this.wrapEtcLayer.addClass("MdNonDisp").html(""),LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.SELECT_COUNTRY)){var headerView=HeaderView.getInstance();headerView.set({back:!0}).setTitle("Select Country").show(),this.setContent(),this.resize(),this.setElementEvent();var countryListItem=this.getCountryListItem(),selectedIdx=0,countryCode=RegisterProxy.getInstance().getRegion()||LineConfig.DEFAULT_REGION;this.listUI=new ListUI(this.wrapEtcLayer.find("#_select_country_list_ui"),{dataSource:function(){return ResourceLoader.getInstance().getAllCountryInfo()},idAttribute:"countryCode",itemHeight:47,renderer:$.proxy(function(item){return item?item.countryCode===countryCode&&(item=_.clone(item),item.selected=!0):item={},Mustache.render(countryListItem,item)},this)}),this.listUI.reload();for(var countryList=ResourceLoader.getInstance().getAllCountryInfo(),i=0;i<countryList.length;i++)countryList[i].countryCode===countryCode&&(selectedIdx=i);this.scrollTop=47*selectedIdx,this.wrapEtcLayer.find("#_select_country_list_ui")[0].scrollTop=this.scrollTop}}},SelectCountryUI.getInstance=function(){return null==SelectCountryUI.instance&&(SelectCountryUI.instance=new SelectCountryUI),SelectCountryUI.instance},SelectCountryUI.instance=null;var EmailConfirmationBO=function(){return null!=EmailConfirmationBO.instance?EmailConfirmationBO.instance:void _.extend(this,BOStructure)};EmailConfirmationBO.prototype={requestEmailConfirmation:function(callback){var emailConfirmation=new EmailConfirmation;emailConfirmation.email=RegisterStepInfoKeeper.getInstance().getUserInputEmail(),emailConfirmation.password=RegisterStepInfoKeeper.getInstance().getUserInputEmailPassword(),emailConfirmation.ignoreDuplication=RegisterStepInfoKeeper.getInstance().isIgnoreDuplication(),emailConfirmation.usePasswordSet=!0,this.requestEmailConfirmationT(emailConfirmation,function(result){RegisterStepInfoKeeper.getInstance().setEmailConfirmationSession(Utility.serialize(result)),callback(result)})},sendResendEmailConfirmation:function(emailConfirmation,callback){var param=new EmailConfirmation(emailConfirmation);emailConfirmation.usePasswordSet&&(param.email=this.emailKeyPair.key,param.password=this.emailKeyPair.value);var options={methodName:"requestEmailConfirmationT",data:[Utility.serialize(param)],success:$.proxy(function(result){result=result?result:{},Logger.log("SUCCESS : requestEmailConfirmationT",result),callback(result)},this),error:function(){Logger.log("ERROR : requestEmailConfirmationT")}};RegisterProxy.getInstance().getJobWorker().send(options)},requestEmailConfirmationT:function(emailConfirmation,callback){var param=new EmailConfirmation(emailConfirmation);RegisterProxy.getInstance().getRSAKeyValuePair(param.email,param.password,$.proxy(function(keyPair){this.emailKeyPair={key:keyPair.key,value:keyPair.value},this.sendResendEmailConfirmation(emailConfirmation,callback)},this))},resendEmailConfirmationT:function(verifier,callback){var options={methodName:"resendEmailConfirmationT",data:[verifier],success:$.proxy(function(result){result=result?result:{},Logger.log("SUCCESS : resendEmailConfirmationT",result),callback(result)},this),error:function(){Logger.log("ERROR : resendEmailConfirmationT")}};RegisterProxy.getInstance().getJobWorker().send(options)},confirmEmailT:function(verifier,pinCode,callback){var options={methodName:"confirmEmailT",data:[verifier,pinCode],success:function(result){result=result?result:{},callback(result)},error:function(){}};RegisterProxy.getInstance().getJobWorker().send(options)},requestAccountPasswordResetT:function(provider,identifier,locale,callback){var options={methodName:"requestAccountPasswordResetT",data:[provider,identifier,locale],success:function(result){result=result?result:{},callback(result)},error:function(){}};RegisterProxy.getInstance().getJobWorker().send(options)}},EmailConfirmationBO.getInstance=function(){return null==EmailConfirmationBO.instance&&(EmailConfirmationBO.instance=new EmailConfirmationBO),EmailConfirmationBO.instance},EmailConfirmationBO.instance=null;var RegisterBO=function(){return null!=RegisterBO.instance?RegisterBO.instance:(_.extend(this,BOStructure),void(this.emailConfirmationBo=EmailConfirmationBO.getInstance()))};RegisterBO.prototype={handleVerificationError:function(result){return result.code===ErrorCode.ILLEGAL_ARGUMENT||result.code===ErrorCode.INVALID_LENGTH?(alert($.i18n.prop("REGISTRATION_INVALID_PHONE")),!1):result.code===ErrorCode.NOT_AVAILABLE_SESSION?(alert($.i18n.prop("REGISTRATION_DIALOG_SESSION_EXPIRED")),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE}),!1):result.code===ErrorCode.NO_AVAILABLE_VERIFICATION_METHOD?(alert($.i18n.prop("NETWORK_ERROR_INFO")),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE}),!1):result.code===ErrorCode.INTERNAL_ERROR?(alert($.i18n.prop("E_UNKNOWN")),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PHONE}),!1):result.code?(alert(result.message),!1):!0},startVerificationWithSendSMS:function(){AuthInfoKeeper.getInstance().setSessionData(null),DimmedUI.getInstance().open("",{},{isCenter:!0}),RegisterProxy.getInstance().startVerification($.proxy(function(result){return DimmedUI.getInstance().close(),ConfirmUI.getInstance().close(),this.handleVerificationError(result)?(RegisterStepInfoKeeper.getInstance().setPhonePinCodeSessionStartTime((new Date).getTime()),AuthInfoKeeper.getInstance().setSessionData(result),AuthInfoKeeper.getInstance().setPhoneNumber(result.normalizedPhone),void LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PIN_CODE})):void LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PHONE})},this))},initializeAccountInformation:function(callback){var settings={chatAutoResend:!0,privacySyncContacts:RegisterStepInfoKeeper.getInstance().isUseMyContactList(),privacySearchByEmail:RegisterStepInfoKeeper.getInstance().getAllowOtherToAdd(),privacySearchByPhoneNumber:RegisterStepInfoKeeper.getInstance().getAllowOtherToAdd(),privacySearchByUserid:RegisterStepInfoKeeper.getInstance().getAllowOtherToAdd()},profile={};0!==RegisterStepInfoKeeper.getInstance().getVerifyPhoneResult()&&(settings.phoneRegistration=!0),RegisterStepInfoKeeper.getInstance().getIsNewUser()===!0?(profile.allowSearchByEmail=!0,profile.allowSearchByUserid=!0,profile.displayName=RegisterStepInfoKeeper.getInstance().getUserInputDisplayName(),_.extend(settings,{notificationEnable:!0,notificationGroupInvitation:!0,notificationIncomingCall:!0,notificationNewMessage:!0,notificationShowMessage:!0,privacyAllowSecondaryDeviceLogin:!0,privacyReceiveMessagesFromNotFriend:!0}),ProfileProxy.getInstance().setProfile(profile),SettingProxy.getInstance().setSettings(settings),callback()):this.updateToLocal($.proxy(function(){ProfileProxy.getInstance().setProfile(profile),SettingProxy.getInstance().setSettings(settings),callback()
},this))},onRegisterFinish:function(){DimmedUI.getInstance().open("",{},{isCenter:!0}),this.initializeAccountInformation($.proxy(function(){this.updateToServer($.proxy(function(){RegisterStepInfoKeeper.getInstance().setAccountInitialized(!0),this.uploadProfileImage($.proxy(function(){GroupProxy.getInstance().migrateGroups(LineMain.initUI),ContactProxy.getInstance().migrateContacts(LineMain.initUI),LineMain.isContactDataOk=!1,ContactProxy.getInstance().syncContacts(LineMain.initUI)},this))},this))},this))},updateToLocal:function(callback){ProfileProxy.getInstance().updateToLocalProfile(EventManager.EMPTY),SettingProxy.getInstance().updateToLocalSettings(callback)},updateToServer:function(callback){ProfileProxy.getInstance().updateToServerProfile(EventManager.EMPTY),SettingProxy.getInstance().updateToServerSettings(callback)},uploadProfileImage:function(callback){var profileImageArrayBuffer=RegisterProxy.getInstance().getUserInputImage();if(null===profileImageArrayBuffer)return void callback();var image={name:"profile_image",type:"image/png"},fileUploader=new FileUploader;fileUploader.uploadProfileImage({authToken:AuthInfoKeeper.getInstance().getAuthToken(),oid:AuthInfoKeeper.getInstance().getAuthMid(),imageName:image.name,imageType:image.type,imageQuality:LineConfig.UPLOAD_IMAGE_QUALITY,imageArrayBuffer:profileImageArrayBuffer,complete:$.proxy(function(){callback()},this),progress:function(){}})}},RegisterBO.getInstance=function(){return null===RegisterBO.instance&&(RegisterBO.instance=new RegisterBO),RegisterBO.instance},RegisterBO.instance=null;var VerificationBO=function(){return null!=VerificationBO.instance?VerificationBO.instance:(_.extend(this,BOStructure),void this.initProperty())};VerificationBO.prototype={initProperty:function(){this.userEmailPassword=null,this.userInputPhoneNumber=null,this.userInputImage=null},setUserInputImage:function(image){this.userInputImage=image},getUserInputImage:function(){return this.userInputImage},setUserEmailPassword:function(password){this.userEmailPassword=password},getUserEmailPassword:function(){return this.userEmailPassword},getVerificationInfo:function(){return{region:RegisterProxy.getInstance().getRegion(),carrier:CarrierCode.NOT_SPECIFIED,phoneNumber:RegisterStepInfoKeeper.getInstance().getUserInputPhoneNumber(),deviceInfo:Utility.serialize(new DeviceInfo({applicationType:LineConfig.getInstance().getApplicationCodeValue(),deviceName:LineConfig.DEVICE_NAME,systemVersion:LineConfig.OS_VERSION,systemName:LineConfig.OS_NAME,carrierCode:CarrierCode.NOT_SPECIFIED,carrierName:"NOT_SPECIFIED",model:""})),networkCode:AuthInfoKeeper.getInstance().getMCCMNC()||null,mid:null}},startVerificationT:function(callback){callback=callback?callback:function(){};var info=this.getVerificationInfo(),deviceId=RegisterStepInfoKeeper.getInstance().getDeviceId(),options={methodName:"startVerificationT",data:[info.region,info.carrier,info.phoneNumber,deviceId,info.deviceInfo,info.networkCode,info.mid],success:$.proxy(function(result){result=result?result:{},callback(result)},this),error:function(){alert("error")}};RegisterProxy.getInstance().getJobWorker().send(options)},resendPinCodeBySMST:function(callback){callback=callback?callback:function(){};var sessionId=AuthInfoKeeper.getInstance().getSessionData().sessionId,options={methodName:"resendPinCodeBySMST",data:[sessionId],success:$.proxy(function(result){result=result?result:{},callback(result)},this),error:function(){}};RegisterProxy.getInstance().getJobWorker().send(options)},verifyPhoneT:function(pinCode,callback){var sessionId=AuthInfoKeeper.getInstance().getSessionData().sessionId,deviceId=RegisterStepInfoKeeper.getInstance().getDeviceId(),options={methodName:"verifyPhoneT",data:[sessionId,pinCode,deviceId],success:$.proxy(function(result){result=result?result:0,callback(result)},this),error:function(){}};RegisterProxy.getInstance().getJobWorker().send(options)},verifyIdentityCredentialT:function(identifier,password,callback){callback=callback?callback:this.undefinedCallback,RegisterProxy.getInstance().getRSAKeyValuePair(identifier,password,$.proxy(function(keyPair){var options={methodName:"verifyIdentityCredentialT",data:[IdentityProvider.LINE,keyPair.key,keyPair.value],success:$.proxy(function(result){result=result?result:{},callback(result)},this),error:function(){}};RegisterProxy.getInstance().getJobWorker().send(options)},this))},getRSAKeyValuePair:function(identifier,password,callback){var getLenChar=function(texts){return texts+="",String.fromCharCode(texts.length)};this.getRSAKeyInfoT(function(keys){var nValue=keys.nvalue,eValue=keys.evalue,rsa=new LineRSAKey;rsa.setPublic(nValue,eValue),callback({key:keys.keynm,value:rsa.encrypt(getLenChar(keys.sessionKey)+keys.sessionKey+getLenChar(identifier)+identifier+getLenChar(password)+password)})})},getRSAKeyInfoT:function(callback){var options={methodName:"getRSAKeyInfoT",data:[IdentityProvider.LINE],success:$.proxy(function(result){return result=result?result:{},result.code?void alert(result.reason):void callback(result)},this),error:function(){}};RegisterProxy.getInstance().getJobWorker().send(options)},registerDeviceT:function(callback){var sessionId=AuthInfoKeeper.getInstance().getSessionData().sessionId,options={methodName:"registerDeviceT",data:[sessionId],success:$.proxy(function(result){result=result?result:{},result.code||result.code===ErrorCode.ILLEGAL_ARGUMENT||(authToken=result,this.setLocalAuth(AuthInfoKeeper.getInstance().getSessionData(),authToken)),callback(result)},this),error:function(){}};RegisterProxy.getInstance().getJobWorker().send(options)},registerDeviceWithIdentityCredentialT:function(callback){var emailAddress=RegisterStepInfoKeeper.getInstance().getUserInputEmail(),emailPassword=this.getUserEmailPassword();RegisterProxy.getInstance().getRSAKeyValuePair(emailAddress,emailPassword,$.proxy(function(keyPair){var sessionId=AuthInfoKeeper.getInstance().getSessionData().sessionId,identityProvider=IdentityProvider.LINE,options={methodName:"registerDeviceWithIdentityCredentialT",data:[sessionId,identityProvider,keyPair.key,keyPair.value],success:$.proxy(function(result){result=result?result:{},result.code||result.code===ErrorCode.ILLEGAL_ARGUMENT||(authToken=result,this.setLocalAuth(AuthInfoKeeper.getInstance().getSessionData(),authToken)),callback(result)},this),error:function(){}};RegisterProxy.getInstance().getJobWorker().send(options)},this))},setLocalAuth:function(sessionData,authToken){if(""!==authToken&&null!==authToken){var countryInfo=ResourceLoader.getInstance().getCountryInfoByCountryNo(sessionData.countryCode);AuthInfoKeeper.getInstance().setAuthToken(authToken),AuthInfoKeeper.getInstance().setPhoneNumber(sessionData.normalizedPhone),AuthInfoKeeper.getInstance().setISOCode(countryInfo.countryCode),RegisterStepInfoKeeper.getInstance().setAuthorized(!0)}},removeAll:function(){this.initProperty()}},VerificationBO.getInstance=function(){return null==VerificationBO.instance&&(VerificationBO.instance=new VerificationBO),VerificationBO.instance},VerificationBO.instance=null;var ConfirmSameDeviceView=function(){return null!=ConfirmSameDeviceView.instance?ConfirmSameDeviceView.instance:void _.extend(this,new RegisterUI)};ConfirmSameDeviceView.prototype={init:function(){this.setContent(RegisterUI.TEMPLATE.CONFIRM_SAME_DEVICE_VIEW),this.setElements(),this.setEvent()},setElements:function(){this.container=this.wrapElement.find("._confirm_same_device_view")},setEvent:function(){this.container.on(UIStructure.EVENT_CLICK,"._new_user_btn",$.proxy(this.onClickNewUserBtn,this)).on(UIStructure.EVENT_CLICK,"._another_device_btn",$.proxy(this.onClickAnotherDeviceBtn,this))},onClickNewUserBtn:function(){this.registerDevice()},registerDevice:function(){DimmedUI.getInstance().open("",{},{isCenter:!0}),RegisterProxy.getInstance().registerDevice($.proxy(function(result){DimmedUI.getInstance().close(),RegisterUI.getInstance().handleRegisterError(result)&&LineMain.getInstance().changeScreen(""===result||null===result?{screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE}:{screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_CONFIRM_USE_CONTACTS})},this))},onClickAnotherDeviceBtn:function(){ConfirmUI.getInstance().open({message:$.i18n.prop("REGISTER_NOTICE_ALREADY_ACCOUNT_ALERT"),button:{left:{label:$.i18n.prop("CANCEL"),callback:function(){}},right:{label:$.i18n.prop("CONFIRM"),callback:$.proxy(function(){this.registerDevice()},this)}}})}},ConfirmSameDeviceView.getInstance=function(){return null==ConfirmSameDeviceView.instance&&(ConfirmSameDeviceView.instance=new ConfirmSameDeviceView),ConfirmSameDeviceView.instance},ConfirmSameDeviceView.instance=null;var ConfirmTermView=function(){return null!=ConfirmTermView.instance?ConfirmTermView.instance:(_.extend(this,new RegisterUI),void this.setProperties())};ConfirmTermView.prototype={setProperties:function(){this.showAgreeTermCheckBox="KR"===RegisterProxy.getInstance().getRegion()||!1,this.agree=this.showAgreeTermCheckBox?{terms:!1,privacyPolicy:!1}:{terms:!0,privacyPolicy:!0}},init:function(){var lang=Utility.getSystemLocale();this.setProperties(),this.setContent(RegisterUI.TEMPLATE.CONFIRM_TERM_VIEW,{showAgreeTermCheckBox:this.showAgreeTermCheckBox,termsOfServiceUrl:" http://terms.line.me/line_terms/sp?lang="+lang,termsAndPrivacyPolicy:"http://terms.line.me/line_terms_privacy/sp?lang="+lang}),this.setElements(),this.setEvent(),this.updateButtonStatus()},setElements:function(){this.container=this.wrapElement.find("#_confirm_term_view")},setEvent:function(){this.container.on(this.EVENT_CLICK,"._check_box",$.proxy(this.onClickCheckbox,this)).on(this.EVENT_CLICK,"._confirm_btn",$.proxy(this.onClickConfirmBtn,this)).on(this.EVENT_CLICK,"._cancel_btn",this.onClickCancelBtn)},toggleCheckboxStatus:function(element){var result=!1,checkboxElement=element.find("input");return"checked"===checkboxElement.attr("checked")?(element.find("span").removeClass("ExSelected"),checkboxElement.removeAttr("checked"),result=!1):(element.find("span").addClass("ExSelected"),checkboxElement.attr("checked","checked"),result=!0),result},onClickCheckbox:function(e){var name=$(e.currentTarget).attr("data-name"),result=this.toggleCheckboxStatus($(e.currentTarget));return this.agree[name]=result,this.updateButtonStatus(),!1},onClickCancelBtn:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PHONE})},updateButtonStatus:function(){this.agree.privacyPolicy&&this.agree.terms?this.container.find("._confirm_btn").removeClass("ExDisabled"):this.container.find("._confirm_btn").addClass("ExDisabled")},onClickConfirmBtn:function(){this.agree.privacyPolicy&&this.agree.terms&&ConfirmUI.getInstance().open({message:$.i18n.prop("SEND_SMS_CONFIRM",RegisterStepInfoKeeper.getInstance().getUserInputPhoneNumber()),closeByCallbackFlag:!0,button:{left:{label:$.i18n.prop("CANCEL"),callback:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PHONE})}},right:{label:$.i18n.prop("CONFIRM"),callback:$.proxy(function(){RegisterProxy.getInstance().startVerificationWithSendSMS(function(){ConfirmUI.getInstance().close()})},this)}}})}},ConfirmTermView.getInstance=function(){return null==ConfirmTermView.instance&&(ConfirmTermView.instance=new ConfirmTermView),ConfirmTermView.instance},ConfirmTermView.instance=null;var ConfirmUseContactsView=function(){return null!=ConfirmUseContactsView.instance?ConfirmUseContactsView.instance:void _.extend(this,new RegisterUI)};ConfirmUseContactsView.prototype={init:function(){this.autoAddFriendFlag=!0,this.allowOthersToAddFlag=!0,this.setContent(RegisterUI.TEMPLATE.CONFIRM_USE_CONTACTS_VIEW),this.setElements(),this.setEvent()},setElements:function(){this.welement=this.wrapElement.find("#_confirm_use_contacts_view")},setEvent:function(){this.welement.on(UIStructure.EVENT_TOUCH,"._auto_add_friend_switch",$.proxy(this.onClickAutoAddFriendSwitch,this)).on(UIStructure.EVENT_TOUCH,"._allow_others_to_add_switch",$.proxy(this.onClickAllowOthersToAddSwitch,this)).on(UIStructure.EVENT_CLICK,"._confirm_btn",$.proxy(this.onClickConfirmBtn,this))},onClickAutoAddFriendSwitch:function(e){var value=$(e.currentTarget).attr("data-value");"true"===value?(value=!1,$(e.currentTarget).removeClass("mdMN13IsOn").addClass("mdMN13IsOff")):(value=!0,$(e.currentTarget).removeClass("mdMN13IsOff").addClass("mdMN13IsOn")),$(e.currentTarget).attr("data-value",value),this.autoAddFriendFlag=value},onClickAllowOthersToAddSwitch:function(e){var value=$(e.currentTarget).attr("data-value");"true"===value?(value=!1,$(e.currentTarget).removeClass("mdMN13IsOn").addClass("mdMN13IsOff")):(value=!0,$(e.currentTarget).removeClass("mdMN13IsOff").addClass("mdMN13IsOn")),$(e.currentTarget).attr("data-value",value),this.allowOthersToAddFlag=value},onClickConfirmBtn:function(){RegisterStepInfoKeeper.getInstance().setUseMyContactList(this.autoAddFriendFlag),RegisterStepInfoKeeper.getInstance().setAllowOtherToAdd(this.allowOthersToAddFlag),RegisterStepInfoKeeper.getInstance().getIsNewUser()?LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PROFILE}):(DimmedUI.getInstance().open("",{},{isCenter:!0}),RegisterProxy.getInstance().registerDeviceWithIdentityCredential(function(result){var authToken=AuthInfoKeeper.getInstance().getAuthToken();RegisterUI.getInstance().handleRegisterError(result)&&(null!==authToken?RegisterProxy.getInstance().onRegisterFinish():LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE}))}))}},ConfirmUseContactsView.getInstance=function(){return null==ConfirmUseContactsView.instance&&(ConfirmUseContactsView.instance=new ConfirmUseContactsView),ConfirmUseContactsView.instance},ConfirmUseContactsView.instance=null;var EmailLoginView=function(){return null!=EmailLoginView.instance?EmailLoginView.instance:void _.extend(this,new RegisterUI)};EmailLoginView.prototype={init:function(){this.setContent(RegisterUI.TEMPLATE.EMAIL_LOGIN_VIEW),this.setElements(),this.setEvent()},setElements:function(){this.container=this.wrapElement.find("._email_login_view")},setEvent:function(){this.container.on(UIStructure.EVENT_INPUT,"._email_text",$.proxy(this.onChangeEmailText,this)).on(UIStructure.EVENT_INPUT,"._password_text",$.proxy(this.onChangePasswordText,this)).on(UIStructure.EVENT_CLICK,"._register_btn",this.onClickRegisterBtn).on(UIStructure.EVENT_CLICK,"._not_registered_btn",this.onClickNewRegisterBtn).on(UIStructure.EVENT_CLICK,"._forgot_password_btn",$.proxy(this.onClickForgotPasswordBtn,this)),this.wrapElement.find("._reset_md").on(UIStructure.EVENT_INPUT,"._reset_email_text",$.proxy(this.onChangeResetEmailText,this)).on(UIStructure.EVENT_CLICK,"._cancel_reset_password_btn",$.proxy(this.onClickCancelResetPasswordBtn,this)).on(UIStructure.EVENT_CLICK,"._reset_password_btn",$.proxy(this.onClickResetPasswordBtn,this)),this.container.find("._email_text").trigger("keyup"),this.container.find("._password_text").trigger("keyup")},onChangeEmailText:function(e){this.changeInputStatus($(e.currentTarget)),this.setConfirmBtnStatus()},onChangePasswordText:function(e){this.changePasswordInputStatus($(e.currentTarget)),this.setConfirmBtnStatus()},setConfirmBtnStatus:function(){var email=$.trim($("._email_text").val()),password=$.trim($("._password_text").val());0===email.length||0===password.length?this.container.find("._register_btn").addClass("ExDisabled"):this.container.find("._register_btn").removeClass("ExDisabled")},onClickRegisterBtn:function(){if("offline"===NetworkChecker.getInstance().getState())return void alert($.i18n.prop("NETWORK_ERROR_INFO"));var email=$.trim($("._email_text").val()),password=$.trim($("._password_text").val());if(0===email.length||0===password.length)return!1;if(!Utility.isValidEmail(email))return alert($.i18n.prop("INVALID_EMAIL_ADDRESS_FORMAT_ERROR_TEXT")),!1;var passwordLength=password.length;return passwordLength<LineConfig.MIN_PASSWORD_LENGTH||passwordLength>LineConfig.MAX_PASSWORD_LENGTH?(alert($.i18n.prop("VALID_PASSWORD_INFO_TEXT",LineConfig.MIN_PASSWORD_LENGTH,LineConfig.MAX_PASSWORD_LENGTH)),!1):(DimmedUI.getInstance().open("",{},{isCenter:!0}),void RegisterProxy.getInstance().verifyIdentityCredential(email,password,$.proxy(function(result){return DimmedUI.getInstance().close(),result.code===ErrorCode.INVALID_IDENTITY_CREDENTIAL?void alert($.i18n.prop("WRONG_EMAIL_ACCOUNT_ERROR_TEXT")):(RegisterProxy.getInstance().setUserInputEmailInfo(email,password),RegisterProxy.getInstance().setEmailAccountInitialized(!0),void LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PHONE}))},this)))},onClickNewRegisterBtn:function(){RegisterStepInfoKeeper.getInstance().setIsNewUser(!0),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PHONE})},onChangeResetEmailText:function(e){var targetElement=$(e.currentTarget);0===$.trim(targetElement.val()).length?(targetElement.addClass("ExPlaceholder"),this.wrapElement.find("._reset_password_btn").addClass("ExDisabled")):(targetElement.removeClass("ExPlaceholder"),this.wrapElement.find("._reset_password_btn").removeClass("ExDisabled"))},onClickForgotPasswordBtn:function(){this.container.find("input").blur();var overlayElement=this.wrapElement.find("._reset_md_overlay"),modalElement=this.wrapElement.find("._reset_md");overlayElement.removeClass("MdNonDisp"),modalElement.removeClass("MdNonDisp");var scrollAreaHeight=LineMain.WINDOW_HEIGHT-LineMain.HEADER_SIZE,centerBoxElements=this.wrapElement.find("._center_box");centerBoxElements.each(function(){var containerHeight=$(this).height();$(this).css("top",(scrollAreaHeight-containerHeight)/2+"px")})},onClickResetPasswordBtn:function(){if("offline"===NetworkChecker.getInstance().getState())return void alert($.i18n.prop("NETWORK_ERROR_INFO"));this.container.find("input").blur();var emailText=$.trim(this.wrapElement.find("._reset_email_text").val());return Utility.isValidEmail(emailText)?(DimmedUI.getInstance().open("",{},{isCenter:!0}),void RegisterProxy.getInstance().requestEmailAccountPasswordReset(emailText,$.proxy(function(result){return DimmedUI.getInstance().close(),result.code===ErrorCode.INVALID_IDENTITY_CREDENTIAL?void alert($.i18n.prop("WRONG_EMAIL_ACCOUNT_ERROR_TEXT")):void(result.hasOwnProperty("code")||(this.hideModal(),alert($.i18n.prop("PASSWORD_RESET_MAIL_IS_SENT"))))},this))):(alert($.i18n.prop("INVALID_EMAIL_ADDRESS_FORMAT_ERROR_TEXT")),!1)},onClickCancelResetPasswordBtn:function(){this.container.find("input").blur(),this.hideModal()},hideModal:function(){var overlayElement=this.wrapElement.find("._reset_md_overlay"),modalElement=this.wrapElement.find("._reset_md");overlayElement.addClass("MdNonDisp"),modalElement.addClass("MdNonDisp")}},EmailLoginView.getInstance=function(){return null==EmailLoginView.instance&&(EmailLoginView.instance=new EmailLoginView),EmailLoginView.instance},EmailLoginView.instance=null;var EmailRegisterView=function(){return null!=EmailRegisterView.instance?EmailRegisterView.instance:(_.extend(this,new RegisterEmailUI),void(this.wrapElement=$("#_wrap_register")))};EmailRegisterView.prototype={initEmailRegister:function(){this.setContent(RegisterUI.TEMPLATE.EMAIL_REGISTER_VIEW,{}),DimmedUI.getInstance().close(),RegisterStepInfoKeeper.getInstance().setShownEmailRegister(!0),this.setOnConfirm(function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_EMAIL_REGISTER_INPUT_PINCODE})}),this.setOnCancel(function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIENDS,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_LIST})}),this.assignEmailRegister(),this.setEventEmailRegister(),this.container.find("input").blur()},initInputPinCode:function(){this.setOnConfirm(function(){RegisterStepInfoKeeper.getInstance().setEmailAccountInitialized(!0),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIENDS,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_LIST})}),this.setContent(RegisterUI.TEMPLATE.EMAIL_REGISTER_INPUT_PIN_CODE_VIEW,{userMail:RegisterStepInfoKeeper.getInstance().getUserInputEmail()}),this.setInputPinCodeElements(),this.setInputPinCodeEvent()}},EmailRegisterView.getInstance=function(){return null==EmailRegisterView.instance&&(EmailRegisterView.instance=new EmailRegisterView),EmailRegisterView.instance},EmailRegisterView.instance=null;var InputPhoneView=function(){return null!=InputPhoneView.instance?InputPhoneView.instance:(AuthInfoKeeper.getInstance().removeAll(),void _.extend(this,new RegisterUI))};InputPhoneView.prototype={init:function(){this.preLoad("INPUT_PIN_CODE_VIEW"),this.setContent(RegisterUI.TEMPLATE.INPUT_PHONE_VIEW,{regionStr:this.getRegionStr(),phoneNumber:RegisterStepInfoKeeper.getInstance().getUserInputPhoneNumber()||""}),this.setElements(),this.setEvent(),this.phoneNumberTextElement.trigger("keydown")},getRegionStr:function(){var countryCode=RegisterProxy.getInstance().getRegion(),countryInfo=ResourceLoader.getInstance().getCountryInfoByCountryCode(countryCode);return"(+"+countryInfo.countryNo+") "+countryInfo.countryName},setElements:function(){this.container=this.wrapElement.find("._input_phone_view"),this.phoneNumberTextElement=this.container.find("#_input_phone_text"),this.verifyButtonElement=this.container.find("#_verify_phone_btn")},setEvent:function(){this.container.on(UIStructure.EVENT_CLICK,"#_verify_phone_btn",$.proxy(this.onClickVerifyPhoneBtn,this)).on(UIStructure.EVENT_CLICK,"#_country_select",$.proxy(this.onClickCountrySelect,this)),this.container.on(UIStructure.EVENT_INPUT,"#_input_phone_text",$.proxy(this.onChangeInputPhoneNumberText,this))},onChangeInputPhoneNumberText:function(e){this.bindEnterEvent(e,this.verifyButtonElement),Utility.setOnlyNumber($(e.currentTarget));var userInputPhoneNumber=$.trim($(e.currentTarget).val()),phoneNumberLength=userInputPhoneNumber.length;return phoneNumberLength>=LineConfig.MAX_PHONE_NUMBER_LENGTH&&!Utility.isSystemKey(e)?void e.preventDefault():(phoneNumberLength<LineConfig.REGISTER_PHONE_NUMBER_MIN_LENGTH?this.verifyButtonElement.addClass("ExDisabled"):this.verifyButtonElement.removeClass("ExDisabled"),0===$.trim(this.phoneNumberTextElement.val()).length?this.phoneNumberTextElement.parent().removeClass("MdFontB"):this.phoneNumberTextElement.parent().addClass("MdFontB"),void this.changeInputStatus(this.phoneNumberTextElement))},onClickCountrySelect:function(){this.container.find("input").blur(),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.ETC,subScreen:LineMain.SUB_SCREEN_TYPE.SELECT_COUNTRY})},isValid:function(){var phoneNumberLength=$.trim(this.phoneNumberTextElement.val()).length;return 0!==phoneNumberLength},onClickVerifyPhoneBtn:function(){if("offline"===NetworkChecker.getInstance().getState())return void alert($.i18n.prop("NETWORK_ERROR_INFO"));var userInputPhoneNumber=$.trim(this.phoneNumberTextElement.val());if(""!==userInputPhoneNumber){if(!this.isValid())return this.verifyButtonElement.removeClass("ExTap"),void this.phoneNumberTextElement.trigger("keydown");this.container.find("input").blur(),this.verifyButtonElement.removeClass("ExDisabled").addClass("ExTap"),RegisterStepInfoKeeper.getInstance().setUserInputPhoneNumber(userInputPhoneNumber),RegisterStepInfoKeeper.getInstance().setPhonePinCodeResendFlag(!1),RegisterStepInfoKeeper.getInstance().getIsNewUser()?LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_CONFIRM_TERM}):RegisterProxy.getInstance().startVerificationWithSendSMS(function(result){result.code||result.code===ErrorCode.ILLEGAL_ARGUMENT?(alert($.i18n.prop("INVALID_PHONE_NUMBER")),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PHONE})):LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PIN_CODE})})}}},InputPhoneView.getInstance=function(){return null==InputPhoneView.instance&&(InputPhoneView.instance=new InputPhoneView),InputPhoneView.instance},InputPhoneView.instance=null;var InputPinCodeView=function(){return null!=InputPinCodeView.instance?InputPinCodeView.instance:void _.extend(this,new RegisterUI)};InputPinCodeView.prototype={init:function(){this.setContent(RegisterUI.TEMPLATE.INPUT_PIN_CODE_VIEW,{phoneNumber:AuthInfoKeeper.getInstance().getPhoneNumber(),resendFlag:RegisterStepInfoKeeper.getInstance().getPhonePinCodeResendFlag()||!1}),this.setElements(),this.setEvent()},setElements:function(){this.container=this.wrapElement.find("#_input_pin_code_view"),this.pinCodeTextElement=this.container.find("._pincode_text"),this.confirmButtonElement=this.container.find("._confirm_btn")},setEvent:function(){this.container.on(UIStructure.EVENT_CLICK,"._confirm_btn",$.proxy(this.onClickConfirmBtn,this)).on(UIStructure.EVENT_CLICK,"._edit_phone_number_btn",$.proxy(this.onClickEditPhoneNumberBtn,this)).on(UIStructure.EVENT_CLICK,"._resend_btn",$.proxy(this.onClickResendBtn,this)),this.container.find("._pincode_text").on(UIStructure.EVENT_INPUT,$.proxy(this.onChangePincodeText,this)),this.pinCodeTextElement.trigger("keydown")},onChangePincodeText:function(e){var pinNumberLength=$.trim($(e.currentTarget).val()).length;return pinNumberLength<LineConfig.REGISTER_PIN_NUMBER_MIN_LENGTH?this.confirmButtonElement.addClass("ExDisabled"):this.confirmButtonElement.removeClass("ExDisabled"),Utility.setOnlyNumber($(e.currentTarget)),pinNumberLength>=LineConfig.MAX_PINCODE_LENGTH&&!Utility.isSystemKey(e)?void e.preventDefault():(this.bindEnterEvent(e,this.confirmButtonElement),void this.changeInputStatus(this.pinCodeTextElement))},onClickEditPhoneNumberBtn:function(){ConfirmUI.getInstance().open({message:$.i18n.prop("REGISTER_PHONE_NUMBER_CHANGE_CONFIRM"),button:{left:{label:$.i18n.prop("CANCEL"),"class":"dark",callback:function(){}},right:{label:$.i18n.prop("CONFIRM"),callback:$.proxy(this.moveToInputPhone,this)}}})},moveToInputPhone:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PHONE})},isSessionTimeOver:function(){var pinCodeSessionStartTime=RegisterStepInfoKeeper.getInstance().getPhonePinCodeSessionStartTime(),nowTime=(new Date).getTime(),sessionGap=(nowTime-pinCodeSessionStartTime)/1e3;return sessionGap/60>=LineConfig.REGISTER_PHONE_PINCODE_SESSION_LIMIT},onClickConfirmBtn:function(){if(this.isSessionTimeOver())return alert($.i18n.prop("REGISTRATION_DIALOG_SESSION_EXPIRED")),void this.moveToInputPhone();var pinCodeNumber=$.trim(this.pinCodeTextElement.val());return pinCodeNumber.length>LineConfig.MAX_PINCODE_LENGTH?!1:void(""!==pinCodeNumber&&(DimmedUI.getInstance().open("",{},{isCenter:!0}),this.dimmedTimer=setTimeout(function(){DimmedUI.getInstance().close()},LineConfig.DIMMED_TIMEOUT),RegisterProxy.getInstance().verifyPhone(pinCodeNumber,$.proxy(this.handleRegisterStep,this))))},onClickResendBtn:function(e){if(!$(e.currentTarget).hasClass("ExDisabled")){if(this.isSessionTimeOver())return alert($.i18n.prop("REGISTRATION_DIALOG_SESSION_EXPIRED")),void this.moveToInputPhone();DimmedUI.getInstance().open("",{},{isCenter:!0}),RegisterProxy.getInstance().resendPinCodeBySMS($.proxy(function(result){DimmedUI.getInstance().close(),result.code===ErrorCode.NOT_AVAILABLE_SESSION||result.code===ErrorCode.NOT_AVAILABLE_PIN_CODE_SESSION?(alert($.i18n.prop("REGISTRATION_DIALOG_SESSION_EXPIRED")),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE})):(RegisterStepInfoKeeper.getInstance().setPhonePinCodeResendFlag(!0),this.container.find("._resend_btn").addClass("ExDisabled"),alert($.i18n.prop("REGISTRATION_BTN_LABEL_RESEND")),this.container.find("._pincode_text").val("").trigger("keyup"))},this))}},handleRegisterStep:function(result){DimmedUI.getInstance().close(),RegisterUI.getInstance().handleRegisterError(result)&&(parseInt(result,10)===VerificationResult.FAILED?(clearTimeout(this.dimmedTimer),alert($.i18n.prop("WRONG_ENFORCE_SECURITY_NUMBER"))):(RegisterStepInfoKeeper.getInstance().setVerifyPhoneResult(result),RegisterStepInfoKeeper.getInstance().getIsNewUser()?this.handleRegisterStepNewUser(result):(DimmedUI.getInstance().close(),clearTimeout(this.dimmedTimer),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_CONFIRM_USE_CONTACTS}))))},handleRegisterStepNewUser:function(result){switch(result){case VerificationResult.OK_NOT_REGISTERED_YET:RegisterProxy.getInstance().registerDevice(function(result){DimmedUI.getInstance().close(),RegisterUI.getInstance().handleRegisterError(result)&&LineMain.getInstance().changeScreen(""===result||null===result?{screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE}:{screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_CONFIRM_USE_CONTACTS})});break;case VerificationResult.OK_REGISTERED_WITH_SAME_DEVICE:RegisterProxy.getInstance().registerDevice(function(result){DimmedUI.getInstance().close(),RegisterUI.getInstance().handleRegisterError(result)&&LineMain.getInstance().changeScreen(""===result||null===result?{screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE}:{screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PROFILE})});break;case VerificationResult.OK_REGISTERED_WITH_ANOTHER_DEVICE:DimmedUI.getInstance().close(),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_CONFIRM_SAME_DEVICE})}}},InputPinCodeView.getInstance=function(){return null==InputPinCodeView.instance&&(InputPinCodeView.instance=new InputPinCodeView),InputPinCodeView.instance},InputPinCodeView.instance=null;var InputProfileView=function(){return null!=InputProfileView.instance?InputProfileView.instance:void _.extend(this,new RegisterUI)};InputProfileView.prototype={init:function(){this.setContent(RegisterUI.TEMPLATE.INPUT_PROFILE_VIEW,{displayName:RegisterStepInfoKeeper.getInstance().getUserInputDisplayName()}),this.setElements(),this.setEvent(),this.container.find("._display_name_text").trigger("keydown")},setElements:function(){this.container=this.wrapElement.find("#_input_profile_view")},setEvent:function(){this.container.on(UIStructure.EVENT_INPUT,"._display_name_text",$.proxy(this.onChangeDisplayNameText,this)).on(UIStructure.EVENT_CLICK,"._confirm_btn",$.proxy(this.onClickRegisterBtn,this)).on(UIStructure.EVENT_CLICK,"._profile_image",$.proxy(this.onClickPhotoImage,this)),this.container.find("._touch_input_text_area").on(UIStructure.EVENT_CLICK,$.proxy(this.onTouchInputTextArea,this))},onTouchInputTextArea:function(){return setTimeout($.proxy(function(){this.container.find("._display_name_text").focus()},this),0),!1},MIN_LENGTH:0,MAX_LENGTH:20,onChangeDisplayNameText:function(e){var displayName=$.trim($(e.currentTarget).val()),displayNameLength=displayName.length;return 0===displayNameLength?($(e.currentTarget).addClass("ExPlaceholder"),this.container.find("._confirm_btn").addClass("ExDisabled")):($(e.currentTarget).removeClass("ExPlaceholder"),this.container.find("._confirm_btn").removeClass("ExDisabled")),this.container.find("._min_max_str").html($(e.currentTarget).val().length+"/"+this.MAX_LENGTH),displayNameLength>=this.MAX_LENGTH&&!Utility.isSystemKey(e)?($(e.currentTarget).val(displayName.substr(0,this.MAX_LENGTH)),this.container.find("._min_max_str").html(this.MAX_LENGTH+"/"+this.MAX_LENGTH),!1):void 0
},onClickRegisterBtn:function(e){e.stopPropagation(),e.preventDefault();var displayName=$.trim(this.container.find("._display_name_text").val());return""!==displayName?(RegisterStepInfoKeeper.getInstance().setUserInputDisplayName(displayName),ProfileProxy.getInstance().setProfile({displayName:displayName}),RegisterProxy.getInstance().onRegisterFinish(),!1):void 0},onClickPhotoImage:function(e){this.pickImage(e.currentTarget)},pickImage:function(elementTarget){var userImage=RegisterProxy.getInstance().getUserInputImage(),element=$(elementTarget).find("img"),hasImage=""!==userImage&&null!==userImage,pickerConfig={photo:{callback:$.proxy(function(image){var url=URL.createObjectURL(image);element.attr("src",url);var img=new Image,elCanvas=document.createElement("canvas"),ctx=elCanvas.getContext("2d");img.onload=function(){elCanvas.setAttribute("width",img.width),elCanvas.setAttribute("height",img.height),ctx.drawImage(img,0,0,img.width,img.height);var oSegmReq=new FileReader;oSegmReq.readAsArrayBuffer(image),oSegmReq.onload=function(e){RegisterProxy.getInstance().setUserInputImage(e.target.result)}},img.src=url},this)}};hasImage&&(pickerConfig.remove={callback:$.proxy(function(){var noImage="/res/img/noimg/profile_img90x90.png";element.attr("src",noImage),RegisterProxy.getInstance().setUserInputImage(null)},this)}),new MediaPickerUI(pickerConfig).pickMedia()}},InputProfileView.getInstance=function(){return null==InputProfileView.instance&&(InputProfileView.instance=new InputProfileView),InputProfileView.instance},InputProfileView.instance=null;var NewLineView=function(){return null!=NewLineView.instance?NewLineView.instance:(_.extend(this,new RegisterUI),void RegisterStepInfoKeeper.getInstance().removeAll())};NewLineView.prototype={init:function(){this.setContent(RegisterUI.TEMPLATE.NEW_LINE_VIEW),this.setElements(),this.setEvent(),this.preLoad("INPUT_PHONE_VIEW"),this.preLoad("EMAIL_LOGIN_VIEW")},setElements:function(){this.container=this.wrapElement.find("#_new_line_view")},setEvent:function(){this.container.on(UIStructure.EVENT_CLICK+" click","._already_registered_btn",this._onClickAlreadyRegisterBtn).on(UIStructure.EVENT_CLICK+" click","._register_new_btn",this._onClickNewRegisterBtn)},_onClickNewRegisterBtn:function(){RegisterProxy.getInstance().clearLoginInfo(),RegisterStepInfoKeeper.getInstance().setIsNewUser(!0),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_INPUT_PHONE})},_onClickAlreadyRegisterBtn:function(){RegisterStepInfoKeeper.getInstance().setIsNewUser(!1),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_EMAIL_LOGIN})}},NewLineView.getInstance=function(){return null==NewLineView.instance&&(NewLineView.instance=new NewLineView),NewLineView.instance},NewLineView.instance=null;var RegisterView=function(){return null!=RegisterView.instance?RegisterView.instance:(this.setWrapElements(),void this.setEvents())};RegisterView.prototype={setWrapElements:function(){this.wrapElement=$("#_wrap_register")},setEvents:function(){},setContent:function(registerViewID){$("#_wrap_register").html(TemplateManager.getInstance().get(RegisterView[registerViewID]))}},RegisterView.getInstance=function(){return null==RegisterView.instance&&(RegisterView.instance=new RegisterView),RegisterView.instance},RegisterView.instance=null,RegisterView.COUNTRY_LIST_ITEM=BASE_DEFAULT+"src/proxy/register/ui/template/CountryListTemplate.mustache",RegisterView.TEMPLATE_LOCATION=BASE_DEFAULT+"src/proxy/register/ui/screen/",RegisterView.NEW_LINE_VIEW=RegisterView.TEMPLATE_LOCATION+"NewLine.mustache",RegisterView.EMAIL_LOGIN_VIEW=RegisterView.TEMPLATE_LOCATION+"EmailLogin.mustache",RegisterView.INPUT_PHONE_VIEW=RegisterView.TEMPLATE_LOCATION+"InputPhone.mustache",RegisterView.INPUT_PROFILE_VIEW=RegisterView.TEMPLATE_LOCATION+"InputProfile.mustache",RegisterView.CONFIRM_TERM_VIEW=RegisterView.TEMPLATE_LOCATION+"ConfirmTerm.mustache",RegisterView.SEND_PIN_CODE_VIEW=RegisterView.TEMPLATE_LOCATION+"SendPinCode.mustache",RegisterView.INPUT_PIN_CODE_VIEW=RegisterView.TEMPLATE_LOCATION+"InputPhonePinCode.mustache",RegisterView.CONFIRM_USE_CONTACTS_VIEW=RegisterView.TEMPLATE_LOCATION+"ConfirmUseContacts.mustache",RegisterView.CONFIRM_EMAIL_REGISTER_VIEW=RegisterView.TEMPLATE_LOCATION+"ConfirmEmailRegister.mustache",RegisterView.EMAIL_REGISTER_VIEW=RegisterView.TEMPLATE_LOCATION+"EmailRegister.mustache",RegisterView.EMAIL_REGISTER_INPUT_PIN_CODE_VIEW=RegisterView.TEMPLATE_LOCATION+"EmailRegisterInputPinCode.mustache";var SettingProxy=function(){return null!=SettingProxy.instance?SettingProxy.instance:(this.eventManager=new EventManager,this.store=SettingPersistentStore.getInstance(),this.customStore=PersistentStore.getInstance(),this.settingBo=SettingBO.getInstance(),this.settingBo.setSettings(this.store.get()),this.jobWorker=new JobWorker(BASE_DEFAULT+"src/worker/SettingNetworkJob.js",LineTalkExceptionHandler.getInstance().handle,LineNetworkExceptionHandler.getInstance().handle),this.pushMuteChecker=0,this.checkPushMuteExpire(),void(this.revision=null))};SettingProxy.prototype={getJobWorker:function(){return this.jobWorker},notifyUpdate:function(){this.eventManager.broadCast()},getEventManager:function(){return this.eventManager},get:function(){return this.store.get()},getProp:function(prop){var settings=this.getSettings();return settings[prop]},getSettings:function(){return this.settingBo.getSettings()},setSettings:function(data){this.settingBo.setSettings(data),this.store.set(this.settingBo.getSettings()),this.eventManager.broadCast()},updateSettingsAttribute:function(key,value,callback){callback=callback?callback:EventManager.EMPTY,this.settingBo.updateSettingsAttributeT(key,value,$.proxy(function(result){this.settingBo.setSettingsAttribute(key,value),this.store.set(this.settingBo.getSettings()),this.eventManager.broadCast(null),callback(result)},this))},updatePushMuteExpiration:function(key,value,callback){callback=callback?callback:EventManager.EMPTY,this.settingBo.setSettingsAttribute(key,value+(new Date).getTime()),this.store.set(this.settingBo.getSettings()),this.eventManager.broadCast(null),this.settingBo.updateSettingsAttributeT(key,value,$.proxy(function(){this.eventManager.broadCast(null),callback()},this))},updateToLocalSettings:function(callback){callback=callback?callback:function(){},this.settingBo.getSettingsT($.proxy(function(settings){this.setSettings(settings),LineMain.getInstance().getEventManager().broadCast(),callback(settings)},this))},updateToServerSettings:function(callback){callback=callback?callback:function(){};var settings=this.getSettings();this.settingBo.updateSettingsT(settings,callback)},setPublicUserId:function(flag){var settings=this.store.get();settings.publicUserId=flag,this.store.set(settings)},unregister:function(){var authToken=AuthInfoKeeper.getInstance().getAuthMid();authToken||(AppCleaner.getInstance().clear(),DimmedUI.getInstance().close(),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE})),this.settingBo.unregisterUserAndDeviceT(function(){AppCleaner.getInstance().clear(),DimmedUI.getInstance().close(),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE})})},setEmailIdentityCredential:function(identifier,verifier,callback){this.setIdentityCredential(IdentityProvider.LINE,identifier,verifier,callback)},setIdentityCredential:function(identityProvider,identifier,verifier,callback){RegisterProxy.getInstance().getRSAKeyValuePair(identifier,verifier,$.proxy(function(result){this.settingBo.setIdentityCredentialT(identityProvider,result.key,result.value,function(result){callback(result)})},this))},clearIdentityCredential:function(callback){this.settingBo.clearIdentityCredentialT(function(result){RegisterProxy.getInstance().clearEmailIdentityCredential(),callback(result)})},removeAll:function(){this.settingBo.removeAll()},updateNotificationToken:function(endPoint){this.settingBo.updateNotificationTokenT(endPoint,EventManager.EMPTY)},getMuteSetting:function(){return this.customStore.get("SD_notifactionMuteExpiration")||-1},changeMuteExpiration:function(muteSetting,callback){this.customStore.set("SD_notifactionMuteExpiration",muteSetting);var muteExpirationTimeStamp=this.settingBo.updateMuteExpiration(muteSetting,callback);SettingUI.getInstance().updateMuteExpiration(muteSetting,muteExpirationTimeStamp-LineMain.SERVER_TIME_OFFSET)},checkPushMuteExpire:function(){if(clearTimeout(this.pushMuteChecker),this.isPushMute()){var offTime=this.getProp("notificationMuteExpiration")-(new Date).getTime();this.pushMuteChecker=setTimeout($.proxy(function(){this.changeMuteExpiration(-1)},this),offTime)}},isPushMute:function(){var now=(new Date).getTime(),muteExpirationTimeStamp=this.getProp("notificationMuteExpiration");return muteExpirationTimeStamp>now},getLastAutoSyncTime:function(){return this.customStore.get("SD_lastSyncTime")},setSyncConfirm:function(){this.customStore.set("SD_syncConfirm",!0)},getSyncConfirm:function(){return this.customStore.get("SD_syncConfirm")},updateConnectionServerInfo:function(){this.jobWorker.sendQuery("pushServerInfo",PersistentStore.getInstance().get("CI_serverList"))},verifyQrcode:function(verifier,pinCode,customCallback){this.settingBo.verifyQrcodeT(verifier,pinCode,customCallback)},getSessions:function(customCallback){this.settingBo.getSessionsT(customCallback)},logoutSession:function(tokenKey,customCallback){this.settingBo.logoutSessionT(tokenKey,customCallback)},getLastOpRevision:function(customCallback){this.settingBo.getLastOpRevisionT(customCallback)},getServerTime:function(customCallback){this.settingBo.getServerTimeT(customCallback)},debugMode:function(debugInfo){this.jobWorker.sendQuery("pushDebugInfo",debugInfo)}},SettingProxy.getInstance=function(){return null==SettingProxy.instance&&(SettingProxy.instance=new SettingProxy),SettingProxy.instance},SettingProxy.instance=null;var SettingUI=function(){return null!=SettingUI.instance?SettingUI.instance:(_.extend(this,UIStructure),TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_LIST_VIEW),LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this)),this.assign(),void this.initFunctionReferences())};SettingUI.prototype={assign:function(){this.elWrapSetting=$("#_wrap_setting")},initFunctionReferences:function(){var subScreenType=LineMain.SUB_SCREEN_TYPE,reference=[];reference[subScreenType.SETTING_LIST]=this.showSettingList,reference[subScreenType.SETTING_PROFILE]=this.showProfile,reference[subScreenType.SETTING_ACCOUNTS]=this.showAccounts,reference[subScreenType.SETTING_NOTIFICATIONS]=this.showNotifications,reference[subScreenType.SETTING_CHATS]=this.showChats,reference[subScreenType.SETTING_FRIENDS]=this.showFriends,reference[subScreenType.SETTING_INVITE_FRIENDS]=this.showInviteFriends,reference[subScreenType.SETTING_HIDE_LIST]=this.showHiddenList,reference[subScreenType.SETTING_BLOCK_LIST]=this.showBlockList,reference[subScreenType.SETTING_PRIVACY]=this.showPrivacy,reference[subScreenType.SETTING_HELP]=this.showHelp,reference[subScreenType.SETTING_ABOUT_LINE]=this.showAboutLine,reference[subScreenType.SETTING_TERMS_OF_SERVICE]=this.showTermsOfService,reference[subScreenType.SETTING_PRIVACY_POLICY]=this.showPrivacyPolicy,reference[subScreenType.SETTING_LEGAL_NOTICES]=this.showLegalNotices,reference[subScreenType.SETTING_DELETE_ACCOUNT]=this.showDeleteAccount,reference[subScreenType.SETTING_INTERCEPT_ACCOUNT]=this.showInterceptAccount,reference[subScreenType.SETTING_EMAIL_ACCOUNTS]=this.showEmailAccounts,reference[subScreenType.SETTING_EMAIL_CHANGE_VERIFY]=this.showVerifyChangeEmailRegistration,reference[subScreenType.SETTING_EMAIL_CHANGE_EMAIL]=this.showChangeEmail,reference[subScreenType.SETTING_EMAIL_CHANGE_PASSWORD]=this.showEmailChangePassword,reference[subScreenType.SETTING_EMAIL_CHANGE_SUCCESS]=this.showEmailChangeSuccess,reference[subScreenType.SETTING_EMAIL_CANCEL_REGISTRATION]=this.showCancelEmailRegistration,reference[subScreenType.SETTING_REGISTER_EMAIL]=this.showRegisterEmail,reference[subScreenType.SETTING_REGISTER_EMAIL_INPUT_PINCODE]=this.showRegisterEmailInputPinCode,reference[subScreenType.SETTING_OTHER_DEVICE]=this.showOtherDevice,this.reference=reference},getFunction:function(subScreen){if(this.reference[subScreen])return $.proxy(this.reference[subScreen],this);throw"Undefined Function : "+subScreen},changeScreen:function(options){if(options&&options.type===UIEventManager.EVENT_RESIZE)return this.resize(),!1;var screenInfo=LineMain.getInstance().getScreenInfo();LineMain.getInstance().isMainScreen(LineMain.MAIN_SCREEN_TYPE.SETTING)?($("body").addClass("bgTypeG03"),this.showWrap(),this.getFunction(screenInfo.subScreen)(),this.resize()):this.hideWrap()},showWrap:function(){this.elWrapSetting.removeClass("MdNonDisp")},hideWrap:function(){this.elWrapSetting.addClass("MdNonDisp")},resize:function(){var scrollAreaHeight=LineMain.WINDOW_HEIGHT-LineMain.HEADER_SIZE-$("#_wrap_main_menu").height();this.elWrapSetting.height(scrollAreaHeight);var iframe=this.elWrapSetting.find("iframe");iframe&&iframe.height(scrollAreaHeight-4);var centerBoxElements=this.elWrapSetting.find("._center_box");centerBoxElements.each(function(){var containerHeight=$(this).height();$(this).css("top",(scrollAreaHeight-containerHeight)/2+"px")}),this.rePositionCenterTargetElement()},rePositionCenterTargetElement:function(){var contentCenterElement=this.elWrapSetting.find("._content_center"),imgElements=contentCenterElement.find("img"),ignoreHeight=0;this.elWrapSetting.find("._content_ignore").each(function(){ignoreHeight+=$(this).height()});var scrollAreaHeight=LineMain.WINDOW_HEIGHT-LineMain.HEADER_SIZE-$("#_wrap_main_menu").height(),contentAvailHeight=scrollAreaHeight-ignoreHeight,rePositionToCenter=function(){var topY=(contentAvailHeight-contentCenterElement.height())/2-6;contentCenterElement.css({"margin-top":topY+"px","margin-bottom":topY+"px"})};Utility.imageLoad(imgElements,rePositionToCenter),rePositionToCenter()},showSettingList:function(){setTimeout(function(){_.each(SettingUI.TEMPLATE,function(templatePath){TemplateManager.getInstance().get(templatePath)})},200),SettingListView.getInstance().init(),HeaderView.getInstance().setTitle($.i18n.prop("TITLE_SETTINGS")).show(),MenuView.getInstance().set(LineMain.getInstance().getScreenInfo()).show()},showProfile:function(){ProfileUI.getInstance().init(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("PROFILE")).show(),MenuView.getInstance().hide()},showDeleteAccount:function(){var contentHtml=Mustache.render(TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_DELETE_ACCOUNT_VIEW),{});this.elWrapSetting.html(contentHtml);var accountWrap=this.elWrapSetting.find("._delete_account_view");accountWrap.find("._delete_account_btn").on(UIStructure.EVENT_CLICK,function(){ConfirmUI.getInstance().open({message:$.i18n.prop("DELETE_ACCOUNT_WARNING_TEXT"),button:{left:{label:$.i18n.prop("CANCEL"),callback:function(){}},right:{label:$.i18n.prop("CONFIRM"),callback:$.proxy(function(){DimmedUI.getInstance().open("",{},{isCenter:!0}),SettingProxy.getInstance().unregister()},this)}}})}),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("DELETE_ACCOUNT")).show(),MenuView.getInstance().set(LineMain.getInstance().getScreenInfo()).hide()},showInterceptAccount:function(){var contentHtml=Mustache.render(TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_INTERCEPT_ACCOUNT_VIEW),{});this.elWrapSetting.html(contentHtml);var accountWrap=this.elWrapSetting.find("._intercept_account_view");accountWrap.find("._confirm_btn").on(UIStructure.EVENT_CLICK,function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE}),AppCleaner.getInstance().clear()}),HeaderView.getInstance().setTitle($.i18n.prop("DELETE_ACCOUNT")).show(),MenuView.getInstance().set(LineMain.getInstance().getScreenInfo()).hide()},showAccounts:function(){AccountsView.getInstance().init(),HeaderView.getInstance().set({back:{action:$.proxy(this.moveToList,this)}}).setTitle($.i18n.prop("TITLE_ACCOUNTS")).show(),MenuView.getInstance().hide()},moveToList:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_LIST})},showEmailAccounts:function(){EmailAccountView.getInstance().initAccountView(),HeaderView.getInstance().set({back:{action:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_ACCOUNTS})}}}).setTitle($.i18n.prop("EMAIL")).show(),MenuView.getInstance().hide()},showVerifyChangeEmailRegistration:function(){EmailAccountView.getInstance().initVerifyChangeEmailRegistration(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("CHANGE_EMAIL")).show(),MenuView.getInstance().hide()},showRegisterEmail:function(){EmailAccountView.getInstance().initEmailRegister(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("REGISTER_EMAIL")).show(),MenuView.getInstance().hide()},showChangeEmail:function(){EmailAccountView.getInstance().initChangeEmail(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("CHANGE_EMAIL")).show(),MenuView.getInstance().hide()},showRegisterEmailInputPinCode:function(){EmailAccountView.getInstance().initInputPinCode(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("REGISTER_EMAIL")).show(),MenuView.getInstance().hide()},showEmailChangePassword:function(){EmailAccountView.getInstance().initChangePassword(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("CHANGE_PASSWORD")).show(),MenuView.getInstance().hide()},showEmailChangeSuccess:function(){EmailAccountView.getInstance().initEmailChangeSuccess(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("REGISTER_EMAIL")).show(),MenuView.getInstance().hide()},showCancelEmailRegistration:function(){EmailAccountView.getInstance().initCancelEmailRegistration(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("UNREGISTER_EMAIL")).show(),MenuView.getInstance().hide()},showNotifications:function(){NotificationsView.getInstance().init(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("TITLE_NOTIFICATIONS")).show(),MenuView.getInstance().hide()},showChats:function(){ChatsView.getInstance().init(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("CHAT_SETTINGS")).show(),MenuView.getInstance().hide()},showFriends:function(){FriendsView.getInstance().initFriends(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("FRIEND")).show(),MenuView.getInstance().hide()},showInviteFriends:function(){FriendsView.getInstance().initInviteFriends(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("INVITE_FRIENDS")).show(),MenuView.getInstance().hide()},showHiddenList:function(){FriendsView.getInstance().initHiddenList(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("HIDDEN_USER_SETTING_TITLE")).show(),MenuView.getInstance().hide()},showBlockList:function(){FriendsView.getInstance().initBlockList(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("BLOCKED_USER_SETTING_TITLE")).show(),MenuView.getInstance().hide()},showPrivacy:function(){PrivacyView.getInstance().init(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("PRIVACY_SETTINGS")).show(),MenuView.getInstance().hide()},showHelp:function(){HelpView.getInstance().init(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("HELP")).show(),MenuView.getInstance().hide()},showAboutLine:function(){AboutLineView.getInstance().init(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("ABOUT_LINE_SETTINGS")).show(),MenuView.getInstance().hide()},showTermsOfService:function(){HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("TERMS_OF_SERVICE")).show(),MenuView.getInstance().hide()},showPrivacyPolicy:function(){HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("PRIVACY_POLICY")).show(),MenuView.getInstance().hide()},showLegalNotices:function(){HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("SETTING_OSS_LICENCE")).show(),MenuView.getInstance().hide()},showOtherDevice:function(){OtherDeviceView.getInstance().init(),HeaderView.getInstance().set({back:!0}).setTitle($.i18n.prop("SETTINGS_PRIVACY_ACCOUNT_DEVICES")).show(),MenuView.getInstance().hide()},updateMuteExpiration:function(muteSetting,timestamp){NotificationsView.getInstance().updateMuteExpiration(muteSetting,timestamp)}},SettingUI.getInstance=function(){return null==SettingUI.instance&&(SettingUI.instance=new SettingUI),SettingUI.instance},SettingUI.instance=null,SettingUI.TEMPLATE={},SettingUI.TEMPLATE.SETTING_LIST_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/SettingList.mustache",SettingUI.TEMPLATE.SETTING_ACCOUNTS_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/Accounts.mustache",SettingUI.TEMPLATE.SETTING_NOTIFICATIONS_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/Notifications.mustache",SettingUI.TEMPLATE.SETTING_EMAIL_CHANGE_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/EmailAccounts.mustache",SettingUI.TEMPLATE.SETTING_EMAIL_CHANGE_ADDRESS_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/EmailChangeAddress.mustache",SettingUI.TEMPLATE.SETTING_EMAIL_CHANGE_PASSWORD_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/EmailChangePassword.mustache",SettingUI.TEMPLATE.SETTING_EMAIL_IDENTIFICATION_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/EmailIdentification.mustache",SettingUI.TEMPLATE.SETTING_EMAIL_CHANGE_SUCCESS_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/EmailChangeSuccess.mustache",SettingUI.TEMPLATE.SETTING_EMAIL_REGISTER_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/EmailSettingRegister.mustache",SettingUI.TEMPLATE.SETTING_EMAIL_INPUT_PINCODE_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/EmailInputPinCode.mustache",SettingUI.TEMPLATE.SETTING_CHATS_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/Chats.mustache",SettingUI.TEMPLATE.SETTING_PRIVACY_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/Privacy.mustache",SettingUI.TEMPLATE.SETTING_FRIENDS_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/Friends.mustache",SettingUI.TEMPLATE.SETTING_INVITE_FRIENDS_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/InviteFriends.mustache",SettingUI.TEMPLATE.SETTING_BLOCK_LIST_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/Block.mustache",SettingUI.TEMPLATE.SETTING_HIDDEN_LIST_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/Hidden.mustache",SettingUI.TEMPLATE.BLOCK_LIST_ITEM=BASE_DEFAULT+"src/proxy/setting/ui/template/BlockListItem.mustache",SettingUI.TEMPLATE.HIDE_LIST_ITEM=BASE_DEFAULT+"src/proxy/setting/ui/template/HideListItem.mustache",SettingUI.TEMPLATE.BLOCK_LIST_CONTEXT_MENU=BASE_DEFAULT+"src/proxy/setting/ui/template/BlockListContextMenuItem.mustache",SettingUI.TEMPLATE.HIDE_LIST_CONTEXT_MENU=BASE_DEFAULT+"src/proxy/setting/ui/template/HideListContextMenuItem.mustache",SettingUI.TEMPLATE.SETTING_HELP_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/Help.mustache",SettingUI.TEMPLATE.SETTING_ABOUT_LINE_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/AboutLine.mustache",SettingUI.TEMPLATE.SETTING_TERMS_OF_SERVICE_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/TermsOfService.mustache",SettingUI.TEMPLATE.SETTING_PRIVACY_POLICY_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/PrivacyPolicy.mustache",SettingUI.TEMPLATE.SETTING_LEGAL_NOTICES_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/LegalNotices.mustache",SettingUI.TEMPLATE.SETTING_DELETE_ACCOUNT_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/DeleteAccount.mustache",SettingUI.TEMPLATE.SETTING_INTERCEPT_ACCOUNT_VIEW=BASE_DEFAULT+"src/proxy/setting/ui/screen/InterceptAccount.mustache",SettingUI.TEMPLATE.OTHER_DEVICE_TEMPLATE=BASE_DEFAULT+"src/proxy/setting/ui/screen/OtherDevice.mustache";var SettingBO=function(){return null!=SettingBO.instance?SettingBO.instance:void this.initProperty()};SettingBO.prototype={initProperty:function(){this.contactMyTicket=null,this.customModes={},this.emailConfirmationStatus=null,this.identityIdentifier=null,this.identityProvider=null,this.notificationDisabledWithSub=!1,this.notificationEnable=!1,this.notificationGroupInvitation=!1,this.notificationIncomingCall=null,this.notificationMuteExpiration=null,this.notificationNewMessage=!1,this.notificationShowMessage=!1,this.notificationSoundGroup=!1,this.notificationSoundMessage=!1,this.phoneRegistration=!1,this.preferenceLocale="",this.privacyAllowSecondaryDeviceLogin=!1,this.privacyProfileImagePostToMyhome=!1,this.privacyReceiveMessagesFromNotFriend=!1,this.privacySearchByEmail=!1,this.privacySearchByPhoneNumber=!1,this.privacySearchByUserid=!1,this.privacySyncContacts=!1,this.snsAccounts={},this.chatAutoResend=!1},getSettings:function(){return Utility.serialize(_.clone(this))},setSettings:function(userData){_.extend(this,userData)},getSettingsT:function(callback){var options={methodName:"getSettingsT",data:[],success:function(result){callback(result)},error:function(){}};SettingProxy.getInstance().getJobWorker().send(options)},updateSettingsT:function(settings,callback){var options={methodName:"updateSettingsT",data:[settings],success:function(result){callback(result)},error:function(){}};SettingProxy.getInstance().getJobWorker().send(options)},unregisterUserAndDeviceT:function(callback){var options={methodName:"unregisterUserAndDeviceT",data:[],success:function(result){callback(result)},error:function(){}};SettingProxy.getInstance().getJobWorker().send(options)},setIdentityCredentialT:function(identityProvider,identifier,verifier,onSuccess){var options={methodName:"setIdentityCredentialT",data:[identityProvider,identifier,verifier],success:onSuccess,error:function(){}};SettingProxy.getInstance().getJobWorker().send(options)},clearIdentityCredentialT:function(onSuccess){var options={methodName:"clearIdentityCredentialT",data:[],success:onSuccess,error:function(){}};SettingProxy.getInstance().getJobWorker().send(options)},setSettingsAttribute:function(attr,value){var attrMap=[];attrMap[SettingsAttribute.ALL]=null,attrMap[SettingsAttribute.NOTIFICATION_ENABLE]="notificationEnable",attrMap[SettingsAttribute.NOTIFICATION_MUTE_EXPIRATION]="notificationMuteExpiration",attrMap[SettingsAttribute.NOTIFICATION_NEW_MESSAGE]="notificationNewMessage",attrMap[SettingsAttribute.NOTIFICATION_GROUP_INVITATION]="notificationGroupInvitation",attrMap[SettingsAttribute.NOTIFICATION_SHOW_MESSAGE]="notificationShowMessage",attrMap[SettingsAttribute.NOTIFICATION_SOUND_MESSAGE]="notificationSoundMessage",attrMap[SettingsAttribute.NOTIFICATION_SOUND_GROUP]="notificationSoundGroup",attrMap[SettingsAttribute.NOTIFICATION_DISABLED_WITH_SUB]="notificationDisabledWithSub",attrMap[SettingsAttribute.PRIVACY_SYNC_CONTACTS]="privacySyncContacts",attrMap[SettingsAttribute.PRIVACY_SEARCH_BY_PHONE_NUMBER]="privacySearchByPhoneNumber",attrMap[SettingsAttribute.PRIVACY_SEARCH_BY_USERID]="privacySearchByUserid",attrMap[SettingsAttribute.PRIVACY_SEARCH_BY_EMAIL]="privacySearchByEmail",attrMap[SettingsAttribute.PRIVACY_ALLOW_SECONDARY_DEVICE_LOGIN]="privacyAllowSecondaryDeviceLogin",attrMap[SettingsAttribute.PRIVACY_PROFILE_IMAGE_POST_TO_MYHOME]="privacyProfileImagePostToMyhome",attrMap[SettingsAttribute.PRIVACY_RECV_MESSAGES_FROM_NOT_FRIEND]="privacyReceiveMessagesFromNotFriend",attrMap[SettingsAttribute.CONTACT_MY_TICKET]="contactMyTicket",attrMap[SettingsAttribute.CUSTOM_MODE]="customModes",attrMap[SettingsAttribute.IDENTITY_PROVIDER]="identityProvider",attrMap[SettingsAttribute.IDENTITY_IDENTIFIER]="identityIdentifier",attrMap[SettingsAttribute.SNS_ACCOUNT]="snsAccounts",attrMap[SettingsAttribute.PHONE_REGISTRATION]="phoneRegistration",attrMap[SettingsAttribute.PREFERENCE_LOCALE]="prferenceLocale",attrMap[SettingsAttribute.EMAIL_CONFIRMATION_STATUS]="emailConfirmationStatus";var attributeNumber=SettingsAttribute[attr],property=attrMap[attributeNumber];if(!property)throw"No such attribute in Settings : "+attr;this[property]=value},updateSettingsAttributeT:function(key,value,onSuccess){var options={methodName:"updateSettingsAttributeT",data:[SettingsAttribute[key],value+""],success:onSuccess,error:function(){}};SettingProxy.getInstance().getJobWorker().send(options)},removeAll:function(){this.initProperty()},updateNotificationTokenT:function(endPoint,onSuccess){var options={methodName:"updateNotificationTokenT",data:[endPoint],success:onSuccess};SettingProxy.getInstance().getJobWorker().send(options)},updateMuteExpiration:function(muteSetting,callback){var now=new Date,muteExpirationTime=new Date,muteExpirationTimeStamp=-1;switch(muteSetting){case"1":muteExpirationTime.setHours(now.getHours()+1),muteExpirationTimeStamp=muteExpirationTime.getTime()+LineMain.SERVER_TIME_OFFSET;break;case"2":muteExpirationTime=new Date(muteExpirationTime.getFullYear(),muteExpirationTime.getMonth(),muteExpirationTime.getDate()+1,8),muteExpirationTimeStamp=muteExpirationTime.getTime()+LineMain.SERVER_TIME_OFFSET;break;default:muteExpirationTimeStamp=muteSetting}var durationTimestamp=muteExpirationTimeStamp-now.getTime();return SettingProxy.getInstance().updatePushMuteExpiration("NOTIFICATION_MUTE_EXPIRATION",parseInt(durationTimestamp,10),callback),muteExpirationTimeStamp},verifyQrcodeT:function(verifier,pinCode,customCallback){SettingProxy.getInstance().getJobWorker().send({methodName:"verifyQrcodeT",data:[verifier,pinCode],success:customCallback,error:function(){}})},getSessionsT:function(customCallback){SettingProxy.getInstance().getJobWorker().send({methodName:"getSessionsT",data:[],success:customCallback,error:function(){}})},logoutSessionT:function(tokenKey,customCallback){SettingProxy.getInstance().getJobWorker().send({methodName:"logoutSessionT",data:[tokenKey],success:customCallback,error:function(){}})},getLastOpRevisionT:function(customCallback){SettingProxy.getInstance().getJobWorker().send({methodName:"getLastOpRevisionT",data:[],success:customCallback,error:function(){}})},getServerTimeT:function(customCallback){var uniqueKey=LineConfig.getInstance().createUUID();SettingProxy.getInstance().getJobWorker().send({methodName:"getServerTimeT",data:[uniqueKey],uniquekey:uniqueKey,success:customCallback,error:function(){}})}},SettingBO.getInstance=function(){return null==SettingBO.instance&&(SettingBO.instance=new SettingBO),SettingBO.instance},SettingBO.instance=null;var AboutLineView=function(){return null!=AboutLineView.instance?AboutLineView.instance:void this.init()};AboutLineView.prototype={init:function(){this.assign(),this.setContents(SettingUI.TEMPLATE.SETTING_ABOUT_LINE_VIEW),this.setEvents()},setContents:function(url,options){var props=_.extend({version:LineConfig.APPLICATION_VERSION,phase:"REAL"!=LineConfig.PHASE?LineConfig.PHASE:""},options),tmpl=Mustache.render(TemplateManager.getInstance().get(url),props);this.settingWrapElement.empty().html(tmpl)},assign:function(){this.settingWrapElement=$("#_wrap_setting")},setEvents:function(){var viewElement=this.settingWrapElement.find("._about_line_view");viewElement.on(UIStructure.EVENT_CLICK,"li",$.proxy(function(e){var menuName=$(e.currentTarget).attr("data-name");this.moveTo(menuName)},this))},initTermsOfService:function(){var lang=Utility.getSystemLocale();this.setContents(SettingUI.TEMPLATE.SETTING_TERMS_OF_SERVICE_VIEW,{lang:lang})},initPrivacyPolicy:function(){var lang=Utility.getSystemLocale();this.setContents(SettingUI.TEMPLATE.SETTING_PRIVACY_POLICY_VIEW,{lang:lang})},initLegalNotices:function(){var lang=Utility.getSystemLocale();this.setContents(SettingUI.TEMPLATE.SETTING_LEGAL_NOTICES_VIEW,{lang:lang})},moveTo:function(listName){listName&&(Logger.log(listName),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE[listName]}),"SETTING_TERMS_OF_SERVICE"===listName?this.initTermsOfService():"SETTING_PRIVACY_POLICY"===listName?this.initPrivacyPolicy():"SETTING_LEGAL_NOTICES"===listName&&this.initLegalNotices(),SettingUI.getInstance().resize())
}},AboutLineView.getInstance=function(){return null==AboutLineView.instance&&(AboutLineView.instance=new AboutLineView),AboutLineView.instance},AboutLineView.instance=null;var AccountsView=function(){return null!=AccountsView.instance?AccountsView.instance:void this.init()};AccountsView.prototype={init:function(){this.assign(),this.setContents(),this.setEvents()},setContents:function(){var template=TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_ACCOUNTS_VIEW),data={isEmailAccountInitialized:SettingProxy.getInstance().getProp("emailConfirmationStatus")===EmailConfirmationStatus.DONE,phoneNumber:AuthInfoKeeper.getInstance().getPhoneNumber(),privacyAllowSecondaryDeviceLogin:SettingProxy.getInstance().getProp("privacyAllowSecondaryDeviceLogin")},screenHtml=Mustache.render(template,data);this.settingWrapElement.empty().html(screenHtml),this.accountWrapElement=this.settingWrapElement.find("._account_list")},assign:function(){this.settingWrapElement=$("#_wrap_setting")},setEvents:function(){this.accountWrapElement.on(UIStructure.EVENT_CLICK,"li",$.proxy(function(e){var listName=$(e.currentTarget).attr("data-name");listName&&("email_account"===listName?LineMain.getInstance().changeScreen("true"===$(e.currentTarget).attr("data-value")?{screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_EMAIL_ACCOUNTS}:{screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_REGISTER_EMAIL}):"other_device"===listName&&LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_OTHER_DEVICE}))}),this),this.accountWrapElement.on(UIStructure.EVENT_TOUCH,"._action_btn",$.proxy(function(e){if(!e.currentTarget)return!1;var actionBtn=$(e.currentTarget),actionName=actionBtn.attr("data-name");if(actionName)switch(actionName){case"ALLOW_OTHER_DEVICE":var privacyAllowSecondaryDeviceLogin="true"==actionBtn.attr("data-value")?!0:!1,toggleValue=!privacyAllowSecondaryDeviceLogin;actionBtn.attr("data-value",toggleValue).removeClass("mdMN13IsOn mdMN13IsOff").addClass(toggleValue?"mdMN13IsOn":"mdMN13IsOff"),this.changeAllowOtherDevice(toggleValue)}},this))},changeAllowOtherDevice:function(privacyAllowSecondaryDeviceLogin){DimmedUI.getInstance().open("",{},{isCenter:!0}),SettingProxy.getInstance().updateSettingsAttribute("PRIVACY_ALLOW_SECONDARY_DEVICE_LOGIN",privacyAllowSecondaryDeviceLogin,$.proxy(function(){privacyAllowSecondaryDeviceLogin?this.accountWrapElement.find("._wrap_other_device").removeClass("MdNonDisp"):this.accountWrapElement.find("._wrap_other_device").addClass("MdNonDisp"),DimmedUI.getInstance().close()},this))}},AccountsView.getInstance=function(){return null==AccountsView.instance&&(AccountsView.instance=new AccountsView),AccountsView.instance},AccountsView.instance=null;var ChatsView=function(){return null!=ChatsView.instance?ChatsView.instance:void this.init()};ChatsView.prototype={init:function(){this.assign(),this.setContents(),this.setEvents()},setContents:function(){var tmpl=Mustache.render(TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_CHATS_VIEW),SettingProxy.getInstance().getSettings());this.settingWrapElement.empty().html(tmpl),this.chatWrapElement=this.settingWrapElement.find("._chats_container")},assign:function(){this.settingWrapElement=$("#_wrap_setting")},setEvents:function(){this.chatWrapElement.on(UIStructure.EVENT_CLICK,"li",$.proxy(function(e){var listName=$(e.currentTarget).attr("data-name");listName&&(""===listName||"clear_chat_history"===listName&&confirm($.i18n.prop("WILL_YOU_CLEAR_CHAT_HISTORY"))&&ChatProxy.getInstance().deleteAllChatHistory())},this)),this.chatWrapElement.on(UIStructure.EVENT_CLICK,"._action_btn",$.proxy(function(e){var prop=$(e.currentTarget).attr("data-name"),value=$(e.currentTarget).attr("data-value");value="true"===value?!1:!0,$(e.currentTarget).attr("data-value",value).removeClass(value?"mdMN13IsOff":"mdMN13IsOn").addClass(value?"mdMN13IsOn":"mdMN13IsOff"),"chatAutoResend"===prop&&SettingProxy.getInstance().setSettings({chatAutoResend:value})},this))}},ChatsView.getInstance=function(){return null==ChatsView.instance&&(ChatsView.instance=new ChatsView),ChatsView.instance},ChatsView.instance=null;var EmailAccountView=function(){return null!=EmailAccountView.instance?EmailAccountView.instance:(_.extend(this,new RegisterEmailUI),void(this.wrapElement=$("#_wrap_setting")))};EmailAccountView.prototype={PASSWORD_MIN_LENGTH:6,initAccountView:function(){this.setContent(SettingUI.TEMPLATE.SETTING_EMAIL_CHANGE_VIEW,{email:SettingProxy.getInstance().getSettings().identityIdentifier}),this.assignAccountView(),this.setEventAccountView()},assignAccountView:function(){this.changeEmailContainer=this.wrapElement.find("._change_email_container")},setEventAccountView:function(){this.changeEmailContainer.on(UIStructure.EVENT_CLICK,"li",function(e){var listName=$(e.currentTarget).attr("data-name");"change_email"===listName?LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_EMAIL_CHANGE_VERIFY}):"change_password"===listName?LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_EMAIL_CHANGE_PASSWORD}):"cancel_registration"===listName&&LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_EMAIL_CANCEL_REGISTRATION})})},initEmailRegister:function(){TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_EMAIL_INPUT_PINCODE_VIEW),this.setContent(SettingUI.TEMPLATE.SETTING_EMAIL_REGISTER_VIEW,{}),this.setOnConfirm(function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_REGISTER_EMAIL_INPUT_PINCODE})}),this.assignEmailRegister(),this.setEventEmailRegister()},initChangeEmail:function(){this.setContent(SettingUI.TEMPLATE.SETTING_EMAIL_CHANGE_ADDRESS_VIEW,{email:SettingProxy.getInstance().getSettings().identityIdentifier}),this.setOnConfirm(function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_REGISTER_EMAIL_INPUT_PINCODE})}),this.setChangeEmailElements(),this.setChangeEmailEvent()},initEmailChangeSuccess:function(){this.setContent(SettingUI.TEMPLATE.SETTING_EMAIL_CHANGE_SUCCESS_VIEW,{email:SettingProxy.getInstance().getSettings().identityIdentifier}),this.wrapElement.find("._email_change_success").on(UIStructure.EVENT_CLICK,"._confirm_btn",function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_EMAIL_ACCOUNTS})})},initInputPinCode:function(){TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_EMAIL_CHANGE_SUCCESS_VIEW),this.setOnConfirm(function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_EMAIL_CHANGE_SUCCESS})}),this.setContent(SettingUI.TEMPLATE.SETTING_EMAIL_INPUT_PINCODE_VIEW,{}),this.setInputPinCodeElements(),this.setInputPinCodeEvent()},initChangePassword:function(){this.setContent(SettingUI.TEMPLATE.SETTING_EMAIL_CHANGE_PASSWORD_VIEW,{}),this.setChangePasswordElements(),this.setChangePasswordEvent()},initVerifyChangeEmailRegistration:function(){this.setContent(SettingUI.TEMPLATE.SETTING_EMAIL_IDENTIFICATION_VIEW,{}),this.setCancelEmailRegistrationElements(),this.setCancelEmailRegistrationEvent(),this.verifyAfterCallback=function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_EMAIL_CHANGE_EMAIL})}},initCancelEmailRegistration:function(){this.setContent(SettingUI.TEMPLATE.SETTING_EMAIL_IDENTIFICATION_VIEW,{}),this.setCancelEmailRegistrationElements(),this.setCancelEmailRegistrationEvent(),this.verifyAfterCallback=function(){ConfirmUI.getInstance().open({message:$.i18n.prop("EMAIL_UNREGISTRATION_WARNING_TEXT"),button:{left:{label:$.i18n.prop("CANCEL"),callback:function(){}},right:{label:$.i18n.prop("CONFIRM"),callback:$.proxy(this.clearIdentity,this)}}})}}},EmailAccountView.getInstance=function(){return null==EmailAccountView.instance&&(EmailAccountView.instance=new EmailAccountView),EmailAccountView.instance},EmailAccountView.instance=null;var FriendsView=function(){return null!=FriendsView.instance?FriendsView.instance:void _.extend(this,UIStructure)};FriendsView.prototype={initFriends:function(){this.assign(),this.setContents(),this.setEvents()},initInviteFriends:function(){this.assign(),this.setContentsInviteFriends(),this.setEventsInviteFriends()},initBlockList:function(){this.assignBlockList(),this.setContentsToBlockList(),this.setBlockListEvents()},initHiddenList:function(){this.assignHideList(),this.setContentsToHideList(),this.setHideListEvents()},assign:function(){this.settingWrapElement=$("#_wrap_setting"),this.wrapContextMenu=$("#_wrap_context_menu")},assignHideList:function(){this.settingWrapElement.empty().html(TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_HIDDEN_LIST_VIEW)),this.wrapHideList=this.settingWrapElement.find("._hidden_list")},setContentsInviteFriends:function(){var settings=SettingProxy.getInstance().getSettings(),lastSyncTime=SettingProxy.getInstance().getLastAutoSyncTime()||ContactProxy.getInstance().getLastSyncTime();settings.syncDate=null==lastSyncTime?"":(new DateFormatUtil).getSyncTimeDateFormat(parseInt(lastSyncTime,10));var contentHtml=Mustache.render(TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_INVITE_FRIENDS_VIEW),settings);this.settingWrapElement.empty().html(contentHtml),this.InviteFriendsWrap=this.settingWrapElement.find("._invite_friends_list")},setContentsToHideList:function(){var hideList=ContactProxy.getInstance().getHideList(),listItemTemplate=TemplateManager.getInstance().get(SettingUI.TEMPLATE.HIDE_LIST_ITEM),tmpl=[];hideList.length>0&&_.each(hideList,$.proxy(function(val){tmpl.push(Mustache.render(listItemTemplate,val))},this)),this.wrapHideList.html(tmpl.join("")),Utility.lazyLoadImage(this.wrapHideList.find("img")),Logger.log("Hidden List",hideList)},setHideListEvents:function(){this.wrapHideList.on(this.EVENT_CLICK,"._btn_edit",$.proxy(function(e){var mid=$(e.target).attr("data-mid");this.showHidenUserContextMenu(mid)},this))},showHidenUserContextMenu:function(mid){var contact=ContactProxy.getInstance().getContactFromLocal(mid),blockContextMenuTemplate=TemplateManager.getInstance().get(SettingUI.TEMPLATE.HIDE_LIST_CONTEXT_MENU),html=Mustache.render(blockContextMenuTemplate,contact);this.wrapContextMenu.empty().html(html),this.wrapContextMenu.removeClass("MdNonDisp")},onClickHideContextMenu:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),actionInfo=currentTarget.attr("data-action").split("-"),action=actionInfo[0],mid=actionInfo[1];switch(action){case"unhide":this.onClickUnhide(mid);break;case"delete":var contact=ContactProxy.getInstance().getContactFromLocal(mid);confirm($.i18n.prop("WILL_YOU_DELETE_USERS",ContactProxy.getInstance().getPrintName(contact)))&&(DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().deleteContact(mid,$.proxy(function(){this.wrapHideList.find("li[data-mid="+mid+"]").addClass("MdNonDisp"),this.notifyUpdatedHideList(),DimmedUI.getInstance().close()},this)));break;case"cancel":this.wrapContextMenu.addClass("MdNonDisp")}this.wrapContextMenu.addClass("MdNonDisp")},onClickUnhide:function(mid){DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().unHideContact(mid,$.proxy(function(){this.wrapHideList.find("li[data-mid="+mid+"]").addClass("MdNonDisp"),this.notifyUpdatedHideList(),DimmedUI.getInstance().close()},this))},notifyUpdatedHideList:function(){var hideList=ContactProxy.getInstance().getHideList();if(0===hideList.length){var tmpl=[];this.wrapHideList.html(tmpl.join(""))}},setContents:function(){this.settingWrapElement.empty().html(TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_FRIENDS_VIEW)),this.friendsWrap=this.settingWrapElement.find("._friends_list")},setEvents:function(){this.friendsWrap.on(this.EVENT_CLICK,"li",function(){"invite_friends"===$(this).attr("data-name")?LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_INVITE_FRIENDS}):"hidden_list"===$(this).attr("data-name")?LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_HIDE_LIST}):"block_list"===$(this).attr("data-name")&&LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE.SETTING_BLOCK_LIST})}),this.wrapContextMenu.off(this.EVENT_CLICK,".wrap_block_context_menu button").on(this.EVENT_CLICK,".wrap_block_context_menu button",$.proxy(this.onClickBlockContextMenu,this)),this.wrapContextMenu.off(this.EVENT_CLICK,".wrap_hide_context_menu button").on(this.EVENT_CLICK,".wrap_hide_context_menu button",$.proxy(this.onClickHideContextMenu,this))},setEventsInviteFriends:function(){var self=this;this.InviteFriendsWrap.on(this.EVENT_CLICK,"._action_btn",function(e){var listName=$(e.currentTarget).attr("data-name");if(Logger.log(listName),"auto_add_friends"===listName){if(SettingProxy.getInstance().getProp("privacySyncContacts"))value=!1;else{if(!self.confirmAutoSync())return!1;value=!0}DimmedUI.getInstance().open("",{},{isCenter:!0}),SettingProxy.getInstance().updateSettingsAttribute("PRIVACY_SYNC_CONTACTS",value,function(){DimmedUI.getInstance().close(),value?$(e.currentTarget).removeClass("mdMN13IsOff").addClass("mdMN13IsOn"):$(e.currentTarget).removeClass("mdMN13IsOn").addClass("mdMN13IsOff")})}else if("sync_contacts"===listName){if(!self.confirmAutoSync())return!1;$(e.currentTarget).html("LOADING..."),DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().syncContactsForceAll($.proxy(function(){$(e.currentTarget).html("sync");var lastSyncTime=ContactProxy.getInstance().getLastSyncTime(),lastSyncDate=(new DateFormatUtil).getSyncTimeDateFormat(lastSyncTime);self.InviteFriendsWrap.find("._last_sync_date").html(lastSyncDate),DimmedUI.getInstance().close()},this))}else"allow_other_to_add"===listName&&(value=SettingProxy.getInstance().getProp("privacySearchByPhoneNumber")?!1:!0,DimmedUI.getInstance().open("",{},{isCenter:!0}),SettingProxy.getInstance().updateSettingsAttribute("PRIVACY_SEARCH_BY_PHONE_NUMBER",value,function(){DimmedUI.getInstance().close(),value===!0?$(e.currentTarget).removeClass("mdMN13IsOff").addClass("mdMN13IsOn"):$(e.currentTarget).removeClass("mdMN13IsOn").addClass("mdMN13IsOff")}))})},setBlockListEvents:function(){this.wrapBlockList.on(this.EVENT_CLICK,"._btn_edit",$.proxy(function(e){var mid=$(e.target).attr("data-mid");this.showBlockUserContextMenu(mid)},this))},showBlockUserContextMenu:function(mid){var contact=ContactProxy.getInstance().getContactFromLocal(mid),blockContextMenuTemplate=TemplateManager.getInstance().get(SettingUI.TEMPLATE.BLOCK_LIST_CONTEXT_MENU),html=Mustache.render(blockContextMenuTemplate,contact);this.wrapContextMenu.html(html),this.wrapContextMenu.removeClass("MdNonDisp")},onClickBlockContextMenu:function(event){if(!event.currentTarget)return!1;var currentTarget=$(event.currentTarget),actionInfo=currentTarget.attr("data-action").split("-"),action=actionInfo[0],mid=actionInfo[1];switch(action){case"unblock":this.onClickUnblock(mid);break;case"delete":var contact=ContactProxy.getInstance().getContactFromLocal(mid);confirm($.i18n.prop("WILL_YOU_DELETE_USERS",ContactProxy.getInstance().getPrintName(contact)))&&(DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().deleteContact(mid,$.proxy(function(){this.wrapBlockList.find("li[data-mid="+mid+"]").addClass("MdNonDisp"),this.notifyUpdatedBlockList(),DimmedUI.getInstance().close()},this)));break;case"cancel":this.wrapContextMenu.addClass("MdNonDisp")}this.wrapContextMenu.addClass("MdNonDisp")},onClickUnblock:function(mid){DimmedUI.getInstance().open("",{},{isCenter:!0}),ContactProxy.getInstance().unBlockContact(mid,$.proxy(function(){this.wrapBlockList.find("li[data-mid="+mid+"]").addClass("MdNonDisp"),this.notifyUpdatedBlockList(),DimmedUI.getInstance().close()},this))},notifyUpdatedBlockList:function(){var blockedList=ContactProxy.getInstance().getBlockedList();if(0===blockedList.length){var tmpl=[];this.wrapBlockList.html(tmpl.join(""))}},assignBlockList:function(){this.settingWrapElement.html(TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_BLOCK_LIST_VIEW)),this.wrapBlockList=this.settingWrapElement.find("._block_list")},getBlockListItemTemplate:function(){return TemplateManager.getInstance().get(SettingUI.TEMPLATE.BLOCK_LIST_ITEM)},setContentsToBlockList:function(){var blockedList=ContactProxy.getInstance().getBlockedList(),listItemTemplate=this.getBlockListItemTemplate(),tmpl=[];blockedList.length>0&&_.each(blockedList,$.proxy(function(val){tmpl.push(Mustache.render(listItemTemplate,val))},this)),this.wrapBlockList.html(tmpl.join("")),Utility.lazyLoadImage(this.wrapBlockList.find("img")),Logger.log("Blocked List",blockedList)},confirmAutoSync:function(){if(SettingProxy.getInstance().getSyncConfirm())return!0;var isConfirm=confirm($.i18n.prop("AUTO_ADD_FRIEND_CONFIRM_TEXT"));return isConfirm&&SettingProxy.getInstance().setSyncConfirm(),isConfirm}},FriendsView.getInstance=function(){return null==FriendsView.instance&&(FriendsView.instance=new FriendsView),FriendsView.instance},FriendsView.instance=null;var HelpView=function(){return null!=HelpView.instance?HelpView.instance:void this.init()};HelpView.prototype={init:function(){this.assign(),this.setContents(),this.setEvents()},setContents:function(){var lang=Utility.getSystemLocale(),serverInfo=ServerInfo.getInstance();serverInfo.setting("help");var tmpl=Mustache.render(TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_HELP_VIEW),{domain:serverInfo.getHost(),lang:lang});this.settingWrapElement.empty().html(tmpl),this.helpWrapElement=this.settingWrapElement.find("._help_view")},assign:function(){this.settingWrapElement=$("#_wrap_setting")},setEvents:function(){}},HelpView.getInstance=function(){return null==HelpView.instance&&(HelpView.instance=new HelpView),HelpView.instance},HelpView.instance=null;var NotificationsView=function(){return null!=NotificationsView.instance?NotificationsView.instance:void this.init()};NotificationsView.prototype={init:function(){this.assign(),this.setContents(),this.setEvents()},assign:function(){this.settingWrapElement=$("#_wrap_setting")},setContents:function(){var settings=SettingProxy.getInstance().getSettings(),tmpl=Mustache.render(TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_NOTIFICATIONS_VIEW),settings);this.settingWrapElement.empty().html(tmpl),this.notificationWrapElement=$("._notification_list"),this.muteSelectBox=this.notificationWrapElement.find("._mute_select"),this.muteSelectLabel=this.notificationWrapElement.find("._mute_label");var muteSetting=SettingProxy.getInstance().getMuteSetting();this.updateMuteExpiration(muteSetting,SettingProxy.getInstance().getProp("notificationMuteExpiration"))},setEvents:function(){this.notificationWrapElement.on(UIStructure.EVENT_TOUCH,"._action_btn",$.proxy(function(e){var prop=$(e.currentTarget).attr("data-name"),value=$(e.currentTarget).attr("data-value");value="true"===value?!1:!0,DimmedUI.getInstance().open("",{},{isCenter:!0}),SettingProxy.getInstance().updateSettingsAttribute(prop,value,$.proxy(function(){DimmedUI.getInstance().close(),"NOTIFICATION_ENABLE"===prop&&(value===!0?this.notificationWrapElement.find("._hide_groups").removeClass("MdNonDisp"):this.notificationWrapElement.find("._hide_groups").addClass("MdNonDisp")),$(e.currentTarget).attr("data-value",value).removeClass(value?"mdMN13IsOff":"mdMN13IsOn").addClass(value?"mdMN13IsOn":"mdMN13IsOff")},this))},this)),this.muteSelectBox.on("change",$.proxy(this.onChangeMuteSelect,this))},onChangeMuteSelect:function(e){var selectBox=$(e.currentTarget),muteSetting=selectBox.val();DimmedUI.getInstance().open("",{},{isCenter:!0}),SettingProxy.getInstance().changeMuteExpiration(muteSetting,function(){DimmedUI.getInstance().close()})},updateMuteExpiration:function(muteSetting,timestamp){this.muteSelectBox.find("option").removeAttr("selected"),this.muteSelectBox.find("option[value='"+muteSetting+"']").attr("selected",!0),this.muteSelectLabel.text(-1!=muteSetting?$.i18n.prop("MUTE_SETTINGS_UNTIL",DateFormatUtil.getInstance().getDate(new Date(timestamp),DateStyle.BASIC)):""),SettingProxy.getInstance().checkPushMuteExpire()}},NotificationsView.getInstance=function(){return null==NotificationsView.instance&&(NotificationsView.instance=new NotificationsView),NotificationsView.instance},NotificationsView.instance=null;var OtherDeviceView=function(){return null!=OtherDeviceView.instance?OtherDeviceView.instance:void _.extend(this,UIStructure)};OtherDeviceView.prototype={init:function(){this.assign(),this.setContents()},assign:function(){this.settingWrapElement=$("#_wrap_setting")},setContents:function(){DimmedUI.getInstance().open("",{},{isCenter:!0}),SettingProxy.getInstance().getSessions($.proxy(function(sessions){var template=TemplateManager.getInstance().get(SettingUI.TEMPLATE.OTHER_DEVICE_TEMPLATE),html=Mustache.render(template,{devices:sessions});this.settingWrapElement.html(html),this.rePosition(),this.settingWrapElement.removeClass("MdNonDisp"),this.setEvents(),DimmedUI.getInstance().close()},this))},setEvents:function(){this.btnLogout=this.settingWrapElement.find("._btn_logout_session"),this.btnLogout.on(this.EVENT_CLICK,$.proxy(this.logoutHandler,this))},logoutHandler:function(){var deviceList=this.settingWrapElement.find("li[data-session-id]");_.each(deviceList,$.proxy(function(li){var tokenKey=$(li).attr("data-session-id");this.logoutSession(tokenKey)},this))},logoutSession:function(tokenKey){SettingProxy.getInstance().logoutSession(tokenKey,function(){LineMain.getInstance().moveBack()})},rePosition:function(){var wrapNoResult=this.settingWrapElement.find("#_no_result"),scrollAreaHeight=LineMain.WINDOW_HEIGHT-LineMain.HEADER_SIZE,topMargin=scrollAreaHeight/2-wrapNoResult.height()/2;this.settingWrapElement.find("#_no_result").css({top:topMargin,position:"relative"})}},OtherDeviceView.getInstance=function(){return null==OtherDeviceView.instance&&(OtherDeviceView.instance=new OtherDeviceView),OtherDeviceView.instance},OtherDeviceView.instance=null;var PrivacyView=function(){return null!=PrivacyView.instance?PrivacyView.instance:void this.init()};PrivacyView.prototype={init:function(){this.assign(),this.setContents(),this.setEvents()},setContents:function(){var profile=ProfileProxy.getInstance().getProfile(),tmpl=Mustache.render(TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_PRIVACY_VIEW),{allowSearchByUserid:profile.allowSearchByUserid});this.settingWrapElement.empty().html(tmpl),this.privacyWrap=this.settingWrapElement.find("._privacy")},assign:function(){this.settingWrapElement=$("#_wrap_setting")},onChangePublicUserIdCheckBox:function(){var flag=!1;"checked"===$(this).attr("checked")&&(flag=!0),SettingProxy.getInstance().setPublicUserId(flag)},setEvents:function(){this.privacyWrap.on(UIStructure.EVENT_CLICK,"._clear_chat_history_btn",this.onClickClearChatHistory).on("click change","._public_user_id_checkbox",this.onChangePublicUserIdCheckBox),this.privacyWrap.on(UIStructure.EVENT_CLICK,"._action_btn",$.proxy(function(e){var prop=$(e.currentTarget).attr("data-name"),value=$(e.currentTarget).attr("data-value");value="true"===value?!1:!0,DimmedUI.getInstance().open("",{},{isCenter:!0}),ProfileProxy.getInstance().updateProfileAttribute(prop,value,function(){DimmedUI.getInstance().close(),$(e.currentTarget).attr("data-value",value).removeClass(value?"mdMN13IsOff":"mdMN13IsOn").addClass(value?"mdMN13IsOn":"mdMN13IsOff")})},this))},onClickClearChatHistory:function(){confirm($.i18n.prop("WILL_YOU_CLEAR_CHAT_HISTORY"))&&ChatProxy.getInstance().deleteAllChatHistory()}},PrivacyView.getInstance=function(){return null==PrivacyView.instance&&(PrivacyView.instance=new PrivacyView),PrivacyView.instance},PrivacyView.instance=null;var SettingListView=function(){return null!=SettingListView.instance?SettingListView.instance:(_.extend(this,UIStructure),SettingPersistentStore.getInstance().getEventManager().regist($.proxy(this.init,this)),void ProfileProxy.getInstance().getEventManager().regist($.proxy(this.init,this)))};SettingListView.prototype={init:function(){LineMain.getInstance().isSubScreen(LineMain.SUB_SCREEN_TYPE.SETTING_LIST)&&(this.assign(),this.setContents(),this.setEvents())},setContents:function(){var settings=SettingProxy.getInstance().getSettings(),profile=ProfileProxy.getInstance().getProfile();settings.thumbnail=Utility.combineSettingProfileURL(profile,56);var contentHtml=Mustache.render(TemplateManager.getInstance().get(SettingUI.TEMPLATE.SETTING_LIST_VIEW),settings);this.settingWrapElement.empty().html(contentHtml),Utility.lazyLoadImage(this.settingWrapElement.find("img")),this.settingListWrap=this.settingWrapElement.find("._setting_list")},assign:function(){this.settingWrapElement=$("#_wrap_setting")},toggleNotification:function(target){var value=$(target).attr("data-value");"true"===value?(value=!1,$(target).removeClass("mdMN13IsOn").addClass("mdMN13IsOff")):(value=!0,$(target).removeClass("mdMN13IsOff").addClass("mdMN13IsOn")),$(target).attr("data-value",value),SettingProxy.getInstance().updateSettingsAttribute("NOTIFICATION_ENABLE",value)},setEvents:function(){this.settingListWrap.on(this.EVENT_CLICK,"._action_btn",$.proxy(function(e){e.stopImmediatePropagation(),e.stopPropagation(),e.cancelBubble=!0;var listName=$(e.currentTarget).attr("data-name");return"toggle_notification"===listName?(this.toggleNotification(e.currentTarget),!1):void 0},this)).on(this.EVENT_CLICK,"li",function(){var listName=$(this).attr("data-name");Logger.log("######>>> Setting List Menu Changed ####  :: "+listName),"SETTING_ACCOUNTS"===listName?(SettingProxy.getInstance().updateToLocalSettings(function(){}),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE[listName]})):LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.SETTING,subScreen:LineMain.SUB_SCREEN_TYPE[listName]})})}},SettingListView.getInstance=function(){return null==SettingListView.instance&&(SettingListView.instance=new SettingListView),SettingListView.instance},SettingListView.instance=null;var StickerLayerUI=function(){return null!=StickerLayerUI.instance?StickerLayerUI.instance:(_.extend(this,UIStructure),this.assign(),this.setEvent(),void this.combineStickerLayer())};StickerLayerUI.prototype={assign:function(){this.stickerProxy=StickerProxy.getInstance(),this.prevSelectedLI=null,this.elStickerLayer=$("._sticker_layer"),this.elStickerHeaderUL=$("._sticker_layer_header"),this.elStickerBodyUL=$("._sticker_layer_body"),this.elCurtainLayer=$("._curtainLayer")},setEvent:function(){this.elStickerHeaderUL.on(this.EVENT_CLICK,$.proxy(this.onClickHeader,this)),this.elStickerBodyUL.on(this.EVENT_CLICK,$.proxy(this.onClickSticker,this))},toggleStickerLayer:function(){this.elCurtainLayer.toggleClass("MdNonDisp"),this.elStickerLayer.toggleClass("MdNonDisp")},initStickerLayer:function(){this.combineStickerLayer()},combineStickerLayer:function(){var selectedTabPkgId=this.stickerProxy.getSelectedTabPkgId();this.stickerProxy.getHistorySize()>0&&(selectedTabPkgId=0),this.makeStickerHeader(selectedTabPkgId),this.makeStickerList(selectedTabPkgId);var LI=this.elStickerHeaderUL.find("li[data-sticker-pkgId='"+selectedTabPkgId+"']");LI.find("img").trigger(this.EVENT_CLICK),this.prevSelectedLI=LI},makeStickerHeader:function(){var itemTmpl=TemplateManager.getInstance().get(StickerLayerUI.STICKER_HEADER_ITEM_TEMPLATE),pkgIdList=this.stickerProxy.getPkgIdList(),tmpList=[];tmpList.push(Mustache.render(itemTmpl,{tabImage:this.stickerProxy.getStickerTabOffImage(0),pkgId:0}));for(var i=0;i<pkgIdList.length;i++){var imgPath=this.stickerProxy.getStickerTabOffImage(pkgIdList[i]),renderObj={tabImage:imgPath,pkgId:pkgIdList[i]};tmpList.push(Mustache.render(itemTmpl,renderObj))}this.elStickerHeaderUL.html(tmpList.join(""))},makeStickerList:function(pkgId){pkgId||(pkgId=1);var itemTmpl=TemplateManager.getInstance().get(StickerLayerUI.STICKER_KEY_ITEM_TEMPLATE),tmpList=[];if(0==pkgId)for(var historyList=this.stickerProxy.getHistory(),i=historyList.length-1;i>=0;i--){var renderObj={keyUrl:this.stickerProxy.getStickerImage(historyList[i].pkgId,historyList[i].stkId),stickerId:historyList[i].stkId,pkgId:historyList[i].pkgId};tmpList.push(Mustache.render(itemTmpl,renderObj))}else for(var stickerList=this.stickerProxy.getStickerList(pkgId),i=0;i<stickerList.length;i++){var renderObj={keyUrl:this.stickerProxy.getStickerImage(pkgId,stickerList[i].id),stickerId:stickerList[i].id};tmpList.push(Mustache.render(itemTmpl,renderObj))}this.elStickerBodyUL.html(tmpList.join(""))},onClickHeader:function(event){if(!event.currentTarget)return!1;var originTarget=$(event.originalTarget||event.target),targetLI=originTarget.parents("li"),pkgId=targetLI.attr("data-sticker-pkgId");if(0==!!pkgId)return!1;if(null!=this.prevSelectedLI){this.prevSelectedLI.toggleClass("ExSelected");var preOriginTarget=this.prevSelectedLI.find("img");preOriginTarget.attr("src",this.stickerProxy.getStickerTabOffImage(this.prevSelectedLI.attr("data-sticker-pkgId")))}this.prevSelectedLI=targetLI,this.stickerProxy.setSelectedTabPkgId(pkgId),targetLI.toggleClass("ExSelected"),originTarget.attr("src",this.stickerProxy.getStickerTabOnImage(pkgId)),this.makeStickerList(pkgId)},onClickSticker:function(event){if(!event.currentTarget)return!1;var originTarget=$(event.originalTarget||event.target),targetLI=originTarget.parents("li");if(0!=!!targetLI[0]){var stickerId=targetLI.attr("data-sticker-id"),stickerVer=this.stickerProxy.getLocalStickerPkgVer(),stickerPkgId=this.stickerProxy.getSelectedTabPkgId();0==this.stickerProxy.getSelectedTabPkgId()?stickerPkgId=targetLI.attr("data-sticker-pkgId"):this.stickerProxy.addHistory({pkgId:stickerPkgId,stkId:stickerId,stkVer:stickerVer}),ChatUI.getInstance().onSendSticker(stickerPkgId,stickerId,stickerVer)}}},StickerLayerUI.getInstance=function(){return null==StickerLayerUI.instance&&(StickerLayerUI.instance=new StickerLayerUI),StickerLayerUI.instance},StickerLayerUI.instance=null,StickerLayerUI.STICKER_HEADER_ITEM_TEMPLATE=BASE_DEFAULT+"src/proxy/sticker/ui/template/StickerHeaderItemTemplate.mustache",StickerLayerUI.STICKER_KEY_ITEM_TEMPLATE=BASE_DEFAULT+"src/proxy/sticker/ui/template/StickerItemTemplate.mustache";var StickerProxy=function(){return null!=StickerProxy.instance?StickerProxy.instance:(this.persistentStore=StickerPersistentArrayStore.getInstance(),this.localStickerPkgVer=100,this.localStickerPkgIdList=[1,2,3,4],this.localStickerList=[],this.selectedTabPkgId=1,this.stickerHistoryMaxSize=80,this.stickerPath="/res/sticker/",void this.prepareLocalStickerList())};StickerProxy.prototype={prepareLocalStickerList:function(){for(var i=0;i<this.localStickerPkgIdList.length;i++){var stickerData=ResourceLoader.loadFile(this.stickerPath+this.localStickerPkgIdList[i]+"/productInfo.meta");this.localStickerList.push(JSON.parse(stickerData))}},getLocalStickerPkgVer:function(){return this.localStickerPkgVer},getStickerTabOnImage:function(pkgId){var path=null;return path=0==pkgId?"/res/img/ico_history_on.png":this.stickerPath+pkgId+"/"+pkgId+"_tab_on.png"},getStickerTabOffImage:function(pkgId){var path=null;return path=0==pkgId?"/res/img/ico_history_off.png":this.stickerPath+pkgId+"/"+pkgId+"_tab_off.png"},getPkgIdList:function(){return this.localStickerPkgIdList},getStickerList:function(pkgId){for(var stickerList=[],i=0;i<this.localStickerList.length;i++){var stickerInfo=this.localStickerList[i];stickerInfo.packageId==pkgId&&(stickerList=stickerInfo.stickers)}return stickerList.sort(function(obj1,obj2){var a=obj1.id,b=obj2.id;
return b>a?-1:a>b?1:0}),stickerList},getStickerImage:function(pkgId,stkId){return this.stickerPath+pkgId+"/"+stkId+"_key.png"},addHistory:function(stickerInfo){var historyList=this.getHistory(),flag=!1;_.each(historyList,function(el){el.stkId==stickerInfo.stkId&&(flag=!0)}),this.getStickerHistoryMaxSize()<=historyList.length&&this.persistentStore.shift(),0==flag&&this.persistentStore.push(stickerInfo)},getHistory:function(){return this.persistentStore.get()},getHistorySize:function(){return this.persistentStore.get().length},setSelectedTabPkgId:function(pkgId){this.selectedTabPkgId=pkgId},getSelectedTabPkgId:function(){return this.selectedTabPkgId},getStickerHistoryMaxSize:function(){return this.stickerHistoryMaxSize}},StickerProxy.getInstance=function(){return null==StickerProxy.instance&&(StickerProxy.instance=new StickerProxy),StickerProxy.instance},StickerProxy.instance=null;var ProductBO=function(){},ScreenManager=function(){return null!=ScreenManager.instance?ScreenManager.instance:(this.eventManager=new UIEventManager,this.headerView=HeaderView.getInstance(),this.prevScreenInfo={},this.screenInfo={},this.stack=[],this.stackLimit=100,this.contentLayers=null,this.loadStackFromLocalStorage(),this.unCacheList=[LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE,LineMain.SUB_SCREEN_TYPE.FRIEND_LIST,LineMain.SUB_SCREEN_TYPE.CHAT_LIST,LineMain.SUB_SCREEN_TYPE.SETTING_LIST,LineMain.SUB_SCREEN_TYPE.ADD_CONTACT_LIST],this.assign(),void this.setEvent())};ScreenManager.prototype={loadStackFromLocalStorage:function(){this.stack=JSON.parse(PersistentStore.getInstance().get("SM_screenStack"))||[]},getStack:function(){return this.stack},setStack:function(stack){this.stack=stack},getEventManager:function(){return this.eventManager},assign:function(){this.contentLayers=$("#_wrap_layers").children()},setEvent:function(){$(window).on("resize",$.proxy(function(){LineMain.WINDOW_HEIGHT=$(window).height(),$("#_wrap_splash").css(LineMain.WINDOW_HEIGHT+"px"),this.getEventManager().broadCast({type:UIEventManager.EVENT_RESIZE})},this))},changeScreen:function(screenInfo,params){return screenInfo.screen&&screenInfo.subScreen?void(_.isEqual(screenInfo,this.screenInfo)||(this.prevScreenInfo=this.screenInfo,this.setScreenInfo(screenInfo),this.pushScreen(screenInfo),this.clearScreen(),this.getEventManager().broadCast({data:params}))):(alert("준비중입니다."),!1)},clearAtNoHistoryScreen:function(){var flag=!1;_.each(this.unCacheList,$.proxy(function(item){this.isSubScreen(item)&&(flag=!0)},this)),flag&&this.clearStack()},pushScreen:function(screenInfo){this.clearAtNoHistoryScreen(screenInfo),this.stack.push(screenInfo),this.stackLimit<this.stack.length&&this.stack.shift(),this.saveToStorage()},removeNotRegisterStack:function(){for(var stack=this.getStack(),i=0;i<stack.length;i++)stack[i].screen!==LineMain.MAIN_SCREEN_TYPE.REGISTER&&stack.pop();this.stack=stack,this.saveToStorage()},saveToStorage:function(){PersistentStore.getInstance().set("SM_screenStack",JSON.stringify(this.stack))},moveBack:function(){var idx=this.stack.length-2,screenInfo=this.stack[idx];screenInfo&&(this.stack.pop(),this.stack.pop(),this.headerView.hideAllButtons(),this.changeScreen(screenInfo))},hideMenu:function(){MenuView.getInstance().hide()},hideHeader:function(){this.hideMenu(),this.headerView.hide()},hideHeaderMenu:function(){this.headerView.hideIcons()},setTitle:function(label){HeaderView.getInstance().setTitle(label)},clearScreen:function(){this.hideHeader(),this.hideMenu(),this.contentLayers.addClass("MdNonDisp"),$("input:focus").blur()},setScreenInfo:function(screenInfo){this.screenInfo=screenInfo},getScreenInfo:function(){return this.screenInfo},removeAll:function(){this.screenInfo={},this.clearStack()},clearStack:function(){this.stack=[]},isMainScreen:function(mainScreen){return this.getScreenInfo().screen===mainScreen},isSubScreen:function(subScreen){return this.getScreenInfo().subScreen===subScreen},prevSubScreen:function(subScreen){return this.prevScreenInfo?this.prevScreenInfo.subScreen===subScreen:void 0}},ScreenManager.getInstance=function(){return null==ScreenManager.instance&&(ScreenManager.instance=new ScreenManager),ScreenManager.instance},ScreenManager.instance=null;var HeaderView=function(){return null!=HeaderView.instance?HeaderView.instance:(_.extend(this,UIStructure),this.assign(),this.initHeaderMap(),this.initDisplayDataMap(),void this.setEvent())};HeaderView.HEADER_DEFAULT_MAP={},HeaderView.prototype={initHeaderMap:function(){var headerIcons=this.buttonContainer.find("._icon_group");headerIcons.each($.proxy(function(seq){var $el=$(headerIcons[seq]),name=$el.attr("data-name");HeaderView.HEADER_DEFAULT_MAP[name]={name:name,visible:!1,type:"active",toggle:!1,toggleOn:!0,action:this["default_"+name]||this.default_func,element:$el}},this))},initDisplayDataMap:function(){this.buttonDisplayData={},_.each(HeaderView.HEADER_DEFAULT_MAP,$.proxy(function(obj){this.buttonDisplayData[obj.name]={},_.extend(this.buttonDisplayData[obj.name],obj)},this))},assign:function(){this.wel=$("#_wrap_page_header"),this.buttonContainer=$("._btn_container")},setEvent:function(){var setButtonEvent=function(e){var name=$(e.currentTarget).attr("data-name"),button=this.buttonDisplayData[name];button.toggle===!0&&this.handleToggle(button.element,button);var runner=button.action||this["default_"+name]||this.default_func;runner(e.target,name,button)};this.buttonContainer.off(this.EVENT_TOUCH_START,"._icon_group",$.proxy(setButtonEvent,this)).on(this.EVENT_TOUCH_START,"._icon_group",$.proxy(setButtonEvent,this))},handleToggle:function(element,button){button.toggleOn=!button.toggleOn,element.removeClass(element.attr("data-active-class")),element.removeClass(element.attr("data-inactive-class")),element.addClass(button.toggleOn?element.attr("data-active-class"):element.attr("data-inactive-class"))},default_func:function(name,fn){},default_close:function(){LineMain.getInstance().moveBack()},default_back:function(){LineMain.getInstance().moveBack()},set:function(data){return this.initDisplayDataMap(),this.updateButtonSet(data),this},updateButtonSet:function(data){_.each(data,$.proxy(function(item,key){var itemData={name:key};item===!1?itemData.visible=!1:item===!0?itemData.visible=!0:(itemData.visible=!0,itemData=_.extend(itemData,item));try{_.extend(this.buttonDisplayData[itemData.name],itemData)}catch(e){}},this))},update:function(data){return this.updateButtonSet(data),this.changeButtonDisplay(),this},hideAllButtons:function(){this.buttonContainer.find("._icon_group").addClass("MdNonDisp")},changeButtonDisplay:function(){this.hideAllButtons();for(var buttonId in this.buttonDisplayData){var buttonObj=this.buttonDisplayData[buttonId],element=buttonObj.element;buttonObj.visible&&element.removeClass("MdNonDisp"),buttonObj.toggle&&(element.removeClass(element.attr("data-active-class")),element.removeClass(element.attr("data-inactive-class")),element.addClass(buttonObj.toggleOn?element.attr("data-active-class"):element.attr("data-inactive-class")))}},setTitle:function(label){return this.wel.find("._header_title").html(label),this},show:function(){return this.changeButtonDisplay(),this.wel.removeClass("MdNonDisp"),this},isShow:function(){return"none"!==this.wel.css("display")},hide:function(){return this.wel.addClass("MdNonDisp"),this.hideIcons(),this},hideIcons:function(){return this.initDisplayDataMap(),this},onAddFriend:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.ETC,subScreen:LineMain.SUB_SCREEN_TYPE.SEARCH_BY_USERID})},onEditFriend:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_EDIT})},onEditChatList:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_LIST_EDIT})},onChooseFriend:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_CHOOSE})},onChatRoomOpiton:function(){ChatUI.getInstance().toggleChatOptionLayer()},default_edit_chat_list:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.CHAT,subScreen:LineMain.SUB_SCREEN_TYPE.CHAT_LIST_EDIT})},default_edit_friend_list:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_EDIT})},default_create_group:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.GROUP_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.GROUP_MANAGER_NEW})},default_choose_friends:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.FRIEND_MANAGER,subScreen:LineMain.SUB_SCREEN_TYPE.FRIEND_MANAGER_NEW})},default_header_link:function(){}},HeaderView.getInstance=function(){return null==HeaderView.instance&&(HeaderView.instance=new HeaderView),HeaderView.instance},HeaderView.instance=null;var MenuView=function(){return null!=MenuView.instance?MenuView.instance:(this.wel=null,this.initElements(),void this.setEvents())};MenuView.prototype={initElements:function(){this.wel=$("#_wrap_main_menu")},setEvents:function(){LineMain.getInstance().getEventManager().regist(this.changeScreen.bind(this));var hasTouch=!!("ontouchstart"in window);$(document).on(hasTouch?"touchstart":"click","#_wrap_main_menu button",$.proxy(function(e){var currentTarget=$(e.currentTarget),screenInfo={screen:LineMain.MAIN_SCREEN_TYPE[currentTarget.attr("data-screen-name")],subScreen:LineMain.SUB_SCREEN_TYPE[currentTarget.attr("data-sub-name")]};return LineMain.getInstance().changeScreen(screenInfo),!1},this))},changeNewLine:function(){LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE})},changeScreen:function(){var screenInfo=LineMain.getInstance().getScreenInfo();"logout"===screenInfo.screen?(SettingProxy.getInstance().logout(),this.changeNewLine()):screenInfo.screen&&screenInfo.subScreen&&(this.wel.find("li").removeClass("ExSelected"),this.wel.find("button[data-screen-name="+LineMain.MAIN_SCREEN_TYPE_MAP[screenInfo.screen]+"]").parent().addClass("ExSelected"))},set:function(){return this},show:function(){return this.wel.removeClass("MdNonDisp"),this},hide:function(){return this.wel.addClass("MdNonDisp"),this}},MenuView.getInstance=function(){return null==MenuView.instance&&(MenuView.instance=new MenuView),MenuView.instance},MenuView.instance=null;var AuthPersistentStore=function(){return null!=AuthPersistentStore.instance?AuthPersistentStore.instance:void(this.store=PersistentStore.getInstance())};AuthPersistentStore.prototype={setAuthToken:function(authToken){var valueObj=this.get();valueObj[AuthPersistentStore.AUTH_TOKEN_KEY]=authToken,this.set(valueObj)},getAuthToken:function(){var valueObj=this.get();return valueObj[AuthPersistentStore.AUTH_TOKEN_KEY]||null},setPhoneNumber:function(phoneNumber){var valueObj=this.get();valueObj[AuthPersistentStore.PHONE_NUMBER_KEY]=phoneNumber,this.set(valueObj)},getPhoneNumber:function(){var valueObj=this.get();return valueObj[AuthPersistentStore.PHONE_NUMBER_KEY]||null},setSessionData:function(sessionData){var valueObj=this.get();valueObj[AuthPersistentStore.SESSION_DATA]=sessionData,this.set(valueObj)},getSessionData:function(){var valueObj=this.get();return valueObj[AuthPersistentStore.SESSION_DATA]||null},setISOCode:function(isoCode){var valueObj=this.get();valueObj[AuthPersistentStore.ISO_CODE_KEY]=isoCode,this.set(valueObj)},getISOCode:function(){var valueObj=this.get();return valueObj[AuthPersistentStore.ISO_CODE_KEY]||null},set:function(data){this.store.set(AuthPersistentStore.STORE_NAME,JSON.stringify(data))},get:function(){var data=this.store.get(AuthPersistentStore.STORE_NAME);return JSON.parse(data)||{}},clear:function(){this.store.remove(AuthPersistentStore.STORE_NAME)}},AuthPersistentStore.getInstance=function(){return null==AuthPersistentStore.instance&&(AuthPersistentStore.instance=new AuthPersistentStore),AuthPersistentStore.instance},AuthPersistentStore.instance=null,AuthPersistentStore.STORE_NAME="authInfo",AuthPersistentStore.AUTH_TOKEN_KEY="authToken",AuthPersistentStore.PHONE_NUMBER_KEY="authorizedPhoneNumber",AuthPersistentStore.ISO_CODE_KEY="authorizedISOCode",AuthPersistentStore.MID_KEY="mid",AuthPersistentStore.SESSION_DATA="authSessionData";var DatabaseStoreFactory=function(){return null!=DatabaseStoreFactory.instance?DatabaseStoreFactory.instance:void 0};DatabaseStoreFactory.prototype={openDB:function(upgradeneedFn,loadFn){IndexedDB.getInstance().open(this.initDB.bind(this),upgradeneedFn,loadFn)},initDB:function(){this.initContactListStore(),this.initLocalContactListStore(),this.initChatListStore(),this.initChatMessageListStore(),this.initChatLastMessageListStore()},initContactListStore:function(){ContactListStore.getInstance(IndexedDB.getInstance().get())},initLocalContactListStore:function(){LocalContactStore.getInstance(IndexedDB.getInstance().get())},initChatListStore:function(){ChatListStore.getInstance(IndexedDB.getInstance().get())},initChatMessageListStore:function(){ChatMessageListStore.getInstance(IndexedDB.getInstance().get())},initChatLastMessageListStore:function(){ChatLastMessageListStore.getInstance(IndexedDB.getInstance().get())},getContactListStore:function(){return ContactListStore.getInstance(IndexedDB.getInstance().get())},getLocalContactListStore:function(){return LocalContactStore.getInstance(IndexedDB.getInstance().get())},getChatListStore:function(){return ChatListStore.getInstance(IndexedDB.getInstance().get())},getChatMessageListStore:function(){return ChatMessageListStore.getInstance(IndexedDB.getInstance().get())},getChatLastMessageListStore:function(){return ChatLastMessageListStore.getInstance(IndexedDB.getInstance().get())}},DatabaseStoreFactory.getInstance=function(){return null==DatabaseStoreFactory.instance&&(DatabaseStoreFactory.instance=new DatabaseStoreFactory),DatabaseStoreFactory.instance},DatabaseStoreFactory.instance=null;var I_DBObjectStore=function(objName){this.objName=objName};I_DBObjectStore.prototype={getByIndex:function(index,fn){var objectStore=this.getTransactionAndObjectStore(this.objName,"readonly"),request=objectStore.get(index+1);request.onsuccess=fn},getCount:function(fn){var objectStore=this.getTransactionAndObjectStore(this.objName,"readonly"),request=objectStore.count();request.onsuccess=fn},getAll:function(fn){var objectStore=this.getTransactionAndObjectStore(this.objName,"readonly"),request=objectStore.openCursor();request.onsuccess=fn},getAllInsideIndex:function(indexName,fn){var objectStore=this.getTransactionAndObjectStore(this.objName,"readonly"),index=objectStore.index(indexName),request=index.openCursor(IDBKeyRange.lowerBound(0),"prev");request.onsuccess=fn},getOnly:function(indexName,value,fn,readType,way){var objectStore=this.getTransactionAndObjectStore(this.objName,readType),index=objectStore.index(indexName),flag=way?"prev":"next",request=index.openCursor(IDBKeyRange.only(value),flag);request.onsuccess=fn},getOnlyForUpdate:function(indexName,value,fn,way){this.getOnly(indexName,value,fn,"readwrite",way)},search:function(indexName,value,way,fn){var objectStore=this.getTransactionAndObjectStore(this.objName,"readonly"),index=objectStore.index(indexName),request=index.openCursor(IDBKeyRange.bound(value,value),way);request.onsuccess=function(result){var flag=fn(result);flag&&(request.onsuccess=function(){})}},searchByRange:function(indexName,startIdx,endIdx,way,isAllowDuplication,fn){var objectStore=this.getTransactionAndObjectStore(this.objName,"readonly"),flag=1==isAllowDuplication?way:way+"unique",index=objectStore.index(indexName),request=index.openCursor(IDBKeyRange.bound(startIdx+1,endIdx+1),flag);request.onsuccess=fn},put:function(data,fn){var objectStore=this.getTransactionAndObjectStore(this.objName,"readwrite");try{var request=objectStore.put(data);request.onsuccess=fn}catch(e){fn()}},add:function(data,fn){var objectStore=this.getTransactionAndObjectStore(this.objName,"readwrite"),request=objectStore.add(data);request.onsuccess=fn},deleteRecordForIndex:function(indexName,value,fn){var objectStore=this.getTransactionAndObjectStore(this.objName,"readwrite"),index=objectStore.index(indexName),request=index.openCursor(IDBKeyRange.bound(value,value));request.onsuccess=function(event){var cursor=event.target.result;cursor?(objectStore.delete(cursor.primaryKey),cursor.continue()):fn()}},deleteRecord:function(value,fn){var objectStore=this.getTransactionAndObjectStore(this.objName,"readwrite"),request=objectStore.delete(value);request.onsuccess=function(){fn()}},clear:function(fn){var objectStore=this.getTransactionAndObjectStore(this.objName,"readwrite"),request=objectStore.clear();request.onsuccess=fn},getTransactionAndObjectStore:function(objName,type){var transaction=this.getTransaction(objName,type),objectStore=this.getObjectStore(transaction,objName);return objectStore},getTransaction:function(objName,type){return IndexedDB.getInstance().get().transaction([objName],type)},getObjectStore:function(transaction,objName){return transaction.objectStore(objName)}},"webkitIndexedDB"in window&&(window.IDBCursor=window.webkitIDBCursor,window.IDBDatabase=window.webkitIDBDatabase,window.IDBDatabaseError=window.webkitIDBDatabaseError,window.IDBDatabaseException=window.webkitIDBDatabaseException,window.IDBErrorEvent=window.webkitIDBErrorEvent,window.IDBEvent=window.webkitIDBEvent,window.IDBFactory=window.webkitIDBFactory,window.IDBIndex=window.webkitIDBIndex,window.IDBKeyRange=window.webkitIDBKeyRange,window.IDBObjectStore=window.webkitIDBObjectStore,window.IDBRequest=window.webkitIDBRequest,window.IDBSuccessEvent=window.webkitIDBSuccessEvent,window.IDBTransaction=window.webkitIDBTransaction,window.indexedDB=window.webkitIndexedDB);var IndexedDB=function(){return null!=IndexedDB.instance?IndexedDB.instance:(this.request=null,this.database=null,this.initFn=null,void(this.loadFn=null))};IndexedDB.prototype={open:function(initFn,upgradeneedFn,loadFn){this.initFn=initFn,this.upgradeneedFn=upgradeneedFn,this.loadFn=loadFn,this.request=indexedDB.open(IndexedDB.DATABASE_NAME,IndexedDB.DATABASE_VERSION),this.request.onupgradeneeded=this.onupgradeneeded.bind(this),this.request.onsuccess=this.onSuccess.bind(this),this.request.onerror=this.onError.bind(this)},close:function(){},onupgradeneeded:function(event){this.database=event.target.result,this.initFn instanceof Function==1&&this.initFn(),this.upgradeneedFn instanceof Function==1&&this.upgradeneedFn()},onSuccess:function(){this.database=this.request.result,this.loadFn instanceof Function==1&&this.loadFn()},onError:function(event){},get:function(){return this.database}},IndexedDB.getInstance=function(){return null==IndexedDB.instance&&(IndexedDB.instance=new IndexedDB),IndexedDB.instance},IndexedDB.instance=null,IndexedDB.DATABASE_VERSION=1,IndexedDB.DATABASE_NAME="LINE_FFOS";var NewFriendPersistentArrayStore=function(){return null!=NewFriendPersistentArrayStore.instance?NewFriendPersistentArrayStore.instance:(this.store=PersistentStore.getInstance(),void(this.eventManager=new EventManager))};NewFriendPersistentArrayStore.prototype={getEventManager:function(){return this.eventManager},set:function(data){this.store.set(NewFriendPersistentArrayStore.STORE_NAME,JSON.stringify(data)),this.getEventManager().broadCast()},add:function(mid){var dataArray=JSON.parse(this.store.get(NewFriendPersistentArrayStore.STORE_NAME))||[];dataArray.push(mid);var uniqueArray=_.uniq(dataArray);this.set(uniqueArray)},get:function(){var contactList=JSON.parse(this.store.get(NewFriendPersistentArrayStore.STORE_NAME));return contactList||[]},clear:function(){this.store.remove(NewFriendPersistentArrayStore.STORE_NAME),this.getEventManager().broadCast(null)},update:function(){var contactList=ContactProxy.getInstance().getFriendList(),newFriendMids=_.map(contactList,function(contact){var offsetTime=(new Date).getTime()-new Date(contact.createdTime).getTime()+LineMain.SERVER_TIME_OFFSET,isNew=offsetTime<=LineConfig.NEW_FRIEND_CHECK_TIME&&contact.status===ContactStatus.FRIEND&&contact.settings!==ContactSetting.CONTACT_SETTING_CONTACT_HIDE;return isNew?contact.mid:void 0});this.set(_.without(newFriendMids,void 0))}},NewFriendPersistentArrayStore.getInstance=function(){return null==NewFriendPersistentArrayStore.instance&&(NewFriendPersistentArrayStore.instance=new NewFriendPersistentArrayStore),NewFriendPersistentArrayStore.instance},NewFriendPersistentArrayStore.instance=null,NewFriendPersistentArrayStore.STORE_NAME="CD_newFriendMids";var ObjectStore=function(db){this.db=db,this.storeName=null,this.store=null};ObjectStore.prototype={createObjectStore:function(objName,key,autoIncrement){var flag=autoIncrement&&1==autoIncrement?!0:!1;this.storeName=objName,this.store=this.db.createObjectStore(objName,{keyPath:key,autoIncrement:flag})},createIndex:function(indexName,fieldName,isUnique){var flag=isUnique&&1==isUnique?!0:!1;this.store.createIndex(indexName,fieldName,{unique:flag})}};var OperationPollerPersistentStore=function(){return null!=OperationPollerPersistentStore.instance?OperationPollerPersistentStore.instance:void(this.store=PersistentStore.getInstance())};OperationPollerPersistentStore.prototype={setLastOperationId:function(lastOperationId){this.store.set(OperationPollerPersistentStore.STORE_NAME,lastOperationId)},getLastOperationId:function(){var rev=this.store.get(OperationPollerPersistentStore.STORE_NAME);return(null==rev||""==rev)&&this.setLastOperationId(0),rev}},OperationPollerPersistentStore.getInstance=function(){return null==OperationPollerPersistentStore.instance&&(OperationPollerPersistentStore.instance=new OperationPollerPersistentStore),OperationPollerPersistentStore.instance},OperationPollerPersistentStore.instance=null,OperationPollerPersistentStore.STORE_NAME="lastFetchOperationRevisionId";var PersistentStore=function(){return null!=PersistentStore.instance?PersistentStore.instance:void(this.store=window.localStorage)};PersistentStore.prototype={set:function(key,dataObj){this.store.setItem(key,dataObj)},get:function(key){return this.store.getItem(key)||null},remove:function(key){this.store.removeItem(key)},clear:function(){this.store.clear()}},PersistentStore.getInstance=function(){return null==PersistentStore.instance&&(PersistentStore.instance=new PersistentStore),PersistentStore.instance},PersistentStore.instance=null;var ProfilePersistentStore=function(){return null!=ProfilePersistentStore.instance?ProfilePersistentStore.instance:(this.store=PersistentStore.getInstance(),void(this.eventManager=new EventManager))};ProfilePersistentStore.prototype={getEventManager:function(){return this.eventManager},set:function(data){_.map(data,$.proxy(function(value,key){this.store.set(ProfilePersistentStore.PREFIX+key,JSON.stringify(value))},this)),this.getEventManager().broadCast()},get:function(){var profile=ProfileBO.getInstance().getProfile();return this.getByProfileObject(profile)},getByName:function(name){var data=this.store.get(name);return JSON.parse(data)},getByProfileObject:function(profile){var storedProfile={};return _.map(profile,$.proxy(function(value,key){var prop=ProfilePersistentStore.PREFIX+key;storedProfile[key]=this.getByName(prop)},this)),storedProfile},clear:function(){this.store.remove(ProfilePersistentStore.STORE_NAME)}},ProfilePersistentStore.getInstance=function(){return null==ProfilePersistentStore.instance&&(ProfilePersistentStore.instance=new ProfilePersistentStore),ProfilePersistentStore.instance},ProfilePersistentStore.instance=null,ProfilePersistentStore.PREFIX="PI_";var SettingPersistentStore=function(){return null!=SettingPersistentStore.instance?SettingPersistentStore.instance:(this.store=PersistentStore.getInstance(),void(this.eventManager=new EventManager))};SettingPersistentStore.prototype={getEventManager:function(){return this.eventManager},set:function(data){this.store.set(SettingPersistentStore.STORE_NAME,JSON.stringify(data)),this.getEventManager().broadCast(null)},add:function(value){var dataArray=JSON.parse(this.store.get(SettingPersistentStore.STORE_NAME))||[];dataArray.push(value),this.set(dataArray)},get:function(){var data=this.store.get(SettingPersistentStore.STORE_NAME);return JSON.parse(data)||{}},clear:function(){this.store.remove(SettingPersistentStore.STORE_NAME)}},SettingPersistentStore.getInstance=function(){return null==SettingPersistentStore.instance&&(SettingPersistentStore.instance=new SettingPersistentStore),SettingPersistentStore.instance},SettingPersistentStore.instance=null,SettingPersistentStore.STORE_NAME="setting";var StickerPersistentArrayStore=function(){return null!=StickerPersistentArrayStore.instance?StickerPersistentArrayStore.instance:(this.store=PersistentStore.getInstance(),void(this.eventManager=new EventManager))};StickerPersistentArrayStore.prototype={getEventManager:function(){return this.eventManager},set:function(data){this.store.set(StickerPersistentArrayStore.STORE_NAME,JSON.stringify(data)),this.getEventManager().broadCast(null)},push:function(value){var dataArray=JSON.parse(this.store.get(StickerPersistentArrayStore.STORE_NAME))||[];dataArray.push(value),this.set(dataArray)},shift:function(){var dataArray=JSON.parse(this.store.get(StickerPersistentArrayStore.STORE_NAME))||[];dataArray.shift(),this.set(dataArray)},get:function(){var data=this.store.get(StickerPersistentArrayStore.STORE_NAME);return JSON.parse(data)||[]},remove:function(chatId){var dataArray=JSON.parse(this.store.get(StickerPersistentArrayStore.STORE_NAME)),filter=function(localChatId){return localChatId!=chatId},newDataArray=dataArray.filter(filter);this.set(newDataArray)},clear:function(){this.store.remove(StickerPersistentArrayStore.STORE_NAME)}},StickerPersistentArrayStore.getInstance=function(){return null==StickerPersistentArrayStore.instance&&(StickerPersistentArrayStore.instance=new StickerPersistentArrayStore),StickerPersistentArrayStore.instance},StickerPersistentArrayStore.instance=null,StickerPersistentArrayStore.STORE_NAME="stickerHistory";var ChatLastMessageListStore=function(db){return null!=ChatLastMessageListStore.instance?ChatLastMessageListStore.instance:(this.db=db,this.checkStore(),void _.extend(this,new I_DBObjectStore(ChatLastMessageListStore.OBJECT_STORE_NAME)))};ChatLastMessageListStore.prototype={checkStore:function(){this.db.objectStoreNames.contains(ChatLastMessageListStore.OBJECT_STORE_NAME)||this.createStore()},createStore:function(){var store=new ObjectStore(this.db);store.createObjectStore(ChatLastMessageListStore.OBJECT_STORE_NAME,"chatId",!1)},getLastMessageAllList:function(onSuccess){var objectStore=this.getTransactionAndObjectStore(this.objName,"readonly"),request=objectStore.openCursor();request.onsuccess=function(event){var cursor=event.target.result;if(cursor){var messageBo=cursor.value;ChatListBO.getInstance().saveLastMessageBo(messageBo),cursor.continue()}else onSuccess()}},deleteMessageBoByChatId:function(chatId){this.deleteRecord(chatId,EventManager.EMPTY)}},ChatLastMessageListStore.getInstance=function(db){return null==ChatLastMessageListStore.instance&&(ChatLastMessageListStore.instance=new ChatLastMessageListStore(db)),ChatLastMessageListStore.instance},ChatLastMessageListStore.instance=null,ChatLastMessageListStore.OBJECT_STORE_NAME="ffos_chat_last_message_list";var ChatListStore=function(db){return null!=ChatListStore.instance?ChatListStore.instance:(this.db=db,_.extend(this,new I_DBObjectStore(ChatListStore.OBJECT_STORE_NAME)),void this.checkStore())};ChatListStore.prototype={checkStore:function(){this.db.objectStoreNames.contains(ChatListStore.OBJECT_STORE_NAME)||this.createStore()},createStore:function(){var store=new ObjectStore(this.db);store.createObjectStore(ChatListStore.OBJECT_STORE_NAME,"chatId",!0)},getChatAllList:function(onSuccess){var objectStore=this.getTransactionAndObjectStore(ChatListStore.OBJECT_STORE_NAME,"readwrite"),request=objectStore.openCursor(IDBKeyRange.lowerBound(0),"prev");request.onsuccess=function(event){var cursor=event.target.result;if(cursor){var chatBo=cursor.value;ChatListBO.getInstance().saveChat(chatBo),cursor.continue()}else onSuccess()}},deleteChat:function(chatId,onSuccess){this.deleteRecord(chatId,onSuccess)}},ChatListStore.getInstance=function(db){return null==ChatListStore.instance&&(ChatListStore.instance=new ChatListStore(db)),ChatListStore.instance},ChatListStore.instance=null,ChatListStore.OBJECT_STORE_NAME="ffos_chat_list",ChatListStore.INDEX_CHAT_ID="idx_chatId";var ChatMessageListStore=function(db){return null!=ChatMessageListStore.instance?ChatMessageListStore.instance:(this.db=db,this.checkStore(),void _.extend(this,new I_DBObjectStore(ChatMessageListStore.OBJECT_STORE_NAME)))};ChatMessageListStore.prototype={checkStore:function(){this.db.objectStoreNames.contains(ChatMessageListStore.OBJECT_STORE_NAME)||this.createStore()},createStore:function(){var store=new ObjectStore(this.db);store.createObjectStore(ChatMessageListStore.OBJECT_STORE_NAME,"seq",!0),store.createIndex(ChatMessageListStore.INDEX_SERVER_ID,"message.id",{unique:!0}),store.createIndex(ChatMessageListStore.INDEX_LOCAL_ID,"localId",{unique:!0}),store.createIndex(ChatMessageListStore.INDEX_STATUS,"status",{unique:!1}),store.createIndex(ChatMessageListStore.INDEX_CHAT_ID,"chatId",{unique:!1}),store.createIndex(ChatMessageListStore.INDEX_UNREAD_STATUS,["chatId","status"],{unique:!1})},getMessageBoList:function(chatId,blockSize,pageSize,msgStackCount,onSuccess){var objectStore=this.getTransactionAndObjectStore(ChatMessageListStore.OBJECT_STORE_NAME,"readonly"),index=objectStore.index(ChatMessageListStore.INDEX_CHAT_ID),request=index.openCursor(IDBKeyRange.only(chatId),"prev"),tmpList=[],cnt=0,jumpFlag=!0;request.onsuccess=function(event){var cursor=event.target.result,jumpIndex=(blockSize-1)*pageSize+msgStackCount;if(cnt==pageSize)return onSuccess(tmpList),!1;if(0==jumpIndex)if(cursor){var messageBo=cursor.value;tmpList.push(messageBo),cursor.continue(),cnt++}else onSuccess(tmpList);else if(1==jumpFlag)jumpFlag=!1,cursor.advance(jumpIndex);else if(cursor){var messageBo=cursor.value;tmpList.push(messageBo),cursor.continue(),cnt++}else onSuccess(tmpList)}},getMessageBoByChatId:function(chatId,onSuccess){this.getOnly(ChatMessageListStore.INDEX_CHAT_ID,chatId,onSuccess,"readonly","prev")},getSuccessfulMessageBoByChatId:function(chatId,onSuccess,onFailure){var tmpList=[];this.getAllInsideIndex(ChatMessageListStore.INDEX_CHAT_ID,function(event){var cursor=event.target.result;if(cursor){var messageBo=cursor.value;tmpList.push(messageBo),cursor.continue()}else{for(var i=0;i<tmpList.length;i++){var msgBo=tmpList[i];if(msgBo.status==ChatMessageBO.STATUS.SENT||msgBo.status==ChatMessageBO.STATUS.RECEIVED){onSuccess(msgBo);break}}onFailure()}}.bind(this))},getMessageBoByLocalId:function(localId,onSuccess){this.getOnlyForUpdate(ChatMessageListStore.INDEX_LOCAL_ID,Number(localId),function(event){var cursor=event.target.result;if(cursor){var messageBo=cursor.value;onSuccess(messageBo)}})},deleteMessageBoByLocalId:function(localId,onSuccess){var objectStore=this.getTransactionAndObjectStore(ChatMessageListStore.OBJECT_STORE_NAME,"readwrite"),index=objectStore.index(ChatMessageListStore.INDEX_LOCAL_ID),request=index.openCursor(IDBKeyRange.only(Number(localId)),"prev");request.onsuccess=function(event){var cursor=event.target.result;cursor&&(objectStore.delete(cursor.primaryKey),onSuccess())}},getMessageBoByLocalIdForMiddleUpdate:function(localId,date,onSuccess){this.getOnlyForUpdate(ChatMessageListStore.INDEX_LOCAL_ID,localId,function(event){var cursor=event.target.result,messageBo=null;cursor&&(messageBo=cursor.value,null==messageBo.message.id&&(messageBo.message.createdTime=date,cursor.update(messageBo),onSuccess(messageBo)))})},getMessageBoByLocalIdForUpdate:function(localId,message,onSuccess){this.getOnlyForUpdate(ChatMessageListStore.INDEX_LOCAL_ID,localId,function(event){var cursor=event.target.result,messageBo=null;
cursor&&(messageBo=cursor.value,null==messageBo.message.id&&(1==!!message.code?messageBo.status=ChatMessageBO.STATUS.FAIL:(message.from=null,messageBo.message.createdTime=message.createdTime,messageBo.message.id=message.id,messageBo.message.contentType!==ContentType.IMAGE&&(messageBo.status=ChatMessageBO.STATUS.SENT)),cursor.update(messageBo),onSuccess(messageBo)))})},deleteMessageBoByChatId:function(chatId,onSuccess){var objectStore=this.getTransactionAndObjectStore(ChatMessageListStore.OBJECT_STORE_NAME,"readwrite"),index=objectStore.index(ChatMessageListStore.INDEX_CHAT_ID),request=index.openCursor(IDBKeyRange.bound(chatId,chatId),"prev");request.onsuccess=function(event){var cursor=event.target.result;cursor?(objectStore.delete(cursor.primaryKey),cursor.continue()):onSuccess()}},deleteAlertMessageByChatId:function(chatId){var objectStore=this.getTransactionAndObjectStore(ChatMessageListStore.OBJECT_STORE_NAME,"readwrite"),index=objectStore.index(ChatMessageListStore.INDEX_CHAT_ID),request=index.openCursor(IDBKeyRange.bound(chatId,chatId),"next");request.onsuccess=function(event){var cursor=event.target.result;cursor&&(messageBo=cursor.value,void 0!=messageBo.sysMsgType&&messageBo.sysMsgType==SystemMessageBO.TYPE.ADD_BLOCK_ALERT&&objectStore.delete(cursor.primaryKey),cursor.continue())}},getUnreadMessageAllList:function(onSuccess){var objectStore=this.getTransactionAndObjectStore(ChatMessageListStore.OBJECT_STORE_NAME,"readwrite"),index=objectStore.index(ChatMessageListStore.INDEX_STATUS),status=ChatMessageBO.STATUS.RECEIVED,request=index.openCursor(IDBKeyRange.bound(status,status),"prev"),messageBo=null,cnt=0;request.onsuccess=function(event){var cursor=event.target.result;cursor?(cnt++,messageBo=cursor.value,ChatListBO.getInstance().saveUnreadMessageBo(messageBo),cursor.continue()):onSuccess(cnt)}},updateReadCount:function(startPoint,endPoint,onSuccess){try{if(1==!!startPoint&&1==!!endPoint){var objectStore=this.getTransactionAndObjectStore(ChatMessageListStore.OBJECT_STORE_NAME,"readwrite"),index=objectStore.index(ChatMessageListStore.INDEX_SERVER_ID),request=index.openCursor(IDBKeyRange.bound(startPoint,endPoint),"prev"),messageBo=null,messageBoList=[];request.onsuccess=function(event){var cursor=event.target.result;if(cursor){messageBo=cursor.value;{messageBo.chatId}messageBo.readCount++,cursor.update(messageBo),messageBoList.push(messageBo),cursor.continue()}else onSuccess(messageBoList)}}}catch(ex){}},updateCheckedMessage:function(chatId,onSuccess){var objectStore=this.getTransactionAndObjectStore(ChatMessageListStore.OBJECT_STORE_NAME,"readwrite"),index=objectStore.index(ChatMessageListStore.INDEX_UNREAD_STATUS),request=index.openCursor(IDBKeyRange.bound([chatId,ChatMessageBO.STATUS.RECEIVED],[chatId,ChatMessageBO.STATUS.RECEIVED]),"prev"),messageBo=null;request.onsuccess=function(event){var cursor=event.target.result;cursor?(messageBo=cursor.value,messageBo.status=ChatMessageBO.STATUS.CHECKED,cursor.update(messageBo),cursor.continue()):onSuccess()}},updateContent:function(message,onSuccess){var messageId=message.id,objectStore=this.getTransactionAndObjectStore(ChatMessageListStore.OBJECT_STORE_NAME,"readwrite"),index=objectStore.index(ChatMessageListStore.INDEX_SERVER_ID),request=index.openCursor(IDBKeyRange.only(messageId),"prev"),messageBo=null;request.onsuccess=function(event){var cursor=event.target.result;cursor?(messageBo=cursor.value,messageBo.message.contentPreview=message.contentPreview,messageBo.message.contentMetadata=message.contentMetadata,cursor.update(messageBo),cursor.continue()):onSuccess()}},getSendingMessageAllList:function(timeGap,onSuccess){var objectStore=this.getTransactionAndObjectStore(ChatMessageListStore.OBJECT_STORE_NAME,"readwrite"),index=objectStore.index(ChatMessageListStore.INDEX_STATUS),status=ChatMessageBO.STATUS.SENDING,request=index.openCursor(IDBKeyRange.bound(status,status),"next"),messageBo=null,retList=[],retFailList=[],currentDate=(new Date).getTime(),maxRunCount=30,runCount=0;request.onsuccess=function(event){var cursor=event.target.result;cursor?(messageBo=cursor.value,maxRunCount>runCount&&(currentDate-messageBo.message.createdTime>=timeGap?retFailList.push(messageBo):messageBo.message.contentType==ContentType.NONE||messageBo.message.contentType==ContentType.STICKER?retList.push(messageBo):retFailList.push(messageBo),runCount++),cursor.continue()):onSuccess(retList,retFailList)}}},ChatMessageListStore.getInstance=function(db){return null==ChatMessageListStore.instance&&(ChatMessageListStore.instance=new ChatMessageListStore(db)),ChatMessageListStore.instance},ChatMessageListStore.instance=null,ChatMessageListStore.OBJECT_STORE_NAME="ffos_chat_message_list",ChatMessageListStore.INDEX_SERVER_ID="idx_serverId",ChatMessageListStore.INDEX_LOCAL_ID="idx_localId",ChatMessageListStore.INDEX_STATUS="idx_status",ChatMessageListStore.INDEX_CHAT_ID="idx_chatId",ChatMessageListStore.INDEX_UNREAD_STATUS="idx_chatId_status";var ContactListStore=function(db){return null!=ContactListStore.instance?ContactListStore.instance:(this.db=db,this.checkStore(),void _.extend(this,new I_DBObjectStore(ContactListStore.OBJECT_STORE_NAME)))};ContactListStore.prototype={getAllContactList:function(onSuccess){var objectStore=this.getTransactionAndObjectStore(ContactListStore.OBJECT_STORE_NAME,"readwrite"),request=objectStore.openCursor(IDBKeyRange.lowerBound(0),"prev");request.onsuccess=onSuccess},checkStore:function(){this.db.objectStoreNames.contains(ContactListStore.OBJECT_STORE_NAME)||this.createStore()},createStore:function(){var store=new ObjectStore(this.db);store.createObjectStore(ContactListStore.OBJECT_STORE_NAME,"mid",!0)}},ContactListStore.getInstance=function(db){return null==ContactListStore.instance&&(ContactListStore.instance=new ContactListStore(db)),ContactListStore.instance},ContactListStore.instance=null,ContactListStore.OBJECT_STORE_NAME="ffos_contact_list",ContactListStore.INDEX_MID="idx_mid";var LocalContactStore=function(db){return null!=LocalContactStore.instance?LocalContactStore.instance:(this.db=db,this.checkStore(),void _.extend(this,new I_DBObjectStore(LocalContactStore.OBJECT_STORE_NAME)))};LocalContactStore.prototype={getAllContactList:function(onSuccess){var objectStore=this.getTransactionAndObjectStore(LocalContactStore.OBJECT_STORE_NAME,"readwrite"),request=objectStore.openCursor();request.onsuccess=onSuccess},checkStore:function(){this.db.objectStoreNames.contains(LocalContactStore.OBJECT_STORE_NAME)||this.createStore()},createStore:function(){var store=new ObjectStore(this.db);store.createObjectStore(LocalContactStore.OBJECT_STORE_NAME,"luid",!0)}},LocalContactStore.getInstance=function(db){return null==LocalContactStore.instance&&(LocalContactStore.instance=new LocalContactStore(db)),LocalContactStore.instance},LocalContactStore.instance=null,LocalContactStore.OBJECT_STORE_NAME="ffos_device_contact_list",LocalContactStore.INDEX_LUID="idx_luid";var BOStructure=function(){this.setEvent(),this.initProperty()};BOStructure.prototype={initProperty:function(){},setEvent:function(){},removeAll:function(){this.initProperty()},undefinedCallback:function(){}};var UIStructure=function(){this.assign(),this.setEvent()};UIStructure.prototype={assign:function(){},setEvent:function(){},showWrap:function(){},hideWrap:function(){}},UIStructure.EVENT_TOUCH_START=LineMain.AVAILABLE_TOUCH?"touchstart":"mousedown",UIStructure.EVENT_TOUCH=LineMain.AVAILABLE_TOUCH?"touch":"mousedown",UIStructure.EVENT_CLICK=LineMain.AVAILABLE_TOUCH?"click":"click",UIStructure.EVENT_TAP=LineMain.AVAILABLE_TOUCH?"tap":"click",UIStructure.EVENT_RELEASE=LineMain.AVAILABLE_TOUCH?"release":"release",UIStructure.EVENT_LONG_TAP=LineMain.AVAILABLE_TOUCH?"hold":"hold",UIStructure.EVENT_INPUT="keydown keyup keypress",UIStructure.ENTER_KEY_CODE=13,$(document).hammer();var AppCleaner=function(){return null!=AppCleaner.instance?AppCleaner.instance:void 0};AppCleaner.prototype={clear:function(){var deviceId=RegisterStepInfoKeeper.getInstance().getDeviceId();try{this.clearMemoryCache(),this.clearDB(),this.clearLocalStorage(),deviceId&&RegisterStepInfoKeeper.getInstance().setDeviceId(deviceId),OperationPoller.getInstance().stop()}catch(e){}window.close()},clearLocalStorage:function(){localStorage.clear()},clearDB:function(){indexedDB.deleteDatabase(IndexedDB.DATABASE_NAME)},clearMemoryCache:function(){ChatProxy.getInstance().removeAll(),ContactProxy.getInstance().removeAll(),GroupProxy.getInstance().removeAll(),ProfileProxy.getInstance().removeAll(),RecommendProxy.getInstance().removeAll(),SettingProxy.getInstance().removeAll(),LineMain.getInstance().removeAll(),RegisterStepInfoKeeper.getInstance().removeAll(),AuthInfoKeeper.getInstance().removeAll()}},AppCleaner.getInstance=function(){return null==AppCleaner.instance&&(AppCleaner.instance=new AppCleaner),AppCleaner.instance},AppCleaner.instance=null;var CommonException=function(){return null!=CommonException.instance?CommonException.instance:void 0};CommonException.prototype={process:function(exception,methodName){postMessage(exception instanceof TalkException?{method:"LineTalkException",arguments:arguments}:{method:"LineNetworkException",arguments:null})}},CommonException.getInstance=function(){return null==CommonException.instance&&(CommonException.instance=new CommonException),CommonException.instance},CommonException.instance=null;var DataCache=function(customOption){var defaultOption={l1CacheCount:3,l1CacheSize:100,l2CacheCount:5,l2CacheSize:20,dataSource:[]};_.extend(this,defaultOption),_.extend(this,customOption),this.checkDataCache(),this.init()};DataCache.prototype={checkDataCache:function(){if(this.maxCacheBlockCount%2===0)throw"Need odd number for maxCacheBlockCount.";if(void 0===this.dataSource)throw"Need for data cache source.";if(void 0===this.dataSource.loadData)throw"Need loadData Method for load data via range.";if(void 0===this.dataSource.getTotalCount)throw"Need getCount Method"},init:function(){this.cursor=0,this.l1Cache=[],this.l2Cache=[],this.l2CachedIndex=[],this.TOTAL_DATA_COUNT=this.dataSource.getTotalCount(),this.TOTAL_CACHE_PAGE=Math.ceil(this.TOTAL_DATA_COUNT/this.l2CacheSize),this.currentMoveCount=0,this.l2CacheCenterIndex=Math.floor(this.l2CacheCount/2);for(var i=0;i<this.l1CacheCount;i++){var startIndex=i*this.l1CacheSize,endIndex=startIndex+this.l1CacheSize;this.l1Cache[i]={startIndex:startIndex,endIndex:endIndex,dataSource:this.dataSource.loadData(startIndex,endIndex)}}for(i=0;i<this.l2CacheCount;i++){var startIndex=i*this.l2CacheSize,endIndex=startIndex+this.l2CacheSize;this.l2Cache.push(this.dataSource.loadData(startIndex,endIndex)),this.l2CachedIndex.push(i)}},getTotalCachedBlock:function(){return this.l2Cache},getCurrBlock:function(){return this.l2Cache[_.indexOf(this.l2CachedIndex,this.cursor)]},prevDataBlock:function(){if(this.cursor-1<0)return void(this.currentMoveCount=0);if(this.cursor-this.l2CacheCenterIndex-1<0)return this.currentMoveCount=0,this.cursor--,this.getCurrBlock();if(this.cursor--,this.currentMoveCount<this.l2CacheCenterIndex)return this.currentMoveCount++,this.getCurrBlock();this.checkPrevL1Cache(this.cursor-this.l2CacheCenterIndex),this.l2Cache.pop();var startIndex=(this.cursor-this.l2CacheCenterIndex)*this.l2CacheSize,endIndex=startIndex+this.l2CacheSize,nextData=this.findPrevData(startIndex,endIndex);return this.l2Cache.unshift(nextData),this.l2CachedIndex.pop(),this.l2CachedIndex.unshift(_.first(this.l2CachedIndex)-1),this.getCurrBlock()},checkPrevL1Cache:function(index){var l1Cache=null,startIndex=index*this.l2CacheSize,endIndex=startIndex+this.l2CacheSize;_.each(this.l1Cache,$.proxy(function(cache){return cache.startIndex<=startIndex&&endIndex<=cache.endIndex?void(l1Cache=cache):void 0},this)),null===l1Cache&&(this.l1Cache.pop(),this.l1Cache.unshift({startIndex:startIndex,endIndex:startIndex+this.l1CacheSize,dataSource:this.dataSource.loadData(startIndex,startIndex+this.l1CacheSize)}))},findPrevData:function(startIndex,endIndex){var l1Cache=null,newStartIndex=null,newEndIndex=null;_.each(this.l1Cache,$.proxy(function(cache){return cache.startIndex<=startIndex&&endIndex<=cache.endIndex?(l1Cache=cache,newStartIndex=startIndex-cache.startIndex,void(newEndIndex=newStartIndex+this.l2CacheSize)):void 0},this));var data=l1Cache.dataSource.slice(newStartIndex,newEndIndex);return data},nextDataBlock:function(){if(this.cursor+1>this.TOTAL_CACHE_PAGE-1)return void(this.currentMoveCount=0);if(this.cursor+this.l2CacheCenterIndex+1>this.TOTAL_CACHE_PAGE-1)return this.currentMoveCount=0,this.cursor++,this.getCurrBlock();if(this.cursor++,this.currentMoveCount<this.l2CacheCenterIndex)return this.currentMoveCount++,this.getCurrBlock();this.checkNextL1Cache(this.cursor+this.l2CacheCenterIndex),this.l2Cache.shift();var startIndex=(this.cursor+this.l2CacheCenterIndex)*this.l2CacheSize,endIndex=startIndex+this.l2CacheSize,nextData=this.findNextData(startIndex,endIndex);return this.l2Cache.push(nextData),this.l2CachedIndex.shift(),this.l2CachedIndex.push(_.last(this.l2CachedIndex)+1),this.getCurrBlock()},checkNextL1Cache:function(index){var l1Cache=null,startIndex=index*this.l2CacheSize,endIndex=startIndex+this.l2CacheSize;_.each(this.l1Cache,$.proxy(function(cache){return cache.startIndex<=startIndex&&endIndex<=cache.endIndex?void(l1Cache=cache):void 0},this)),null===l1Cache&&(this.l1Cache.shift(),this.l1Cache.push({startIndex:startIndex,endIndex:startIndex+this.l1CacheSize,dataSource:this.dataSource.loadData(startIndex,startIndex+this.l1CacheSize)}))},findNextData:function(startIndex,endIndex){var l1Cache=null,newStartIndex=null,newEndIndex=null;_.each(this.l1Cache,$.proxy(function(cache){return cache.startIndex<=startIndex&&endIndex<=cache.endIndex?(l1Cache=cache,newStartIndex=startIndex-cache.startIndex,void(newEndIndex=newStartIndex+this.l2CacheSize)):void 0},this));var data=l1Cache.dataSource.slice(newStartIndex,newEndIndex);return data},getCount:function(){return this.getCurrBlock().length},getTotalCount:function(){return this.TOTAL_DATA_COUNT},reload:function(){this.init()}};var DateFormatUtil=function(){return null!=DateFormatUtil.instance?DateFormatUtil.instance:(this.getDate=function(date,style){var format=null;return style==DateStyle.BASIC?format="es"==LineConfig.LOCALE?"h:mm a":"a h:mm":style==DateStyle.NOYEAR?format=DateFormatUtil.DATE_NOYEAR:style==DateStyle.YEAR?format=DateFormatUtil.DATE_YEAR:style==DateStyle.DAY?format=DateFormatUtil.DATE_DAY:style==DateStyle.FULL?format=DateFormatUtil.DATE_FULL:style==DateStyle.CHAT_ROOM&&(format="es"==LineConfig.LOCALE?"E, d/M":"M. d (E)"),new SimpleDateFormat(format,LineConfig.LOCALE).format(date)},this.isSameDay=function(date1,date2){return date1.getFullYear()==date2.getFullYear()&&date1.getMonth()==date2.getMonth()&&date1.getDay()==date2.getDay()},this.isToday=function(timestamp){var date=new Date(timestamp);return this.isSameDay(date,new Date)},this.isSameYear=function(timestamp){var date=new Date(timestamp);return date.getFullYear()==date.getFullYear()},this.is7DaysAgo=function(timestamp){var flag=!1,date=new Date(timestamp),aWeekAgoDate=new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()-7);return date.getTime()-aWeekAgoDate.getTime()>0&&(flag=!0),flag},this.getChatRoomDateFormat=function(timestamp){return this.formatToTime(timestamp,DateStyle.BASIC)},this.getChatRoomDateDivisionFormat=function(timestamp){return this.formatToTime(timestamp,DateStyle.CHAT_ROOM)},this.getSyncTimeDateFormat=function(timestamp){return this.formatToTime(timestamp,DateStyle.FULL)},this.getChatListDateFormat=function(timestamp){return this.isToday(timestamp)?this.formatToTime(timestamp,DateStyle.BASIC):this.isSameYear(timestamp)&&this.is7DaysAgo(timestamp)?this.formatToTime(timestamp,DateStyle.DAY):void 0},void(this.formatToTime=function(timestamp,style){return LineConfig.LOCALE.indexOf("en")>-1&&style===DateStyle.BASIC?new SimpleDateFormat("h:mm a",LineConfig.LOCALE).format(new Date(timestamp)):this.getDate(new Date(timestamp),style)}))};DateFormatUtil.getInstance=function(){return null==DateFormatUtil.instance&&(DateFormatUtil.instance=new DateFormatUtil),DateFormatUtil.instance},DateFormatUtil.instance=null,DateFormatUtil.DATE_FULL="yy. M. d h:mm",DateFormatUtil.DATE_BASIC="a h:mm",DateFormatUtil.DATE_NOYEAR="M. d",DateFormatUtil.DATE_YEAR="yy. M. d",DateFormatUtil.CHAT_ROOM="M. d (E)",DateFormatUtil.DATE_DAY="E",DateFormatUtil.MILLIS_PER_SECOND=1e3,DateFormatUtil.MILLIS_PER_MINUTE=60*DateFormatUtil.MILLIS_PER_SECOND,DateFormatUtil.MILLIS_PER_HOUR=60*DateFormatUtil.MILLIS_PER_MINUTE,DateFormatUtil.MILLIS_PER_DAY=24*DateFormatUtil.MILLIS_PER_HOUR;var DateStyle={BASIC:0,NOYEAR:1,YEAR:2,DAY:3,FULL:4,CHAT_ROOM:5},Debugger=null,DebugManager=function(filePath){this.init(filePath)};DebugManager.prototype={init:function(filePath){this.data={},this.data.isDebugMode=!1,this.data.HOSTS={},this.filePath=filePath,this.sdcard=navigator.getDeviceStorage("sdcard"),this.sdcard.addEventListener("change",$.proxy(function(event){var path=(event.reason,event.path);path.indexOf(filePath)>-1&&this.updateConfig()},this)),this.updateConfig()},updateConfig:function(){var self=this;this.sdcard=navigator.getDeviceStorage("sdcard");var request=this.sdcard.get(this.filePath);request.onsuccess=function(){var file=this.result,reader=new FileReader;reader.onload=$.proxy(function(e){var str=e.target.result;self.data={},_.extend(self.data,JSON.parse(str)),self.data.isDebugMode?$("body").append("<div id='debug_mode' style='position:absolute;bottom:0;right:0;background-color: red;color:white;font-weight:bold;'>Debug Mode</div>"):$("#debug_mode").remove(),ServerInfo.isDebugMode=self.data.isDebugMode,ServerInfo.DebugHost=self.data.HOSTS,ServerInfo.DebugPort=self.data.PORTS;var DebugInfo={isDebugMode:ServerInfo.isDebugMode,DebugHost:ServerInfo.DebugHost,DebugPort:ServerInfo.DebugPort};SettingProxy.getInstance().debugMode(DebugInfo),ProfileProxy.getInstance().debugMode(DebugInfo),ContactProxy.getInstance().debugMode(DebugInfo),GroupProxy.getInstance().debugMode(DebugInfo),ChatProxy.getInstance().debugMode(DebugInfo),OperationPoller.getInstance().debugMode(DebugInfo)},this),reader.readAsText(file)}},isDebugging:function(){return this.data.isDebugMode||!1}};var FileDownloader=function(){return null!=FileDownloader.instance?FileDownloader.instance:void this.init()};FileDownloader.prototype={init:function(){},getChatImageURL:function(oid,callback,onFail){this.getImageURL(oid,"r.620x320",callback,onFail)},getChatPreviewImageURL:function(oid,callback,onFail){this.getImageURL(oid,"preview",callback,onFail)},getImageURL:function(oid,type,callback,onFail){onFail=onFail?onFail:function(){};var tid=type?type:"",params={oid:oid,tid:tid,r:""},authToken=AuthInfoKeeper.getInstance().getAuthToken();this.httpClient=HttpClientFactory.createOBSChatImageDownloadHttpClient(authToken,params);var xreq=this.httpClient.getXHRObj();xreq.responseType="arraybuffer",xreq.onreadystatechange=function(xhr){if(4==xreq.readyState)if(200==xreq.status||0===xhr.status){var url=URL.createObjectURL(new Blob([xhr.target.response],{type:"image/jpeg"}));callback(url)}else onFail()},xreq.send()}},FileDownloader.getChatObjectInfoByOid=function(oid,callback){this.httpClient=HttpClientFactory.createOBSChatObjectInfoHttpClient(AuthInfoKeeper.getInstance().getAuthToken(),{});var xreq=this.httpClient.getXHRObj();xreq.responseType="json",xreq.onreadystatechange=function(xhr){4==xreq.readyState&&(200==xreq.status||0===xhr.status)&&callback(xhr.target.response)},xreq.send("oid="+oid)},FileDownloader.getGroupProfileObjectInfoByOid=function(oid,callback){this.httpClient=HttpClientFactory.createOBSGroupProfileObjectInfoHttpClient(AuthInfoKeeper.getInstance().getAuthToken(),{});var xreq=this.httpClient.getXHRObj();xreq.responseType="json",xreq.onreadystatechange=function(xhr){4==xreq.readyState&&(200==xreq.status||0===xhr.status)&&callback(xhr.target.response)},xreq.send("oid="+oid)},FileDownloader.getInstance=function(){return null==FileDownloader.instance&&(FileDownloader.instance=new FileDownloader),FileDownloader.instance},FileDownloader.instance=null;var FileUploader=function(){this.init()};FileUploader.prototype={init:function(){this.status=0,this.contentType="multipart/form-data",this.segments=[],this.onProgressCallback=function(){}},createBoundary:function(){return"---------------------------"+Date.now().toString(16)},onProgress:function(callback){this.onProgressCallback=callback},bindProgressEvent:function(){var oAjaxReq=this.httpClient.getXHRObj(),self=this,onProgressCallback=function(e){var done=e.position||e.loaded,total=e.totalSize||e.total,percent=Math.floor(done/total*1e3)/10;self.updateUploadTimeout(),self.onProgressCallback({percentage:percent,done:done,total:total})};oAjaxReq.onprogress=function(){oAjaxReq.onprogress=onProgressCallback},oAjaxReq.upload&&(oAjaxReq.upload.onprogress=onProgressCallback)},resetUploadTimeout:function(){clearTimeout(this.uploadTimeoutTimer)},updateUploadTimeout:function(){this.resetUploadTimeout();var self=this;this.uploadTimeoutTimer=setTimeout(function(){self.options.error&&self.options.error()},LineConfig.UPLOAD_TIMEOUT_INTERVAL)},setParam:function(params){var defaultParams={ver:"1.0",type:"",name:"",quality:"70"};_.extend(defaultParams,params),defaultParams.name=parseInt((new Date).getTime()/1e3,10)+"",this.segments.push('Content-Disposition: form-data; name="params"\r\n\r\n'+JSON.stringify(defaultParams)+"\r\n")},submitRequest:function(imageArrayBuffer){var blob=new Blob([imageArrayBuffer],{type:this.options.imageType}),fileReader=new FileReader;fileReader.onload=$.proxy(function(e){this.resetUploadTimeout();var segmentIdx=this.segments.length;this.segments.push('Content-Disposition: form-data; name="Filedata"; filename="upload_image"\r\nContent-Type: '+this.options.imageType+"\r\n\r\n"),this.segments[segmentIdx]+=e.target.result+"\r\n",this.submitData(this)},this),fileReader.readAsBinaryString(blob)},initHttpClient:function(authToken,type,oid){type===FileUploader.PROFILE?this.httpClient=HttpClientFactory.createOBSProfileUploadHttpClient(authToken,oid):type===FileUploader.GROUP_PROFILE?this.httpClient=HttpClientFactory.createOBSGroupProfileUploadHttpClient(authToken,oid):type===FileUploader.CHAT_IMAGE&&(this.httpClient=HttpClientFactory.createOBSChatImageUploadHttpClient(authToken,oid))},submitData:function(oData){XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=function(sData){for(var nBytes=sData.length,ui8Data=new Uint8Array(nBytes),nIdx=0;nBytes>nIdx;nIdx++)ui8Data[nIdx]=255&sData.charCodeAt(nIdx);this.send(ui8Data)});var oAjaxReq=this.httpClient.getXHRObj();oAjaxReq.submittedData=oData;var sBoundary=this.createBoundary();this.bindProgressEvent(),oAjaxReq.setRequestHeader("Content-Type","multipart/form-data; boundary="+sBoundary),oAjaxReq.sendAsBinary("--"+sBoundary+"\r\n"+oData.segments.join("--"+sBoundary+"\r\n")+"--"+sBoundary+"--\r\n")},extendOptions:function(options){this.options=_.extend({authToken:null,oid:null,imageName:"",imageType:"image/jpeg",imageQuality:LineConfig.UPLOAD_IMAGE_QUALITY,imageArrayBuffer:null,complete:function(){},error:function(){},progress:function(){}},options),this.setParam({oid:this.options.oid,type:"image",name:this.options.imageName,quality:LineConfig.UPLOAD_IMAGE_QUALITY}),this.onProgressCallback=this.options.progress},uploadProfileImage:function(options){this.extendOptions(options),this.initHttpClient(this.options.authToken,FileUploader.PROFILE,this.options.oid),this.httpClient.getXHRObj().onload=$.proxy(function(result){this.resetUploadTimeout(),this.options.complete(result)},this),this.httpClient.getXHRObj().onerror=$.proxy(function(result){this.resetUploadTimeout(),this.options.error(result)},this),this.submitRequest(this.options.imageArrayBuffer)},uploadGroupProfileImage:function(options){this.extendOptions(options),this.initHttpClient(this.options.authToken,FileUploader.GROUP_PROFILE,this.options.oid),this.httpClient.getXHRObj().onload=$.proxy(function(result){this.resetUploadTimeout(),this.options.complete(result)},this),this.httpClient.getXHRObj().onerror=$.proxy(function(result){this.resetUploadTimeout(),this.options.error(result)},this),this.submitRequest(this.options.imageArrayBuffer)},uploadChatImage:function(options){this.extendOptions(options),this.initHttpClient(this.options.authToken,FileUploader.CHAT_IMAGE,this.options.oid),this.httpClient.getXHRObj().onload=$.proxy(function(result){this.resetUploadTimeout(),this.options.complete(result)},this),this.httpClient.getXHRObj().onerror=$.proxy(function(result){this.resetUploadTimeout(),this.options.error(result)},this),this.submitRequest(this.options.imageArrayBuffer)}},FileUploader.PROFILE=1,FileUploader.GROUP_PROFILE=2,FileUploader.CHAT_IMAGE=3,FileUploader.STATUS={},FileUploader.STATUS.UPLOADING=1,FileUploader.STATUS.FAIL=2,FileUploader.STATUS.COMPLETE=3;var LineNetworkExceptionHandler=function(){return null!=LineNetworkExceptionHandler.instance?LineNetworkExceptionHandler.instance:void 0};LineNetworkExceptionHandler.prototype={handle:function(){NetworkChecker.getInstance().setState("offline"),alert($.i18n.prop("NETWORK_ERROR_INFO")),DimmedUI.getInstance().close(),ConfirmUI.getInstance().close()},serverError:function(){alert($.i18n.prop("E_UNKNOWN"))},unknownError:function(errNo){alert($.i18n.prop("UNKNOWN_ERROR")+" : "+errNo)}},LineNetworkExceptionHandler.getInstance=function(){return null==LineNetworkExceptionHandler.instance&&(LineNetworkExceptionHandler.instance=new LineNetworkExceptionHandler),LineNetworkExceptionHandler.instance},LineNetworkExceptionHandler.instance=null;var LineTalkExceptionHandler=function(){return null!=LineTalkExceptionHandler.instance?LineTalkExceptionHandler.instance:void 0};LineTalkExceptionHandler.prototype={handle:function(ex){var code=null,codeValue=null,reason=null,err=ex[0],errMethodName=ex[1];switch(code=err.code,codeValue=LineTalkExceptionHandler.getErrorCodeValue(code),reason=err.reason,code){case ErrorCode.NOT_AUTHORIZED_DEVICE:case ErrorCode.NOT_AVAILABLE_USER:case ErrorCode.AUTHENTICATION_FAILED:AlertUI.getInstance().open({message:$.i18n.prop("INVALID_AUTH_ERROR_TEXT"),button:{label:$.i18n.prop("CLOSE"),callback:function(){AppCleaner.getInstance().clear()}}});break;case ErrorCode.INTERNAL_ERROR:break;case ErrorCode.ILLEGAL_ARGUMENT:break;case ErrorCode.INVALID_IDENTITY_CREDENTIAL:break;case ErrorCode.INVALID_LENGTH:break;case ErrorCode.INVALID_PIN_CODE:break;case ErrorCode.NOT_AVAILABLE_PIN_CODE_SESSION:break;case ErrorCode.NOT_AVAILABLE_IDENTITY_IDENTIFIER:break;case ErrorCode.NOT_AVAILABLE_SESSION:break;case ErrorCode.NOT_FOUND:break;case ErrorCode.EXCESSIVE_ACCESS:break;case ErrorCode.NOT_A_MEMBER:break;default:alert("# [TalkException]-"+errMethodName+" # code("+code+") = "+codeValue+", reason = "+reason+", reqTime = "+new Date)}}},LineTalkExceptionHandler.getInstance=function(){return null==LineTalkExceptionHandler.instance&&(LineTalkExceptionHandler.instance=new LineTalkExceptionHandler),LineTalkExceptionHandler.instance},LineTalkExceptionHandler.instance=null,LineTalkExceptionHandler.getErrorCodeValue=function(code){for(var key in ErrorCode)if(ErrorCode[key]==code)return key};var ListView=function(listViewInfo){_.extend(this,listViewInfo),this.cursor=0,this.totalDataCount=this.dataSource.getRealDataCount(),this.totalPageSize=Math.ceil(this.totalDataCount/this.dataSource.cacheBlockSize),this.topOffset=this.wrapper.offset().top,this.itemHeight=50,this.wrapper.height(this.totalDataCount*this.itemHeight+$("#footer").height()),this.initList();$(window).height();$(document).on("scroll",$.proxy(function(){var scrollPos=$(window).scrollTop();scrollPos>this.preNextLoadPos&&this.next()},this))};ListView.prototype={initList:function(){var pannels=this.wrapper.find("ul").children(),renderData={dataList:this.dataSource.getCurrBlock()},html=this.createItem(renderData);$(pannels[0]).html(html);for(var i=1;2>=i;i++){var renderData={dataList:this.dataSource.nextDataBlock()},html=this.createItem(renderData);$(pannels[i]).html(html)}this.preNextLoadPos=$("#change_block").offset().top+$($("#change_block").children()[0]).height()},prev:function(){this.cursor--;var pannels=this.wrapper.find("ul").children();$("#head_buffer").height($("#head_buffer").height()-$(pannels[2]).height()),$(pannels[2]).remove();var renderData={dataList:this.dataSource.prevDataBlock()},html=this.createItem(renderData);this.wrapper.find("ul").prepend("<li>"+html+"</li>"),this.preNextLoadPos=this.preNextLoadPos-1020},refresh:function(){({dataList:this.dataSource.getCurrBlock()})},next:function(){if(this.cursor>=this.totalPageSize)return!1;this.cursor++;var pannels=this.wrapper.find("ul").children();$("#head_buffer").height($("#head_buffer").height()+$(pannels[0]).height()),$(pannels[0]).remove();var renderData={dataList:this.dataSource.nextDataBlock()},html=this.createItem(renderData);this.wrapper.find("ul").append("<li>"+html+"</li>"),this.preNextLoadPos=this.preNextLoadPos+1020},createItem:function(data){return Mustache.render(this.template,data)}};var Logger={level:LineConfig.PHASE};Logger.infoLog=[],Logger.log=function(msg){Logger.infoLog.push(msg)},Logger.startTime=function(name){},Logger.endTime=function(name){},Logger.clear=function(){Logger.infoLog=[],Logger.infoLog.length=0},Logger.flush=function(){if("BETA"==Logger.level);else{var fileJobWorker=new JobWorkor("src/worker/fileJob.js");fileJobWorker.sendQuery("writeLog",Logger.infoLog)}Logger.clear()};var MCC_REFERENCE_LOCATION=BASE_DEFAULT+"res/mcc_code.txt",COUNTRY_REFERENCE_LOCATION=BASE_DEFAULT+"res/src_main_resources_countries.txt",ResourceLoader=function(){return null!=ResourceLoader.instance?ResourceLoader.instance:(this.mccInfoReference=null,void(this.countryInfoReference=null))};ResourceLoader.prototype={loadCountryInfoReference:function(){var referenceText=ResourceLoader.loadFile(COUNTRY_REFERENCE_LOCATION);this.countryInfoReference=ResourceLoader.parseCountryInfo(referenceText)},loadMccInfoReference:function(){var referenceText=ResourceLoader.loadFile(MCC_REFERENCE_LOCATION);this.mccInfoReference=ResourceLoader.parseMccInfo(referenceText)},getAllCountryInfo:function(){return null===this.countryInfoReference&&this.loadCountryInfoReference(),_.sortBy(this.countryInfoReference.countryCodeReference,function(o){return o.priority})},getAllMccInfo:function(){return _.sortBy(this.mccInfoReference.mccInfoReference,function(o){return o.priority})},getCountryInfoByCountryNo:function(countryNo){return null===this.countryInfoReference&&this.loadCountryInfoReference(),this.countryInfoReference.countryNoReference[countryNo]},getCountryInfoByCountryCode:function(ccode){return null===this.countryInfoReference&&this.loadCountryInfoReference(),this.countryInfoReference.countryCodeReference[ccode]},getMccInfoByMccNo:function(mccNo){return null===this.mccInfoReference&&this.loadMccInfoReference(),this.mccInfoReference.mccInfoReference[mccNo]},getMccInfoByCountryCode:function(ccode){return null===this.mccInfoReference&&this.loadMccInfoReference(),this.mccInfoReference.countryCodeReference[ccode]}},ResourceLoader.loadFile=function(url,type){var data="";return $.ajax({url:url,data:{bust:(new Date).getTime()},async:!1,cache:!0,dataType:type?type:"text",success:function(result){data=result},error:function(errorMsg){}}),data},ResourceLoader.parseCountryInfo=function(data){var mccCodeLists=data.split("\n"),countryNoReference={},countryCodeReference={};return _.each(mccCodeLists,function(val,key){if(""!==val){var aResult=val.split("	"),countryCode=aResult[0],countryNo=aResult[1];countryCodeReference[countryCode]=countryNoReference[countryNo]={countryNo:countryNo,countryCode:countryCode,countryName:aResult[2],priority:key}}}),{countryNoReference:countryNoReference,countryCodeReference:countryCodeReference}},ResourceLoader.parseMccInfo=function(data){var mccCodeLists=data.split("\n"),mccReference={},countryCodeReference={};return _.each(mccCodeLists,function(val,key){if(""!==val){var aResult=val.split("	"),mccNumber=aResult[0],countryCode=aResult[1];
countryCodeReference[countryCode]=mccReference[mccNumber]={mccNo:mccNumber,countryCode:countryCode,countryName:aResult[2],priority:key}}}),{mccInfoReference:mccReference,countryCodeReference:countryCodeReference}},ResourceLoader.getInstance=function(){return null==ResourceLoader.instance&&(ResourceLoader.instance=new ResourceLoader),ResourceLoader.instance},ResourceLoader.instance=null;var TemplateManager=function(){return null!=TemplateManager.instance?TemplateManager.instance:void 0};TemplateManager.prototype={templateList:[],get:function(template_path){var templateKey=_.first(_.last(template_path.split("/")).split("."));if(templateKey&&this.templateList[templateKey])return this.templateList[templateKey];var sTemplate=ResourceLoader.loadFile(template_path),html=_.template(sTemplate,Zepto.i18n.map);return this.templateList[templateKey]=html,html}},TemplateManager.getInstance=function(){return null==TemplateManager.instance&&(TemplateManager.instance=new TemplateManager),TemplateManager.instance},TemplateManager.instance=null;var timers={};console.time=function(id){timers[id]=(new Date).getTime()},console.timeEnd=function(id){var start=timers[id];if(start){{id+": "+((new Date).getTime()-start)+"ms"}delete timers[id]}};var Utility;Utility={timerId:null,serialize:function(object){var retObj={};for(var key in object)object[key]instanceof Function!=!0&&(retObj[key]=object[key]instanceof Object==!0&&object[key]instanceof Array==!1&&object[key]instanceof ArrayBuffer==!1?Utility.serialize(object[key]):object[key]);return retObj},isValidEmail:function(emailStr){var mailFormat=/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;return emailStr.match(mailFormat)?!0:!1},isSystemKey:function(e){var key=e.charCode||e.keyCode||0;return 8==key||9==key||46==key||110==key||190==key},setOnlyNumber:function(targetElement){targetElement.val()!==targetElement.val().replace(/[^0-9]/g,"")&&targetElement.val(targetElement.val().replace(/[^0-9]/g,""))},Timer:function(limitSeconds,callBack){clearInterval(Utility.timerId);var limitTime=1e3*limitSeconds,endTime=new Date((new Date).getTime()+limitTime+100),result="",tick=function(){var currentDate=new Date,leaveTime=endTime-currentDate.getTime(),percent=100-leaveTime/limitTime*100,leaveDate=new Date(leaveTime);return 0>=leaveTime||"clear"===result?(percent=100,endTime=currentDate.getTime(),void clearInterval(Utility.timerId)):void(result=callBack(percent,leaveDate))};Utility.timerId=setInterval(tick,1e3),tick()},padZeroNumber:function(n,width,z){return z=z||"0",n+="",n.length>=width?n:new Array(width-n.length+1).join(z)+n},combineProfileURL:function(contact,size,type){var path="res/img/noimg/profile_img56x56.png";if(90===size&&(path="res/img/noimg/profile_img90x90.png"),contact){var picturePath=contact.picturePath,pictureStatus=contact.pictureStatus;picturePath&&"myProfile"===type&&AuthInfoKeeper.getInstance().getAuthMid()?path="http://"+ServerInfo.getInstance().getOBSHost()+"/talk/p/download.nhn?ver=1.0&oid="+AuthInfoKeeper.getInstance().getAuthMid()+"&tid=preview.wap&r="+pictureStatus:contact.mid&&pictureStatus&&(path="http://"+ServerInfo.getInstance().getOBSHost()+"/talk/p/download.nhn?ver=1.0&tid=preview.wap&oid="+contact.mid+"&r="+pictureStatus,picturePath.indexOf("http://")>-1&&(path=picturePath))}return path},combineSettingProfileURL:function(profile,size){size||(size=90);var path=["/res/img/noimg/profile_img",size,"x",size,".png"].join("");return profile&&profile.pictureStatus&&AuthInfoKeeper.getInstance().getAuthMid()&&(path="http://"+ServerInfo.getInstance().getOBSHost()+"/talk/p/download.nhn?ver=1.0&oid="+AuthInfoKeeper.getInstance().getAuthMid()+"&tid=preview.wap&r="+profile.pictureStatus),path},groupProfileURL:function(groupInfo,size){var path="";if(size||(size=90),groupInfo){{var pictureStatus=groupInfo.pictureStatus;groupInfo.id}path=null!=pictureStatus&&""!=pictureStatus?"http://"+ServerInfo.getInstance().getGCDNOBSHost()+"/"+pictureStatus+"/preview":["/res/img/noimg/group_profile_img",size,"x",size,".png"].join("")}return path},combineChatURL:function(messageBo){var path="res/img/noimg/profile_img56x56.png";return messageBo&&(path="http://"+ServerInfo.getInstance().getOBSHost()+"/talk/m/download.nhn?ver=1.0&oid="+messageBo.chatId+"&tid=preview&r="+messageBo.message.id),path},roomProfileURL:function(){return"res/img/noimg/room_profile_img56x56.png"},makeDisplayNameForUser:function(contact){return 0!=!!contact?contact.printName:void 0},makeDisplayNameForRoom:function(contacts){for(var dpNames=[],i=0;i<contacts.length;i++){var contact=ContactProxy.getInstance().getContactFromLocal(contacts[i].mid);if(null==contact){var dpName=contacts[i].printName||contacts[i].displayName;dpNames.push(dpName)}else{var dpn=contact.printName||contact.displayName;""!=dpn&&dpNames.push(dpn)}}var retStr="";return retStr=dpNames.length>0?dpNames.length>1?dpNames.join(", "):dpNames:$.i18n.prop("NO_MEMBER")},makeDisplayNameForGroup:function(chatBo){var dpName=chatBo.groupInfo.name;return 1==chatBo.isKickoutStatus&&(dpName=$.i18n.prop("NO_MEMBER")),dpName},makeDisplayNameForMids:function(mids){for(var dpNames=[],i=0;i<mids.length;i++){var contact=ContactProxy.getInstance().getContactFromLocal(mids[i]);if(null!=contact){var dpn=contact.printName;""!=dpn&&dpNames.push(dpn)}}return dpNames.length>0?dpNames.join(", "):$.i18n.prop("NO_MEMBER")},makeRoomMemeberCount:function(contacts){return contacts.length},getSystemLanguage:function(){return navigator.mozL10n?navigator.mozL10n.language.code:navigator.language},initPressedEvent:function(){var contentBody=$("body"),pressedClass=null;contentBody.off(UIStructure.EVENT_TOUCH).on(UIStructure.EVENT_TOUCH,"*[data-pressed-class]",function(e){if(e.currentTarget){var target=$(e.currentTarget);if(target.hasClass(target.attr("data-disabled-class")))return!1;pressedClass=target.attr("data-pressed-class"),target.addClass(pressedClass)}}),$(document).off(UIStructure.EVENT_RELEASE).on(UIStructure.EVENT_RELEASE,function(){$("."+pressedClass).removeClass(pressedClass)})},imageLoad:function($el,fn){$el.on("load",fn),$el.each(function(){this.complete&&0!==this.naturalWidth&&$(this).trigger("load")})},getRequest:function(url,resType,callback){var xhr=new XMLHttpRequest;xhr.open("GET",url,!0),xhr.responseType=resType,xhr.onreadystatechange=function(){if(xhr.readyState==xhr.DONE){var res=xhr.response;callback(res)}},xhr.send()},getArrayBufferByUrl:function(url,callback){try{Utility.getRequest(url,"arraybuffer",callback)}catch(e){callback(!1)}},getBlobByUrl:function(url,callback){Utility.getRequest(url,"blob",callback)},resourcePreLoader:function(type,url){"img"==type&&(img=new Image,img.src=url)},seperateString:function(str,seperator){return str?str.split(seperator):[]},escapeString:function(originText){var retString=originText.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\r\n]/g,"<br>");return retString},unescapeString:function(){var retString=originText.replace(/&lt;/g,"<").replace(/&gt;/g,">");return retString},preferLanguage:function(countryCode){var langCode=[],defaultLanguage="en";langCode.en=["US","UK"],langCode.ja=["JP"],langCode.ko=["KR"],langCode["zh-hans"]=["CN"],langCode["zh-hant"]=["TW"];for(var code in langCode)if(result=_.find(langCode[code],function(val){return val===countryCode}))return code;return defaultLanguage},getSystemLocale:function(){return LineConfig.LOCALE},initI18nProperties:function(){var mozL10n=navigator.mozL10n;if(1==!!mozL10n){var code=mozL10n.language.code;code.indexOf("en")>-1&&(code="en"),LineConfig.LOCALE=code}Zepto.i18n.properties({name:"firefoxOS",path:"res/locales/",language:LineConfig.LOCALE,mode:"map"})},lazyLoadImage:function(imgArr){return 0===imgArr.length?!1:void _.each(imgArr,function(img){var img=$(img),tempImg=new Image,src=img.attr("data-src");return src?(tempImg.onload=function(){img.attr("src",src)},void(tempImg.src=src)):!1})},getSDCardStatus:function(callback){var sdcard=navigator.getDeviceStorage("sdcard"),available=sdcard.available();available.onsuccess=function(){callback.apply(callback,[this.result])},available.onerror=function(){alert($.i18n.prop("SD_CARD_STORAGE_FAIL_UNKNOWN_ERROR")),DimmedUI.getInstance().close()}},getSDCardFreeSpace:function(callback){var sdcard=navigator.getDeviceStorage("sdcard"),freeSpace=sdcard.freeSpace();freeSpace.onsuccess=function(){var size=this.result;callback.apply(callback,[size])},freeSpace.onerror=function(){alert($.i18n.prop("SD_CARD_STORAGE_FAIL_UNKNOWN_ERROR")),callback.apply(callback,[""])}},autoLink:function(text){str=text,out="",url="",i=0;do url=str.match(/((https?:\/\/)?([a-z\-]+\.)*[\-\w]+(\.[a-z]{2,4})+(\/[\w\_\-\?\=\&\.]*)*(?![a-z]))/i),null!=url?(href=url[0],"http://"!=href.substr(0,7)&&(href="http://"+href),where=str.indexOf(url[0]),out+=str.substr(0,where),out+='<a href="'+href+'" target="_blank">'+url[0]+"</a>",str=str.substr(where+url[0].length)):(out+=str,str="");while(str.length>0);return out}};var escaper=/\\|'|\r|\n|\t|\u2028|\u2029/g,escapes={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"};_.template=function(text,data,settings){settings=_.defaults({},settings,_.templateSettings);var matcher=new RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g"),index=0,source="";return text.replace(matcher,function(match,escape,interpolate,evaluate,offset){return source+=text.slice(index,offset),escape&&(source+=$.i18n.prop($.trim(escape))),interpolate&&(source+=$.i18n.prop($.trim(interpolate))),evaluate&&(source+=$.i18n.prop($.trim(evaluate))),index=offset+match.length,match}),source};var ActivityHelper=function(options){window.MozActivity=window.MozActivity||void 0;var type=options.type||"pick",dataType=options.dataType||["image/*","image/jpeg"],onSuccess=(options.imageQuality||LineConfig.UPLOAD_IMAGE_QUALITY,options.success||function(){});if(!window.MozActivity){var inputObj=document.createElement("input");return inputObj.type="file",void $(inputObj).on("change",function(){var files=this.files;return files[0].size>=LineConfig.FILE_UPLOAD_LIMIT?void alert($.i18n.prop("LIMIT_SEND_IMAGE_SIZE")):void options.success(files[0])}).trigger("click")}var activity=new MozActivity({name:type,data:{type:dataType}});activity.onsuccess=function(){var picture=this.result;return picture.blob.size>=LineConfig.FILE_UPLOAD_LIMIT?void alert($.i18n.prop("LIMIT_SEND_IMAGE_SIZE")):void onSuccess(picture.blob)},activity.onerror=function(){}};ActivityHelper.getPhotoWithOptimizedQuality=function(image,type,quality,callback){{var img=new Image,elCanvas=document.createElement("canvas"),elCanvas2=document.createElement("canvas"),ctx=elCanvas.getContext("2d");elCanvas2.getContext("2d")}img.src=URL.createObjectURL(image.blob),img.onload=function(){resizeImg(elCanvas,img),ctx.drawImage(img,0,0,img.width,img.height),elCanvas.toBlob(function(blob){callback(blob)},type,LineConfig.UPLOAD_IMAGE_QUALITY/100)};var resizeImg=function(target,img){$(target).attr("width",img.width).attr("height",img.height)}};var AuthInfoKeeper=function(){return null!=AuthInfoKeeper.instance?AuthInfoKeeper.instance:(this.authToken=null,this.phoneNumber=null,this.isoCode=null,this.sessionData=null,this.mcc=0,void(this.mnc=0))};AuthInfoKeeper.prototype={setAuthToken:function(authToken){null==this.authToken?(this.authToken=authToken,AuthPersistentStore.getInstance().setAuthToken(authToken)):(alert($.i18n.prop("ANOTHER_DEVICE_IS_REGISTERED_WITH_SAME_PHONE_NUMBER_ERROR_TEXT")),this.authToken=null,AuthPersistentStore.getInstance().setAuthToken(null),LineMain.getInstance().changeScreen({screen:LineMain.MAIN_SCREEN_TYPE.REGISTER,subScreen:LineMain.SUB_SCREEN_TYPE.REGISTER_NEW_LINE}))},getAuthToken:function(){return this.authToken||AuthPersistentStore.getInstance().getAuthToken()},setPhoneNumber:function(phoneNumber){AuthPersistentStore.getInstance().setPhoneNumber(phoneNumber),this.phoneNumber=phoneNumber},getPhoneNumber:function(){return this.phoneNumber||AuthPersistentStore.getInstance().getPhoneNumber()},setISOCode:function(isoCode){null==this.isoCode&&(AuthPersistentStore.getInstance().setISOCode(isoCode),this.isoCode=isoCode)},getISOCode:function(){return this.isoCode||AuthPersistentStore.getInstance().getISOCode()},getAuthMid:function(){return null!==this.getAuthToken()?this.getAuthToken().split(":")[0]:null},setSessionData:function(sessionData){AuthPersistentStore.getInstance().setSessionData(sessionData),this.sessionData=sessionData},getSessionData:function(){return this.sessionData||AuthPersistentStore.getInstance().getSessionData()},removeAll:function(){AuthPersistentStore.getInstance().clear(),this.authToken=null,this.phoneNumber=null,this.isoCode=null},getSessions:function(){},setMCCMNC:function(){var conn=navigator.mozMobileConnection;if(1==!!conn){var network=(conn.lastKnownHomeNetwork||conn.lastKnownNetwork||"-").split("-");this.mcc=network[0],this.mnc=network[1]}else if(1==!!navigator.mozMobileConnections)for(var i=0;i<navigator.mozMobileConnections.length;i++){var connData=conn[i].data;1==!!connData&&1==!!connData.network&&(this.mcc=connData.network.mcc,this.mnc=connData.network.mnc)}},getMNC:function(){return this.mnc},getMCC:function(){return this.mcc},getMCCMNC:function(){return this.getMCC()+""+this.getMNC()}},AuthInfoKeeper.getInstance=function(){return null===AuthInfoKeeper.instance&&(AuthInfoKeeper.instance=new AuthInfoKeeper),AuthInfoKeeper.instance},AuthInfoKeeper.instance=null;var RegisterStepInfoKeeper=function(){return null!=RegisterStepInfoKeeper.instance?RegisterStepInfoKeeper.instance:void this.initProperty()};RegisterStepInfoKeeper.prototype={initProperty:function(){this.isNewUser=!0,this.applicationInitialized=null,this.authorized=null,this.accountInitialized=null,this.userInputPhoneNumber=null,this.verifyPhoneResult=null,this.userInputPhoneNumber=null,this.userInputEmail=null,this.userInputEmailPassword=null,this.userInputDisplayName=null,this.userInputPhoneNumber=null,this.emailAccountInitialized=null,this.region=null,this.allowOtherToAdd=null,this.emailIgnoreDuplication=null,this.shownEmailRegister=null,this.emailConfirmationSession={},this.phonePincodeSessionStartTime=null,this.phonePincodeResendFlag=null},setPhonePinCodeResendFlag:function(flag){this.phonePincodeResendFlag=flag,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_PHONE_PINCODE_RESEND_FLAG,flag)},getPhonePinCodeResendFlag:function(){return null==this.phonePincodeResendFlag?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_PHONE_PINCODE_RESEND_FLAG):this.phonePincodeResendFlag},setPhonePinCodeSessionStartTime:function(time){this.phonePincodeSessionStartTime=time,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_PHONE_PINCODE_SESSION_START_TIME,time)},getPhonePinCodeSessionStartTime:function(){return null==this.phonePincodeSessionStartTime?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_PHONE_PINCODE_SESSION_START_TIME):this.phonePincodeSessionStartTime},setIgnoreDuplication:function(flag){this.emailIgnoreDuplication=flag,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_EMAIL_IGNORE_DUPLICATION,flag)},setShownEmailRegister:function(flag){this.shownEmailRegister=flag,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_EMAIL_REGISTER_SHOWN_FLAG,flag)},isShownEmailRegister:function(){return null==this.shownEmailRegister?!!PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_EMAIL_REGISTER_SHOWN_FLAG):!!this.shownEmailRegister},isIgnoreDuplication:function(){return null==this.emailIgnoreDuplication?!!PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_EMAIL_IGNORE_DUPLICATION):!!this.emailIgnoreDuplication},setAllowOtherToAdd:function(flag){this.allowOtherToAdd=flag,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_ALLOW_OTHER_TO_ADD,flag)},getAllowOtherToAdd:function(){return null==this.allowOtherToAdd?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_ALLOW_OTHER_TO_ADD):this.allowOtherToAdd},setDeviceId:function(deviceId){this.deviceId=deviceId,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_DEVICE_ID,deviceId)},getDeviceId:function(){return null==this.deviceId?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_DEVICE_ID):this.deviceId},setIsNewUser:function(flag){this.isNewUser=flag,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_IS_NEW_USER,flag)},getIsNewUser:function(){return null==this.isNewUser?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_IS_NEW_USER):this.isNewUser},setUserInputPhoneNumber:function(userInputPhoneNumber){this.userInputPhoneNumber=userInputPhoneNumber,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_USER_INPUT_PHONE_NUMBER,userInputPhoneNumber)},getUserInputPhoneNumber:function(){return null==this.userInputPhoneNumber?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_USER_INPUT_PHONE_NUMBER):this.userInputPhoneNumber},setUserInputDisplayName:function(displayName){this.userInputDisplayName=displayName,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_USER_INPUT_DISPLAY_NAME,displayName)},getUserInputDisplayName:function(){return null==this.userInputDisplayName?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_USER_INPUT_DISPLAY_NAME):this.userInputDisplayName},setEmailConfirmationSession:function(emailConfirmationSession){this.emailConfirmationSession=emailConfirmationSession,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_EMAIL_CONFIRMATION_SESSION,emailConfirmationSession)},getEmailConfirmationSession:function(){return this.emailConfirmationSession},getEmailConfirmationSessionVerifier:function(){return this.getEmailConfirmationSession().verifier},setApplicationInitialized:function(flag){this.applicationInitialized=flag,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_APPLICATION_INITIALIZED,flag)},isApplicationInitialized:function(){return null==this.applicationInitialized?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_APPLICATION_INITIALIZED):this.applicationInitialized},setAuthorized:function(flag){this.authorized=flag,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_AUTHORIZED,flag)},isAuthorized:function(){return null==this.authorized?!!PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_AUTHORIZED):!!this.authorized},setAccountInitialized:function(flag){this.accountInitialized=flag,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_ACCOUNT_INITIALIZED,flag)},isAccountInitialized:function(){return null==this.accountInitialized?!!PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_ACCOUNT_INITIALIZED):!!this.accountInitialized},setEmailAccountInitialized:function(flag){this.emailAccountInitialized=flag,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_EMAIL_ACCOUNT_INITIALIZED,flag)},isEmailAccountInitialized:function(){return null==this.emailAccountInitialized?!!PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_EMAIL_ACCOUNT_INITIALIZED):!!this.emailAccountInitialized},setUseMyContactList:function(flag){this.useMyContactList=flag,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_USE_MY_CONTACT_LIST_CONFIRM,flag)},isUseMyContactList:function(){return null==this.useMyContactList?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_USE_MY_CONTACT_LIST_CONFIRM):this.useMyContactList},getRegion:function(){return null==this.region?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_REGION):this.region},setRegion:function(countryCode){this.region=countryCode,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_REGION,countryCode)},setUserInputEmail:function(email){this.userInputEmail=email,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_USER_INPUT_EMAIL,email)},getUserInputEmail:function(){return null==this.userInputEmail?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_USER_INPUT_EMAIL):this.userInputEmail},setUserInputEmailPassword:function(password){this.userInputEmailPassword=password},getUserInputEmailPassword:function(){return null==this.userInputEmailPassword?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_USER_INPUT_EMAIL_PASSWORD):this.userInputEmailPassword},setVerifyPhoneResult:function(result){this.verifyPhoneResult=result,PersistentStore.getInstance().set(RegisterStepInfoKeeper.KEY_VERIFY_PHONE_RESULT,result)},getVerifyPhoneResult:function(){return null==this.verifyPhoneResult?PersistentStore.getInstance().get(RegisterStepInfoKeeper.KEY_VERIFY_PHONE_RESULT):this.verifyPhoneResult},clearLoginInfo:function(){this.userInputEmail=null,this.emailAccountInitialized=null,PersistentStore.getInstance().remove(RegisterStepInfoKeeper.KEY_EMAIL_ACCOUNT_INITIALIZED),PersistentStore.getInstance().remove(RegisterStepInfoKeeper.KEY_USER_INPUT_EMAIL)},removeAll:function(){this.initProperty();for(var key in RegisterStepInfoKeeper)/KEY_/.test(key)&&"KEY_DEVICE_ID"!==key&&/KEY_/.test(key)&&"KEY_USER_INPUT_PHONE_NUMBER"!==key&&/KEY_/.test(key)&&"KEY_REGION"!==key&&PersistentStore.getInstance().remove(RegisterStepInfoKeeper[key]);RegisterStepInfoKeeper.getInstance().setApplicationInitialized(!0)}},RegisterStepInfoKeeper.getInstance=function(){return null==RegisterStepInfoKeeper.instance&&(RegisterStepInfoKeeper.instance=new RegisterStepInfoKeeper),RegisterStepInfoKeeper.instance},RegisterStepInfoKeeper.instance=null,RegisterStepInfoKeeper.KEY_IS_NEW_USER="RS_isNewUser",RegisterStepInfoKeeper.KEY_APPLICATION_INITIALIZED="RS_applicationInitialized",RegisterStepInfoKeeper.KEY_AUTHORIZED="RS_authorized",RegisterStepInfoKeeper.KEY_ACCOUNT_INITIALIZED="RS_accountInitialized",RegisterStepInfoKeeper.KEY_EMAIL_ACCOUNT_INITIALIZED="RS_emailAccountInitialized",RegisterStepInfoKeeper.KEY_VERIFY_PHONE_RESULT="RS_verifyPhoneResult",RegisterStepInfoKeeper.KEY_USE_MY_CONTACT_LIST_CONFIRM="RS_useMyContactListConfirm",RegisterStepInfoKeeper.KEY_USER_INPUT_EMAIL="RS_userInputEmail",RegisterStepInfoKeeper.KEY_USER_INPUT_DISPLAY_NAME="RS_userInputDisplayName",RegisterStepInfoKeeper.KEY_USER_INPUT_PHONE_NUMBER="RS_userInputPhoneNumber",RegisterStepInfoKeeper.KEY_DEVICE_ID="RS_deviceId",RegisterStepInfoKeeper.KEY_ALLOW_OTHER_TO_ADD="RS_allowOtherToAdd",RegisterStepInfoKeeper.KEY_PHONE_PINCODE_RESEND_FLAG="RS_phonePincodeResendFlag",RegisterStepInfoKeeper.KEY_PHONE_PINCODE_SESSION_START_TIME="RS_phonePincodeSessionStartTime",RegisterStepInfoKeeper.KEY_EMAIL_REGISTER_SHOWN_FLAG="RS_emailRegisterShownFlag",RegisterStepInfoKeeper.KEY_EMAIL_IGNORE_DUPLICATION="RS_ignoreDuplication",RegisterStepInfoKeeper.KEY_USER_INPUT_EMAIL_PASSWORD="RS_userInputEmailPassword",RegisterStepInfoKeeper.KEY_EMAIL_CONFIRMATION_SESSION="RS_emailConfirmationSession",RegisterStepInfoKeeper.KEY_REGION="RS_region";var LinePushNotification={};LinePushNotification._referencesArray=[],LinePushNotification.isSetEvent=!1,LinePushNotification.pushEndPoint=localStorage.getItem("TK"),LinePushNotification.queue=[],LinePushNotification.startQueueFlag=!1,LinePushNotification.intervalValue=0,LinePushNotification.lastPushVersion=0,LinePushNotification.register=function(onSuccess){if(navigator.push){var reqPush=navigator.push.register();reqPush.onsuccess=function(event){LinePushNotification.pushEndPoint=event.target.result,onSuccess(LinePushNotification.pushEndPoint)}}},LinePushNotification.unRegister=function(){null!=LinePushNotification.pushEndPoint&&(navigator.push.unregister(LinePushNotification.pushEndPoint),LinePushNotification.pushEndPoint=null)},LinePushNotification.setMessageHandler=function(){navigator.mozSetMessageHandler&&(navigator.mozSetMessageHandler("push",LinePushNotification.onMessagePush),navigator.mozSetMessageHandler("notification",LinePushNotification.onMessageNotification))},LinePushNotification.onMessageNotification=function(message){message.pushEndpoint==LinePushNotification.pushEndPoint},LinePushNotification.onMessagePush=function(message){message.pushEndpoint==LinePushNotification.pushEndPoint&&0==OperationPoller.getInstance().isRunState&&OperationPoller.getInstance().enforceFetch()},LinePushNotification.showNotification=function(type,sender,notiText){var icon="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAACXBIWXMAABlgAAAZYAFm3TO7AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAENNJREFUeNrkm3mUFdWdxz/1ln69scgijSCuiEQiqGgAE4kJ0VETjYooOkYxmYzxTDxxH49EEz1K1FGTOCducxI0GXVgcBuXxDijMiyyiCLIoomAElAW2Zrufq/q/n7zR91bdev1a0QnKuekzqlTr6vqvXu/9/f97bcDVeVv6Sj0Xwn/OuQIQBFA8RdAMfZv9e65d901sN/S5DdA0UZBj4lPGaZwkMCACOmuSM8IVYNuM8h2A2sN5k8RsjSCeRGyIEI6DEqEEiEYwGAwgKCEKAZJZmNQxF7jd0HtZMT+PTuvFAC6sT0Bqh5oTYCkfzmA4i2DSZepWZHxChMFjlOkXu1kxU5eEPtZggjZy8BeiuxXwRzrABqkLYSXBHk4FJ4MlVYREI1BRICReHQjIAKq9rkF598TB2JvYsCCZkCovUcVeDypSnZBhoFcYeBsoEHssMaOE9mlkgS4WGDxL1QwhHYhQiBCGo1yslFONoZWgUdVuFOU5aIQ+pKTeBHcnBxA1RQ0dhEAcniU0ASMJARVb2KSSCD+LMiBgkw3yBsReqGgDWoJ5KRq7JsGwWAsWLH0FMr2aixNIwyRQqgQCRih2QjfqyhLI+V3kWGQsaCMgeSzeNI28TO1Eg/tcw9wAsBOTTudUUJJMEgpQq43sDRCxwsauKUyiNUvTcD5Z2jfiSx4Y6Wb6KpAZKVjTEzfKKZcLhLOC5U3VbgmEuqMo7hdILHSNo7a7r6mNqiQ6mB8y+mo8XRVPVMlMFjRaQojgoyGY9ngU1itlOO/IvsbESaRaLwwxKDFk5iJaZiAt1dRmlX5mSjjjTBBYJWjrlpKQ8wOK9T4ez6lfcqmxiWeiHhyN+gEQRcpMgJLd7XfjxJKSmItHdiKlbpYqYYoZUt3q7MJ2EjsqVDRlKZi7xuNn0XCSCMsEuFbTj8dtUPfwNnvOCXO4VnQKNE2PJC4BfiRIo+CNEsimcSqWnrGn8Wjc5gsTJbSxnMtoaRA1eminbAx6TPRePLJIkBPozyuwveTdyRhQmw0rY/K6LAk1I1p5ygnKBN/+j4gPwW5S9Ag8vxc6iOdNE0CPkqkHd/rEEObUdqMsNNAuzG0R0o5gnKUgqhYCVYEIpMCjCwAMfFCeFY4b5T7jHKtERLPIAISpYvkrLV1S5JxM4Gn07+7oe+VBr3eaavJuKl0oXxdNSihgVCFisQU1iAeI0r03NLUrr5RMEFsRCQHgaa+NvL8Kk6ffRcUS/sWha2q3OOMV6LTXixVwE7CB+n8sA0gbpMMPGfYJIlgnJ5HCh1GiCSmKjko5OsZlBtO72AI3RhEE33Jaz2CUtEOthc2sMGs5j1Zzjvha3SYClFoKZiHwBlEzyK7gEM1tcgaM+BuItYq/Jd6952PTgC7MEO8yEphqEEfUDTwAw7N+OtUom2hEomSyym9CvsxNHcmg/km+zCSPMVsQBtUXfPWstaXecvMYWH4FDPbp7EhXEckkM/F76qmUZQLLpz7UQU15FX5rcKRAu/4oB3ioGWFcvuQvglQC6RBkfnAsGqQQcYyC2UDHZGQzwkHFo5jVHAlBzCOIDYPn/gwhCyoPM201lt4s30hqpDPx7RXTcNGYynn9NrEAF9VGK1KqBaYAgsOVueWSKytNTzXCQwzCVklI83YzRhaK0I5MvQvDub84nOcGzzPgZzw/wYbC73IqLrTuaPXfH7S5zH6FQ6grQJhmEZVxkZVYlLwVvpHiXAFki6OM1o5rB+UxLVwiCBXmkx4mLqbil2U7ZUY/NjSZXw3t4D9OP5TSecCAkaXTueBfkv4do/vE0ZQLqdRlUgaoDh3ZnXvx6Lsp17Q4oWWJgEkmNsELTlj5AIF51cFw7ayUBc0MLFuGmO5hTx1n3oeWx80cVnP+7hu79+QkyKV0ILUFKSjr7XejUa5BYVAYqufAA6tTgp6uEFPdVQOE5BpMLE9FOpy3Tm/+AyH8K3PPIE/qelCbh3wOIHUEYYWnKT5r3j6jXK2KoPF+vZM4GGN0LURGqRA1cbHsc7ujAxGi5xb/A8GMvpzq1qMaTiFG/r/Go0CJLQGy/O7LmNSIS/KNaY6W7J07RchZxoL04WWZQwVhA5V2gycUncLB3xK+vpxjhObz+OCPlcTRl6A4YC6HDiOuc8RoRuaSR4EQSYqWjSWymWEDi/23VlRBhe/wih+uMfUp37Q5yYOaRiBqdgITDJAXZbVJHC6aFUBQJAznTTDTJKulEWQIODU3C8IkmhhDyjIBUWuafk5UZRGXaF46aQNG1U4J+OWykhTGflSdebjsqi2SBmeP51+DNvjqpBHNY5lZLevUonSCCwBmvrfsaqxK7FWWo8LkWLkgY0QKiiRCqEqY3KX1BywQ1q58u2Tmbbp9prPb199CTe+8x0AWs0WLnnzRB7dcFfmHUW5bPl47lp9DQBLWucyfv4oTpt/JKfNO5LTXjmSM+YdwwubHqs5xoReFxNFmUpFEk5ayTeijPIqHmaMeMU50MS8lyNo0L4cEHy55mB/2DKVWa3P8W7xdSb0uSrzrNVs4cE199LUS5kUTmbm5qd4ecvzLDAvM6TpSI5oGgvAwu0v8tTaGTTuVeSy/W/ll3++kdc65hEUvMkrPLzxPsb1OaPTHMZ2P4U6ShjKadhppRxIkoCMAma6bOmL1UCNB/gLhbHkXIRfdYRSIchB2YSdnpWlnSBv82cJCU1IUICyKXPdmknMGLKYhnw3QilDIf2NilQggAEN+zKi+9E21KxjUsvlNefQmGvmsMajeL1jTgZolkUMSdND1QPdiy7HdOFYaGBg8fAudSjJS2s8c+4ik8JZab3btorJqy/ijoOmx8+sS3FfVGB489H84qAZu6XLQxqG89rOOZ1MapIOqwdYlBYXokWO+66mrNDE3rscTDRO5Lt6JsYbXKBIibJUeGbzDMZ0/zdaigMQIUk53Hsrdizj6jcvxEhEIajjHw64nIObahvOfoUBGZD+gudiMAMTwJWIbkm1wWtNuKpDiW5dglVbYVTpArBXMXT62KfYwrAeI3l2wwymrL6Ka/f7l3iSkv6mCry1YwUrt69Iqh3rzV94aPgfao5TF5RSoBZDzltEiEEUgKJR6v3aj0+9SgTt0rpLwEleSm1ei1cUdwHBlP2nsnDjPNaHa7lz9Q0EXkbjsPeu683AhkE2Lg44a8CFXc6jLKnBCjQGKlZoEs+z2QEOkiK2VydyZySwKVoPpS7xJBKpmcgL5DWlt0vU6/PN3DH0Qc5ffBLrzV8I6tOQ0Fnl0XuN5VeH7p4Or29fC9YiO6B4glBiP1wAKsZQFqUkVYAdBd8pL4WmrgEbgXYJefrDqXREHbEP6PEN6vMNGR3GK7UAHNPja1zQ/2IeWPdL/Fqbq0i+37GeaeseIFJDKShxcr+zaMg315zHstYlqTsi222w19ZUh4UdopRcg8qXdi4Pr+58Ce0ltSsZdnG2l7dx9duT4uwF6Fffn8eHL4pry3bQXBCki2mPawf/nNkfzmJp+yKQwAKOexrzN81l7rq5Sdvz5IFP8Osjnuw0hZ1mB69tmQ+NqTpkWrzxh21ptiR84Cr7rhYcep83ljexpPy/NVd2VPcT6F3Ym/pcE43FJpobmuhW38QhPQ6jd7GFoT2HMbhxKIPqDmZM7xPoXdeH0T2Pz1Q07h0+nYGF/RnV5zgAxrWcRLd8Dxry9vcam+jW3MyIXiNrzuHZDY8R5sK0q+kFK965JinifaVv8KTCqX6r0dfnne1wXPEcbhzwyB7Z1T9h7kiW8ypBkPUGVcfU98boJJsPsyQyaU8nlLjyX5G4+1YswbObp7MmXL7HgX1u4xO8sePVOHz0qpc1jhVpPmyYH2LbG96Z9FwNFEqGm1dfWrUl4vM9dppWJi++nEJTlyATSosyNwFcEWZFEcb1ZP2WZRTFulxXD7O3vMC0Tb/aYwBfu/hS1gWrUipXGVJJuw7twDzfaH0YKQtce9IBNV4ybQSa94Ibll/O/J3/87mDnbr6Hh5Z/xsKDUmsnAA12XYSCjMVyimlY+pO1yhOFnw6GxsnRwY0gFLPChctPIOlbfM/P7394AmuWvxD6nt6VUpSoIHEp9NphMfxi3gm3hPxcCREkaWyGM9Nef3aQgm0aRvjZ3+dl7c985mDfXnzH5k0+2yKvUxmdwIWpJ/42KNdYHpmB4BtSL8vhsdcA9ptBHG1XtddFwPFBgh6tXLezFO5Y9VkQq18JmB/v+Epzn7xNII+cQ7upOmDrG6jqjA9ED4MqiUcGQiVKSKoa2Hguun2eeQZtXwddB8o3LHsZsbNPII52//7UwX70Lv3c95LZxD0bScXJFRN9NeBdF2GXHzVQLkzqO4tJcUv4XVRnvVBhp5rUn/bASB56DYQVpllnP7COCa88nVe2vKc7Rz/dQ6jhslLruDSOf9IXYshyNmxNZuMOJCulmXXY4Yqi93zJNLqT5BEJwJDVVmMUNTOKVZCncDr5bhFa90IUTsM6r4/3x50Fif2+yYjun+JuqD0icBuCTfz3TkTeXHjHyn1S8cKPABJZkSnqks7cBiwyt344HiNAe8tQZLXWvFPAf45AzJ9lgycNJu9HBaBjq0QtsWsaCg2cGiPLzCs5whO3fdMjt/rpN0Cu3DbXC546RzWybuUensSqion7WJv7GTgZv9GArh3JciUZBQaFRYpDFGJSySZXLUq08ssBtlYPNwJpgOiMmgI9499kLNavrOLGplw959v46fzfkzQM6KuKQUZqE2oPjrYewM4Bij7C7Lha3ZzqdFMsQtV2oBzA2F2oNRLVTobeJWF6vxTNfbXblKFhvgsAVEb/GnHSmipPct3O1Zx8SsXMmvdTBr7Qq6YNsn8+e2q+gLsBCZiA43q13NJ5dF5bmNNvWGRKt8TjYuJbkcc3u7VzD5H7eQOslUQhXwJ+jb2qxHuKg+9dz9jnh7B3E0zadwHtGjLTPCRJtDrMAhwkcIy7WJt4k0tkZWa95KJZ/LvgbKvKlPwJVhVnaiZklXrto3oBjcempnAW23LuGzBD5i1dibFnlBqSueyK7C+annHPwHTdtmPwqsr+3rofumd5/jZfn9HL4Wr0GwVoabBqCUVSa+D6g8E4MNwE7euvIEHlt6P5iIa9+lcmunKMNUaNlB+AtzzkQ04sD3VKiPkX9f8nqv3PZHNKkyBzu1DrbKeGu9ui12Xp+MmgnvX3EVRivx25YNsbd9KXXcoNNWWpOxCZwPNvPajjbO4u++Xd2PPSMsKpbQ16ExRO9h7z6d/DvwGfw88ANRXS9J9LQPStT2cFTfQvjm+5hqgrkfXVK2FNdBOD1qBizbOZjpA32O7JBwAG8dZt1TcGqS+dVcWIn5nhMDDwNBaIJ00/QDho/ymapc07XL2GrueicCy3Q1kNo6z+7TU1LaqaFW/KTZmryMchXCT3SjQKdTLSdqq9G1DNVjRzjobeIzwW5+esWxXuB44+uOAzbglqv2ctz9RvPSLNGBvN8r1onxRlKcC22u1AXsnkNJFz2mXEtVaQuU/bbh4E/CJUrRcYhn9RFo9cH5W4knFSuHtnHCaKiOBR1Tp6AqkVnU0Okm0atec5/ragakKhyucpbCqcwV2987USnvBuFY3CbzJ5aoor0Ey+UXAuQo9iP+zZYIqxyrUf0wp2u3LtAOzNLYVjwHb/1rZV9CyQtlsglqV+k6TDGoEE518bvpOPTAGGI1yOHAAMADojVKysc12e66zZdSVAq8Qn+WPjeYjYmw9Qgn+1v4V7/8GANZ4eoyjZDS5AAAAAElFTkSuQmCC",message="",notiType="";
type==ContentType.NONE?(message=null!=sender?sender+" : "+notiText:notiText,notiType="message"):type==ContentType.STICKER?(message=null!=sender?sender+" "+$.i18n.prop("SENT_STICKER"):notiText,notiType="message"):type==ContentType.IMAGE?(message=null!=sender?sender+" "+$.i18n.prop("SENT_PICTURE"):notiText,notiType="message"):"inviteIntoGroup"==type?(message=$.i18n.prop("GROUP_INVITED",sender,notiText),notiType="group"):(message=sender+" "+$.i18n.prop("NOT_SUPPORT_MESSAGE_FORMAT"),notiType="message");var settings=SettingProxy.getInstance().getSettings();if(0!=settings.notificationEnable&&!(SettingProxy.getInstance().isPushMute()||"message"==notiType&&0==settings.notificationNewMessage||"group"==notiType&&0==settings.notificationGroupInvitation||!navigator.mozNotification)){var notification=navigator.mozNotification.createNotification("LINE",message,icon);notification.onclick=function(){navigator.mozApps.getSelf().onsuccess=function(event){var app=event.target.result;app.launch()}},notification.show(),LinePushNotification._referencesArray.push(notification)}},LinePushNotification.setEvent=function(){1!=LinePushNotification.isSetEvent&&(LinePushNotification.setMessageHandler(),LinePushNotification.isSetEvent=!0,document.addEventListener("visibilitychange",function(){"hidden"==document.visibilityState?(ChatUI.getInstance().clearWarmup(),null==LinePushNotification.pushEndPoint?LinePushNotification.register(function(token){PersistentStore.getInstance().set("TK",token),SettingProxy.getInstance().updateNotificationToken(token),OperationPoller.getInstance().setBackgroundMode()}):OperationPoller.getInstance().setBackgroundMode()):"visible"==document.visibilityState&&(OperationPoller.getInstance().setForegroundMode(),ChatUI.getInstance().checkChatScreenForVisibility())}),OperationPoller.getInstance().run())},LinePushNotification._forget=function(notification){LinePushNotification._referencesArray.splice(LinePushNotification._referencesArray.indexOf(notification),1)};var JobWorker=function(sUrl,fTalkException,fNetworkException){var oInstance=this,oWorker=new Worker(sUrl),oListeners={};this.defaultListener=fTalkException||function(){},oWorker.onmessage=function(oEvent){oEvent.data instanceof Object&&oEvent.data.hasOwnProperty("method")&&oEvent.data.hasOwnProperty("arguments")&&("logger"===oEvent.data.method||("LineTalkException"==oEvent.data.method?fTalkException&&fTalkException.call(oInstance,oEvent.data.arguments):"LineNetworkException"==oEvent.data.method?fNetworkException&&fNetworkException():oListeners[oEvent.data.method].apply(oInstance,oEvent.data.arguments)))},oWorker.onerror=function(event){event.message.indexOf("HTTP Response code: 0")>-1&&LineNetworkExceptionHandler.getInstance().handle()},this.sendQuery=function(){var authToken=AuthInfoKeeper.getInstance().getAuthToken();if(arguments.length<1)throw new TypeError("QueryableWorker.sendQuery - not enough arguments");oWorker.postMessage({method:arguments[0],authToken:authToken,arguments:Array.prototype.slice.call(arguments,1)})},this.close=function(){try{oWorker.close()}catch(e){try{oWorker.terminate()}catch(e){}}},this.terminate=function(){oWorker.terminate()},this.addListener=function(sName,fListener){oListeners[sName]=fListener},this.removeListener=function(sName){delete oListeners[sName]},this.send=function(options){var arg=[options.methodName].concat(options.data),methodName=options.methodName;options.uniquekey&&(methodName+=options.uniquekey),this.removeListener(methodName),this.addListener(methodName,function(result,p1){result&&1==!!result.code&&LineTalkExceptionHandler.getInstance().handle(arguments),options.success(result,p1)}),this.sendQuery.apply(this,arg)}};